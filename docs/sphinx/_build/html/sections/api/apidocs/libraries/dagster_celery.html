
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Celery (dagster_celery) &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Orchestration on Celery + Docker" href="dagster_celery_docker.html" />
    <link rel="prev" title="Azure (dagster_azure)" href="dagster_azure.html" />
 
<link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            &larr;
            <a href="dagster_azure.html" title="Previous document">Azure (dagster_azure)</a>
        </li>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
        <li>
            <a href="dagster_celery_docker.html" title="Next document">Orchestration on Celery + Docker</a>
            &rarr;
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <div class="section" id="celery-dagster-celery">
<h1>Celery (dagster_celery)<a class="headerlink" href="#celery-dagster-celery" title="Permalink to this headline">¶</a></h1>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>To get a local rabbitmq broker started and available via the default
<code class="docutils literal notranslate"><span class="pre">pyamqp://guest&#64;localhost:5672</span></code>, in the <code class="docutils literal notranslate"><span class="pre">dagster/python_modules/libraries/dagster-celery/</span></code>
directory run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker-compose up
</pre></div>
</div>
<p>To run a celery worker:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>celery -A dagster_celery.app worker -l info
</pre></div>
</div>
<p>To start multiple workers in the background, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>celery multi start w2 -A dagster_celery.app -l info
</pre></div>
</div>
<p>To execute a pipeline using the celery-backed executor, you’ll need to add the celery executor to
a mode definition on the pipeline:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">default_executors</span>
<span class="kn">from</span> <span class="nn">dagster_celery</span> <span class="kn">import</span> <span class="n">celery_executor</span>

<span class="nd">@pipeline</span><span class="p">(</span><span class="n">mode_defs</span><span class="o">=</span><span class="p">[</span><span class="n">ModeDefinition</span><span class="p">(</span><span class="n">executor_defs</span><span class="o">=</span><span class="n">default_executors</span> <span class="o">+</span> <span class="p">[</span><span class="n">celery_executor</span><span class="p">])])</span>
<span class="k">def</span> <span class="nf">my_pipeline</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Then you can use config like the following to execute the pipeline:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">execution</span><span class="p">:</span>
  <span class="nt">celery</span><span class="p">:</span>
</pre></div>
</div>
<div class="section" id="monitoring-your-celery-tasks">
<h3>Monitoring your Celery tasks<a class="headerlink" href="#monitoring-your-celery-tasks" title="Permalink to this headline">¶</a></h3>
<p>We advise using [Flower](<a class="reference external" href="https://celery.readthedocs.io/en/latest/userguide/monitoring.html#flower-real-time-celery-web-monitor">https://celery.readthedocs.io/en/latest/userguide/monitoring.html#flower-real-time-celery-web-monitor</a>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>celery -A dagster_celery.app flower
</pre></div>
</div>
</div>
<div class="section" id="customizing-the-celery-broker-backend-and-other-app-configuration">
<h3>Customizing the Celery broker, backend, and other app configuration<a class="headerlink" href="#customizing-the-celery-broker-backend-and-other-app-configuration" title="Permalink to this headline">¶</a></h3>
<p>By default this will use <code class="docutils literal notranslate"><span class="pre">amqp://guest:**&#64;localhost:5672//</span></code> as the Celery broker URL and
<code class="docutils literal notranslate"><span class="pre">rpc://</span></code> as the results backend. In production, you will want to change these values. Pending the
introduction of a dagster_celery CLI, that would entail writing a Python module <code class="docutils literal notranslate"><span class="pre">my_module</span></code> as
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="kn">from</span> <span class="nn">dagster_celery.tasks</span> <span class="kn">import</span> <span class="n">create_task</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;dagster&#39;</span><span class="p">,</span> <span class="n">broker_url</span><span class="o">=</span><span class="s1">&#39;some://custom@value&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

<span class="n">execute_plan</span> <span class="o">=</span> <span class="n">create_task</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">worker_main</span><span class="p">()</span>
</pre></div>
</div>
<p>You can then run the celery worker using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>celery -A my_module worker --loglevel<span class="o">=</span>info
</pre></div>
</div>
<p>This customization mechanism is used to implement <cite>dagster_celery_k8s</cite> and <cite>dagster_celery_k8s</cite> which delegate the execution of steps to ephemeral kubernetes pods and docker containers, respectively.</p>
</div>
<div class="section" id="celery-best-practices">
<h3>Celery best practices<a class="headerlink" href="#celery-best-practices" title="Permalink to this headline">¶</a></h3>
<p>Celery is a rich and full-featured system. We’ve found the following resources helpful:</p>
<ul class="simple">
<li><p>Deni Bertović’s [Celery best practices](<a class="reference external" href="https://denibertovic.com/posts/celery-best-practices/">https://denibertovic.com/posts/celery-best-practices/</a>)</p></li>
<li><p>Pawel Zadrozny’s [series of articles](<a class="reference external" href="https://pawelzny.com/python/celery/2017/08/14/celery-4-tasks-best-practices/">https://pawelzny.com/python/celery/2017/08/14/celery-4-tasks-best-practices/</a>) on Celery best practices</p></li>
<li><p>Balthazar Rouberol’s [Celery best practices](<a class="reference external" href="https://blog.balthazar-rouberol.com/celery-best-practices">https://blog.balthazar-rouberol.com/celery-best-practices</a>)</p></li>
</ul>
</div>
</div>
<div class="section" id="api">
<h2>API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<dl class="data">
<dt id="dagster_celery.celery_executor">
<code class="sig-prename descclassname">dagster_celery.</code><code class="sig-name descname">celery_executor</code><em class="property"> ExecutorDefinition</em><a class="reference internal" href="../../../../_modules/dagster_celery/executor.html#celery_executor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#dagster_celery.celery_executor" title="Permalink to this definition">¶</a></dt>
<dd><p>Celery-based executor.</p>
<p>The Celery executor exposes config settings for the underlying Celery app under
the <code class="docutils literal notranslate"><span class="pre">config_source</span></code> key. This config corresponds to the “new lowercase settings” introduced
in Celery version 4.0 and the object constructed from config will be passed to the
<a class="reference external" href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery" title="(in Celery v4.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.Celery</span></code></a> constructor as its <code class="docutils literal notranslate"><span class="pre">config_source</span></code> argument.
(See <a class="reference external" href="https://docs.celeryproject.org/en/latest/userguide/configuration.html">https://docs.celeryproject.org/en/latest/userguide/configuration.html</a> for details.)</p>
<p>The executor also exposes the <code class="docutils literal notranslate"><span class="pre">broker</span></code>, <cite>backend</cite>, and <code class="docutils literal notranslate"><span class="pre">include</span></code> arguments to the
<a class="reference external" href="http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery" title="(in Celery v4.3)"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.Celery</span></code></a> constructor.</p>
<p>In the most common case, you may want to modify the <code class="docutils literal notranslate"><span class="pre">broker</span></code> and <code class="docutils literal notranslate"><span class="pre">backend</span></code> (e.g., to use
Redis instead of RabbitMQ). We expect that <code class="docutils literal notranslate"><span class="pre">config_source</span></code> will be less frequently
modified, but that when solid executions are especially fast or slow, or when there are
different requirements around idempotence or retry, it may make sense to execute pipelines
with variations on these settings.</p>
<p>If you’d like to configure a celery executor in addition to the
<a class="reference internal" href="../execution.html#dagster.default_executors" title="dagster.default_executors"><code class="xref py py-class docutils literal notranslate"><span class="pre">default_executors</span></code></a>, you should add it to the <code class="docutils literal notranslate"><span class="pre">executor_defs</span></code> defined on a
<a class="reference internal" href="../modes-resources.html#dagster.ModeDefinition" title="dagster.ModeDefinition"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModeDefinition</span></code></a> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">ModeDefinition</span><span class="p">,</span> <span class="n">default_executors</span><span class="p">,</span> <span class="n">pipeline</span>
<span class="kn">from</span> <span class="nn">dagster_celery</span> <span class="kn">import</span> <span class="n">celery_executor</span>

<span class="nd">@pipeline</span><span class="p">(</span><span class="n">mode_defs</span><span class="o">=</span><span class="p">[</span><span class="n">ModeDefinition</span><span class="p">(</span><span class="n">executor_defs</span><span class="o">=</span><span class="n">default_executors</span> <span class="o">+</span> <span class="p">[</span><span class="n">celery_executor</span><span class="p">])])</span>
<span class="k">def</span> <span class="nf">celery_enabled_pipeline</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Then you can configure the executor as follows:</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">execution</span><span class="p">:</span>
  <span class="nt">celery</span><span class="p">:</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">broker</span><span class="p">:</span> <span class="s">&#39;pyamqp://guest@localhost//&#39;</span>  <span class="c1"># Optional[str]: The URL of the Celery broker</span>
      <span class="nt">backend</span><span class="p">:</span> <span class="s">&#39;rpc://&#39;</span> <span class="c1"># Optional[str]: The URL of the Celery results backend</span>
      <span class="nt">include</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;my_module&#39;</span><span class="p p-Indicator">]</span> <span class="c1"># Optional[List[str]]: Modules every worker should import</span>
      <span class="nt">config_source</span><span class="p">:</span> <span class="c1"># Dict[str, Any]: Any additional parameters to pass to the</span>
          <span class="c1">#...       # Celery workers. This dict will be passed as the `config_source`</span>
          <span class="c1">#...       # argument of celery.Celery().</span>
</pre></div>
</div>
<p>Note that the YAML you provide here must align with the configuration with which the Celery
workers on which you hope to run were started. If, for example, you point the executor at a
different broker than the one your workers are listening to, the workers will never be able to
pick up tasks for execution.</p>
</dd></dl>

</div>
<div class="section" id="cli">
<h2>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">dagster-celery</span></code> CLI lets you start, monitor, and terminate workers.</p>
<div class="section" id="dagster-celery-worker-start">
<h3>dagster-celery worker start<a class="headerlink" href="#dagster-celery-worker-start" title="Permalink to this headline">¶</a></h3>
<p>Start a dagster celery worker.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dagster-celery worker start <span class="o">[</span>OPTIONS<span class="o">]</span>
                            <span class="o">[</span>ADDITIONAL_ARGS<span class="o">]</span>...
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-n">
<code class="sig-name descname">-n</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--name</code><code class="sig-prename descclassname"> &lt;name&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-n" title="Permalink to this definition">¶</a></dt>
<dd><p>The name of the worker. Defaults to a unique name prefixed with “dagster-” and ending with the hostname.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-y">
<code class="sig-name descname">-y</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--config-yaml</code><code class="sig-prename descclassname"> &lt;config_yaml&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-y" title="Permalink to this definition">¶</a></dt>
<dd><p>Specify the path to a config YAML file with options for the worker. This is the same config block that you provide to dagster_celery.celery_executor when configuring a pipeline for execution with Celery, with, e.g., the URL of the broker to use.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-q">
<code class="sig-name descname">-q</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--queue</code><code class="sig-prename descclassname"> &lt;queue&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-q" title="Permalink to this definition">¶</a></dt>
<dd><p>Names of the queues on which this worker should listen for tasks.  Provide multiple -q arguments to specify multiple queues. Note that each celery worker may listen on no more than four queues.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-d">
<code class="sig-name descname">-d</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--background</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-d" title="Permalink to this definition">¶</a></dt>
<dd><p>Set this flag to run the worker in the background.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-i">
<code class="sig-name descname">-i</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--includes</code><code class="sig-prename descclassname"> &lt;includes&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-i" title="Permalink to this definition">¶</a></dt>
<dd><p>Python modules the worker should import. Provide multiple -i arguments to specify multiple modules.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-l">
<code class="sig-name descname">-l</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--loglevel</code><code class="sig-prename descclassname"> &lt;loglevel&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-l" title="Permalink to this definition">¶</a></dt>
<dd><p>Log level for the worker.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-a">
<code class="sig-name descname">-A</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--app</code><code class="sig-prename descclassname"> &lt;app&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-a" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p class="rubric">Arguments</p>
<dl class="option">
<dt id="cmdoption-dagster-celery-worker-start-arg-additional-args">
<code class="sig-name descname">ADDITIONAL_ARGS</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-dagster-celery-worker-start-arg-additional-args" title="Permalink to this definition">¶</a></dt>
<dd><p>Optional argument(s)</p>
</dd></dl>

</div>
<div class="section" id="dagster-celery-worker-list">
<h3>dagster-celery worker list<a class="headerlink" href="#dagster-celery-worker-list" title="Permalink to this headline">¶</a></h3>
<p>List running dagster-celery workers. Note that we use the broker to contact the workers.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dagster-celery worker list <span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="option">
<dt id="cmdoption-dagster-celery-worker-list-y">
<code class="sig-name descname">-y</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--config-yaml</code><code class="sig-prename descclassname"> &lt;config_yaml&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-list-y" title="Permalink to this definition">¶</a></dt>
<dd><p>Specify the path to a config YAML file with options for the workers you are trying to manage. This is the same config block that you provide to dagster_celery.celery_executor when configuring a pipeline for execution with Celery, with, e.g., the URL of the broker to use. Without this config file, you will not be able to find your workers (since the CLI won’t know how to reach the broker).</p>
</dd></dl>

</div>
<div class="section" id="dagster-celery-worker-terminate">
<h3>dagster-celery worker terminate<a class="headerlink" href="#dagster-celery-worker-terminate" title="Permalink to this headline">¶</a></h3>
<p>Shut down dagster-celery workers. Note that we use the broker to send signals to the workers to terminate – if the broker is not running, this command is a no-op. Provide the argument NAME to terminate a specific worker by name.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>dagster-celery worker terminate 
    <span class="o">[</span>OPTIONS<span class="o">]</span> <span class="o">[</span>NAME<span class="o">]</span>
</pre></div>
</div>
<p class="rubric">Options</p>
<dl class="option">
<dt id="cmdoption-dagster-celery-worker-terminate-a">
<code class="sig-name descname">-a</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--all</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-dagster-celery-worker-terminate-a" title="Permalink to this definition">¶</a></dt>
<dd><p>Set this flag to terminate all running workers.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-dagster-celery-worker-terminate-y">
<code class="sig-name descname">-y</code><code class="sig-prename descclassname"></code><code class="sig-prename descclassname">, </code><code class="sig-name descname">--config-yaml</code><code class="sig-prename descclassname"> &lt;config_yaml&gt;</code><a class="headerlink" href="#cmdoption-dagster-celery-worker-terminate-y" title="Permalink to this definition">¶</a></dt>
<dd><p>Specify the path to a config YAML file with options for the workers you are trying to manage. This is the same config block that you provide to dagster_celery.celery_executor when configuring a pipeline for execution with Celery, with, e.g., the URL of the broker to use. Without this config file, you will not be able to terminate your workers (since the CLI won’t know how to reach the broker).</p>
</dd></dl>

<p class="rubric">Arguments</p>
<dl class="option">
<dt id="cmdoption-dagster-celery-worker-terminate-arg-name">
<code class="sig-name descname">NAME</code><code class="sig-prename descclassname"></code><a class="headerlink" href="#cmdoption-dagster-celery-worker-terminate-arg-name" title="Permalink to this definition">¶</a></dt>
<dd><p>Optional argument</p>
</dd></dl>

</div>
</div>
</div>


            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            &larr;
            <a href="dagster_azure.html" title="Previous document">Azure (dagster_azure)</a>
        </li>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
        <li>
            <a href="dagster_celery_docker.html" title="Next document">Orchestration on Celery + Docker</a>
            &rarr;
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>