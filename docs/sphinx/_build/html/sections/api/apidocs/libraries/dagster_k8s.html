
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Kubernetes (dagster_k8s) &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="PagerDuty (dagster_pagerduty)" href="dagster_pagerduty.html" />
    <link rel="prev" title="GitHub (dagster_github)" href="dagster_github.html" />
 
<link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            &larr;
            <a href="dagster_github.html" title="Previous document">GitHub (dagster_github)</a>
        </li>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
        <li>
            <a href="dagster_pagerduty.html" title="Next document">PagerDuty (dagster_pagerduty)</a>
            &rarr;
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <div class="section" id="kubernetes-dagster-k8s">
<h1>Kubernetes (dagster_k8s)<a class="headerlink" href="#kubernetes-dagster-k8s" title="Permalink to this headline">¶</a></h1>
<p>See also the <a class="reference external" href="https://docs.dagster.io/deploying/kubernetes/">Kubernetes deployment guide</a>.</p>
<p>This library contains utilities for running Dagster with Kubernetes. This includes a Python API
allowing Dagit to launch runs as Kubernetes Jobs, as well as a Helm chart you can use as the basis
for a Dagster deployment on a Kubernetes cluster.</p>
</div>
<div class="section" id="apis">
<h1>APIs<a class="headerlink" href="#apis" title="Permalink to this headline">¶</a></h1>
<dl class="class">
<dt id="dagster_k8s.K8sRunLauncher">
<em class="property">class </em><code class="sig-prename descclassname">dagster_k8s.</code><code class="sig-name descname">K8sRunLauncher</code><span class="sig-paren">(</span><em class="sig-param">service_account_name</em>, <em class="sig-param">instance_config_map</em>, <em class="sig-param">postgres_password_secret</em>, <em class="sig-param">dagster_home</em>, <em class="sig-param">job_image=None</em>, <em class="sig-param">image_pull_policy='Always'</em>, <em class="sig-param">image_pull_secrets=None</em>, <em class="sig-param">load_incluster_config=True</em>, <em class="sig-param">kubeconfig_file=None</em>, <em class="sig-param">inst_data=None</em>, <em class="sig-param">job_namespace='default'</em>, <em class="sig-param">env_config_maps=None</em>, <em class="sig-param">env_secrets=None</em>, <em class="sig-param">k8s_client_batch_api=None</em>, <em class="sig-param">k8s_client_core_api=None</em><span class="sig-paren">)</span><a class="reference internal" href="../../../../_modules/dagster_k8s/launcher.html#K8sRunLauncher"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#dagster_k8s.K8sRunLauncher" title="Permalink to this definition">¶</a></dt>
<dd><p>RunLauncher that starts a Kubernetes Job for each pipeline run.</p>
<p>Encapsulates each pipeline run in a separate, isolated invocation of <code class="docutils literal notranslate"><span class="pre">dagster-graphql</span></code>.</p>
<p>You may configure a Dagster instance to use this RunLauncher by adding a section to your
<code class="docutils literal notranslate"><span class="pre">dagster.yaml</span></code> like the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">run_launcher</span><span class="p">:</span>
    <span class="nt">module</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dagster_k8s.launcher</span>
    <span class="nt">class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">K8sRunLauncher</span>
    <span class="nt">config</span><span class="p">:</span>
        <span class="nt">service_account_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pipeline_run_service_account</span>
        <span class="nt">job_image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my_project/dagster_image:latest</span>
        <span class="nt">instance_config_map</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dagster-instance</span>
        <span class="nt">postgres_password_secret</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dagster-postgresql-secret</span>
</pre></div>
</div>
<p>As always when using a <a class="reference internal" href="../internals.html#dagster.serdes.ConfigurableClass" title="dagster.serdes.ConfigurableClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">ConfigurableClass</span></code></a>, the values
under the <code class="docutils literal notranslate"><span class="pre">config</span></code> key of this YAML block will be passed to the constructor. The full list
of acceptable values is given below by the constructor args.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>service_account_name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – The name of the Kubernetes service account under which to run
the Job.</p></li>
<li><p><strong>job_image</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em>) – The <code class="docutils literal notranslate"><span class="pre">name</span></code> of the image to use for the Job’s Dagster container.
This image will be run with the command
<code class="docutils literal notranslate"><span class="pre">dagster</span> <span class="pre">api</span> <span class="pre">execute_run</span></code>.
When using user code deployments, the image should not be specified.</p></li>
<li><p><strong>instance_config_map</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – The <code class="docutils literal notranslate"><span class="pre">name</span></code> of an existing Volume to mount into the pod in
order to provide a ConfigMap for the Dagster instance. This Volume should contain a
<code class="docutils literal notranslate"><span class="pre">dagster.yaml</span></code> with appropriate values for run storage, event log storage, etc.</p></li>
<li><p><strong>postgres_password_secret</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – The name of the Kubernetes Secret where the postgres
password can be retrieved. Will be mounted and supplied as an environment variable to
the Job Pod.</p></li>
<li><p><strong>dagster_home</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a>) – The location of DAGSTER_HOME in the Job container; this is where the
<code class="docutils literal notranslate"><span class="pre">dagster.yaml</span></code> file will be mounted from the instance ConfigMap specified above.</p></li>
<li><p><strong>load_incluster_config</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.8)"><em>bool</em></a><em>]</em>) – Set this value if you are running the launcher
within a k8s cluster. If <code class="docutils literal notranslate"><span class="pre">True</span></code>, we assume the launcher is running within the target
cluster and load config using <code class="docutils literal notranslate"><span class="pre">kubernetes.config.load_incluster_config</span></code>. Otherwise,
we will use the k8s config specified in <code class="docutils literal notranslate"><span class="pre">kubeconfig_file</span></code> (using
<code class="docutils literal notranslate"><span class="pre">kubernetes.config.load_kube_config</span></code>) or fall back to the default kubeconfig. Default:
<code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>kubeconfig_file</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em>) – The kubeconfig file from which to load config. Defaults to
None (using the default kubeconfig).</p></li>
<li><p><strong>image_pull_secrets</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><em>Dict</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>, </em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em><em>]</em><em>]</em>) – Optionally, a list of dicts, each of
which corresponds to a Kubernetes <code class="docutils literal notranslate"><span class="pre">LocalObjectReference</span></code> (e.g.,
<code class="docutils literal notranslate"><span class="pre">{'name':</span> <span class="pre">'myRegistryName'}</span></code>). This allows you to specify the <code class="docutils literal notranslate"><span class="pre">`imagePullSecrets</span></code> on
a pod basis. Typically, these will be provided through the service account, when needed,
and you will not need to pass this argument.
See:
<a class="reference external" href="https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod">https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod</a>
and <a class="reference external" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#podspec-v1-core">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/#podspec-v1-core</a>.</p></li>
<li><p><strong>image_pull_policy</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em>) – Allows the image pull policy to be overridden, e.g. to
facilitate local testing with <a class="reference external" href="https://kind.sigs.k8s.io/">kind</a>. Default:
<code class="docutils literal notranslate"><span class="pre">&quot;Always&quot;</span></code>. See: <a class="reference external" href="https://kubernetes.io/docs/concepts/containers/images/#updating-images">https://kubernetes.io/docs/concepts/containers/images/#updating-images</a>.</p></li>
<li><p><strong>job_namespace</strong> (<em>Optional</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em>) – The namespace into which to launch new jobs. Note that any
other Kubernetes resources the Job requires (such as the service account) must be
present in this namespace. Default: <code class="docutils literal notranslate"><span class="pre">&quot;default&quot;</span></code></p></li>
<li><p><strong>env_config_maps</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em><em>]</em>) – A list of custom ConfigMapEnvSource names from which to
draw environment variables (using <code class="docutils literal notranslate"><span class="pre">envFrom</span></code>) for the Job. Default: <code class="docutils literal notranslate"><span class="pre">[]</span></code>. See:
<a class="reference external" href="https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/#define-an-environment-variable-for-a-container">https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/#define-an-environment-variable-for-a-container</a></p></li>
<li><p><strong>env_secrets</strong> (<em>Optional</em><em>[</em><em>List</em><em>[</em><a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.8)"><em>str</em></a><em>]</em><em>]</em>) – A list of custom Secret names from which to
draw environment variables (using <code class="docutils literal notranslate"><span class="pre">envFrom</span></code>) for the Job. Default: <code class="docutils literal notranslate"><span class="pre">[]</span></code>. See:
<a class="reference external" href="https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/#configure-all-key-value-pairs-in-a-secret-as-container-environment-variables">https://kubernetes.io/docs/tasks/inject-data-application/distribute-credentials-secure/#configure-all-key-value-pairs-in-a-secret-as-container-environment-variables</a></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="dagster_k8s.K8sScheduler">
<em class="property">class </em><code class="sig-prename descclassname">dagster_k8s.</code><code class="sig-name descname">K8sScheduler</code><span class="sig-paren">(</span><em class="sig-param">dagster_home</em>, <em class="sig-param">service_account_name</em>, <em class="sig-param">instance_config_map</em>, <em class="sig-param">postgres_password_secret</em>, <em class="sig-param">job_image</em>, <em class="sig-param">load_incluster_config=True</em>, <em class="sig-param">scheduler_namespace='default'</em>, <em class="sig-param">image_pull_policy='Always'</em>, <em class="sig-param">image_pull_secrets=None</em>, <em class="sig-param">kubeconfig_file=None</em>, <em class="sig-param">inst_data=None</em>, <em class="sig-param">env_config_maps=None</em>, <em class="sig-param">env_secrets=None</em><span class="sig-paren">)</span><a class="reference internal" href="../../../../_modules/dagster_k8s/scheduler.html#K8sScheduler"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#dagster_k8s.K8sScheduler" title="Permalink to this definition">¶</a></dt>
<dd><p>Scheduler implementation on top of Kubernetes CronJob.</p>
<p>Enable this scheduler by adding it to your dagster.yaml, or by configuring the scheduler
section of the Helm chart
<a class="reference external" href="https://github.com/dagster-io/dagster/tree/master/helm">https://github.com/dagster-io/dagster/tree/master/helm</a></p>
</dd></dl>

<div class="section" id="python-api">
<h2>Python API<a class="headerlink" href="#python-api" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">K8sRunLauncher</span></code> allows Dagit instances to be configured to launch new runs by starting per-run
Kubernetes Jobs. To configure the <code class="docutils literal notranslate"><span class="pre">K8sRunLauncher</span></code>, your <code class="docutils literal notranslate"><span class="pre">dagster.yaml</span></code> should include a section
like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">run_launcher</span><span class="p">:</span>
  <span class="nt">module</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dagster_k8s.launcher</span>
  <span class="nt">class</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">K8sRunLauncher</span>
  <span class="nt">config</span><span class="p">:</span>
    <span class="nt">image_pull_secrets</span><span class="p">:</span>
    <span class="nt">service_account_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">dagster</span>
    <span class="nt">job_image</span><span class="p">:</span> <span class="s">&quot;my-company.com/image:latest&quot;</span>
    <span class="nt">dagster_home</span><span class="p">:</span> <span class="s">&quot;/opt/dagster/dagster_home&quot;</span>
    <span class="nt">postgres_password_secret</span><span class="p">:</span> <span class="s">&quot;dagster-postgresql-secret&quot;</span>
    <span class="nt">image_pull_policy</span><span class="p">:</span> <span class="s">&quot;IfNotPresent&quot;</span>
    <span class="nt">job_namespace</span><span class="p">:</span> <span class="s">&quot;dagster&quot;</span>
    <span class="nt">instance_config_map</span><span class="p">:</span> <span class="s">&quot;dagster-instance&quot;</span>
    <span class="nt">env_config_maps</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;dagster-k8s-job-runner-env&quot;</span>
    <span class="nt">env_secrets</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;dagster-k8s-some-secret&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="helm-chart">
<h2>Helm chart<a class="headerlink" href="#helm-chart" title="Permalink to this headline">¶</a></h2>
<p>For local dev (e.g., on kind or minikube):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>helm install <span class="se">\</span>
    --set dagit.image.repository<span class="o">=</span><span class="s2">&quot;dagster.io/buildkite-test-image&quot;</span> <span class="se">\</span>
    --set dagit.image.tag<span class="o">=</span><span class="s2">&quot;py37-latest&quot;</span> <span class="se">\</span>
    --set job_runner.image.repository<span class="o">=</span><span class="s2">&quot;dagster.io/buildkite-test-image&quot;</span> <span class="se">\</span>
    --set job_runner.image.tag<span class="o">=</span><span class="s2">&quot;py37-latest&quot;</span> <span class="se">\</span>
    --set <span class="nv">imagePullPolicy</span><span class="o">=</span><span class="s2">&quot;IfNotPresent&quot;</span> <span class="se">\</span>
    dagster <span class="se">\</span>
    helm/dagster/
</pre></div>
</div>
<p>Upon installation, the Helm chart will provide instructions for port forwarding Dagit and Flower (if
configured).</p>
</div>
<div class="section" id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Permalink to this headline">¶</a></h2>
<p>To run the unit tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pytest</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;not integration&quot;</span>
</pre></div>
</div>
<p>To run the integration tests, you must have <a class="reference external" href="https://docs.docker.com/install/">Docker</a>,
<a class="reference external" href="https://kind.sigs.k8s.io/docs/user/quick-start#installation">kind</a>,
and <a class="reference external" href="https://helm.sh/docs/intro/install/">helm</a> installed.</p>
<p>On macOS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">install</span> <span class="n">kind</span>
<span class="n">brew</span> <span class="n">install</span> <span class="n">helm</span>
</pre></div>
</div>
<p>Docker must be running.</p>
<p>You may experience slow first test runs thanks to image pulls (run <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-svv</span> <span class="pre">--fulltrace</span></code> for
visibility). Building images and loading them to the kind cluster is slow, and there is
no visibility into the progress of the load.</p>
<p><strong>NOTE:</strong> This process is quite slow, as it requires bootstrapping a local <code class="docutils literal notranslate"><span class="pre">kind</span></code> cluster with Docker images and the <code class="docutils literal notranslate"><span class="pre">dagster-k8s</span></code> Helm chart. For faster development, you can either:</p>
<ol class="arabic simple">
<li><p>Keep a warm kind cluster</p></li>
<li><p>Use a remote K8s cluster, e.g. via AWS EKS or GCP GKE</p></li>
</ol>
<p>Instructions are below.</p>
<div class="section" id="faster-local-development-with-kind">
<h3>Faster local development (with kind)<a class="headerlink" href="#faster-local-development-with-kind" title="Permalink to this headline">¶</a></h3>
<p>You may find that the kind cluster creation, image loading, and kind cluster creation loop
is too slow for effective local dev.</p>
<p>You may bypass cluster creation and image loading in the following way. First add the <code class="docutils literal notranslate"><span class="pre">--no-cleanup</span></code>
flag to your pytest invocation:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest --no-cleanup -s -vvv -m <span class="s2">&quot;not integration&quot;</span>
</pre></div>
</div>
<p>The tests will run as before, but the kind cluster will be left running after the tests are completed.</p>
<p>For subsequent test runs, you can run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest --kind-cluster<span class="o">=</span><span class="s2">&quot;cluster-d9971c84d44d47f382a2928c8c161faa&quot;</span> --existing-helm-namespace<span class="o">=</span><span class="s2">&quot;dagster-test-95590a&quot;</span> -s -vvv -m <span class="s2">&quot;not integration&quot;</span>
</pre></div>
</div>
<p>This will bypass cluster creation, image loading, and Helm chart installation, for much faster tests.</p>
<p>The kind cluster name and Helm namespace for this command can be found in the logs, or retrieved via the respective CLIs, using <code class="docutils literal notranslate"><span class="pre">kind</span> <span class="pre">get</span> <span class="pre">clusters</span></code> and <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">namespaces</span></code>. Note that for <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> and <code class="docutils literal notranslate"><span class="pre">helm</span></code> to work correctly with a kind cluster, you should override your kubeconfig file location with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kind get kubeconfig --name kind-test &gt; /tmp/kubeconfig
<span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/tmp/kubeconfig
</pre></div>
</div>
</div>
<div class="section" id="manual-kind-cluster-setup">
<h3>Manual kind cluster setup<a class="headerlink" href="#manual-kind-cluster-setup" title="Permalink to this headline">¶</a></h3>
<p>The test fixtures provided by <code class="docutils literal notranslate"><span class="pre">dagster-k8s</span></code> automate the process described below, but sometimes its useful to manually configure a kind cluster and load images onto it.</p>
<p>First, ensure you have a Docker image appropriate for your Python version. Run, from the root of
the repo:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./python_modules/dagster-test/dagster_test/test_project/build.sh <span class="m">3</span>.7.6 <span class="se">\</span>
    dagster.io.priv/buildkite-test-image:py37-latest
</pre></div>
</div>
<p>In the above invocation, the Python majmin version should be appropriate for your desired tests.</p>
<p>Then run the following commands to create the cluster and load the image. Note that there is no
feedback from the loading process.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kind create cluster --name kind-test
kind load docker-image --name kind-test dagster.io/dagster-docker-buildkite:py37-latest
</pre></div>
</div>
<p>If you are deploying the Helm chart with an in-cluster Postgres (rather than an external database),
and/or with dagster-celery workers (and a RabbitMQ), you’ll also want to have images present for
rabbitmq and postgresql:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>docker pull docker.io/bitnami/rabbitmq
docker pull docker.io/bitnami/postgresql

kind load docker-image --name kind-test docker.io/bitnami/rabbitmq:latest
kind load docker-image --name kind-test docker.io/bitnami/postgresql:latest
</pre></div>
</div>
<p>Then you can run pytest as follows:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pytest --kind-cluster<span class="o">=</span>kind-test
</pre></div>
</div>
</div>
</div>
<div class="section" id="faster-local-development-with-an-existing-k8s-cluster">
<h2>Faster local development (with an existing K8s cluster)<a class="headerlink" href="#faster-local-development-with-an-existing-k8s-cluster" title="Permalink to this headline">¶</a></h2>
<p>If you already have a development K8s cluster available, you can run tests on that cluster vs. running locally in <code class="docutils literal notranslate"><span class="pre">kind</span></code>.</p>
<p>For this to work, first build and deploy the test image to a registry available to your cluster. For example, with ECR:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>./python_modules/dagster-test/dagster_test/test_project/build.sh 3.7.6
docker tag dagster-docker-buildkite:latest $AWS_ACCOUNT_ID.dkr.ecr.us-west-1.amazonaws.com/dagster-k8s-tests:2020-04-21T21-04-06

aws ecr get-login --no-include-email --region us-west-1 | sh
docker push $AWS_ACCOUNT_ID.dkr.ecr.us-west-1.amazonaws.com/dagster-k8s-tests:2020-04-21T21-04-06
</pre></div>
</div>
<p>Then, you can run tests on EKS with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">DAGSTER_DOCKER_IMAGE_TAG</span><span class="o">=</span><span class="s2">&quot;2020-04-21T21-04-06&quot;</span>
<span class="n">export</span> <span class="n">DAGSTER_DOCKER_REPOSITORY</span><span class="o">=</span><span class="s2">&quot;$AWS_ACCOUNT_ID.dkr.ecr.us-west-1.amazonaws.com&quot;</span>
<span class="n">export</span> <span class="n">DAGSTER_DOCKER_IMAGE</span><span class="o">=</span><span class="s2">&quot;dagster-k8s-tests&quot;</span>

<span class="c1"># First run with --no-cleanup to leave Helm chart in place</span>
<span class="n">pytest</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">provider</span><span class="o">=</span><span class="s2">&quot;kubeconfig&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cleanup</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">vvv</span>

<span class="c1"># Subsequent runs against existing Helm chart</span>
<span class="n">pytest</span> <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">provider</span><span class="o">=</span><span class="s2">&quot;kubeconfig&quot;</span> <span class="o">--</span><span class="n">existing</span><span class="o">-</span><span class="n">helm</span><span class="o">-</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;dagster-test-&lt;some id&gt;&quot;</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">vvv</span>
</pre></div>
</div>
</div>
<div class="section" id="validating-helm-charts">
<h2>Validating Helm charts<a class="headerlink" href="#validating-helm-charts" title="Permalink to this headline">¶</a></h2>
<p>To test / validate Helm charts, you can run:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>helm install dagster --dry-run --debug helm/dagster
helm lint
</pre></div>
</div>
</div>
<div class="section" id="enabling-gcr-access-from-minikube">
<h2>Enabling GCR access from Minikube<a class="headerlink" href="#enabling-gcr-access-from-minikube" title="Permalink to this headline">¶</a></h2>
<p>To enable GCR access from Minikube:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>kubectl create secret docker-registry element-dev-key <span class="se">\</span>
    --docker-server<span class="o">=</span>https://gcr.io <span class="se">\</span>
    --docker-username<span class="o">=</span>oauth2accesstoken <span class="se">\</span>
    --docker-password<span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>gcloud auth print-access-token<span class="k">)</span><span class="s2">&quot;</span> <span class="se">\</span>
    --docker-email<span class="o">=</span>my@email.com
</pre></div>
</div>
</div>
<div class="section" id="a-note-about-pvcs">
<h2>A note about PVCs<a class="headerlink" href="#a-note-about-pvcs" title="Permalink to this headline">¶</a></h2>
<p>Both the Postgres and the RabbitMQ Helm charts will store credentials using Persistent Volume
Claims, which will outlive test invocations and calls to <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">uninstall</span></code>. These must be deleted if
you want to change credentials. To view your pvcs, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">pvc</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-redis">
<h2>Testing Redis<a class="headerlink" href="#testing-redis" title="Permalink to this headline">¶</a></h2>
<p>The Redis Helm chart installs w/ a randomly-generated password by default; turn this off:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">dagredis</span> <span class="n">stable</span><span class="o">/</span><span class="n">redis</span> <span class="o">--</span><span class="nb">set</span> <span class="n">usePassword</span><span class="o">=</span><span class="n">false</span>
</pre></div>
</div>
<p>Then, to connect to your database from outside the cluster execute the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">port</span><span class="o">-</span><span class="n">forward</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">default</span> <span class="n">svc</span><span class="o">/</span><span class="n">dagredis</span><span class="o">-</span><span class="n">master</span> <span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span>
<span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="o">-</span><span class="n">h</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">-</span><span class="n">p</span> <span class="mi">6379</span>
</pre></div>
</div>
</div>
</div>


            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            &larr;
            <a href="dagster_github.html" title="Previous document">GitHub (dagster_github)</a>
        </li>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
        <li>
            <a href="dagster_pagerduty.html" title="Next document">PagerDuty (dagster_pagerduty)</a>
            &rarr;
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>