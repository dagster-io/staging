
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dagster.core.scheduler.scheduler &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
 
<link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <h1>Source code for dagster.core.scheduler.scheduler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dagster.config</span> <span class="kn">import</span> <span class="n">Field</span>
<span class="kn">from</span> <span class="nn">dagster.config.source</span> <span class="kn">import</span> <span class="n">IntSource</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions.job</span> <span class="kn">import</span> <span class="n">JobType</span>
<span class="kn">from</span> <span class="nn">dagster.core.errors</span> <span class="kn">import</span> <span class="n">DagsterError</span>
<span class="kn">from</span> <span class="nn">dagster.core.host_representation</span> <span class="kn">import</span> <span class="n">ExternalSchedule</span>
<span class="kn">from</span> <span class="nn">dagster.core.instance</span> <span class="kn">import</span> <span class="n">DagsterInstance</span>
<span class="kn">from</span> <span class="nn">dagster.core.scheduler.job</span> <span class="kn">import</span> <span class="n">JobState</span><span class="p">,</span> <span class="n">JobStatus</span><span class="p">,</span> <span class="n">ScheduleJobData</span>
<span class="kn">from</span> <span class="nn">dagster.serdes</span> <span class="kn">import</span> <span class="n">ConfigurableClass</span>
<span class="kn">from</span> <span class="nn">dagster.seven</span> <span class="kn">import</span> <span class="n">get_current_datetime_in_utc</span><span class="p">,</span> <span class="n">get_timestamp_from_utc_datetime</span>
<span class="kn">from</span> <span class="nn">dagster.utils</span> <span class="kn">import</span> <span class="n">mkdir_p</span>


<span class="k">class</span> <span class="nc">DagsterSchedulerError</span><span class="p">(</span><span class="n">DagsterError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all Dagster Scheduler errors&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DagsterScheduleReconciliationError</span><span class="p">(</span><span class="n">DagsterError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error raised during schedule state reconcilation. During reconcilation, exceptions that are</span>
<span class="sd">    raised when trying to start or stop a schedule are collected and passed to this wrapper exception.</span>
<span class="sd">    The individual exceptions can be accessed by the `errors` property. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preamble</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span>

        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">preamble</span>
        <span class="n">error_messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_error</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
            <span class="n">error_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
            <span class="n">error_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Error </span><span class="si">{i_error}</span><span class="s2">: </span><span class="si">{error_message}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">i_error</span><span class="o">=</span><span class="n">i_error</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">error_message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_messages</span> <span class="o">=</span> <span class="n">error_messages</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DagsterScheduleReconciliationError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DagsterScheduleDoesNotExist</span><span class="p">(</span><span class="n">DagsterSchedulerError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Errors raised when ending a job for a schedule.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">SchedulerDebugInfo</span><span class="p">(</span>
    <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;SchedulerDebugInfo&quot;</span><span class="p">,</span> <span class="s2">&quot;errors scheduler_config_info scheduler_info schedule_storage&quot;</span><span class="p">)</span>
<span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">scheduler_config_info</span><span class="p">,</span> <span class="n">scheduler_info</span><span class="p">,</span> <span class="n">schedule_storage</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SchedulerDebugInfo</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">list_param</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">scheduler_config_info</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">scheduler_config_info</span><span class="p">,</span> <span class="s2">&quot;scheduler_config_info&quot;</span><span class="p">),</span>
            <span class="n">scheduler_info</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">scheduler_info</span><span class="p">,</span> <span class="s2">&quot;scheduler_info&quot;</span><span class="p">),</span>
            <span class="n">schedule_storage</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">list_param</span><span class="p">(</span><span class="n">schedule_storage</span><span class="p">,</span> <span class="s2">&quot;schedule_storage&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
        <span class="p">)</span>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../../../sections/api/apidocs/internals.html#dagster.core.scheduler.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstract base class for a scheduler. This component is responsible for interfacing with</span>
<span class="sd">    an external system such as cron to ensure scheduled repeated execution according.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_schedule_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_origin_id</span><span class="p">):</span>
        <span class="n">schedule_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">external_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schedule_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DagsterScheduleDoesNotExist</span><span class="p">(</span>
                <span class="s2">&quot;You have attempted to start the job for schedule id </span><span class="si">{id}</span><span class="s2">, but its state is not in storage.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">external_origin_id</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">schedule_state</span>

    <span class="k">def</span> <span class="nf">_create_new_schedule_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="n">schedule_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span>
            <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin</span><span class="p">(),</span>
            <span class="n">JobType</span><span class="o">.</span><span class="n">SCHEDULE</span><span class="p">,</span>
            <span class="n">JobStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">,</span>
            <span class="n">ScheduleJobData</span><span class="p">(</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">add_job_state</span><span class="p">(</span><span class="n">schedule_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schedule_state</span>

    <span class="k">def</span> <span class="nf">reconcile_scheduler_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_repository</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconcile the ExternalSchedule list from the repository and ScheduleStorage</span>
<span class="sd">        on the instance to ensure there is a 1-1 correlation between ExternalSchedule and</span>
<span class="sd">        JobStates of type JobType.SCHEDULE, where the ExternalSchedule list is the source of truth.</span>

<span class="sd">        If a new ExternalSchedule is introduced, a new JobState is added to storage with status</span>
<span class="sd">        JobStatus.STOPPED.</span>

<span class="sd">        For every previously existing ExternalSchedule (where target id is the primary key),</span>
<span class="sd">        any changes to the definition are persisted in the corresponding JobState and the status is</span>
<span class="sd">        left unchanged. The schedule is also restarted to make sure the external artifacts (such</span>
<span class="sd">        as a cron job) are up to date.</span>

<span class="sd">        For every ScheduleDefinitions that is removed, the corresponding JobState is removed from</span>
<span class="sd">        the storage and the corresponding job is ended.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">schedules_to_restart</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">external_schedule</span> <span class="ow">in</span> <span class="n">external_repository</span><span class="o">.</span><span class="n">get_external_schedules</span><span class="p">():</span>
            <span class="c1"># If a schedule already exists for schedule_def, overwrite bash script and</span>
            <span class="c1"># metadata file</span>
            <span class="n">existing_schedule_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span>
                <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_schedule_state</span><span class="p">:</span>
                <span class="n">new_timestamp</span> <span class="o">=</span> <span class="n">existing_schedule_state</span><span class="o">.</span><span class="n">job_specific_data</span><span class="o">.</span><span class="n">start_timestamp</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">new_timestamp</span> <span class="ow">and</span> <span class="n">existing_schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                    <span class="n">new_timestamp</span> <span class="o">=</span> <span class="n">get_timestamp_from_utc_datetime</span><span class="p">(</span><span class="n">get_current_datetime_in_utc</span><span class="p">())</span>

                <span class="c1"># Keep the status, update target and cron schedule</span>
                <span class="n">schedule_state</span> <span class="o">=</span> <span class="n">JobState</span><span class="p">(</span>
                    <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin</span><span class="p">(),</span>
                    <span class="n">JobType</span><span class="o">.</span><span class="n">SCHEDULE</span><span class="p">,</span>
                    <span class="n">existing_schedule_state</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">ScheduleJobData</span><span class="p">(</span>
                        <span class="n">external_schedule</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span>
                        <span class="n">new_timestamp</span><span class="p">,</span>
                        <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>

                <span class="n">instance</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span><span class="n">schedule_state</span><span class="p">)</span>
                <span class="n">schedules_to_restart</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">existing_schedule_state</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_schedule_state</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>

        <span class="c1"># Delete all existing schedules that are not in external schedules</span>
        <span class="n">external_schedule_origin_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">s</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">external_repository</span><span class="o">.</span><span class="n">get_external_schedules</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">existing_schedule_origin_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">job</span><span class="o">.</span><span class="n">job_origin_id</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">all_stored_job_state</span><span class="p">(</span>
                    <span class="n">external_repository</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="n">JobType</span><span class="o">.</span><span class="n">SCHEDULE</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">schedule_origin_ids_to_delete</span> <span class="o">=</span> <span class="n">existing_schedule_origin_ids</span> <span class="o">-</span> <span class="n">external_schedule_origin_ids</span>

        <span class="n">schedule_reconciliation_errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">schedule_state</span><span class="p">,</span> <span class="n">external_schedule</span> <span class="ow">in</span> <span class="n">schedules_to_restart</span><span class="p">:</span>
            <span class="c1"># Restart is only needed if the schedule was previously running</span>
            <span class="k">if</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">refresh_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">DagsterSchedulerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">schedule_reconciliation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stop_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">())</span>
                <span class="k">except</span> <span class="n">DagsterSchedulerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">schedule_reconciliation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">schedule_origin_id</span> <span class="ow">in</span> <span class="n">schedule_origin_ids_to_delete</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">stop_schedule_and_delete_from_storage</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">DagsterSchedulerError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">schedule_reconciliation_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">schedule_reconciliation_errors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DagsterScheduleReconciliationError</span><span class="p">(</span>
                <span class="s2">&quot;One or more errors were encountered by the Scheduler while starting or stopping schedules. &quot;</span>
                <span class="s2">&quot;Individual error messages follow:&quot;</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">=</span><span class="n">schedule_reconciliation_errors</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the status of the given schedule to `JobStatus.RUNNING` in schedule storage,</span>
<span class="sd">        then calls `start_schedule`.</span>

<span class="sd">        This should not be overridden by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            external_schedule (ExternalSchedule): The schedule to start</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="n">schedule_state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">schedule_state</span><span class="p">:</span>
            <span class="n">schedule_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_new_schedule_state</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DagsterSchedulerError</span><span class="p">(</span>
                <span class="s2">&quot;You have attempted to start schedule </span><span class="si">{name}</span><span class="s2">, but it is already running&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>
        <span class="n">started_schedule</span> <span class="o">=</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span><span class="o">.</span><span class="n">with_data</span><span class="p">(</span>
            <span class="n">ScheduleJobData</span><span class="p">(</span>
                <span class="n">external_schedule</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span>
                <span class="n">get_current_datetime_in_utc</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span><span class="n">started_schedule</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">started_schedule</span>

    <span class="k">def</span> <span class="nf">stop_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the status of the given schedule to `JobStatus.STOPPED` in schedule storage,</span>
<span class="sd">        then calls `stop_schedule`.</span>

<span class="sd">        This should not be overridden by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            schedule_origin_id (string): The id of the schedule target to stop running.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="n">schedule_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_schedule_state</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="n">stopped_schedule</span> <span class="o">=</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">)</span><span class="o">.</span><span class="n">with_data</span><span class="p">(</span>
            <span class="n">ScheduleJobData</span><span class="p">(</span>
                <span class="n">cron_schedule</span><span class="o">=</span><span class="n">schedule_state</span><span class="o">.</span><span class="n">job_specific_data</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span>
                <span class="n">scheduler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span><span class="n">stopped_schedule</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stopped_schedule</span>

    <span class="k">def</span> <span class="nf">stop_schedule_and_delete_from_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a schedule from schedule storage, then calls `stop_schedule`.</span>

<span class="sd">        This should not be overridden by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            schedule_origin_id (string): The id of the schedule target to start running.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_schedule_state</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">delete_job_state</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">schedule</span>

    <span class="k">def</span> <span class="nf">refresh_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Refresh a running schedule. This is called when user reconciles the schedule state.</span>

<span class="sd">        By default, this method will call stop_schedule and then start_schedule but can be</span>
<span class="sd">        overriden. For example, in the K8s Scheduler we patch the existing cronjob</span>
<span class="sd">        (without stopping it) to minimize downtime.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            external_schedule (ExternalSchedule): The schedule to start running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns debug information about the scheduler</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">start_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start running a schedule. This method is called by `start_schedule_and_update_storage_state`,</span>
<span class="sd">        which first updates the status of the schedule in schedule storage to `JobStatus.RUNNING`,</span>
<span class="sd">        then calls this method.</span>

<span class="sd">        For example, in the cron scheduler, this method writes a cron job to the cron tab</span>
<span class="sd">        for the given schedule.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            external_schedule (ExternalSchedule): The schedule to start running.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">stop_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop running a schedule.</span>

<span class="sd">        This method is called by</span>
<span class="sd">        1) `stop_schedule_and_update_storage_state`,</span>
<span class="sd">        which first updates the status of the schedule in schedule storage to `JobStatus.STOPPED`,</span>
<span class="sd">        then calls this method.</span>
<span class="sd">        2) `stop_schedule_and_delete_from_storage`, which deletes the schedule from schedule storage</span>
<span class="sd">        then calls this method.</span>

<span class="sd">        For example, in the cron scheduler, this method deletes the cron job for a given scheduler</span>
<span class="sd">        from the cron tab.</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            schedule_origin_id (string): The id of the schedule target to stop running.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">running_schedule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the number of jobs currently running for the given schedule. This method is used</span>
<span class="sd">        for detecting when the scheduler is out of sync with schedule storage.</span>

<span class="sd">        For example, when:</span>
<span class="sd">        - There are duplicate jobs runnning for a single schedule</span>
<span class="sd">        - There are no jobs runnning for a schedule that is set to be running</span>
<span class="sd">        - There are still jobs running for a schedule that is set to be stopped</span>

<span class="sd">        When the scheduler and schedule storage are in sync, this method should return:</span>
<span class="sd">        - 1 when a schedule is set to be running</span>
<span class="sd">        - 0 when a schedule is set to be stopped</span>

<span class="sd">        Args:</span>
<span class="sd">            instance (DagsterInstance): The current instance.</span>
<span class="sd">            schedule_origin_id (string): The id of the schedule target to return the number of jobs for</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_logs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get path to store logs for schedule</span>

<span class="sd">        Args:</span>
<span class="sd">            schedule_origin_id (string): The id of the schedule target to retrieve the log path for</span>
<span class="sd">        &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DagsterDaemonScheduler"><a class="viewcode-back" href="../../../../sections/api/apidocs/schedules-sensors.html#dagster.core.scheduler.DagsterDaemonScheduler">[docs]</a><span class="k">class</span> <span class="nc">DagsterDaemonScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">,</span> <span class="n">ConfigurableClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default scheduler implementation that submits runs from the `dagster-daemon`</span>
<span class="sd">    long-lived process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_catchup_runs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inst_data</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_catchup_runs</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_int_param</span><span class="p">(</span><span class="n">max_catchup_runs</span><span class="p">,</span> <span class="s2">&quot;max_catchup_runs&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inst_data</span> <span class="o">=</span> <span class="n">inst_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inst_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst_data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">config_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;max_catchup_runs&quot;</span><span class="p">:</span> <span class="n">Field</span><span class="p">(</span><span class="n">IntSource</span><span class="p">,</span> <span class="n">is_required</span><span class="o">=</span><span class="kc">False</span><span class="p">)}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_config_value</span><span class="p">(</span><span class="n">inst_data</span><span class="p">,</span> <span class="n">config_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DagsterDaemonScheduler</span><span class="p">(</span>
            <span class="n">inst_data</span><span class="o">=</span><span class="n">inst_data</span><span class="p">,</span> <span class="n">max_catchup_runs</span><span class="o">=</span><span class="n">config_value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_catchup_runs&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">start_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="c1"># Automatically picked up by the `dagster scheduler run` command</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">stop_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="c1"># Automatically picked up by the `dagster scheduler run` command</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">running_schedule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">wipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_get_or_create_logs_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="n">logs_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">schedules_directory</span><span class="p">(),</span> <span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">logs_directory</span><span class="p">):</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">logs_directory</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logs_directory</span>

    <span class="k">def</span> <span class="nf">get_logs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="n">logs_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_logs_directory</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logs_directory</span><span class="p">,</span> <span class="s2">&quot;scheduler.log&quot;</span><span class="p">)</span></div>
</pre></div>

            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>