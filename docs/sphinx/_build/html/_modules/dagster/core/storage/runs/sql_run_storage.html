
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dagster.core.storage.runs.sql_run_storage &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
 
<link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <h1>Source code for dagster.core.storage.runs.sql_run_storage</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">import</span> <span class="nn">sqlalchemy</span> <span class="k">as</span> <span class="nn">db</span>
<span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dagster.core.errors</span> <span class="kn">import</span> <span class="n">DagsterRunAlreadyExists</span><span class="p">,</span> <span class="n">DagsterSnapshotDoesNotExist</span>
<span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
<span class="kn">from</span> <span class="nn">dagster.core.snap</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExecutionPlanSnapshot</span><span class="p">,</span>
    <span class="n">PipelineSnapshot</span><span class="p">,</span>
    <span class="n">create_execution_plan_snapshot_id</span><span class="p">,</span>
    <span class="n">create_pipeline_snapshot_id</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.tags</span> <span class="kn">import</span> <span class="n">PARTITION_NAME_TAG</span><span class="p">,</span> <span class="n">PARTITION_SET_TAG</span><span class="p">,</span> <span class="n">ROOT_RUN_ID_TAG</span>
<span class="kn">from</span> <span class="nn">dagster.serdes</span> <span class="kn">import</span> <span class="n">deserialize_json_to_dagster_namedtuple</span><span class="p">,</span> <span class="n">serialize_dagster_namedtuple</span>
<span class="kn">from</span> <span class="nn">dagster.seven</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>
<span class="kn">from</span> <span class="nn">dagster.utils</span> <span class="kn">import</span> <span class="n">merge_dicts</span><span class="p">,</span> <span class="n">utc_datetime_from_timestamp</span>

<span class="kn">from</span> <span class="nn">..pipeline_run</span> <span class="kn">import</span> <span class="n">PipelineRun</span><span class="p">,</span> <span class="n">PipelineRunStatus</span><span class="p">,</span> <span class="n">PipelineRunsFilter</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">RunStorage</span>
<span class="kn">from</span> <span class="nn">.migration</span> <span class="kn">import</span> <span class="n">RUN_DATA_MIGRATIONS</span><span class="p">,</span> <span class="n">RUN_PARTITIONS</span>
<span class="kn">from</span> <span class="nn">.schema</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DaemonHeartbeatsTable</span><span class="p">,</span>
    <span class="n">RunTagsTable</span><span class="p">,</span>
    <span class="n">RunsTable</span><span class="p">,</span>
    <span class="n">SecondaryIndexMigrationTable</span><span class="p">,</span>
    <span class="n">SnapshotsTable</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">class</span> <span class="nc">SnapshotType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PIPELINE</span> <span class="o">=</span> <span class="s2">&quot;PIPELINE&quot;</span>
    <span class="n">EXECUTION_PLAN</span> <span class="o">=</span> <span class="s2">&quot;EXECUTION_PLAN&quot;</span>


<div class="viewcode-block" id="SqlRunStorage"><a class="viewcode-back" href="../../../../../sections/api/apidocs/internals.html#dagster.core.storage.runs.SqlRunStorage">[docs]</a><span class="k">class</span> <span class="nc">SqlRunStorage</span><span class="p">(</span><span class="n">RunStorage</span><span class="p">):</span>  <span class="c1"># pylint: disable=no-init</span>
    <span class="sd">&quot;&quot;&quot;Base class for SQL based run storages</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context manager yielding a sqlalchemy.engine.Connection.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method should perform any schema or data migrations necessary to bring an</span>
<span class="sd">        out-of-date instance of the storage up to date.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">fetchall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">result_proxy</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">result_proxy</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="n">result_proxy</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">fetchone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">result_proxy</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">result_proxy</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">result_proxy</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">add_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_pipeline_snapshot</span><span class="p">(</span>
            <span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">DagsterSnapshotDoesNotExist</span><span class="p">(</span>
                <span class="s2">&quot;Snapshot </span><span class="si">{ss_id}</span><span class="s2"> does not exist in run storage&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ss_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">has_tags</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">partition</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PARTITION_NAME_TAG</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_tags</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">partition_set</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PARTITION_SET_TAG</span><span class="p">)</span> <span class="k">if</span> <span class="n">has_tags</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">runs_insert</span> <span class="o">=</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">run_body</span><span class="o">=</span><span class="n">serialize_dagster_namedtuple</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">),</span>
                    <span class="n">snapshot_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span>
                    <span class="n">partition</span><span class="o">=</span><span class="n">partition</span><span class="p">,</span>
                    <span class="n">partition_set</span><span class="o">=</span><span class="n">partition_set</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">runs_insert</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">db</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DagsterRunAlreadyExists</span> <span class="kn">from</span> <span class="nn">exc</span>

            <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="p">[</span>
                        <span class="nb">dict</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">],</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">pipeline_run</span>

    <span class="k">def</span> <span class="nf">handle_run_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">DagsterEvent</span><span class="p">)</span>

        <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_START</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">STARTED</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_SUCCESS</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_FAILURE</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_INIT_FAILURE</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">FAILURE</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_ENQUEUED</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">QUEUED</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_STARTING</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">STARTING</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_CANCELING</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">CANCELING</span><span class="p">,</span>
            <span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_CANCELED</span><span class="p">:</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">CANCELED</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
            <span class="c1"># TODO log?</span>
            <span class="k">return</span>

        <span class="n">new_pipeline_status</span> <span class="o">=</span> <span class="n">lookup</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">]</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">RunsTable</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">new_pipeline_status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">run_body</span><span class="o">=</span><span class="n">serialize_dagster_namedtuple</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">new_pipeline_status</span><span class="p">)),</span>
                    <span class="n">update_timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_row_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deserialize_json_to_dagster_namedtuple</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_rows_to_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_to_run</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_cursor_limit_to_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper function to deal with cursor/limit pagination args &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">cursor</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">cursor_query</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_add_filters_to_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">,</span> <span class="n">PipelineRunsFilter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">run_ids</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">run_ids</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">pipeline_name</span> <span class="o">==</span> <span class="n">filters</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">statuses</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="n">status</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">statuses</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">(</span>
                        <span class="n">db</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">key</span><span class="p">,</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_body</span><span class="p">,</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">having</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">tags</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="o">==</span> <span class="n">filters</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">_runs_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">filters</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span>
            <span class="n">filters</span><span class="p">,</span> <span class="s2">&quot;filters&quot;</span><span class="p">,</span> <span class="n">PipelineRunsFilter</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">PipelineRunsFilter</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="s2">&quot;cursor&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_int_param</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;run_body&quot;</span><span class="p">]</span>

        <span class="n">base_query_columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

        <span class="c1"># If we have a tags filter, then we need to select from a joined table</span>
        <span class="k">if</span> <span class="n">filters</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">base_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">base_query_columns</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">RunsTable</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="p">,</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">base_query_columns</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">RunsTable</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_filters_to_query</span><span class="p">(</span><span class="n">base_query</span><span class="p">,</span> <span class="n">filters</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_cursor_limit_to_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">get_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs_query</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows_to_runs</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_runs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">subquery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs_query</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;subquery&quot;</span><span class="p">)</span>

        <span class="c1"># We use an alias here because Postgres requires subqueries to be</span>
        <span class="c1"># aliased.</span>
        <span class="n">subquery</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;subquery&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()])</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">subquery</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">def</span> <span class="nf">get_run_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a run by its id.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_id (str): The id of the run</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[PipelineRun]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_body</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deserialize_json_to_dagster_namedtuple</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">(</span>
            <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">()]),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">add_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">dict_param</span><span class="p">(</span><span class="n">new_tags</span><span class="p">,</span> <span class="s2">&quot;new_tags&quot;</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">value_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
        <span class="n">current_tags</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">tags</span> <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">tags</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">all_tags</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">current_tags</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">)</span>
        <span class="n">partition</span> <span class="o">=</span> <span class="n">all_tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PARTITION_NAME_TAG</span><span class="p">)</span>
        <span class="n">partition_set</span> <span class="o">=</span> <span class="n">all_tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PARTITION_SET_TAG</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">RunsTable</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span>
                    <span class="n">run_body</span><span class="o">=</span><span class="n">serialize_dagster_namedtuple</span><span class="p">(</span>
                        <span class="n">run</span><span class="o">.</span><span class="n">with_tags</span><span class="p">(</span><span class="n">merge_dicts</span><span class="p">(</span><span class="n">current_tags</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">))</span>
                    <span class="p">),</span>
                    <span class="n">partition</span><span class="o">=</span><span class="n">partition</span><span class="p">,</span>
                    <span class="n">partition_set</span><span class="o">=</span><span class="n">partition_set</span><span class="p">,</span>
                    <span class="n">update_timestamp</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">current_tags_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">new_tags_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_tags</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">existing_tags</span> <span class="o">=</span> <span class="n">current_tags_set</span> <span class="o">&amp;</span> <span class="n">new_tags_set</span>
            <span class="n">added_tags</span> <span class="o">=</span> <span class="n">new_tags_set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">existing_tags</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">existing_tags</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">tag</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">new_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">added_tags</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">new_tags</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">added_tags</span><span class="p">],</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_run</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># find root_run</span>
        <span class="n">root_run_id</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">root_run_id</span> <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">root_run_id</span> <span class="k">else</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span>
        <span class="n">root_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">root_run_id</span><span class="p">)</span>

        <span class="c1"># root_run_id to run_id 1:1 mapping</span>
        <span class="n">root_to_run</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;root_run_id&quot;</span><span class="p">),</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">and_</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">ROOT_RUN_ID_TAG</span><span class="p">,</span> <span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">root_run_id</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;root_to_run&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># get run group</span>
        <span class="n">run_group_query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_body</span><span class="p">])</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">root_to_run</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">RunsTable</span><span class="p">,</span> <span class="n">root_to_run</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;run_group&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">run_group_query</span><span class="p">)</span>
            <span class="n">run_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows_to_runs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">root_run_id</span><span class="p">,</span> <span class="p">[</span><span class="n">root_run</span><span class="p">]</span> <span class="o">+</span> <span class="n">run_group</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># The runs that would be returned by calling RunStorage.get_runs with the same arguments</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs_query</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;run_body&quot;</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;runs&quot;</span><span class="p">)</span>

        <span class="c1"># Gets us the run_id and associated root_run_id for every run in storage that is a</span>
        <span class="c1"># descendant run of some root</span>
        <span class="c1">#</span>
        <span class="c1"># pseudosql:</span>
        <span class="c1">#   with all_descendant_runs as (</span>
        <span class="c1">#     select *</span>
        <span class="c1">#     from run_tags</span>
        <span class="c1">#     where key = @ROOT_RUN_ID_TAG</span>
        <span class="c1">#   )</span>

        <span class="n">all_descendant_runs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunTagsTable</span><span class="p">])</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">ROOT_RUN_ID_TAG</span><span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;all_descendant_runs&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Augment the runs in our query, for those runs that are the descendant of some root run,</span>
        <span class="c1"># with the root_run_id</span>
        <span class="c1">#</span>
        <span class="c1"># pseudosql:</span>
        <span class="c1">#</span>
        <span class="c1">#   with runs_augmented as (</span>
        <span class="c1">#     select</span>
        <span class="c1">#       runs.run_id as run_id,</span>
        <span class="c1">#       all_descendant_runs.value as root_run_id</span>
        <span class="c1">#     from runs</span>
        <span class="c1">#     left outer join all_descendant_runs</span>
        <span class="c1">#       on all_descendant_runs.run_id = runs.run_id</span>
        <span class="c1">#   )</span>

        <span class="n">runs_augmented</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span><span class="n">runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">),</span> <span class="n">all_descendant_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;root_run_id&quot;</span><span class="p">),]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">runs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">all_descendant_runs</span><span class="p">,</span>
                    <span class="n">all_descendant_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;runs_augmented&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Get all the runs our query will return. This includes runs as well as their root runs.</span>
        <span class="c1">#</span>
        <span class="c1"># pseudosql:</span>
        <span class="c1">#</span>
        <span class="c1">#    with runs_and_root_runs as (</span>
        <span class="c1">#      select runs.run_id as run_id</span>
        <span class="c1">#      from runs, runs_augmented</span>
        <span class="c1">#      where</span>
        <span class="c1">#        runs.run_id = runs_augmented.run_id or</span>
        <span class="c1">#        runs.run_id = runs_augmented.root_run_id</span>
        <span class="c1">#    )</span>

        <span class="n">runs_and_root_runs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;run_id&quot;</span><span class="p">)])</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">runs_augmented</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">db</span><span class="o">.</span><span class="n">or_</span><span class="p">(</span>
                    <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">runs_augmented</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">runs_augmented</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">root_run_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">distinct</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;runs_and_root_runs&quot;</span><span class="p">)</span>

        <span class="c1"># We count the descendants of all of the runs in our query that are roots so that</span>
        <span class="c1"># we can accurately display when a root run has more descendants than are returned by this</span>
        <span class="c1"># query and afford a drill-down. This might be an unnecessary complication, but the</span>
        <span class="c1"># alternative isn&#39;t obvious -- we could go and fetch *all* the runs in any group that we&#39;re</span>
        <span class="c1"># going to return in this query, and then append those.</span>
        <span class="c1">#</span>
        <span class="c1"># pseudosql:</span>
        <span class="c1">#</span>
        <span class="c1">#    select runs.run_body, count(all_descendant_runs.id) as child_counts</span>
        <span class="c1">#    from runs</span>
        <span class="c1">#    join runs_and_root_runs on runs.run_id = runs_and_root_runs.run_id</span>
        <span class="c1">#    left outer join all_descendant_runs</span>
        <span class="c1">#      on all_descendant_runs.value = runs_and_root_runs.run_id</span>
        <span class="c1">#    group by runs.run_body</span>
        <span class="c1">#    order by child_counts desc</span>

        <span class="n">runs_and_root_runs_with_descendant_counts</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_body</span><span class="p">,</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">all_descendant_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;child_counts&quot;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select_from</span><span class="p">(</span>
                <span class="n">RunsTable</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">runs_and_root_runs</span><span class="p">,</span> <span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">runs_and_root_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span>
                <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">all_descendant_runs</span><span class="p">,</span>
                    <span class="n">all_descendant_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">runs_and_root_runs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
                    <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_body</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;child_counts&quot;</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">runs_and_root_runs_with_descendant_counts</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># Postprocess: descendant runs get aggregated with their roots</span>
        <span class="n">run_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;runs&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">run_body</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_body</span><span class="p">,)</span>
            <span class="n">pipeline_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_to_run</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">root_run_id</span> <span class="o">=</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">get_root_run_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">root_run_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">run_groups</span><span class="p">[</span><span class="n">root_run_id</span><span class="p">][</span><span class="s2">&quot;runs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run_groups</span><span class="p">[</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">][</span><span class="s2">&quot;runs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">)</span>
                <span class="n">run_groups</span><span class="p">[</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">][</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">run_groups</span>

    <span class="k">def</span> <span class="nf">has_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">delete_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="s2">&quot;run_id&quot;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">RunsTable</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">run_id</span> <span class="o">==</span> <span class="n">run_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_snapshot_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span> <span class="s2">&quot;pipeline_snapshot_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_snapshot_id</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_snapshot</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_snapshot</span><span class="p">,</span> <span class="s2">&quot;pipeline_snapshot&quot;</span><span class="p">,</span> <span class="n">PipelineSnapshot</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_snapshot</span><span class="p">(</span>
            <span class="n">snapshot_id</span><span class="o">=</span><span class="n">create_pipeline_snapshot_id</span><span class="p">(</span><span class="n">pipeline_snapshot</span><span class="p">),</span>
            <span class="n">snapshot_obj</span><span class="o">=</span><span class="n">pipeline_snapshot</span><span class="p">,</span>
            <span class="n">snapshot_type</span><span class="o">=</span><span class="n">SnapshotType</span><span class="o">.</span><span class="n">PIPELINE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_snapshot_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span> <span class="s2">&quot;pipeline_snapshot_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_execution_plan_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_plan_snapshot_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span><span class="p">,</span> <span class="s2">&quot;execution_plan_snapshot_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_execution_plan_snapshot</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_execution_plan_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_plan_snapshot</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="p">,</span> <span class="s2">&quot;execution_plan_snapshot&quot;</span><span class="p">,</span> <span class="n">ExecutionPlanSnapshot</span><span class="p">)</span>
        <span class="n">execution_plan_snapshot_id</span> <span class="o">=</span> <span class="n">create_execution_plan_snapshot_id</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_snapshot</span><span class="p">(</span>
            <span class="n">snapshot_id</span><span class="o">=</span><span class="n">execution_plan_snapshot_id</span><span class="p">,</span>
            <span class="n">snapshot_obj</span><span class="o">=</span><span class="n">execution_plan_snapshot</span><span class="p">,</span>
            <span class="n">snapshot_type</span><span class="o">=</span><span class="n">SnapshotType</span><span class="o">.</span><span class="n">EXECUTION_PLAN</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_execution_plan_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_plan_snapshot_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span><span class="p">,</span> <span class="s2">&quot;execution_plan_snapshot_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_snapshot</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">snapshot_obj</span><span class="p">,</span> <span class="n">snapshot_type</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">,</span> <span class="s2">&quot;snapshot_id&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">not_none_param</span><span class="p">(</span><span class="n">snapshot_obj</span><span class="p">,</span> <span class="s2">&quot;snapshot_obj&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">snapshot_type</span><span class="p">,</span> <span class="s2">&quot;snapshot_type&quot;</span><span class="p">,</span> <span class="n">SnapshotType</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">snapshot_insert</span> <span class="o">=</span> <span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                <span class="n">snapshot_id</span><span class="o">=</span><span class="n">snapshot_id</span><span class="p">,</span>
                <span class="n">snapshot_body</span><span class="o">=</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span>
                    <span class="n">serialize_dagster_namedtuple</span><span class="p">(</span><span class="n">snapshot_obj</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">snapshot_type</span><span class="o">=</span><span class="n">snapshot_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">snapshot_insert</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">snapshot_id</span>

    <span class="k">def</span> <span class="nf">_has_snapshot_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">snapshot_id</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="o">==</span> <span class="n">snapshot_id</span>
        <span class="p">)</span>

        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchone</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">snapshot_body</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">snapshot_id</span> <span class="o">==</span> <span class="n">snapshot_id</span>
        <span class="p">)</span>

        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchone</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">defensively_unpack_pipeline_snapshot_query</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span> <span class="k">if</span> <span class="n">row</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_get_partition_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_set_name</span><span class="p">,</span> <span class="n">partition_name</span><span class="p">):</span>
        <span class="c1"># utility method to help test reads off of the partition column</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_built_index</span><span class="p">(</span><span class="n">RUN_PARTITIONS</span><span class="p">):</span>
            <span class="c1"># query by tags</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_runs</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">PipelineRunsFilter</span><span class="p">(</span>
                    <span class="n">tags</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">PARTITION_SET_TAG</span><span class="p">:</span> <span class="n">partition_set_name</span><span class="p">,</span>
                        <span class="n">PARTITION_NAME_TAG</span><span class="p">:</span> <span class="n">partition_name</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_runs_query</span><span class="p">()</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">partition</span> <span class="o">==</span> <span class="n">partition_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">partition_set</span> <span class="o">==</span> <span class="n">partition_set_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rows_to_runs</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

    <span class="c1"># Tracking data migrations over secondary indexes</span>

    <span class="k">def</span> <span class="nf">build_missing_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">force_rebuild_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">migration_name</span><span class="p">,</span> <span class="n">migration_fn</span> <span class="ow">in</span> <span class="n">RUN_DATA_MIGRATIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_built_index</span><span class="p">(</span><span class="n">migration_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force_rebuild_all</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">print_fn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting data migration: </span><span class="si">{</span><span class="n">migration_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">migration_fn</span><span class="p">()(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mark_index_built</span><span class="p">(</span><span class="n">migration_name</span><span class="p">)</span>
            <span class="n">print_fn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished data migration: </span><span class="si">{</span><span class="n">migration_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_built_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration_name</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SecondaryIndexMigrationTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">migration_name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SecondaryIndexMigrationTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">migration_completed</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">mark_index_built</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration_name</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">SecondaryIndexMigrationTable</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
            <span class="n">name</span><span class="o">=</span><span class="n">migration_name</span><span class="p">,</span> <span class="n">migration_completed</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">db</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">SecondaryIndexMigrationTable</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SecondaryIndexMigrationTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">migration_name</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">migration_completed</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
                <span class="p">)</span>

    <span class="c1"># Daemon heartbeats</span>

    <span class="k">def</span> <span class="nf">add_daemon_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daemon_heartbeat</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

            <span class="c1"># insert, or update if already present</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">utc_datetime_from_timestamp</span><span class="p">(</span><span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">timestamp</span><span class="p">),</span>
                        <span class="n">daemon_type</span><span class="o">=</span><span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">daemon_type</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">daemon_id</span><span class="o">=</span><span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">daemon_id</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">serialize_dagster_namedtuple</span><span class="p">(</span><span class="n">daemon_heartbeat</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">db</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">IntegrityError</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">daemon_type</span> <span class="o">==</span> <span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">daemon_type</span><span class="o">.</span><span class="n">value</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
                        <span class="n">timestamp</span><span class="o">=</span><span class="n">utc_datetime_from_timestamp</span><span class="p">(</span><span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">timestamp</span><span class="p">),</span>
                        <span class="n">daemon_id</span><span class="o">=</span><span class="n">daemon_heartbeat</span><span class="o">.</span><span class="n">daemon_id</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">serialize_dagster_namedtuple</span><span class="p">(</span><span class="n">daemon_heartbeat</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_daemon_heartbeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="n">heartbeats</span> <span class="o">=</span> <span class="p">[</span><span class="n">deserialize_json_to_dagster_namedtuple</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">heartbeat</span><span class="o">.</span><span class="n">daemon_type</span><span class="p">:</span> <span class="n">heartbeat</span> <span class="k">for</span> <span class="n">heartbeat</span> <span class="ow">in</span> <span class="n">heartbeats</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">wipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears the run storage.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># https://stackoverflow.com/a/54386260/324449</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">RunsTable</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">RunTagsTable</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SnapshotsTable</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span>

    <span class="k">def</span> <span class="nf">wipe_daemon_heartbeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="c1"># https://stackoverflow.com/a/54386260/324449</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">DaemonHeartbeatsTable</span><span class="o">.</span><span class="n">delete</span><span class="p">())</span>  <span class="c1"># pylint: disable=no-value-for-parameter</span></div>


<span class="n">GET_PIPELINE_SNAPSHOT_QUERY_ID</span> <span class="o">=</span> <span class="s2">&quot;get-pipeline-snapshot&quot;</span>


<span class="k">def</span> <span class="nf">defensively_unpack_pipeline_snapshot_query</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="c1"># no checking here because sqlalchemy returns a special</span>
    <span class="c1"># row proxy and don&#39;t want to instance check on an internal</span>
    <span class="c1"># implementation detail</span>

    <span class="k">def</span> <span class="nf">_warn</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;get-pipeline-snapshot: </span><span class="si">{msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;First entry in row is not a binary type.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">uncompressed_bytes</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">zlib</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Could not decompress bytes stored in snapshot table.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">decoded_str</span> <span class="o">=</span> <span class="n">uncompressed_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Could not unicode decode decompressed bytes stored in snapshot table.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">deserialize_json_to_dagster_namedtuple</span><span class="p">(</span><span class="n">decoded_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">_warn</span><span class="p">(</span><span class="s2">&quot;Could not parse json in snapshot table.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>

            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>