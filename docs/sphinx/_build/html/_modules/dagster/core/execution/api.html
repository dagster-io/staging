
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dagster.core.execution.api &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
 
<link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <h1>Source code for dagster.core.execution.api</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">FrozenSet</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions</span> <span class="kn">import</span> <span class="n">IPipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions.pipeline</span> <span class="kn">import</span> <span class="n">PipelineSubsetDefinition</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions.pipeline_base</span> <span class="kn">import</span> <span class="n">InMemoryPipeline</span>
<span class="kn">from</span> <span class="nn">dagster.core.errors</span> <span class="kn">import</span> <span class="n">DagsterExecutionInterruptedError</span><span class="p">,</span> <span class="n">DagsterInvariantViolationError</span>
<span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">DagsterEvent</span>
<span class="kn">from</span> <span class="nn">dagster.core.execution.context.system</span> <span class="kn">import</span> <span class="n">SystemPipelineExecutionContext</span>
<span class="kn">from</span> <span class="nn">dagster.core.execution.plan.execute_plan</span> <span class="kn">import</span> <span class="n">inner_plan_execution_iterator</span>
<span class="kn">from</span> <span class="nn">dagster.core.execution.plan.plan</span> <span class="kn">import</span> <span class="n">ExecutionPlan</span>
<span class="kn">from</span> <span class="nn">dagster.core.execution.resolve_versions</span> <span class="kn">import</span> <span class="n">resolve_memoized_execution_plan</span>
<span class="kn">from</span> <span class="nn">dagster.core.execution.retries</span> <span class="kn">import</span> <span class="n">Retries</span>
<span class="kn">from</span> <span class="nn">dagster.core.instance</span> <span class="kn">import</span> <span class="n">DagsterInstance</span><span class="p">,</span> <span class="n">is_memoized_run</span>
<span class="kn">from</span> <span class="nn">dagster.core.selector</span> <span class="kn">import</span> <span class="n">parse_items_from_selection</span><span class="p">,</span> <span class="n">parse_step_selection</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.mem_io_manager</span> <span class="kn">import</span> <span class="n">InMemoryIOManager</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.pipeline_run</span> <span class="kn">import</span> <span class="n">PipelineRun</span><span class="p">,</span> <span class="n">PipelineRunStatus</span>
<span class="kn">from</span> <span class="nn">dagster.core.system_config.objects</span> <span class="kn">import</span> <span class="n">EnvironmentConfig</span>
<span class="kn">from</span> <span class="nn">dagster.core.telemetry</span> <span class="kn">import</span> <span class="n">log_repo_stats</span><span class="p">,</span> <span class="n">telemetry_wrapper</span>
<span class="kn">from</span> <span class="nn">dagster.core.utils</span> <span class="kn">import</span> <span class="n">str_format_set</span>
<span class="kn">from</span> <span class="nn">dagster.utils</span> <span class="kn">import</span> <span class="n">merge_dicts</span>
<span class="kn">from</span> <span class="nn">dagster.utils.error</span> <span class="kn">import</span> <span class="n">serializable_error_info_from_exc_info</span>
<span class="kn">from</span> <span class="nn">dagster.utils.interrupts</span> <span class="kn">import</span> <span class="n">capture_interrupts</span>

<span class="kn">from</span> <span class="nn">.context_creation_pipeline</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ExecutionContextManager</span><span class="p">,</span>
    <span class="n">PipelineExecutionContextManager</span><span class="p">,</span>
    <span class="n">PlanExecutionContextManager</span><span class="p">,</span>
    <span class="n">scoped_pipeline_context</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.results</span> <span class="kn">import</span> <span class="n">PipelineExecutionResult</span>

<span class="c1">## Brief guide to the execution APIs</span>
<span class="c1"># | function name               | operates over      | sync  | supports    | creates new PipelineRun |</span>
<span class="c1"># |                             |                    |       | reexecution | in instance             |</span>
<span class="c1"># | --------------------------- | ------------------ | ----- | ----------- | ----------------------- |</span>
<span class="c1"># | execute_pipeline_iterator   | IPipeline          | async | no          | yes                     |</span>
<span class="c1"># | execute_pipeline            | IPipeline          | sync  | no          | yes                     |</span>
<span class="c1"># | execute_run_iterator        | PipelineRun        | async | (1)         | no                      |</span>
<span class="c1"># | execute_run                 | PipelineRun        | sync  | (1)         | no                      |</span>
<span class="c1"># | execute_plan_iterator       | ExecutionPlan      | async | (2)         | no                      |</span>
<span class="c1"># | execute_plan                | ExecutionPlan      | sync  | (2)         | no                      |</span>
<span class="c1"># | reexecute_pipeline          | IPipeline          | sync  | yes         | yes                     |</span>
<span class="c1"># | reexecute_pipeline_iterator | IPipeline          | async | yes         | yes                     |</span>
<span class="c1">#</span>
<span class="c1"># Notes on reexecution support:</span>
<span class="c1"># (1) The appropriate bits must be set on the PipelineRun passed to this function. Specifically,</span>
<span class="c1">#     parent_run_id and root_run_id must be set and consistent, and if a solids_to_execute or</span>
<span class="c1">#     step_keys_to_execute are set they must be consistent with the parent and root runs.</span>
<span class="c1"># (2) As for (1), but the ExecutionPlan passed must also agree in all relevant bits.</span>


<span class="k">def</span> <span class="nf">execute_run_iterator</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">IPipeline</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">:</span> <span class="n">PipelineRun</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">CANCELED</span><span class="p">:</span>
        <span class="c1"># This can happen if the run was force-terminated while it was starting</span>
        <span class="k">def</span> <span class="nf">gen_execute_on_cancel</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">instance</span><span class="o">.</span><span class="n">report_engine_event</span><span class="p">(</span>
                <span class="s2">&quot;Not starting execution since the run was canceled before execution could start&quot;</span><span class="p">,</span>
                <span class="n">pipeline_run</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">gen_execute_on_cancel</span><span class="p">()</span>

    <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
        <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">NOT_STARTED</span>
        <span class="ow">or</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">STARTING</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Pipeline run </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) in state </span><span class="si">{}</span><span class="s2">, expected NOT_STARTED or STARTING&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">:</span>
        <span class="n">pipeline_def</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="n">PipelineSubsetDefinition</span><span class="p">):</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span> <span class="o">==</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
                <span class="s2">&quot;Cannot execute PipelineRun with solids_to_execute </span><span class="si">{solids_to_execute}</span><span class="s2"> that conflicts &quot;</span>
                <span class="s2">&quot;with pipeline subset </span><span class="si">{pipeline_solids_to_execute}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pipeline_solids_to_execute</span><span class="o">=</span><span class="n">str_format_set</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">),</span>
                    <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">str_format_set</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># when `execute_run_iterator` is directly called, the sub pipeline hasn&#39;t been created</span>
            <span class="c1"># note that when we receive the solids to execute via PipelineRun, it won&#39;t support</span>
            <span class="c1"># solid selection query syntax</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">subset_for_execution_from_existing_pipeline</span><span class="p">(</span>
                <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span>
            <span class="p">)</span>
    <span class="n">execution_plan</span> <span class="o">=</span> <span class="n">create_execution_plan</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
        <span class="n">_ExecuteRunWithPlanIterable</span><span class="p">(</span>
            <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
            <span class="n">iterator</span><span class="o">=</span><span class="n">_pipeline_execution_iterator</span><span class="p">,</span>
            <span class="n">execution_context_manager</span><span class="o">=</span><span class="n">PipelineExecutionContextManager</span><span class="p">(</span>
                <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
                <span class="n">pipeline_run</span><span class="o">=</span><span class="n">pipeline_run</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                <span class="n">run_config</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">execute_run</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">IPipeline</span><span class="p">,</span>
    <span class="n">pipeline_run</span><span class="p">:</span> <span class="n">PipelineRun</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineExecutionResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Executes an existing pipeline run synchronously.</span>

<span class="sd">    Synchronous version of execute_run_iterator.</span>

<span class="sd">    Args:</span>
<span class="sd">        pipeline (IPipeline): The pipeline to execute.</span>
<span class="sd">        pipeline_run (PipelineRun): The run to execute</span>
<span class="sd">        instance (DagsterInstance): The instance in which the run has been created.</span>
<span class="sd">        raise_on_error (Optional[bool]): Whether or not to raise exceptions when they occur.</span>
<span class="sd">            Defaults to ``False``.</span>

<span class="sd">    Returns:</span>
<span class="sd">        PipelineExecutionResult: The result of the execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
            <span class="s2">&quot;execute_run requires an IPipeline but received a PipelineDefinition &quot;</span>
            <span class="s2">&quot;directly instead. To support hand-off to other processes provide a &quot;</span>
            <span class="s2">&quot;ReconstructablePipeline which can be done using reconstructable(). For in &quot;</span>
            <span class="s2">&quot;process only execution you can use InMemoryPipeline.&quot;</span>
        <span class="p">)</span>

    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">CANCELED</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Not starting execution since the run was canceled before execution could start&quot;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">report_engine_event</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
        <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">NOT_STARTED</span>
        <span class="ow">or</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">STARTING</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Pipeline run </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) in state </span><span class="si">{}</span><span class="s2">, expected NOT_STARTED or STARTING&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">status</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">pipeline_def</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="n">PipelineSubsetDefinition</span><span class="p">):</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span> <span class="o">==</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
                <span class="s2">&quot;Cannot execute PipelineRun with solids_to_execute </span><span class="si">{solids_to_execute}</span><span class="s2"> that &quot;</span>
                <span class="s2">&quot;conflicts with pipeline subset </span><span class="si">{pipeline_solids_to_execute}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">pipeline_solids_to_execute</span><span class="o">=</span><span class="n">str_format_set</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">),</span>
                    <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">str_format_set</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">),</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># when `execute_run` is directly called, the sub pipeline hasn&#39;t been created</span>
            <span class="c1"># note that when we receive the solids to execute via PipelineRun, it won&#39;t support</span>
            <span class="c1"># solid selection query syntax</span>
            <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">subset_for_execution_from_existing_pipeline</span><span class="p">(</span>
                <span class="n">pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span>
            <span class="p">)</span>

    <span class="n">execution_plan</span> <span class="o">=</span> <span class="n">create_execution_plan</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_memoized_run</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">tags</span><span class="p">):</span>
        <span class="n">execution_plan</span> <span class="o">=</span> <span class="n">resolve_memoized_execution_plan</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">)</span>

    <span class="n">_execute_run_iterable</span> <span class="o">=</span> <span class="n">_ExecuteRunWithPlanIterable</span><span class="p">(</span>
        <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
        <span class="n">iterator</span><span class="o">=</span><span class="n">_pipeline_execution_iterator</span><span class="p">,</span>
        <span class="n">execution_context_manager</span><span class="o">=</span><span class="n">PipelineExecutionContextManager</span><span class="p">(</span>
            <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
            <span class="n">pipeline_run</span><span class="o">=</span><span class="n">pipeline_run</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">event_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_execute_run_iterable</span><span class="p">)</span>
    <span class="n">pipeline_context</span> <span class="o">=</span> <span class="n">_execute_run_iterable</span><span class="o">.</span><span class="n">pipeline_context</span>

    <span class="c1"># workaround for mem_io_manager to work in reconstruct_context, e.g. result.result_for_solid</span>
    <span class="c1"># in-memory values dict will get lost when the resource is re-initiated in reconstruct_context</span>
    <span class="c1"># so instead of re-initiating every single resource, we pass the resource instances to</span>
    <span class="c1"># reconstruct_context directly to avoid re-building from resource def.</span>
    <span class="n">resource_instances_to_override</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">pipeline_context</span><span class="p">:</span>  <span class="c1"># None if we have a pipeline failure</span>
        <span class="k">for</span> <span class="p">(</span>
            <span class="n">key</span><span class="p">,</span>
            <span class="n">resource_instance</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">pipeline_context</span><span class="o">.</span><span class="n">scoped_resources_builder</span><span class="o">.</span><span class="n">resource_instance_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resource_instance</span><span class="p">,</span> <span class="n">InMemoryIOManager</span><span class="p">):</span>
                <span class="n">resource_instances_to_override</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_instance</span>

    <span class="k">return</span> <span class="n">PipelineExecutionResult</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(),</span>
        <span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="n">event_list</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">hardcoded_resources_arg</span><span class="p">:</span> <span class="n">scoped_pipeline_context</span><span class="p">(</span>
            <span class="n">execution_plan</span><span class="p">,</span>
            <span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">pipeline_run</span><span class="p">,</span>
            <span class="n">instance</span><span class="p">,</span>
            <span class="n">intermediate_storage</span><span class="o">=</span><span class="n">pipeline_context</span><span class="o">.</span><span class="n">intermediate_storage</span><span class="p">,</span>
            <span class="n">resource_instances_to_override</span><span class="o">=</span><span class="n">hardcoded_resources_arg</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">resource_instances_to_override</span><span class="o">=</span><span class="n">resource_instances_to_override</span><span class="p">,</span>
    <span class="p">)</span>


<div class="viewcode-block" id="execute_pipeline_iterator"><a class="viewcode-back" href="../../../../sections/api/apidocs/execution.html#dagster.execute_pipeline_iterator">[docs]</a><span class="k">def</span> <span class="nf">execute_pipeline_iterator</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PipelineDefinition</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">],</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">solid_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DagsterInstance</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Execute a pipeline iteratively.</span>

<span class="sd">    Rather than package up the result of running a pipeline into a single object, like</span>
<span class="sd">    :py:func:`execute_pipeline`, this function yields the stream of events resulting from pipeline</span>
<span class="sd">    execution.</span>

<span class="sd">    This is intended to allow the caller to handle these events on a streaming basis in whatever</span>
<span class="sd">    way is appropriate.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        pipeline (Union[IPipeline, PipelineDefinition]): The pipeline to execute.</span>
<span class="sd">        run_config (Optional[dict]): The environment configuration that parametrizes this run,</span>
<span class="sd">            as a dict.</span>
<span class="sd">        mode (Optional[str]): The name of the pipeline mode to use. You may not set both ``mode``</span>
<span class="sd">            and ``preset``.</span>
<span class="sd">        preset (Optional[str]): The name of the pipeline preset to use. You may not set both</span>
<span class="sd">            ``mode`` and ``preset``.</span>
<span class="sd">        tags (Optional[Dict[str, Any]]): Arbitrary key-value pairs that will be added to pipeline</span>
<span class="sd">            logs.</span>
<span class="sd">        solid_selection (Optional[List[str]]): A list of solid selection queries (including single</span>
<span class="sd">            solid names) to execute. For example:</span>
<span class="sd">            - [&#39;some_solid&#39;]: select &quot;some_solid&quot; itself.</span>
<span class="sd">            - [&#39;*some_solid&#39;]: select &quot;some_solid&quot; and all its ancestors (upstream dependencies).</span>
<span class="sd">            - [&#39;*some_solid+++&#39;]: select &quot;some_solid&quot;, all its ancestors, and its descendants</span>
<span class="sd">                (downstream dependencies) within 3 levels down.</span>
<span class="sd">            - [&#39;*some_solid&#39;, &#39;other_solid_a&#39;, &#39;other_solid_b+&#39;]: select &quot;some_solid&quot; and all its</span>
<span class="sd">                ancestors, &quot;other_solid_a&quot; itself, and &quot;other_solid_b&quot; and its direct child solids.</span>
<span class="sd">        instance (Optional[DagsterInstance]): The instance to execute against. If this is ``None``,</span>
<span class="sd">            an ephemeral instance will be used, and no artifacts will be persisted from the run.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Iterator[DagsterEvent]: The stream of events resulting from pipeline execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">_ephemeral_instance_if_missing</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">as</span> <span class="n">execute_instance</span><span class="p">:</span>
        <span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span>
            <span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">,</span>
            <span class="n">tags</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_check_execute_pipeline_args</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">create_run_for_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_def</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(),</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">execute_run_iterator</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">execute_instance</span><span class="p">)</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_ephemeral_instance_if_missing</span><span class="p">(</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DagsterInstance</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterInstance</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">instance</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">ephemeral</span><span class="p">()</span> <span class="k">as</span> <span class="n">ephemeral_instance</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ephemeral_instance</span>


<div class="viewcode-block" id="execute_pipeline"><a class="viewcode-back" href="../../../../sections/api/apidocs/execution.html#dagster.execute_pipeline">[docs]</a><span class="k">def</span> <span class="nf">execute_pipeline</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PipelineDefinition</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">],</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">solid_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DagsterInstance</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineExecutionResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Execute a pipeline synchronously.</span>

<span class="sd">    Users will typically call this API when testing pipeline execution, or running standalone</span>
<span class="sd">    scripts.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        pipeline (Union[IPipeline, PipelineDefinition]): The pipeline to execute.</span>
<span class="sd">        run_config (Optional[dict]): The environment configuration that parametrizes this run,</span>
<span class="sd">            as a dict.</span>
<span class="sd">        mode (Optional[str]): The name of the pipeline mode to use. You may not set both ``mode``</span>
<span class="sd">            and ``preset``.</span>
<span class="sd">        preset (Optional[str]): The name of the pipeline preset to use. You may not set both</span>
<span class="sd">            ``mode`` and ``preset``.</span>
<span class="sd">        tags (Optional[Dict[str, Any]]): Arbitrary key-value pairs that will be added to pipeline</span>
<span class="sd">            logs.</span>
<span class="sd">        instance (Optional[DagsterInstance]): The instance to execute against. If this is ``None``,</span>
<span class="sd">            an ephemeral instance will be used, and no artifacts will be persisted from the run.</span>
<span class="sd">        raise_on_error (Optional[bool]): Whether or not to raise exceptions when they occur.</span>
<span class="sd">            Defaults to ``True``, since this is the most useful behavior in test.</span>
<span class="sd">        solid_selection (Optional[List[str]]): A list of solid selection queries (including single</span>
<span class="sd">            solid names) to execute. For example:</span>
<span class="sd">            - [&#39;some_solid&#39;]: select &quot;some_solid&quot; itself.</span>
<span class="sd">            - [&#39;*some_solid&#39;]: select &quot;some_solid&quot; and all its ancestors (upstream dependencies).</span>
<span class="sd">            - [&#39;*some_solid+++&#39;]: select &quot;some_solid&quot;, all its ancestors, and its descendants</span>
<span class="sd">                (downstream dependencies) within 3 levels down.</span>
<span class="sd">            - [&#39;*some_solid&#39;, &#39;other_solid_a&#39;, &#39;other_solid_b+&#39;]: select &quot;some_solid&quot; and all its</span>
<span class="sd">                ancestors, &quot;other_solid_a&quot; itself, and &quot;other_solid_b&quot; and its direct child solids.</span>

<span class="sd">    Returns:</span>
<span class="sd">      :py:class:`PipelineExecutionResult`: The result of pipeline execution.</span>

<span class="sd">    For the asynchronous version, see :py:func:`execute_pipeline_iterator`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">_ephemeral_instance_if_missing</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">as</span> <span class="n">execute_instance</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_logged_execute_pipeline</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">execute_instance</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">,</span>
        <span class="p">)</span></div>


<span class="nd">@telemetry_wrapper</span>
<span class="k">def</span> <span class="nf">_logged_execute_pipeline</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">],</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span><span class="p">,</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">solid_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineExecutionResult</span><span class="p">:</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
    <span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span>
        <span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_check_execute_pipeline_args</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">log_repo_stats</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;execute_pipeline&quot;</span><span class="p">)</span>

    <span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">create_run_for_pipeline</span><span class="p">(</span>
        <span class="n">pipeline_def</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(),</span>
        <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">execute_run</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span>


<div class="viewcode-block" id="reexecute_pipeline"><a class="viewcode-back" href="../../../../sections/api/apidocs/execution.html#dagster.reexecute_pipeline">[docs]</a><span class="k">def</span> <span class="nf">reexecute_pipeline</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">],</span>
    <span class="n">parent_run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">step_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">raise_on_error</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PipelineExecutionResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reexecute an existing pipeline run.</span>

<span class="sd">    Users will typically call this API when testing pipeline reexecution, or running standalone</span>
<span class="sd">    scripts.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        pipeline (Union[IPipeline, PipelineDefinition]): The pipeline to execute.</span>
<span class="sd">        parent_run_id (str): The id of the previous run to reexecute. The run must exist in the</span>
<span class="sd">            instance.</span>
<span class="sd">        run_config (Optional[dict]): The environment configuration that parametrizes this run,</span>
<span class="sd">            as a dict.</span>
<span class="sd">        step_selection (Optional[List[str]]): A list of step selection queries (including single</span>
<span class="sd">            step keys) to execute. For example:</span>
<span class="sd">            - [&#39;some_solid&#39;]: select the execution step &quot;some_solid&quot; itself.</span>
<span class="sd">            - [&#39;*some_solid&#39;]: select the step &quot;some_solid&quot; and all its ancestors</span>
<span class="sd">                (upstream dependencies).</span>
<span class="sd">            - [&#39;*some_solid+++&#39;]: select the step &quot;some_solid&quot;, all its ancestors,</span>
<span class="sd">                and its descendants (downstream dependencies) within 3 levels down.</span>
<span class="sd">            - [&#39;*some_solid&#39;, &#39;other_solid_a&#39;, &#39;other_solid_b+&#39;]: select</span>
<span class="sd">                &quot;some_solid&quot; and all its ancestors, &quot;other_solid_a&quot; itself, and</span>
<span class="sd">                &quot;other_solid_b&quot; and its direct child execution steps.</span>
<span class="sd">        mode (Optional[str]): The name of the pipeline mode to use. You may not set both ``mode``</span>
<span class="sd">            and ``preset``.</span>
<span class="sd">        preset (Optional[str]): The name of the pipeline preset to use. You may not set both</span>
<span class="sd">            ``mode`` and ``preset``.</span>
<span class="sd">        tags (Optional[Dict[str, Any]]): Arbitrary key-value pairs that will be added to pipeline</span>
<span class="sd">            logs.</span>
<span class="sd">        instance (Optional[DagsterInstance]): The instance to execute against. If this is ``None``,</span>
<span class="sd">            an ephemeral instance will be used, and no artifacts will be persisted from the run.</span>
<span class="sd">        raise_on_error (Optional[bool]): Whether or not to raise exceptions when they occur.</span>
<span class="sd">            Defaults to ``True``, since this is the most useful behavior in test.</span>

<span class="sd">    Returns:</span>
<span class="sd">      :py:class:`PipelineExecutionResult`: The result of pipeline execution.</span>

<span class="sd">    For the asynchronous version, see :py:func:`reexecute_pipeline_iterator`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">step_selection</span><span class="p">,</span> <span class="s2">&quot;step_selection&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">parent_run_id</span><span class="p">,</span> <span class="s2">&quot;parent_run_id&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">_ephemeral_instance_if_missing</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">as</span> <span class="n">execute_instance</span><span class="p">:</span>
        <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">_check_execute_pipeline_args</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parent_pipeline_run</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">parent_run_id</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="n">parent_pipeline_run</span><span class="p">,</span>
            <span class="s2">&quot;No parent run with id </span><span class="si">{parent_run_id}</span><span class="s2"> found in instance.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># resolve step selection DSL queries using parent execution plan snapshot</span>
        <span class="k">if</span> <span class="n">step_selection</span><span class="p">:</span>
            <span class="n">full_plan</span> <span class="o">=</span> <span class="n">create_execution_plan</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">step_keys</span> <span class="o">=</span> <span class="n">parse_items_from_selection</span><span class="p">(</span><span class="n">step_selection</span><span class="p">)</span>
            <span class="c1"># resolve execution plan with any resolved dynamic step keys</span>
            <span class="n">resolved_plan</span> <span class="o">=</span> <span class="n">full_plan</span><span class="o">.</span><span class="n">build_subset_plan</span><span class="p">(</span><span class="n">step_keys</span><span class="p">)</span>
            <span class="c1"># parse selection using all step deps</span>
            <span class="n">step_keys_to_execute</span> <span class="o">=</span> <span class="n">parse_step_selection</span><span class="p">(</span>
                <span class="n">resolved_plan</span><span class="o">.</span><span class="n">get_all_step_deps</span><span class="p">(),</span> <span class="n">step_selection</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step_keys_to_execute</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">create_run_for_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_def</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(),</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="c1"># convert to frozenset https://github.com/dagster-io/dagster/issues/2914</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">)</span> <span class="k">if</span> <span class="n">step_keys_to_execute</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">root_run_id</span> <span class="ow">or</span> <span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">execute_run</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">execute_instance</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="n">raise_on_error</span><span class="p">)</span></div>


<div class="viewcode-block" id="reexecute_pipeline_iterator"><a class="viewcode-back" href="../../../../sections/api/apidocs/execution.html#dagster.reexecute_pipeline_iterator">[docs]</a><span class="k">def</span> <span class="nf">reexecute_pipeline_iterator</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">],</span>
    <span class="n">parent_run_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">step_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Reexecute a pipeline iteratively.</span>

<span class="sd">    Rather than package up the result of running a pipeline into a single object, like</span>
<span class="sd">    :py:func:`reexecute_pipeline`, this function yields the stream of events resulting from pipeline</span>
<span class="sd">    reexecution.</span>

<span class="sd">    This is intended to allow the caller to handle these events on a streaming basis in whatever</span>
<span class="sd">    way is appropriate.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        pipeline (Union[IPipeline, PipelineDefinition]): The pipeline to execute.</span>
<span class="sd">        parent_run_id (str): The id of the previous run to reexecute. The run must exist in the</span>
<span class="sd">            instance.</span>
<span class="sd">        run_config (Optional[dict]): The environment configuration that parametrizes this run,</span>
<span class="sd">            as a dict.</span>
<span class="sd">        step_selection (Optional[List[str]]): A list of step selection queries (including single</span>
<span class="sd">            step keys) to execute. For example:</span>
<span class="sd">            - [&#39;some_solid&#39;]: select the execution step &quot;some_solid&quot; itself.</span>
<span class="sd">            - [&#39;*some_solid&#39;]: select the step &quot;some_solid&quot; and all its ancestors</span>
<span class="sd">                (upstream dependencies).</span>
<span class="sd">            - [&#39;*some_solid+++&#39;]: select the step &quot;some_solid&quot;, all its ancestors,</span>
<span class="sd">                and its descendants (downstream dependencies) within 3 levels down.</span>
<span class="sd">            - [&#39;*some_solid&#39;, &#39;other_solid_a&#39;, &#39;other_solid_b+&#39;]: select</span>
<span class="sd">                &quot;some_solid&quot; and all its ancestors, &quot;other_solid_a&quot; itself, and</span>
<span class="sd">                &quot;other_solid_b&quot; and its direct child execution steps.</span>
<span class="sd">        mode (Optional[str]): The name of the pipeline mode to use. You may not set both ``mode``</span>
<span class="sd">            and ``preset``.</span>
<span class="sd">        preset (Optional[str]): The name of the pipeline preset to use. You may not set both</span>
<span class="sd">            ``mode`` and ``preset``.</span>
<span class="sd">        tags (Optional[Dict[str, Any]]): Arbitrary key-value pairs that will be added to pipeline</span>
<span class="sd">            logs.</span>
<span class="sd">        instance (Optional[DagsterInstance]): The instance to execute against. If this is ``None``,</span>
<span class="sd">            an ephemeral instance will be used, and no artifacts will be persisted from the run.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Iterator[DagsterEvent]: The stream of events resulting from pipeline reexecution.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">step_selection</span><span class="p">,</span> <span class="s2">&quot;step_selection&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">parent_run_id</span><span class="p">,</span> <span class="s2">&quot;parent_run_id&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">_ephemeral_instance_if_missing</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="k">as</span> <span class="n">execute_instance</span><span class="p">:</span>
        <span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">_check_execute_pipeline_args</span><span class="p">(</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">pipeline</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parent_pipeline_run</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">parent_run_id</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="n">parent_pipeline_run</span><span class="p">,</span>
            <span class="s2">&quot;No parent run with id </span><span class="si">{parent_run_id}</span><span class="s2"> found in instance.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># resolve step selection DSL queries using parent execution plan snapshot</span>
        <span class="k">if</span> <span class="n">step_selection</span><span class="p">:</span>
            <span class="n">parent_execution_plan_snapshot</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">get_execution_plan_snapshot</span><span class="p">(</span>
                <span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">execution_plan_snapshot_id</span>
            <span class="p">)</span>
            <span class="n">step_keys_to_execute</span> <span class="o">=</span> <span class="n">parse_step_selection</span><span class="p">(</span>
                <span class="n">parent_execution_plan_snapshot</span><span class="o">.</span><span class="n">step_deps</span><span class="p">,</span> <span class="n">step_selection</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">step_keys_to_execute</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="n">execute_instance</span><span class="o">.</span><span class="n">create_run_for_pipeline</span><span class="p">(</span>
            <span class="n">pipeline_def</span><span class="o">=</span><span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">(),</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="c1"># convert to frozenset https://github.com/dagster-io/dagster/issues/2914</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">)</span> <span class="k">if</span> <span class="n">step_keys_to_execute</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">root_run_id</span> <span class="ow">or</span> <span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">execute_run_iterator</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">execute_instance</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">execute_plan_iterator</span><span class="p">(</span>
    <span class="n">execution_plan</span><span class="p">:</span> <span class="n">ExecutionPlan</span><span class="p">,</span>
    <span class="n">pipeline_run</span><span class="p">:</span> <span class="n">PipelineRun</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span><span class="p">,</span>
    <span class="n">retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Retries</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">,</span> <span class="s2">&quot;execution_plan&quot;</span><span class="p">,</span> <span class="n">ExecutionPlan</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">retries</span><span class="p">,</span> <span class="s2">&quot;retries&quot;</span><span class="p">,</span> <span class="n">Retries</span><span class="p">,</span> <span class="n">Retries</span><span class="o">.</span><span class="n">disabled_mode</span><span class="p">())</span>
    <span class="n">run_config</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">run_config</span><span class="p">,</span> <span class="s2">&quot;run_config&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span>
        <span class="n">_ExecuteRunWithPlanIterable</span><span class="p">(</span>
            <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
            <span class="n">iterator</span><span class="o">=</span><span class="n">inner_plan_execution_iterator</span><span class="p">,</span>
            <span class="n">execution_context_manager</span><span class="o">=</span><span class="n">PlanExecutionContextManager</span><span class="p">(</span>
                <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span>
                <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
                <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
                <span class="n">pipeline_run</span><span class="o">=</span><span class="n">pipeline_run</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
                <span class="n">raise_on_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">execute_plan</span><span class="p">(</span>
    <span class="n">execution_plan</span><span class="p">:</span> <span class="n">ExecutionPlan</span><span class="p">,</span>
    <span class="n">instance</span><span class="p">:</span> <span class="n">DagsterInstance</span><span class="p">,</span>
    <span class="n">pipeline_run</span><span class="p">:</span> <span class="n">PipelineRun</span><span class="p">,</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">retries</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Retries</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;This is the entry point of dagster-graphql executions. For the dagster CLI entry point, see</span>
<span class="sd">    execute_pipeline() above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">,</span> <span class="s2">&quot;execution_plan&quot;</span><span class="p">,</span> <span class="n">ExecutionPlan</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
    <span class="n">run_config</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">run_config</span><span class="p">,</span> <span class="s2">&quot;run_config&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">retries</span><span class="p">,</span> <span class="s2">&quot;retries&quot;</span><span class="p">,</span> <span class="n">Retries</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">execute_plan_iterator</span><span class="p">(</span>
            <span class="n">execution_plan</span><span class="o">=</span><span class="n">execution_plan</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">pipeline_run</span><span class="o">=</span><span class="n">pipeline_run</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span>
            <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PipelineDefinition</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IPipeline</span><span class="p">:</span>
    <span class="c1"># backcompat</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">InMemoryPipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pipeline</span>


<span class="k">def</span> <span class="nf">create_execution_plan</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">IPipeline</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">],</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">step_keys_to_execute</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExecutionPlan</span><span class="p">:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">_check_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
    <span class="n">pipeline_def</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">()</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="s2">&quot;pipeline_def&quot;</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">)</span>

    <span class="n">run_config</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">run_config</span><span class="p">,</span> <span class="s2">&quot;run_config&quot;</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_default_mode_name</span><span class="p">())</span>
    <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">,</span> <span class="s2">&quot;step_keys_to_execute&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="n">environment_config</span> <span class="o">=</span> <span class="n">EnvironmentConfig</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ExecutionPlan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span> <span class="n">environment_config</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">step_keys_to_execute</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_pipeline_execution_iterator</span><span class="p">(</span>
    <span class="n">pipeline_context</span><span class="p">:</span> <span class="n">SystemPipelineExecutionContext</span><span class="p">,</span> <span class="n">execution_plan</span><span class="p">:</span> <span class="n">ExecutionPlan</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">DagsterEvent</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;A complete execution of a pipeline. Yields pipeline start, success,</span>
<span class="sd">    and failure events.</span>

<span class="sd">    Args:</span>
<span class="sd">        pipeline_context (SystemPipelineExecutionContext):</span>
<span class="sd">        execution_plan (ExecutionPlan):</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_context</span><span class="p">,</span> <span class="s2">&quot;pipeline_context&quot;</span><span class="p">,</span> <span class="n">SystemPipelineExecutionContext</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">,</span> <span class="s2">&quot;execution_plan&quot;</span><span class="p">,</span> <span class="n">ExecutionPlan</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_start</span><span class="p">(</span><span class="n">pipeline_context</span><span class="p">)</span>

    <span class="n">pipeline_exception_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pipeline_canceled_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">failed_steps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">generator_closed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pipeline_context</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">pipeline_context</span><span class="p">,</span> <span class="n">execution_plan</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_step_failure</span><span class="p">:</span>
                <span class="n">failed_steps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">step_key</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">event</span>
    <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
        <span class="c1"># Shouldn&#39;t happen, but avoid runtime-exception in case this generator gets GC-ed</span>
        <span class="c1"># (see https://amir.rachum.com/blog/2017/03/03/generator-cleanup/).</span>
        <span class="n">generator_closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">pipeline_exception_info</span> <span class="o">=</span> <span class="n">serializable_error_info_from_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="n">DagsterExecutionInterruptedError</span><span class="p">):</span>
        <span class="n">pipeline_canceled_info</span> <span class="o">=</span> <span class="n">serializable_error_info_from_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">pipeline_exception_info</span> <span class="o">=</span> <span class="n">serializable_error_info_from_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">raise</span>  <span class="c1"># finally block will run before this is re-raised</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pipeline_canceled_info</span><span class="p">:</span>
            <span class="n">reloaded_run</span> <span class="o">=</span> <span class="n">pipeline_context</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">pipeline_context</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reloaded_run</span> <span class="ow">and</span> <span class="n">reloaded_run</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">CANCELING</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_canceled</span><span class="p">(</span><span class="n">pipeline_context</span><span class="p">,</span> <span class="n">pipeline_canceled_info</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_failure</span><span class="p">(</span>
                    <span class="n">pipeline_context</span><span class="p">,</span>
                    <span class="s2">&quot;Execution was interrupted unexpectedly. &quot;</span>
                    <span class="s2">&quot;No user initiated termination request was found, treating as failure.&quot;</span><span class="p">,</span>
                    <span class="n">pipeline_canceled_info</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">pipeline_exception_info</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_failure</span><span class="p">(</span>
                <span class="n">pipeline_context</span><span class="p">,</span>
                <span class="s2">&quot;An exception was thrown during execution.&quot;</span><span class="p">,</span>
                <span class="n">pipeline_exception_info</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">failed_steps</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_failure</span><span class="p">(</span>
                <span class="n">pipeline_context</span><span class="p">,</span> <span class="s2">&quot;Steps failed: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">failed_steps</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="o">.</span><span class="n">pipeline_success</span><span class="p">(</span><span class="n">pipeline_context</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">generator_closed</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">event</span>


<span class="k">class</span> <span class="nc">_ExecuteRunWithPlanIterable</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Utility class to consolidate execution logic.</span>

<span class="sd">    This is a class and not a function because, e.g., in constructing a `scoped_pipeline_context`</span>
<span class="sd">    for `PipelineExecutionResult`, we need to pull out the `pipeline_context` after we&#39;re done</span>
<span class="sd">    yielding events. This broadly follows a pattern we make use of in other places,</span>
<span class="sd">    cf. `dagster.utils.EventGenerationManager`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">execution_plan</span><span class="p">,</span> <span class="n">iterator</span><span class="p">,</span> <span class="n">execution_context_manager</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_plan</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">,</span> <span class="s2">&quot;execution_plan&quot;</span><span class="p">,</span> <span class="n">ExecutionPlan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">callable_param</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="s2">&quot;iterator&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_context_manager</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span>
            <span class="n">execution_context_manager</span><span class="p">,</span> <span class="s2">&quot;execution_context_manager&quot;</span><span class="p">,</span> <span class="n">ExecutionContextManager</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_context</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Since interrupts can&#39;t be raised at arbitrary points safely, delay them until designated</span>
        <span class="c1"># checkpoints during the execution.</span>
        <span class="c1"># To be maximally certain that interrupts are always caught during an execution process,</span>
        <span class="c1"># you can safely add an additional `with capture_interrupts()` at the very beginning of the</span>
        <span class="c1"># process that performs the execution.</span>
        <span class="k">with</span> <span class="n">capture_interrupts</span><span class="p">():</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_context_manager</span><span class="o">.</span><span class="n">prepare_context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_context_manager</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
            <span class="n">generator_closed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_context</span><span class="p">:</span>  <span class="c1"># False if we had a pipeline init failure</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterator</span><span class="p">(</span>
                        <span class="n">execution_plan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_plan</span><span class="p">,</span> <span class="n">pipeline_context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_context</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
                <span class="c1"># Shouldn&#39;t happen, but avoid runtime-exception in case this generator gets GC-ed</span>
                <span class="c1"># (see https://amir.rachum.com/blog/2017/03/03/generator-cleanup/).</span>
                <span class="n">generator_closed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_context_manager</span><span class="o">.</span><span class="n">shutdown_context</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">generator_closed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">event</span>


<span class="k">def</span> <span class="nf">_check_execute_pipeline_args</span><span class="p">(</span>
    <span class="n">pipeline</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">PipelineDefinition</span><span class="p">,</span> <span class="n">IPipeline</span><span class="p">],</span>
    <span class="n">run_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span>
    <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">preset</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">solid_selection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">IPipeline</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="p">]:</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">_check_pipeline</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>
    <span class="n">pipeline_def</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">get_definition</span><span class="p">()</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="s2">&quot;pipeline_def&quot;</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">)</span>

    <span class="n">run_config</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">run_config</span><span class="p">,</span> <span class="s2">&quot;run_config&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">preset</span><span class="p">,</span> <span class="s2">&quot;preset&quot;</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
        <span class="ow">not</span> <span class="p">(</span><span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">preset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">),</span>
        <span class="s2">&quot;You may set only one of `mode` (got </span><span class="si">{mode}</span><span class="s2">) or `preset` (got </span><span class="si">{preset}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="n">preset</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span> <span class="s2">&quot;tags&quot;</span><span class="p">,</span> <span class="n">key_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">solid_selection</span><span class="p">,</span> <span class="s2">&quot;solid_selection&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">preset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pipeline_preset</span> <span class="o">=</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_preset</span><span class="p">(</span><span class="n">preset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">run_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="n">run_config</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pipeline_preset</span><span class="o">.</span><span class="n">run_config</span> <span class="o">==</span> <span class="n">run_config</span><span class="p">),</span>
                <span class="s2">&quot;The environment set in preset &#39;</span><span class="si">{preset}</span><span class="s2">&#39; does not agree with the environment &quot;</span>
                <span class="s2">&quot;passed in the `run_config` argument.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">run_config</span> <span class="o">=</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">run_config</span>

        <span class="c1"># load solid_selection from preset</span>
        <span class="k">if</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">solid_selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                <span class="n">solid_selection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">solid_selection</span> <span class="o">==</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">solid_selection</span><span class="p">,</span>
                <span class="s2">&quot;The solid_selection set in preset &#39;</span><span class="si">{preset}</span><span class="s2">&#39;, </span><span class="si">{preset_subset}</span><span class="s2">, does not agree with &quot;</span>
                <span class="s2">&quot;the `solid_selection` argument: </span><span class="si">{solid_selection}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span>
                    <span class="n">preset_subset</span><span class="o">=</span><span class="n">pipeline_preset</span><span class="o">.</span><span class="n">solid_selection</span><span class="p">,</span>
                    <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">solid_selection</span> <span class="o">=</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">solid_selection</span>

        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span>
            <span class="s2">&quot;Mode </span><span class="si">{mode}</span><span class="s2"> does not agree with the mode set in preset &#39;</span><span class="si">{preset}</span><span class="s2">&#39;: &quot;</span>
            <span class="s2">&quot;(&#39;</span><span class="si">{preset_mode}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">preset</span><span class="o">=</span><span class="n">preset</span><span class="p">,</span> <span class="n">preset_mode</span><span class="o">=</span><span class="n">pipeline_preset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">pipeline_preset</span><span class="o">.</span><span class="n">mode</span>

        <span class="n">tags</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">pipeline_preset</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">has_mode_definition</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;You have attempted to execute pipeline </span><span class="si">{name}</span><span class="s2"> with mode </span><span class="si">{mode}</span><span class="s2">. &quot;</span>
                    <span class="s2">&quot;Available modes: </span><span class="si">{modes}</span><span class="s2">&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">available_modes</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">is_multi_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="s2">&quot;Pipeline </span><span class="si">{name}</span><span class="s2"> has multiple modes (Available modes: </span><span class="si">{modes}</span><span class="s2">) and you have &quot;</span>
                    <span class="s2">&quot;attempted to execute it without specifying a mode. Set &quot;</span>
                    <span class="s2">&quot;mode property on the PipelineRun object.&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">available_modes</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_default_mode_name</span><span class="p">()</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">tags</span><span class="p">,</span> <span class="n">tags</span><span class="p">)</span>

    <span class="c1"># generate pipeline subset from the given solid_selection</span>
    <span class="k">if</span> <span class="n">solid_selection</span><span class="p">:</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">subset_for_execution</span><span class="p">(</span><span class="n">solid_selection</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">pipeline</span><span class="p">,</span>
        <span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>

            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>