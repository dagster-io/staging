
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dagster.core.instance &#8212; Dagster</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
 
<link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <h1>Source code for dagster.core.instance</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions.events</span> <span class="kn">import</span> <span class="n">AssetKey</span>
<span class="kn">from</span> <span class="nn">dagster.core.definitions.pipeline</span> <span class="kn">import</span> <span class="n">PipelineDefinition</span><span class="p">,</span> <span class="n">PipelineSubsetDefinition</span>
<span class="kn">from</span> <span class="nn">dagster.core.errors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DagsterInvariantViolationError</span><span class="p">,</span>
    <span class="n">DagsterRunAlreadyExists</span><span class="p">,</span>
    <span class="n">DagsterRunConflict</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.migration.utils</span> <span class="kn">import</span> <span class="n">upgrading_instance</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.pipeline_run</span> <span class="kn">import</span> <span class="n">PipelineRun</span><span class="p">,</span> <span class="n">PipelineRunStatus</span>
<span class="kn">from</span> <span class="nn">dagster.core.storage.tags</span> <span class="kn">import</span> <span class="n">MEMOIZED_RUN_TAG</span>
<span class="kn">from</span> <span class="nn">dagster.core.system_config.objects</span> <span class="kn">import</span> <span class="n">EnvironmentConfig</span>
<span class="kn">from</span> <span class="nn">dagster.core.utils</span> <span class="kn">import</span> <span class="n">str_format_list</span>
<span class="kn">from</span> <span class="nn">dagster.serdes</span> <span class="kn">import</span> <span class="n">ConfigurableClass</span>
<span class="kn">from</span> <span class="nn">dagster.seven</span> <span class="kn">import</span> <span class="n">get_current_datetime_in_utc</span>
<span class="kn">from</span> <span class="nn">dagster.utils.error</span> <span class="kn">import</span> <span class="n">serializable_error_info_from_exc_info</span>

<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">DAGSTER_CONFIG_YAML_FILENAME</span>
<span class="kn">from</span> <span class="nn">.ref</span> <span class="kn">import</span> <span class="n">InstanceRef</span>

<span class="c1"># &#39;airflow_execution_date&#39; and &#39;is_airflow_ingest_pipeline&#39; are hardcoded tags used in the</span>
<span class="c1"># airflow ingestion logic (see: dagster_pipeline_factory.py). &#39;airflow_execution_date&#39; stores the</span>
<span class="c1"># &#39;execution_date&#39; used in Airflow operator execution and &#39;is_airflow_ingest_pipeline&#39; determines</span>
<span class="c1"># whether &#39;airflow_execution_date&#39; is needed.</span>
<span class="c1"># https://github.com/dagster-io/dagster/issues/2403</span>
<span class="n">AIRFLOW_EXECUTION_DATE_STR</span> <span class="o">=</span> <span class="s2">&quot;airflow_execution_date&quot;</span>
<span class="n">IS_AIRFLOW_INGEST_PIPELINE_STR</span> <span class="o">=</span> <span class="s2">&quot;is_airflow_ingest_pipeline&quot;</span>


<span class="k">def</span> <span class="nf">_is_dagster_home_set</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DAGSTER_HOME&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">is_memoized_run</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">MEMOIZED_RUN_TAG</span> <span class="ow">in</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MEMOIZED_RUN_TAG</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span>


<span class="k">def</span> <span class="nf">_dagster_home</span><span class="p">():</span>
    <span class="n">dagster_home_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DAGSTER_HOME&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dagster_home_path</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s2">&quot;The environment variable $DAGSTER_HOME is not set. Dagster requires this &quot;</span>
                <span class="s2">&quot;environment variable to be set to an existing directory in your filesystem &quot;</span>
                <span class="s2">&quot;that contains your dagster instance configuration file (dagster.yaml).</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;You can resolve this error by exporting the environment variable.&quot;</span>
                <span class="s2">&quot;For example, you can run the following command in your shell or &quot;</span>
                <span class="s2">&quot;include it in your shell configuration file:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">export DAGSTER_HOME=&quot;~/dagster_home&quot;&#39;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">dagster_home_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;$DAGSTER_HOME &quot;</span><span class="si">{}</span><span class="s1">&quot; must be an absolute path. Dagster requires this &#39;</span>
                <span class="s2">&quot;environment variable to be set to an existing directory in your filesystem that&quot;</span>
                <span class="s2">&quot;contains your dagster instance configuration file (dagster.yaml).&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="s1">&#39;$DAGSTER_HOME &quot;</span><span class="si">{}</span><span class="s1">&quot; is not a directory or does not exist. Dagster requires this &#39;</span>
                <span class="s2">&quot;environment variable to be set to an existing directory in your filesystem that &quot;</span>
                <span class="s2">&quot;contains your dagster instance configuration file (dagster.yaml).&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dagster_home_path</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">dagster_home_path</span>


<span class="k">def</span> <span class="nf">_check_run_equality</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="n">candidate_run</span><span class="p">):</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
    <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">candidate_run</span><span class="p">,</span> <span class="s2">&quot;candidate_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>

    <span class="n">field_diff</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pipeline_run</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
        <span class="n">expected_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="n">candidate_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">candidate_run</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expected_value</span> <span class="o">!=</span> <span class="n">candidate_value</span><span class="p">:</span>
            <span class="n">field_diff</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">expected_value</span><span class="p">,</span> <span class="n">candidate_value</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">field_diff</span>


<span class="k">def</span> <span class="nf">_format_field_diff</span><span class="p">(</span><span class="n">field_diff</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="s2">&quot;    </span><span class="si">{field_name}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;        Expected: </span><span class="si">{expected_value}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;        Received: </span><span class="si">{candidate_value}</span><span class="s2">&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                <span class="n">expected_value</span><span class="o">=</span><span class="n">expected_value</span><span class="p">,</span>
                <span class="n">candidate_value</span><span class="o">=</span><span class="n">candidate_value</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="p">(</span><span class="n">expected_value</span><span class="p">,</span> <span class="n">candidate_value</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">field_diff</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">)</span>


<span class="k">class</span> <span class="nc">_EventListenerLogHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span> <span class="o">=</span> <span class="n">instance</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">_EventListenerLogHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">construct_event_record</span><span class="p">,</span> <span class="n">StructuredLoggerMessage</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">construct_event_record</span><span class="p">(</span>
                <span class="n">StructuredLoggerMessage</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span>
                    <span class="n">level</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">levelno</span><span class="p">,</span>
                    <span class="n">meta</span><span class="o">=</span><span class="n">record</span><span class="o">.</span><span class="n">dagster_meta</span><span class="p">,</span>
                    <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_instance</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pylint: disable=W0703</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Error during instance event listen&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span>


<span class="k">class</span> <span class="nc">InstanceType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PERSISTENT</span> <span class="o">=</span> <span class="s2">&quot;PERSISTENT&quot;</span>
    <span class="n">EPHEMERAL</span> <span class="o">=</span> <span class="s2">&quot;EPHEMERAL&quot;</span>


<div class="viewcode-block" id="DagsterInstance"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance">[docs]</a><span class="k">class</span> <span class="nc">DagsterInstance</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Core abstraction for managing Dagster&#39;s access to storage and other resources.</span>

<span class="sd">    Use DagsterInstance.get() to grab the current DagsterInstance which will load based on</span>
<span class="sd">    the values in the ``dagster.yaml`` file in ``$DAGSTER_HOME`` if set, otherwise fallback</span>
<span class="sd">    to using an ephemeral in-memory set of components.</span>

<span class="sd">    Configuration of this class should be done by setting values in ``$DAGSTER_HOME/dagster.yaml``.</span>
<span class="sd">    For example, to use Postgres for run and event log storage, you can write a ``dagster.yaml``</span>
<span class="sd">    such as the following:</span>

<span class="sd">    .. literalinclude:: ../../../../docs/sections/deploying/postgres_dagster.yaml</span>
<span class="sd">       :caption: dagster.yaml</span>
<span class="sd">       :language: YAML</span>

<span class="sd">    Args:</span>
<span class="sd">        instance_type (InstanceType): Indicates whether the instance is ephemeral or persistent.</span>
<span class="sd">            Users should not attempt to set this value directly or in their ``dagster.yaml`` files.</span>
<span class="sd">        local_artifact_storage (LocalArtifactStorage): The local artifact storage is used to</span>
<span class="sd">            configure storage for any artifacts that require a local disk, such as schedules, or</span>
<span class="sd">            when using the filesystem system storage to manage files and intermediates. By default,</span>
<span class="sd">            this will be a :py:class:`dagster.core.storage.root.LocalArtifactStorage`. Configurable</span>
<span class="sd">            in ``dagster.yaml`` using the :py:class:`~dagster.serdes.ConfigurableClass`</span>
<span class="sd">            machinery.</span>
<span class="sd">        run_storage (RunStorage): The run storage is used to store metadata about ongoing and past</span>
<span class="sd">            pipeline runs. By default, this will be a</span>
<span class="sd">            :py:class:`dagster.core.storage.runs.SqliteRunStorage`. Configurable in ``dagster.yaml``</span>
<span class="sd">            using the :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>
<span class="sd">        event_storage (EventLogStorage): Used to store the structured event logs generated by</span>
<span class="sd">            pipeline runs. By default, this will be a</span>
<span class="sd">            :py:class:`dagster.core.storage.event_log.SqliteEventLogStorage`. Configurable in</span>
<span class="sd">            ``dagster.yaml`` using the :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>
<span class="sd">        compute_log_manager (ComputeLogManager): The compute log manager handles stdout and stderr</span>
<span class="sd">            logging for solid compute functions. By default, this will be a</span>
<span class="sd">            :py:class:`dagster.core.storage.local_compute_log_manager.LocalComputeLogManager`.</span>
<span class="sd">            Configurable in ``dagster.yaml`` using the</span>
<span class="sd">            :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>
<span class="sd">        run_coordinator (RunCoordinator): A runs coordinator may be used to manage the execution</span>
<span class="sd">            of pipeline runs.</span>
<span class="sd">        run_launcher (Optional[RunLauncher]): Optionally, a run launcher may be used to enable</span>
<span class="sd">            a Dagster instance to launch pipeline runs, e.g. on a remote Kubernetes cluster, in</span>
<span class="sd">            addition to running them locally.</span>
<span class="sd">        settings (Optional[Dict]): Specifies certain per-instance settings,</span>
<span class="sd">            such as feature flags. These are set in the ``dagster.yaml`` under a set of whitelisted</span>
<span class="sd">            keys.</span>
<span class="sd">        ref (Optional[InstanceRef]): Used by internal machinery to pass instances across process</span>
<span class="sd">            boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_PROCESS_TEMPDIR</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instance_type</span><span class="p">,</span>
        <span class="n">local_artifact_storage</span><span class="p">,</span>
        <span class="n">run_storage</span><span class="p">,</span>
        <span class="n">event_storage</span><span class="p">,</span>
        <span class="n">compute_log_manager</span><span class="p">,</span>
        <span class="n">schedule_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_coordinator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_launcher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">settings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_validation_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.compute_log_manager</span> <span class="kn">import</span> <span class="n">ComputeLogManager</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.event_log</span> <span class="kn">import</span> <span class="n">EventLogStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.root</span> <span class="kn">import</span> <span class="n">LocalArtifactStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.runs</span> <span class="kn">import</span> <span class="n">RunStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.schedules</span> <span class="kn">import</span> <span class="n">ScheduleStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.scheduler</span> <span class="kn">import</span> <span class="n">Scheduler</span>
        <span class="kn">from</span> <span class="nn">dagster.core.run_coordinator</span> <span class="kn">import</span> <span class="n">RunCoordinator</span>
        <span class="kn">from</span> <span class="nn">dagster.core.launcher</span> <span class="kn">import</span> <span class="n">RunLauncher</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_instance_type</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance_type</span><span class="p">,</span> <span class="s2">&quot;instance_type&quot;</span><span class="p">,</span> <span class="n">InstanceType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span>
            <span class="n">local_artifact_storage</span><span class="p">,</span> <span class="s2">&quot;local_artifact_storage&quot;</span><span class="p">,</span> <span class="n">LocalArtifactStorage</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">event_storage</span><span class="p">,</span> <span class="s2">&quot;event_storage&quot;</span><span class="p">,</span> <span class="n">EventLogStorage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">run_storage</span><span class="p">,</span> <span class="s2">&quot;run_storage&quot;</span><span class="p">,</span> <span class="n">RunStorage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_log_manager</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span>
            <span class="n">compute_log_manager</span><span class="p">,</span> <span class="s2">&quot;compute_log_manager&quot;</span><span class="p">,</span> <span class="n">ComputeLogManager</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span>
            <span class="n">schedule_storage</span><span class="p">,</span> <span class="s2">&quot;schedule_storage&quot;</span><span class="p">,</span> <span class="n">ScheduleStorage</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="s2">&quot;scheduler&quot;</span><span class="p">,</span> <span class="n">Scheduler</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_validation_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">validate_stored_schedules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler_class</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_coordinator</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">run_coordinator</span><span class="p">,</span> <span class="s2">&quot;run_coordinator&quot;</span><span class="p">,</span> <span class="n">RunCoordinator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_coordinator</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">run_launcher</span><span class="p">,</span> <span class="s2">&quot;run_launcher&quot;</span><span class="p">,</span> <span class="n">RunLauncher</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_dict_param</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s2">&quot;settings&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="n">InstanceRef</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="c1"># ctors</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ephemeral</span><span class="p">(</span><span class="n">tempdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.run_coordinator</span> <span class="kn">import</span> <span class="n">DefaultRunCoordinator</span>
        <span class="kn">from</span> <span class="nn">dagster.core.launcher.sync_in_memory_run_launcher</span> <span class="kn">import</span> <span class="n">SyncInMemoryRunLauncher</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.event_log</span> <span class="kn">import</span> <span class="n">InMemoryEventLogStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.root</span> <span class="kn">import</span> <span class="n">LocalArtifactStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.runs</span> <span class="kn">import</span> <span class="n">InMemoryRunStorage</span>
        <span class="kn">from</span> <span class="nn">dagster.core.storage.noop_compute_log_manager</span> <span class="kn">import</span> <span class="n">NoOpComputeLogManager</span>

        <span class="k">if</span> <span class="n">tempdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempdir</span> <span class="o">=</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">temp_storage</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="p">(</span>
            <span class="n">InstanceType</span><span class="o">.</span><span class="n">EPHEMERAL</span><span class="p">,</span>
            <span class="n">local_artifact_storage</span><span class="o">=</span><span class="n">LocalArtifactStorage</span><span class="p">(</span><span class="n">tempdir</span><span class="p">),</span>
            <span class="n">run_storage</span><span class="o">=</span><span class="n">InMemoryRunStorage</span><span class="p">(</span><span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">),</span>
            <span class="n">event_storage</span><span class="o">=</span><span class="n">InMemoryEventLogStorage</span><span class="p">(</span><span class="n">preload</span><span class="o">=</span><span class="n">preload</span><span class="p">),</span>
            <span class="n">compute_log_manager</span><span class="o">=</span><span class="n">NoOpComputeLogManager</span><span class="p">(),</span>
            <span class="n">run_coordinator</span><span class="o">=</span><span class="n">DefaultRunCoordinator</span><span class="p">(),</span>
            <span class="n">run_launcher</span><span class="o">=</span><span class="n">SyncInMemoryRunLauncher</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">fallback_storage</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># 1. Use $DAGSTER_HOME to determine instance if set.</span>
        <span class="k">if</span> <span class="n">_is_dagster_home_set</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_dagster_home</span><span class="p">())</span>

        <span class="c1"># 2. If that is not set use the fallback storage directory if provided.</span>
        <span class="c1"># This allows us to have a nice out of the box dagit experience where runs are persisted</span>
        <span class="c1"># across restarts in a tempdir that gets cleaned up when the dagit watchdog process exits.</span>
        <span class="k">elif</span> <span class="n">fallback_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">fallback_storage</span><span class="p">)</span>

        <span class="c1"># 3. If all else fails create an ephemeral in memory instance.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">ephemeral</span><span class="p">(</span><span class="n">fallback_storage</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_for_migration</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">_dagster_home</span><span class="p">(),</span> <span class="n">skip_validation_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">local_temp</span><span class="p">(</span><span class="n">tempdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;To create a local DagsterInstance for a test, use the instance_for_test &quot;</span>
            <span class="s2">&quot;context manager instead, which ensures that resoures are cleaned up afterwards&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">tempdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tempdir</span> <span class="o">=</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">temp_storage</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">from_ref</span><span class="p">(</span><span class="n">InstanceRef</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span>
        <span class="n">config_dir</span><span class="p">,</span> <span class="n">config_filename</span><span class="o">=</span><span class="n">DAGSTER_CONFIG_YAML_FILENAME</span><span class="p">,</span> <span class="n">skip_validation_checks</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">instance_ref</span> <span class="o">=</span> <span class="n">InstanceRef</span><span class="o">.</span><span class="n">from_dir</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">config_filename</span><span class="o">=</span><span class="n">config_filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">from_ref</span><span class="p">(</span><span class="n">instance_ref</span><span class="p">,</span> <span class="n">skip_validation_checks</span><span class="o">=</span><span class="n">skip_validation_checks</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_ref</span><span class="p">(</span><span class="n">instance_ref</span><span class="p">,</span> <span class="n">skip_validation_checks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance_ref</span><span class="p">,</span> <span class="s2">&quot;instance_ref&quot;</span><span class="p">,</span> <span class="n">InstanceRef</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="p">(</span>
            <span class="n">instance_type</span><span class="o">=</span><span class="n">InstanceType</span><span class="o">.</span><span class="n">PERSISTENT</span><span class="p">,</span>
            <span class="n">local_artifact_storage</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">local_artifact_storage</span><span class="p">,</span>
            <span class="n">run_storage</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">run_storage</span><span class="p">,</span>
            <span class="n">event_storage</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">event_storage</span><span class="p">,</span>
            <span class="n">compute_log_manager</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">compute_log_manager</span><span class="p">,</span>
            <span class="n">schedule_storage</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">schedule_storage</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">run_coordinator</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">run_coordinator</span><span class="p">,</span>
            <span class="n">run_launcher</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">run_launcher</span><span class="p">,</span>
            <span class="n">settings</span><span class="o">=</span><span class="n">instance_ref</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span>
            <span class="n">skip_validation_checks</span><span class="o">=</span><span class="n">skip_validation_checks</span><span class="p">,</span>
            <span class="n">ref</span><span class="o">=</span><span class="n">instance_ref</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># flags</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_persistent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_type</span> <span class="o">==</span> <span class="n">InstanceType</span><span class="o">.</span><span class="n">PERSISTENT</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ephemeral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instance_type</span> <span class="o">==</span> <span class="n">InstanceType</span><span class="o">.</span><span class="n">EPHEMERAL</span>

    <span class="k">def</span> <span class="nf">get_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ref</span>

        <span class="n">check</span><span class="o">.</span><span class="n">failed</span><span class="p">(</span>
            <span class="s2">&quot;Attempted to prepare an ineligible DagsterInstance (</span><span class="si">{inst_type}</span><span class="s2">) for cross &quot;</span>
            <span class="s2">&quot;process communication.</span><span class="si">{dagster_home_msg}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">inst_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_instance_type</span><span class="p">,</span>
                <span class="n">dagster_home_msg</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">DAGSTER_HOME environment variable is not set, set it to &quot;</span>
                <span class="s2">&quot;a directory on the filesystem for dagster to use for storage and cross &quot;</span>
                <span class="s2">&quot;process coordination.&quot;</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DAGSTER_HOME&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span><span class="o">.</span><span class="n">base_dir</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">temp_storage</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">_PROCESS_TEMPDIR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">_PROCESS_TEMPDIR</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">DagsterInstance</span><span class="o">.</span><span class="n">_PROCESS_TEMPDIR</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="c1"># ConfigurableClass may not have inst_data if it&#39;s a direct instantiation</span>
        <span class="c1"># which happens for ephemeral instances</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">ConfigurableClass</span><span class="p">)</span> <span class="ow">and</span> <span class="n">component</span><span class="o">.</span><span class="n">inst_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="n">inst_data</span><span class="o">.</span><span class="n">info_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">component</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">component</span>
        <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="k">def</span> <span class="nf">_info_str_for_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
            <span class="p">{</span><span class="n">component_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="n">component</span><span class="p">)},</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">info_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;local_artifact_storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span><span class="p">),</span>
            <span class="s2">&quot;run_storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="p">),</span>
            <span class="s2">&quot;event_log_storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="p">),</span>
            <span class="s2">&quot;compute_logs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_log_manager</span><span class="p">),</span>
            <span class="s2">&quot;schedule_storage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="p">),</span>
            <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">),</span>
            <span class="s2">&quot;run_coordinator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_coordinator</span><span class="p">),</span>
            <span class="s2">&quot;run_launcher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">settings_key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span><span class="p">(</span><span class="n">settings_value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">settings_key</span><span class="p">,</span> <span class="n">settings_value</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">info_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">info_dict</span><span class="p">(),</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># schedule storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schedule_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span>

    <span class="c1"># schedule storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scheduler_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># run coordinator</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_coordinator</span>

    <span class="c1"># run launcher</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_launcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span>

    <span class="c1"># compute logs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compute_log_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_log_manager</span>

    <span class="k">def</span> <span class="nf">get_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings_key</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">settings_key</span><span class="p">,</span> <span class="s2">&quot;settings_key&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span> <span class="ow">and</span> <span class="n">settings_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">settings_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">telemetry_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ephemeral</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">dagster_telemetry_enabled_default</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">telemetry_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_settings</span><span class="p">(</span><span class="s2">&quot;telemetry&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">telemetry_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dagster_telemetry_enabled_default</span>

        <span class="k">if</span> <span class="s2">&quot;enabled&quot;</span> <span class="ow">in</span> <span class="n">telemetry_settings</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">telemetry_settings</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dagster_telemetry_enabled_default</span>

    <span class="k">def</span> <span class="nf">upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">upgrading_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">print_fn</span><span class="p">(</span><span class="s2">&quot;Updating run storage...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">build_missing_indexes</span><span class="p">()</span>

            <span class="n">print_fn</span><span class="p">(</span><span class="s2">&quot;Updating event storage...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>

            <span class="n">print_fn</span><span class="p">(</span><span class="s2">&quot;Updating schedule storage...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">optimize_for_dagit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement_timeout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">optimize_for_dagit</span><span class="p">(</span><span class="n">statement_timeout</span><span class="o">=</span><span class="n">statement_timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">optimize_for_dagit</span><span class="p">(</span><span class="n">statement_timeout</span><span class="o">=</span><span class="n">statement_timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">optimize_for_dagit</span><span class="p">(</span><span class="n">statement_timeout</span><span class="o">=</span><span class="n">statement_timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reindex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">print_fn</span><span class="p">(</span><span class="s2">&quot;Checking for reindexing...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">print_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">print_fn</span><span class="p">)</span>
        <span class="n">print_fn</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_coordinator</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_log_manager</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="c1"># run storage</span>

    <span class="k">def</span> <span class="nf">get_run_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_historical_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.host_representation</span> <span class="kn">import</span> <span class="n">HistoricalPipeline</span>

        <span class="n">snapshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">)</span>
        <span class="n">parent_snapshot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span><span class="o">.</span><span class="n">parent_snapshot_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">HistoricalPipeline</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">),</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">parent_snapshot</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_historical_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_pipeline_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_execution_plan_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_execution_plan_snapshot</span><span class="p">(</span><span class="n">snapshot_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_stats_for_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_step_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">step_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_step_stats_for_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">step_keys</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_run_tags</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_run_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_run_group</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_run_for_pipeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_def</span><span class="p">,</span>
        <span class="n">execution_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">root_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent_run_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.execution.api</span> <span class="kn">import</span> <span class="n">create_execution_plan</span>
        <span class="kn">from</span> <span class="nn">dagster.core.execution.plan.plan</span> <span class="kn">import</span> <span class="n">ExecutionPlan</span>
        <span class="kn">from</span> <span class="nn">dagster.core.snap</span> <span class="kn">import</span> <span class="n">snapshot_from_execution_plan</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="s2">&quot;pipeline_def&quot;</span><span class="p">,</span> <span class="n">PipelineDefinition</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">execution_plan</span><span class="p">,</span> <span class="s2">&quot;execution_plan&quot;</span><span class="p">,</span> <span class="n">ExecutionPlan</span><span class="p">)</span>

        <span class="c1"># note that solids_to_execute is required to execute the solid subset, which is the</span>
        <span class="c1"># frozenset version of the previous solid_subset.</span>
        <span class="c1"># solid_selection is not required and will not be converted to solids_to_execute here.</span>
        <span class="c1"># i.e. this function doesn&#39;t handle solid queries.</span>
        <span class="c1"># solid_selection is only used to pass the user queries further down.</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_set_param</span><span class="p">(</span><span class="n">solids_to_execute</span><span class="p">,</span> <span class="s2">&quot;solids_to_execute&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">solid_selection</span><span class="p">,</span> <span class="s2">&quot;solid_selection&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">solids_to_execute</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pipeline_def</span><span class="p">,</span> <span class="n">PipelineSubsetDefinition</span><span class="p">):</span>
                <span class="c1"># for the case when pipeline_def is created by IPipeline or ExternalPipeline</span>
                <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                    <span class="n">solids_to_execute</span> <span class="o">==</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">,</span>
                    <span class="s2">&quot;Cannot create a PipelineRun from pipeline subset </span><span class="si">{pipeline_solids_to_execute}</span><span class="s2"> &quot;</span>
                    <span class="s2">&quot;that conflicts with solids_to_execute arg </span><span class="si">{solids_to_execute}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">pipeline_solids_to_execute</span><span class="o">=</span><span class="n">str_format_list</span><span class="p">(</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">solids_to_execute</span><span class="p">),</span>
                        <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">str_format_list</span><span class="p">(</span><span class="n">solids_to_execute</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for cases when `create_run_for_pipeline` is directly called</span>
                <span class="n">pipeline_def</span> <span class="o">=</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_pipeline_subset_def</span><span class="p">(</span>
                    <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span>
                <span class="p">)</span>

        <span class="n">full_execution_plan</span> <span class="o">=</span> <span class="n">execution_plan</span> <span class="ow">or</span> <span class="n">create_execution_plan</span><span class="p">(</span>
            <span class="n">pipeline_def</span><span class="p">,</span> <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">full_execution_plan</span><span class="o">.</span><span class="n">step_keys_to_execute</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_execution_plan</span><span class="o">.</span><span class="n">steps</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">is_memoized_run</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">dagster.core.execution.resolve_versions</span> <span class="kn">import</span> <span class="n">resolve_memoized_execution_plan</span>

            <span class="k">if</span> <span class="n">step_keys_to_execute</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DagsterInvariantViolationError</span><span class="p">(</span>
                    <span class="s2">&quot;step_keys_to_execute parameter cannot be used in conjunction with memoized &quot;</span>
                    <span class="s2">&quot;pipeline runs.&quot;</span>
                <span class="p">)</span>

            <span class="n">subsetted_execution_plan</span> <span class="o">=</span> <span class="n">resolve_memoized_execution_plan</span><span class="p">(</span>
                <span class="n">full_execution_plan</span>
            <span class="p">)</span>  <span class="c1"># TODO: tighter integration with existing step_keys_to_execute functionality</span>
            <span class="n">step_keys_to_execute</span> <span class="o">=</span> <span class="n">subsetted_execution_plan</span><span class="o">.</span><span class="n">step_keys_to_execute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subsetted_execution_plan</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">full_execution_plan</span><span class="o">.</span><span class="n">build_subset_plan</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">step_keys_to_execute</span>
                <span class="k">else</span> <span class="n">full_execution_plan</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_run</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_default_mode_name</span><span class="p">()),</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">root_run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span><span class="p">,</span>
            <span class="n">pipeline_snapshot</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_pipeline_snapshot</span><span class="p">(),</span>
            <span class="n">execution_plan_snapshot</span><span class="o">=</span><span class="n">snapshot_from_execution_plan</span><span class="p">(</span>
                <span class="n">subsetted_execution_plan</span><span class="p">,</span> <span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_pipeline_snapshot_id</span><span class="p">()</span>
            <span class="p">),</span>
            <span class="n">parent_pipeline_snapshot</span><span class="o">=</span><span class="n">pipeline_def</span><span class="o">.</span><span class="n">get_parent_pipeline_snapshot</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_run_with_snapshots</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_name</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">,</span>
        <span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="p">,</span>
        <span class="n">status</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">,</span>
        <span class="n">root_run_id</span><span class="p">,</span>
        <span class="n">parent_run_id</span><span class="p">,</span>
        <span class="n">pipeline_snapshot</span><span class="p">,</span>
        <span class="n">execution_plan_snapshot</span><span class="p">,</span>
        <span class="n">parent_pipeline_snapshot</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">external_pipeline_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># https://github.com/dagster-io/dagster/issues/2403</span>
        <span class="k">if</span> <span class="n">tags</span> <span class="ow">and</span> <span class="n">IS_AIRFLOW_INGEST_PIPELINE_STR</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AIRFLOW_EXECUTION_DATE_STR</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">tags</span><span class="p">[</span><span class="n">AIRFLOW_EXECUTION_DATE_STR</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_current_datetime_in_utc</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="ow">not</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pipeline_snapshot</span> <span class="ow">and</span> <span class="n">execution_plan_snapshot</span><span class="p">),</span>
            <span class="s2">&quot;It is illegal to have an execution plan snapshot and not have a pipeline snapshot. &quot;</span>
            <span class="s2">&quot;It is possible to have no execution plan snapshot since we persist runs &quot;</span>
            <span class="s2">&quot;that do not successfully compile execution plans in the scheduled case.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">pipeline_snapshot_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_persisted_pipeline_snapshot</span><span class="p">(</span><span class="n">pipeline_snapshot</span><span class="p">,</span> <span class="n">parent_pipeline_snapshot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pipeline_snapshot</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">execution_plan_snapshot_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_persisted_execution_plan_snapshot</span><span class="p">(</span>
                <span class="n">execution_plan_snapshot</span><span class="p">,</span> <span class="n">pipeline_snapshot_id</span><span class="p">,</span> <span class="n">step_keys_to_execute</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">execution_plan_snapshot</span> <span class="ow">and</span> <span class="n">pipeline_snapshot_id</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">PipelineRun</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">root_run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span><span class="p">,</span>
            <span class="n">pipeline_snapshot_id</span><span class="o">=</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span>
            <span class="n">execution_plan_snapshot_id</span><span class="o">=</span><span class="n">execution_plan_snapshot_id</span><span class="p">,</span>
            <span class="n">external_pipeline_origin</span><span class="o">=</span><span class="n">external_pipeline_origin</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_persisted_pipeline_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_snapshot</span><span class="p">,</span> <span class="n">parent_pipeline_snapshot</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.snap</span> <span class="kn">import</span> <span class="n">create_pipeline_snapshot_id</span><span class="p">,</span> <span class="n">PipelineSnapshot</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_snapshot</span><span class="p">,</span> <span class="s2">&quot;pipeline_snapshot&quot;</span><span class="p">,</span> <span class="n">PipelineSnapshot</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">parent_pipeline_snapshot</span><span class="p">,</span> <span class="s2">&quot;parent_pipeline_snapshot&quot;</span><span class="p">,</span> <span class="n">PipelineSnapshot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pipeline_snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_pipeline_snapshot</span><span class="p">(</span>
                <span class="n">pipeline_snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span><span class="o">.</span><span class="n">parent_snapshot_id</span>
            <span class="p">):</span>
                <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                    <span class="n">create_pipeline_snapshot_id</span><span class="p">(</span><span class="n">parent_pipeline_snapshot</span><span class="p">)</span>
                    <span class="o">==</span> <span class="n">pipeline_snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span><span class="o">.</span><span class="n">parent_snapshot_id</span><span class="p">,</span>
                    <span class="s2">&quot;Parent pipeline snapshot id out of sync with passed parent pipeline snapshot&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">returned_pipeline_snapshot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_pipeline_snapshot</span><span class="p">(</span>
                    <span class="n">parent_pipeline_snapshot</span>
                <span class="p">)</span>
                <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                    <span class="n">pipeline_snapshot</span><span class="o">.</span><span class="n">lineage_snapshot</span><span class="o">.</span><span class="n">parent_snapshot_id</span>
                    <span class="o">==</span> <span class="n">returned_pipeline_snapshot_id</span>
                <span class="p">)</span>

        <span class="n">pipeline_snapshot_id</span> <span class="o">=</span> <span class="n">create_pipeline_snapshot_id</span><span class="p">(</span><span class="n">pipeline_snapshot</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_pipeline_snapshot</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">):</span>
            <span class="n">returned_pipeline_snapshot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_pipeline_snapshot</span><span class="p">(</span>
                <span class="n">pipeline_snapshot</span>
            <span class="p">)</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span> <span class="o">==</span> <span class="n">returned_pipeline_snapshot_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pipeline_snapshot_id</span>

    <span class="k">def</span> <span class="nf">_ensure_persisted_execution_plan_snapshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">execution_plan_snapshot</span><span class="p">,</span> <span class="n">pipeline_snapshot_id</span><span class="p">,</span> <span class="n">step_keys_to_execute</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.snap.execution_plan_snapshot</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">ExecutionPlanSnapshot</span><span class="p">,</span>
            <span class="n">create_execution_plan_snapshot_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="p">,</span> <span class="s2">&quot;execution_plan_snapshot&quot;</span><span class="p">,</span> <span class="n">ExecutionPlanSnapshot</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span> <span class="s2">&quot;pipeline_snapshot_id&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">,</span> <span class="s2">&quot;step_keys_to_execute&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>

        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="n">execution_plan_snapshot</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span> <span class="o">==</span> <span class="n">pipeline_snapshot_id</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;Snapshot mismatch: Snapshot ID in execution plan snapshot is &quot;</span>
                <span class="s1">&#39;&quot;</span><span class="si">{ep_pipeline_snapshot_id}</span><span class="s1">&quot; and snapshot_id created in memory is &#39;</span>
                <span class="s1">&#39;&quot;</span><span class="si">{pipeline_snapshot_id}</span><span class="s1">&quot;&#39;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ep_pipeline_snapshot_id</span><span class="o">=</span><span class="n">execution_plan_snapshot</span><span class="o">.</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span>
                <span class="n">pipeline_snapshot_id</span><span class="o">=</span><span class="n">pipeline_snapshot_id</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">step_keys_to_execute</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="o">.</span><span class="n">step_keys_to_execute</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step_keys_to_execute</span>
            <span class="k">else</span> <span class="nb">set</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="o">.</span><span class="n">step_keys_to_execute</span><span class="p">)</span>
            <span class="o">==</span> <span class="nb">set</span><span class="p">([</span><span class="n">step</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">execution_plan_snapshot</span><span class="o">.</span><span class="n">steps</span><span class="p">]),</span>
            <span class="s2">&quot;We encode step_keys_to_execute twice in our stack, unfortunately. This check &quot;</span>
            <span class="s2">&quot;ensures that they are consistent. We check that step_keys_to_execute in the plan &quot;</span>
            <span class="s2">&quot;matches the step_keys_to_execute params if it is set. If it is not, this indicates &quot;</span>
            <span class="s2">&quot;a full execution plan, and so we verify that.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">execution_plan_snapshot_id</span> <span class="o">=</span> <span class="n">create_execution_plan_snapshot_id</span><span class="p">(</span><span class="n">execution_plan_snapshot</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_execution_plan_snapshot</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span><span class="p">):</span>
            <span class="n">returned_execution_plan_snapshot_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_execution_plan_snapshot</span><span class="p">(</span>
                <span class="n">execution_plan_snapshot</span>
            <span class="p">)</span>

            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span><span class="n">execution_plan_snapshot_id</span> <span class="o">==</span> <span class="n">returned_execution_plan_snapshot_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">execution_plan_snapshot_id</span>

    <span class="k">def</span> <span class="nf">create_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_name</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">,</span>
        <span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="p">,</span>
        <span class="n">status</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">,</span>
        <span class="n">root_run_id</span><span class="p">,</span>
        <span class="n">parent_run_id</span><span class="p">,</span>
        <span class="n">pipeline_snapshot</span><span class="p">,</span>
        <span class="n">execution_plan_snapshot</span><span class="p">,</span>
        <span class="n">parent_pipeline_snapshot</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">external_pipeline_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_run_with_snapshots</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">root_run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span><span class="p">,</span>
            <span class="n">pipeline_snapshot</span><span class="o">=</span><span class="n">pipeline_snapshot</span><span class="p">,</span>
            <span class="n">execution_plan_snapshot</span><span class="o">=</span><span class="n">execution_plan_snapshot</span><span class="p">,</span>
            <span class="n">parent_pipeline_snapshot</span><span class="o">=</span><span class="n">parent_pipeline_snapshot</span><span class="p">,</span>
            <span class="n">external_pipeline_origin</span><span class="o">=</span><span class="n">external_pipeline_origin</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_run</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_managed_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pipeline_name</span><span class="p">,</span>
        <span class="n">run_id</span><span class="p">,</span>
        <span class="n">run_config</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span>
        <span class="n">solids_to_execute</span><span class="p">,</span>
        <span class="n">step_keys_to_execute</span><span class="p">,</span>
        <span class="n">tags</span><span class="p">,</span>
        <span class="n">root_run_id</span><span class="p">,</span>
        <span class="n">parent_run_id</span><span class="p">,</span>
        <span class="n">pipeline_snapshot</span><span class="p">,</span>
        <span class="n">execution_plan_snapshot</span><span class="p">,</span>
        <span class="n">parent_pipeline_snapshot</span><span class="p">,</span>
        <span class="n">solid_selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># The usage of this method is limited to dagster-airflow, specifically in Dagster</span>
        <span class="c1"># Operators that are executed in Airflow. Because a common workflow in Airflow is to</span>
        <span class="c1"># retry dags from arbitrary tasks, we need any node to be capable of creating a</span>
        <span class="c1"># PipelineRun.</span>
        <span class="c1">#</span>
        <span class="c1"># The try-except DagsterRunAlreadyExists block handles the race when multiple &quot;root&quot; tasks</span>
        <span class="c1"># simultaneously execute self._run_storage.add_run(pipeline_run). When this happens, only</span>
        <span class="c1"># one task succeeds in creating the run, while the others get DagsterRunAlreadyExists</span>
        <span class="c1"># error; at this point, the failed tasks try again to fetch the existing run.</span>
        <span class="c1"># https://github.com/dagster-io/dagster/issues/2412</span>

        <span class="n">pipeline_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_run_with_snapshots</span><span class="p">(</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">run_config</span><span class="o">=</span><span class="n">run_config</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">solid_selection</span><span class="o">=</span><span class="n">solid_selection</span><span class="p">,</span>
            <span class="n">solids_to_execute</span><span class="o">=</span><span class="n">solids_to_execute</span><span class="p">,</span>
            <span class="n">step_keys_to_execute</span><span class="o">=</span><span class="n">step_keys_to_execute</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">PipelineRunStatus</span><span class="o">.</span><span class="n">MANAGED</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">root_run_id</span><span class="o">=</span><span class="n">root_run_id</span><span class="p">,</span>
            <span class="n">parent_run_id</span><span class="o">=</span><span class="n">parent_run_id</span><span class="p">,</span>
            <span class="n">pipeline_snapshot</span><span class="o">=</span><span class="n">pipeline_snapshot</span><span class="p">,</span>
            <span class="n">execution_plan_snapshot</span><span class="o">=</span><span class="n">execution_plan_snapshot</span><span class="p">,</span>
            <span class="n">parent_pipeline_snapshot</span><span class="o">=</span><span class="n">parent_pipeline_snapshot</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_run</span><span class="p">():</span>
            <span class="n">candidate_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">)</span>

            <span class="n">field_diff</span> <span class="o">=</span> <span class="n">_check_run_equality</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="n">candidate_run</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">field_diff</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DagsterRunConflict</span><span class="p">(</span>
                    <span class="s2">&quot;Found conflicting existing run with same id </span><span class="si">{run_id}</span><span class="s2">. Runs differ in:&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{field_diff}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span> <span class="n">field_diff</span><span class="o">=</span><span class="n">_format_field_diff</span><span class="p">(</span><span class="n">field_diff</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">candidate_run</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_run</span><span class="p">(</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">get_run</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_run</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DagsterRunAlreadyExists</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_run</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_run</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_run_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">handle_run_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_run_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_run_tags</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">new_tags</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">has_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_runs</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_runs_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_runs_count</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_run_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_run_groups</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wipe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">delete_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">delete_events</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="c1"># event storage</span>

    <span class="k">def</span> <span class="nf">logs_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">cursor</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_logs_for_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="n">cursor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_logs_for_run</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">watch_event_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span>

    <span class="c1"># asset storage</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_asset_aware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">is_asset_aware</span>

    <span class="k">def</span> <span class="nf">check_asset_aware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_asset_aware</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="s2">&quot;Asset queries can only be performed on instances with asset-aware event log &quot;</span>
                <span class="s2">&quot;storage. Use `instance.is_asset_aware` to verify that the instance is configured &quot;</span>
                <span class="s2">&quot;with an EventLogStorage that implements `AssetAwareEventLogStorage`&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_asset_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_asset_aware</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_all_asset_keys</span><span class="p">(</span><span class="n">prefix_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_asset_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_asset_aware</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">has_asset_key</span><span class="p">(</span><span class="n">asset_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">events_for_asset_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">,</span> <span class="n">partitions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cursor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">asset_key</span><span class="p">,</span> <span class="s2">&quot;asset_key&quot;</span><span class="p">,</span> <span class="n">AssetKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_asset_aware</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_asset_events</span><span class="p">(</span>
            <span class="n">asset_key</span><span class="p">,</span> <span class="n">partitions</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span><span class="p">,</span> <span class="n">include_cursor</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_ids_for_asset_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_key</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">asset_key</span><span class="p">,</span> <span class="s2">&quot;asset_key&quot;</span><span class="p">,</span> <span class="n">AssetKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_asset_aware</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_asset_run_ids</span><span class="p">(</span><span class="n">asset_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wipe_assets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asset_keys</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">list_param</span><span class="p">(</span><span class="n">asset_keys</span><span class="p">,</span> <span class="s2">&quot;asset_keys&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="n">AssetKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_asset_aware</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">asset_key</span> <span class="ow">in</span> <span class="n">asset_keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">wipe_asset</span><span class="p">(</span><span class="n">asset_key</span><span class="p">)</span>

    <span class="c1"># event subscriptions</span>

    <span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="s2">&quot;__event_listener&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">_EventListenerLogHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">handle_new_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">run_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">run_id</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">store_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_dagster_event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">dagster_event</span><span class="o">.</span><span class="n">is_pipeline_event</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">handle_run_event</span><span class="p">(</span><span class="n">run_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">dagster_event</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="n">run_id</span><span class="p">]:</span>
            <span class="n">sub</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_event_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="n">run_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>

<div class="viewcode-block" id="DagsterInstance.report_engine_event"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.report_engine_event">[docs]</a>    <span class="k">def</span> <span class="nf">report_engine_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">engine_event_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report a EngineEvent that occurred outside of a pipeline execution context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">EngineEventData</span><span class="p">,</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">DagsterEventRecord</span>

        <span class="n">check</span><span class="o">.</span><span class="n">class_param</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
        <span class="n">engine_event_data</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span>
            <span class="n">engine_event_data</span><span class="p">,</span> <span class="s2">&quot;engine_event_data&quot;</span><span class="p">,</span> <span class="n">EngineEventData</span><span class="p">,</span> <span class="n">EngineEventData</span><span class="p">([]),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
        <span class="k">if</span> <span class="n">engine_event_data</span> <span class="ow">and</span> <span class="n">engine_event_data</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span>

        <span class="n">dagster_event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="p">(</span>
            <span class="n">event_type_value</span><span class="o">=</span><span class="n">DagsterEventType</span><span class="o">.</span><span class="n">ENGINE_EVENT</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">event_specific_data</span><span class="o">=</span><span class="n">engine_event_data</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event_record</span> <span class="o">=</span> <span class="n">DagsterEventRecord</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">user_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">log_level</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">error_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">step_key</span><span class="o">=</span><span class="n">step_key</span><span class="p">,</span>
            <span class="n">dagster_event</span><span class="o">=</span><span class="n">dagster_event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event_record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dagster_event</span></div>

    <span class="k">def</span> <span class="nf">report_run_canceling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">DagsterEventRecord</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;Sending pipeline termination request.&quot;</span><span class="p">,)</span>
        <span class="n">canceling_event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="p">(</span>
            <span class="n">event_type_value</span><span class="o">=</span><span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_CANCELING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">event_record</span> <span class="o">=</span> <span class="n">DagsterEventRecord</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">user_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">error_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">dagster_event</span><span class="o">=</span><span class="n">canceling_event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event_record</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">report_run_canceled</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">DagsterEventRecord</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="s2">&quot;mesage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;This pipeline run has been marked as canceled from outside the execution context.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">dagster_event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="p">(</span>
            <span class="n">event_type_value</span><span class="o">=</span><span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_CANCELED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event_record</span> <span class="o">=</span> <span class="n">DagsterEventRecord</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">user_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">error_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">dagster_event</span><span class="o">=</span><span class="n">dagster_event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event_record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dagster_event</span>

    <span class="k">def</span> <span class="nf">report_run_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pipeline_run</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">DagsterEventRecord</span>

        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">pipeline_run</span><span class="p">,</span> <span class="s2">&quot;pipeline_run&quot;</span><span class="p">,</span> <span class="n">PipelineRun</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">,</span>
            <span class="s2">&quot;This pipeline run has been marked as failed from outside the execution context.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">dagster_event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="p">(</span>
            <span class="n">event_type_value</span><span class="o">=</span><span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_FAILURE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">event_record</span> <span class="o">=</span> <span class="n">DagsterEventRecord</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">user_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">pipeline_run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">error_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">dagster_event</span><span class="o">=</span><span class="n">dagster_event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event_record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dagster_event</span>

    <span class="c1"># directories</span>

    <span class="k">def</span> <span class="nf">file_manager_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span><span class="o">.</span><span class="n">file_manager_dir</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">intermediates_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span><span class="o">.</span><span class="n">intermediates_dir</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedules_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_artifact_storage</span><span class="o">.</span><span class="n">schedules_dir</span>

    <span class="c1"># Runs coordinator</span>

<div class="viewcode-block" id="DagsterInstance.submit_run"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.submit_run">[docs]</a>    <span class="k">def</span> <span class="nf">submit_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">external_pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Submit a pipeline run to the coordinator.</span>

<span class="sd">        This method delegates to the ``RunCoordinator``, configured on the instance, and will</span>
<span class="sd">        call its implementation of ``RunCoordinator.submit_run()`` to send the run to the</span>
<span class="sd">        coordinator for execution. Runs should be created in the instance (e.g., by calling</span>
<span class="sd">        ``DagsterInstance.create_run()``) *before* this method is called, and</span>
<span class="sd">        should be in the ``PipelineRunStatus.NOT_STARTED`` state. They also must have a non-null</span>
<span class="sd">        ExternalPipelineOrigin.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_id (str): The id of the run.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">dagster.core.host_representation</span> <span class="kn">import</span> <span class="n">ExternalPipelineOrigin</span>

        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst</span><span class="p">(</span>
            <span class="n">run</span><span class="o">.</span><span class="n">external_pipeline_origin</span><span class="p">,</span>
            <span class="n">ExternalPipelineOrigin</span><span class="p">,</span>
            <span class="s2">&quot;External pipeline origin must be set for submitted runs&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">submitted_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_coordinator</span><span class="o">.</span><span class="n">submit_run</span><span class="p">(</span>
                <span class="n">run</span><span class="p">,</span> <span class="n">external_pipeline</span><span class="o">=</span><span class="n">external_pipeline</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">EngineEventData</span>

            <span class="n">error</span> <span class="o">=</span> <span class="n">serializable_error_info_from_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_engine_event</span><span class="p">(</span>
                <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">EngineEventData</span><span class="o">.</span><span class="n">engine_error</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_run_failed</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">submitted_run</span></div>

    <span class="c1"># Run launcher</span>

<div class="viewcode-block" id="DagsterInstance.launch_run"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.launch_run">[docs]</a>    <span class="k">def</span> <span class="nf">launch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_id</span><span class="p">,</span> <span class="n">external_pipeline</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Launch a pipeline run.</span>

<span class="sd">        This method is typically called using `instance.submit_run` rather than being invoked</span>
<span class="sd">        directly. This method delegates to the ``RunLauncher``, if any, configured on the instance,</span>
<span class="sd">        and will call its implementation of ``RunLauncher.launch_run()`` to begin the execution of</span>
<span class="sd">        the specified run. Runs should be created in the instance (e.g., by calling</span>
<span class="sd">        ``DagsterInstance.create_run()``) *before* this method is called, and should be in the</span>
<span class="sd">        ``PipelineRunStatus.NOT_STARTED`` state.</span>

<span class="sd">        Args:</span>
<span class="sd">            run_id (str): The id of the run the launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">dagster.core.events</span> <span class="kn">import</span> <span class="n">EngineEventData</span><span class="p">,</span> <span class="n">DagsterEvent</span><span class="p">,</span> <span class="n">DagsterEventType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.events.log</span> <span class="kn">import</span> <span class="n">DagsterEventRecord</span>

        <span class="n">launch_started_event</span> <span class="o">=</span> <span class="n">DagsterEvent</span><span class="p">(</span>
            <span class="n">event_type_value</span><span class="o">=</span><span class="n">DagsterEventType</span><span class="o">.</span><span class="n">PIPELINE_STARTING</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">event_record</span> <span class="o">=</span> <span class="n">DagsterEventRecord</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">user_message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="n">pipeline_name</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">pipeline_name</span><span class="p">,</span>
            <span class="n">run_id</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">run_id</span><span class="p">,</span>
            <span class="n">error_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">timestamp</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">dagster_event</span><span class="o">=</span><span class="n">launch_started_event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handle_new_event</span><span class="p">(</span><span class="n">event_record</span><span class="p">)</span>

        <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_by_id</span><span class="p">(</span><span class="n">run_id</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_launcher</span><span class="o">.</span><span class="n">launch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">external_pipeline</span><span class="o">=</span><span class="n">external_pipeline</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">serializable_error_info_from_exc_info</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_engine_event</span><span class="p">(</span>
                <span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">EngineEventData</span><span class="o">.</span><span class="n">engine_error</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report_run_failed</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">run</span></div>

    <span class="c1"># Scheduler</span>

    <span class="k">def</span> <span class="nf">reconcile_scheduler_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_repository</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">reconcile_scheduler_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_repository</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">start_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">stop_schedule_and_update_storage_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_schedule_and_delete_from_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">stop_schedule_and_delete_from_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">running_schedule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">running_schedule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">scheduler_debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.scheduler</span> <span class="kn">import</span> <span class="n">SchedulerDebugInfo</span>
        <span class="kn">from</span> <span class="nn">dagster.core.definitions.job</span> <span class="kn">import</span> <span class="n">JobType</span>
        <span class="kn">from</span> <span class="nn">dagster.core.scheduler.job</span> <span class="kn">import</span> <span class="n">JobStatus</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">schedules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">schedule_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_stored_job_state</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="n">JobType</span><span class="o">.</span><span class="n">SCHEDULE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_schedule_count</span><span class="p">(</span>
                <span class="n">schedule_state</span><span class="o">.</span><span class="n">job_origin_id</span>
            <span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Schedule </span><span class="si">{schedule_name}</span><span class="s2"> is set to be running, but the scheduler is not &quot;</span>
                    <span class="s2">&quot;running the schedule.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schedule_name</span><span class="o">=</span><span class="n">schedule_state</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">STOPPED</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_schedule_count</span><span class="p">(</span>
                <span class="n">schedule_state</span><span class="o">.</span><span class="n">job_origin_id</span>
            <span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Schedule </span><span class="si">{schedule_name}</span><span class="s2"> is set to be stopped, but the scheduler is still running &quot;</span>
                    <span class="s2">&quot;the schedule.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schedule_name</span><span class="o">=</span><span class="n">schedule_state</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_schedule_count</span><span class="p">(</span><span class="n">schedule_state</span><span class="o">.</span><span class="n">job_origin_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;Duplicate jobs found: More than one job for schedule </span><span class="si">{schedule_name}</span><span class="s2"> are &quot;</span>
                    <span class="s2">&quot;running on the scheduler.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schedule_name</span><span class="o">=</span><span class="n">schedule_state</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">schedule_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">schedule_state</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;cron_schedule&quot;</span><span class="p">:</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">job_specific_data</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span>
                    <span class="s2">&quot;repository_pointer&quot;</span><span class="p">:</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">get_repo_cli_args</span><span class="p">(),</span>
                    <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">:</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">job_origin_id</span><span class="p">,</span>
                    <span class="s2">&quot;repository_origin_id&quot;</span><span class="p">:</span> <span class="n">schedule_state</span><span class="o">.</span><span class="n">repository_origin_id</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">schedules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">schedule_info</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">SchedulerDebugInfo</span><span class="p">(</span>
            <span class="n">scheduler_config_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info_str_for_component</span><span class="p">(</span><span class="s2">&quot;Scheduler&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="p">),</span>
            <span class="n">scheduler_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">debug_info</span><span class="p">(),</span>
            <span class="n">schedule_storage</span><span class="o">=</span><span class="n">schedules</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Schedule Storage</span>

    <span class="k">def</span> <span class="nf">start_sensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_sensor</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.scheduler.job</span> <span class="kn">import</span> <span class="n">JobState</span><span class="p">,</span> <span class="n">JobStatus</span><span class="p">,</span> <span class="n">SensorJobData</span>
        <span class="kn">from</span> <span class="nn">dagster.core.definitions.job</span> <span class="kn">import</span> <span class="n">JobType</span>

        <span class="n">job_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">external_sensor</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">job_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_job_state</span><span class="p">(</span>
                <span class="n">JobState</span><span class="p">(</span>
                    <span class="n">external_sensor</span><span class="o">.</span><span class="n">get_external_origin</span><span class="p">(),</span>
                    <span class="n">JobType</span><span class="o">.</span><span class="n">SENSOR</span><span class="p">,</span>
                    <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span>
                    <span class="n">SensorJobData</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">job_state</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">:</span>
            <span class="c1"># set the last completed time to the modified state time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span>
                <span class="n">job_state</span><span class="o">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">)</span><span class="o">.</span><span class="n">with_data</span><span class="p">(</span>
                    <span class="n">SensorJobData</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_sensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">dagster.core.scheduler.job</span> <span class="kn">import</span> <span class="n">JobStatus</span><span class="p">,</span> <span class="n">SensorJobData</span>

        <span class="n">job_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span>
                <span class="n">job_state</span><span class="o">.</span><span class="n">with_status</span><span class="p">(</span><span class="n">JobStatus</span><span class="o">.</span><span class="n">STOPPED</span><span class="p">)</span><span class="o">.</span><span class="n">with_data</span><span class="p">(</span>
                    <span class="n">SensorJobData</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">all_stored_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repository_origin_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">all_stored_job_state</span><span class="p">(</span><span class="n">repository_origin_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">get_job_state</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_state</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">add_job_state</span><span class="p">(</span><span class="n">job_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_state</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">update_job_state</span><span class="p">(</span><span class="n">job_state</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_job_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">delete_job_state</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_job_ticks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">get_job_ticks</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_latest_job_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">get_latest_job_tick</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_job_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_tick_data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">create_job_tick</span><span class="p">(</span><span class="n">job_tick_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_job_tick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tick</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">update_job_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_job_tick_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">get_job_tick_stats</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">purge_job_ticks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_origin_id</span><span class="p">,</span> <span class="n">tick_status</span><span class="p">,</span> <span class="n">before</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">purge_job_ticks</span><span class="p">(</span><span class="n">job_origin_id</span><span class="p">,</span> <span class="n">tick_status</span><span class="p">,</span> <span class="n">before</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">wipe_all_schedules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">wipe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule_storage</span><span class="o">.</span><span class="n">wipe</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">logs_path_for_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span><span class="o">.</span><span class="n">get_logs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>

<div class="viewcode-block" id="DagsterInstance.get_addresses_for_step_output_versions"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.get_addresses_for_step_output_versions">[docs]</a>    <span class="k">def</span> <span class="nf">get_addresses_for_step_output_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_output_versions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For each given step output, finds whether an output exists with the given</span>
<span class="sd">        version, and returns its address if it does.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_output_versions (Dict[(str, StepOutputHandle), str]):</span>
<span class="sd">                (pipeline name, step output handle) -&gt; version.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[(str, StepOutputHandle), str]: (pipeline name, step output handle) -&gt; address.</span>
<span class="sd">                For each step output, an address if there is one and None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_storage</span><span class="o">.</span><span class="n">get_addresses_for_step_output_versions</span><span class="p">(</span><span class="n">step_output_versions</span><span class="p">)</span></div>

    <span class="c1"># dagster daemon</span>
<div class="viewcode-block" id="DagsterInstance.add_daemon_heartbeat"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.add_daemon_heartbeat">[docs]</a>    <span class="k">def</span> <span class="nf">add_daemon_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">daemon_heartbeat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called on a regular interval by the daemon&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">add_daemon_heartbeat</span><span class="p">(</span><span class="n">daemon_heartbeat</span><span class="p">)</span></div>

<div class="viewcode-block" id="DagsterInstance.get_daemon_heartbeats"><a class="viewcode-back" href="../../../sections/api/apidocs/internals.html#dagster.DagsterInstance.get_daemon_heartbeats">[docs]</a>    <span class="k">def</span> <span class="nf">get_daemon_heartbeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Latest heartbeats of all daemon types&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">get_daemon_heartbeats</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">wipe_daemon_heartbeats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_storage</span><span class="o">.</span><span class="n">wipe_daemon_heartbeats</span><span class="p">()</span></div>
</pre></div>

            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>