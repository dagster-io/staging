
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>dagster_k8s.scheduler &#8212; Dagster</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
 
<link rel="stylesheet" href="../../_static/custom.css" type="text/css" />


<meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
    <div class="documentwrapper">
        <div class="bodywrapper">
            <div class="related top">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            

            

            <div class="body" role="main">
                
  <h1>Source code for dagster_k8s.scheduler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">kubernetes</span>
<span class="kn">from</span> <span class="nn">dagster</span> <span class="kn">import</span> <span class="n">DagsterInstance</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Noneable</span><span class="p">,</span> <span class="n">StringSource</span><span class="p">,</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">dagster.core.host_representation</span> <span class="kn">import</span> <span class="n">ExternalSchedule</span>
<span class="kn">from</span> <span class="nn">dagster.core.scheduler</span> <span class="kn">import</span> <span class="n">DagsterSchedulerError</span><span class="p">,</span> <span class="n">Scheduler</span>
<span class="kn">from</span> <span class="nn">dagster.serdes</span> <span class="kn">import</span> <span class="n">ConfigurableClass</span><span class="p">,</span> <span class="n">ConfigurableClassData</span>
<span class="kn">from</span> <span class="nn">dagster.utils</span> <span class="kn">import</span> <span class="n">merge_dicts</span>
<span class="kn">from</span> <span class="nn">dagster_k8s.job</span> <span class="kn">import</span> <span class="n">DagsterK8sJobConfig</span><span class="p">,</span> <span class="n">construct_dagster_k8s_job</span><span class="p">,</span> <span class="n">get_k8s_job_name</span>


<div class="viewcode-block" id="K8sScheduler"><a class="viewcode-back" href="../../sections/api/apidocs/libraries/dagster_k8s.html#dagster_k8s.K8sScheduler">[docs]</a><span class="k">class</span> <span class="nc">K8sScheduler</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">,</span> <span class="n">ConfigurableClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Scheduler implementation on top of Kubernetes CronJob.</span>

<span class="sd">    Enable this scheduler by adding it to your dagster.yaml, or by configuring the scheduler</span>
<span class="sd">    section of the Helm chart</span>
<span class="sd">    https://github.com/dagster-io/dagster/tree/master/helm&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dagster_home</span><span class="p">,</span>
        <span class="n">service_account_name</span><span class="p">,</span>
        <span class="n">instance_config_map</span><span class="p">,</span>
        <span class="n">postgres_password_secret</span><span class="p">,</span>
        <span class="n">job_image</span><span class="p">,</span>
        <span class="n">load_incluster_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">scheduler_namespace</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="n">image_pull_policy</span><span class="o">=</span><span class="s2">&quot;Always&quot;</span><span class="p">,</span>
        <span class="n">image_pull_secrets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">kubeconfig_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">inst_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">env_config_maps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">env_secrets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inst_data</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">opt_inst_param</span><span class="p">(</span><span class="n">inst_data</span><span class="p">,</span> <span class="s2">&quot;inst_data&quot;</span><span class="p">,</span> <span class="n">ConfigurableClassData</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">load_incluster_config</span><span class="p">:</span>
            <span class="n">check</span><span class="o">.</span><span class="n">invariant</span><span class="p">(</span>
                <span class="n">kubeconfig_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;`kubeconfig_file` is set but `load_incluster_config` is True.&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load_incluster_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check</span><span class="o">.</span><span class="n">opt_str_param</span><span class="p">(</span><span class="n">kubeconfig_file</span><span class="p">,</span> <span class="s2">&quot;kubeconfig_file&quot;</span><span class="p">)</span>
            <span class="n">kubernetes</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">load_kube_config</span><span class="p">(</span><span class="n">kubeconfig_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">BatchV1beta1Api</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">scheduler_namespace</span><span class="p">,</span> <span class="s2">&quot;scheduler_namespace&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grace_period_seconds</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># This should be passed in via config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">job_config</span> <span class="o">=</span> <span class="n">DagsterK8sJobConfig</span><span class="p">(</span>
            <span class="n">job_image</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">job_image</span><span class="p">,</span> <span class="s2">&quot;job_image&quot;</span><span class="p">),</span>
            <span class="n">dagster_home</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">dagster_home</span><span class="p">,</span> <span class="s2">&quot;dagster_home&quot;</span><span class="p">),</span>
            <span class="n">image_pull_policy</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">image_pull_policy</span><span class="p">,</span> <span class="s2">&quot;image_pull_policy&quot;</span><span class="p">),</span>
            <span class="n">image_pull_secrets</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span>
                <span class="n">image_pull_secrets</span><span class="p">,</span> <span class="s2">&quot;image_pull_secrets&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">dict</span>
            <span class="p">),</span>
            <span class="n">service_account_name</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">service_account_name</span><span class="p">,</span> <span class="s2">&quot;service_account_name&quot;</span><span class="p">),</span>
            <span class="n">instance_config_map</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">instance_config_map</span><span class="p">,</span> <span class="s2">&quot;instance_config_map&quot;</span><span class="p">),</span>
            <span class="n">postgres_password_secret</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span>
                <span class="n">postgres_password_secret</span><span class="p">,</span> <span class="s2">&quot;postgres_password_secret&quot;</span>
            <span class="p">),</span>
            <span class="n">env_config_maps</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">env_config_maps</span><span class="p">,</span> <span class="s2">&quot;env_config_maps&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">env_secrets</span><span class="o">=</span><span class="n">check</span><span class="o">.</span><span class="n">opt_list_param</span><span class="p">(</span><span class="n">env_secrets</span><span class="p">,</span> <span class="s2">&quot;env_secrets&quot;</span><span class="p">,</span> <span class="n">of_type</span><span class="o">=</span><span class="nb">str</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inst_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inst_data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">config_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">job_cfg</span> <span class="o">=</span> <span class="n">DagsterK8sJobConfig</span><span class="o">.</span><span class="n">config_type</span><span class="p">()</span>

        <span class="n">scheduler_extra_cfg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;scheduler_namespace&quot;</span><span class="p">:</span> <span class="n">Field</span><span class="p">(</span><span class="n">StringSource</span><span class="p">,</span> <span class="n">is_required</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;load_incluster_config&quot;</span><span class="p">:</span> <span class="n">Field</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">is_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;kubeconfig_file&quot;</span><span class="p">:</span> <span class="n">Field</span><span class="p">(</span><span class="n">Noneable</span><span class="p">(</span><span class="n">StringSource</span><span class="p">),</span> <span class="n">is_required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">merge_dicts</span><span class="p">(</span><span class="n">job_cfg</span><span class="p">,</span> <span class="n">scheduler_extra_cfg</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config_value</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inst_data</span><span class="p">,</span> <span class="n">config_value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">inst_data</span><span class="o">=</span><span class="n">inst_data</span><span class="p">,</span> <span class="o">**</span><span class="n">config_value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">debug_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Running K8s CronJob(s):</span><span class="se">\n</span><span class="si">{jobs}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">jobs</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_cron_jobs</span><span class="p">()])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">wipe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="c1"># Note: This method deletes schedules from ALL repositories</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">delete_collection_namespaced_cron_job</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grace_period_seconds</span><span class="p">)</span>

        <span class="c1"># Verify that no cron jobs are running</span>
        <span class="n">running_cron_job_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_all_cron_jobs</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">running_cron_job_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DagsterSchedulerError</span><span class="p">(</span>
                <span class="s2">&quot;Attempted to delete all K8s CronJobs but failed. There are &quot;</span>
                <span class="s2">&quot;still </span><span class="si">{}</span><span class="s2"> running schedules&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">running_cron_job_count</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_job_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="n">local_target</span> <span class="o">=</span> <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin</span><span class="p">()</span>

        <span class="n">job_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_config</span>

        <span class="n">external_schedule_name</span> <span class="o">=</span> <span class="n">external_schedule</span><span class="o">.</span><span class="n">name</span>
        <span class="n">job_name</span> <span class="o">=</span> <span class="n">get_k8s_job_name</span><span class="p">(</span><span class="n">external_schedule_name</span><span class="p">)</span>
        <span class="n">pod_name</span> <span class="o">=</span> <span class="n">job_name</span>

        <span class="n">job_template</span> <span class="o">=</span> <span class="n">construct_dagster_k8s_job</span><span class="p">(</span>
            <span class="n">job_config</span><span class="o">=</span><span class="n">job_config</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;dagster&quot;</span><span class="p">,</span>
                <span class="s2">&quot;api&quot;</span><span class="p">,</span>
                <span class="s2">&quot;launch_scheduled_execution&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/tmp/launch_scheduled_execution_output&quot;</span><span class="p">,</span>  <span class="c1"># https://bugs.python.org/issue20074 prevents using /dev/stdout</span>
                <span class="s2">&quot;--schedule_name&quot;</span><span class="p">,</span>
                <span class="n">external_schedule_name</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="o">+</span> <span class="n">local_target</span><span class="o">.</span><span class="n">get_repo_cli_args</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
            <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
            <span class="n">pod_name</span><span class="o">=</span><span class="n">pod_name</span><span class="p">,</span>
            <span class="n">component</span><span class="o">=</span><span class="s2">&quot;scheduled_job&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">job_template</span>

    <span class="k">def</span> <span class="nf">_start_cron_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="n">job_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_job_template</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">)</span>

        <span class="n">cron_job_spec</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1beta1CronJobSpec</span><span class="p">(</span>
            <span class="n">schedule</span><span class="o">=</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">cron_schedule</span><span class="p">,</span> <span class="n">job_template</span><span class="o">=</span><span class="n">job_template</span>
        <span class="p">)</span>

        <span class="n">schedule_origin_id</span> <span class="o">=</span> <span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">()</span>
        <span class="n">cron_job</span> <span class="o">=</span> <span class="n">kubernetes</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">V1beta1CronJob</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">=</span><span class="n">cron_job_spec</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">schedule_origin_id</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">existing_cron_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="o">=</span><span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_cron_job</span><span class="p">:</span>
            <span class="c1"># patch_namespaced_cron_job will cause the containers array to be additive</span>
            <span class="c1"># https://blog.atomist.com/kubernetes-apply-replace-patch/</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">replace_namespaced_cron_job</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">cron_job</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">create_namespaced_cron_job</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">cron_job</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grace_period_seconds</span><span class="p">)</span>

    <span class="c1"># Update the existing K8s CronJob if it exists; else, create it.</span>
    <span class="k">def</span> <span class="nf">start_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_cron_job</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">)</span>

        <span class="c1"># Verify that the cron job is running</span>
        <span class="n">cron_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="o">=</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">get_external_origin_id</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cron_job</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DagsterSchedulerError</span><span class="p">(</span>
                <span class="s2">&quot;Attempted to add K8s CronJob for schedule </span><span class="si">{schedule_name}</span><span class="s2">, but failed. &quot;</span>
                <span class="s2">&quot;The schedule </span><span class="si">{schedule_name}</span><span class="s2"> is not running.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schedule_name</span><span class="o">=</span><span class="n">external_schedule</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">refresh_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">external_schedule</span><span class="p">,</span> <span class="s2">&quot;external_schedule&quot;</span><span class="p">,</span> <span class="n">ExternalSchedule</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_schedule</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">external_schedule</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">running_schedule_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">get_cron_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="n">cron_jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">list_namespaced_cron_job</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cron_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">schedule_origin_id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_all_cron_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">list_namespaced_cron_job</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span><span class="o">.</span><span class="n">items</span>

    <span class="k">def</span> <span class="nf">_end_cron_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_api</span><span class="o">.</span><span class="n">delete_namespaced_cron_job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grace_period_seconds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop_schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="n">check</span><span class="o">.</span><span class="n">inst_param</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;instance&quot;</span><span class="p">,</span> <span class="n">DagsterInstance</span><span class="p">)</span>
        <span class="n">check</span><span class="o">.</span><span class="n">str_param</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">,</span> <span class="s2">&quot;schedule_origin_id&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_end_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="o">=</span><span class="n">schedule_origin_id</span><span class="p">)</span>

        <span class="n">cron_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cron_job</span><span class="p">(</span><span class="n">schedule_origin_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cron_job</span><span class="p">:</span>
            <span class="n">schedule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_schedule_state</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">DagsterSchedulerError</span><span class="p">(</span>
                <span class="s2">&quot;Attempted to remove existing K8s CronJob for schedule &quot;</span>
                <span class="s2">&quot;</span><span class="si">{schedule_name}</span><span class="s2">, but failed. Schedule is still running.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">schedule_name</span><span class="o">=</span><span class="n">schedule</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_logs_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">schedule_origin_id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;To get logs, inspect the corresponding K8s CronJob&quot;</span><span class="p">)</span></div>
</pre></div>

            </div>
            <div class="related bottom">
                &nbsp;
<nav id="rellinks">
    <ul>
        <li>
            <a href="/" title="Home">Home</a>
        </li>
    </ul>
</nav>
            </div>
            
        </div>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../index.html">Dagster</a></h3>

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel">Search</h2>
  <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
  </div>
</div>
<script type="text/javascript">
  $("#searchbox").show(0);
</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>


  </body>
</html>