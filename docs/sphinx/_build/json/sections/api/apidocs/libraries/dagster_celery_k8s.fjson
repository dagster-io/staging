{"parents": [], "prev": {"link": "../dagster_celery_docker/", "title": "Orchestration on Celery + Docker"}, "next": {"link": "../dagster_cron/", "title": "Cron (dagster_cron)"}, "title": "Orchestration on Celery + Kubernetes", "meta": null, "body": "<div class=\"section\" id=\"orchestration-on-celery-kubernetes\">\n<h1>Orchestration on Celery + Kubernetes<a class=\"headerlink\" href=\"#orchestration-on-celery-kubernetes\" title=\"Permalink to this headline\">\u00b6</a></h1>\n</div>\n<div class=\"section\" id=\"apis\">\n<h1>APIs<a class=\"headerlink\" href=\"#apis\" title=\"Permalink to this headline\">\u00b6</a></h1>\n<dl class=\"class\">\n<dt id=\"dagster_celery_k8s.CeleryK8sRunLauncher\">\n<em class=\"property\">class </em><code class=\"sig-prename descclassname\">dagster_celery_k8s.</code><code class=\"sig-name descname\">CeleryK8sRunLauncher</code><span class=\"sig-paren\">(</span><em class=\"sig-param\">instance_config_map</em>, <em class=\"sig-param\">dagster_home</em>, <em class=\"sig-param\">postgres_password_secret</em>, <em class=\"sig-param\">load_incluster_config=True</em>, <em class=\"sig-param\">kubeconfig_file=None</em>, <em class=\"sig-param\">broker=None</em>, <em class=\"sig-param\">backend=None</em>, <em class=\"sig-param\">include=None</em>, <em class=\"sig-param\">config_source=None</em>, <em class=\"sig-param\">retries=None</em>, <em class=\"sig-param\">inst_data=None</em>, <em class=\"sig-param\">k8s_client_batch_api=None</em><span class=\"sig-paren\">)</span><a class=\"reference internal\" href=\"../../../../../_modules/dagster_celery_k8s/launcher/#CeleryK8sRunLauncher\"><span class=\"viewcode-link\">[source]</span></a><a class=\"headerlink\" href=\"#dagster_celery_k8s.CeleryK8sRunLauncher\" title=\"Permalink to this definition\">\u00b6</a></dt>\n<dd><p>In contrast to the <code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">K8sRunLauncher</span></code>, which launches pipeline runs as single K8s\nJobs, this run launcher is intended for use in concert with\n<a class=\"reference internal\" href=\"#dagster_celery_k8s.celery_k8s_job_executor\" title=\"dagster_celery_k8s.celery_k8s_job_executor\"><code class=\"xref py py-func docutils literal notranslate\"><span class=\"pre\">dagster_celery_k8s.celery_k8s_job_executor()</span></code></a>.</p>\n<p>With this run launcher, execution is delegated to:</p>\n<blockquote>\n<div><ol class=\"arabic simple\">\n<li><p>A run coordinator Kubernetes Job, which traverses the pipeline run execution plan and\nsubmits steps to Celery queues for execution;</p></li>\n<li><p>The step executions which are submitted to Celery queues are picked up by Celery workers,\nand each step execution spawns a step execution Kubernetes Job. See the implementation\ndefined in <code class=\"xref py py-func docutils literal notranslate\"><span class=\"pre\">dagster_celery_k8.executor.create_k8s_job_task()</span></code>.</p></li>\n</ol>\n</div></blockquote>\n<p>You may configure a Dagster instance to use this RunLauncher by adding a section to your\n<code class=\"docutils literal notranslate\"><span class=\"pre\">dagster.yaml</span></code> like the following:</p>\n<div class=\"highlight-yaml notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nt\">run_launcher</span><span class=\"p\">:</span>\n  <span class=\"nt\">module</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">dagster_k8s.launcher</span>\n  <span class=\"nt\">class</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">CeleryK8sRunLauncher</span>\n  <span class=\"nt\">config</span><span class=\"p\">:</span>\n    <span class=\"nt\">instance_config_map</span><span class=\"p\">:</span> <span class=\"s\">&quot;dagster-k8s-instance-config-map&quot;</span>\n    <span class=\"nt\">dagster_home</span><span class=\"p\">:</span> <span class=\"s\">&quot;/some/path&quot;</span>\n    <span class=\"nt\">postgres_password_secret</span><span class=\"p\">:</span> <span class=\"s\">&quot;dagster-k8s-pg-password&quot;</span>\n    <span class=\"nt\">broker</span><span class=\"p\">:</span> <span class=\"s\">&quot;some_celery_broker_url&quot;</span>\n    <span class=\"nt\">backend</span><span class=\"p\">:</span> <span class=\"s\">&quot;some_celery_backend_url&quot;</span>\n</pre></div>\n</div>\n<p>As always when using a <a class=\"reference internal\" href=\"../../internals/#dagster.serdes.ConfigurableClass\" title=\"dagster.serdes.ConfigurableClass\"><code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">ConfigurableClass</span></code></a>, the values\nunder the <code class=\"docutils literal notranslate\"><span class=\"pre\">config</span></code> key of this YAML block will be passed to the constructor. The full list\nof acceptable values is given below by the constructor args.</p>\n<dl class=\"field-list simple\">\n<dt class=\"field-odd\">Parameters</dt>\n<dd class=\"field-odd\"><ul class=\"simple\">\n<li><p><strong>instance_config_map</strong> (<a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a>) \u2013 The <code class=\"docutils literal notranslate\"><span class=\"pre\">name</span></code> of an existing Volume to mount into the pod in\norder to provide a ConfigMap for the Dagster instance. This Volume should contain a\n<code class=\"docutils literal notranslate\"><span class=\"pre\">dagster.yaml</span></code> with appropriate values for run storage, event log storage, etc.</p></li>\n<li><p><strong>dagster_home</strong> (<a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a>) \u2013 The location of DAGSTER_HOME in the Job container; this is where the\n<code class=\"docutils literal notranslate\"><span class=\"pre\">dagster.yaml</span></code> file will be mounted from the instance ConfigMap specified above.</p></li>\n<li><p><strong>postgres_password_secret</strong> (<a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a>) \u2013 The name of the Kubernetes Secret where the postgres\npassword can be retrieved. Will be mounted and supplied as an environment variable to\nthe Job Pod.</p></li>\n<li><p><strong>load_incluster_config</strong> (<em>Optional</em><em>[</em><a class=\"reference external\" href=\"https://docs.python.org/3/library/functions.html#bool\" title=\"(in Python v3.8)\"><em>bool</em></a><em>]</em>) \u2013 Set this value if you are running the launcher\nwithin a k8s cluster. If <code class=\"docutils literal notranslate\"><span class=\"pre\">True</span></code>, we assume the launcher is running within the target\ncluster and load config using <code class=\"docutils literal notranslate\"><span class=\"pre\">kubernetes.config.load_incluster_config</span></code>. Otherwise,\nwe will use the k8s config specified in <code class=\"docutils literal notranslate\"><span class=\"pre\">kubeconfig_file</span></code> (using\n<code class=\"docutils literal notranslate\"><span class=\"pre\">kubernetes.config.load_kube_config</span></code>) or fall back to the default kubeconfig. Default:\n<code class=\"docutils literal notranslate\"><span class=\"pre\">True</span></code>.</p></li>\n<li><p><strong>kubeconfig_file</strong> (<em>Optional</em><em>[</em><a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a><em>]</em>) \u2013 The kubeconfig file from which to load config. Defaults to\nNone (using the default kubeconfig).</p></li>\n<li><p><strong>broker</strong> (<em>Optional</em><em>[</em><a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a><em>]</em>) \u2013 The URL of the Celery broker.</p></li>\n<li><p><strong>backend</strong> (<em>Optional</em><em>[</em><a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a><em>]</em>) \u2013 The URL of the Celery backend.</p></li>\n<li><p><strong>include</strong> (<em>List</em><em>[</em><a class=\"reference external\" href=\"https://docs.python.org/3/library/stdtypes.html#str\" title=\"(in Python v3.8)\"><em>str</em></a><em>]</em>) \u2013 List of includes for the Celery workers</p></li>\n<li><p><strong>config_source</strong> \u2013 (Optional[dict]): Additional settings for the Celery app.</p></li>\n<li><p><strong>retries</strong> \u2013 (Optional[dict]): Default retry configuration for Celery tasks.</p></li>\n</ul>\n</dd>\n</dl>\n</dd></dl>\n\n<dl class=\"data\">\n<dt id=\"dagster_celery_k8s.celery_k8s_job_executor\">\n<code class=\"sig-prename descclassname\">dagster_celery_k8s.</code><code class=\"sig-name descname\">celery_k8s_job_executor</code><em class=\"property\"> ExecutorDefinition</em><a class=\"reference internal\" href=\"../../../../../_modules/dagster_celery_k8s/executor/#celery_k8s_job_executor\"><span class=\"viewcode-link\">[source]</span></a><a class=\"headerlink\" href=\"#dagster_celery_k8s.celery_k8s_job_executor\" title=\"Permalink to this definition\">\u00b6</a></dt>\n<dd><p>Celery-based executor which launches tasks as Kubernetes Jobs.</p>\n<p>The Celery executor exposes config settings for the underlying Celery app under\nthe <code class=\"docutils literal notranslate\"><span class=\"pre\">config_source</span></code> key. This config corresponds to the \u201cnew lowercase settings\u201d introduced\nin Celery version 4.0 and the object constructed from config will be passed to the\n<a class=\"reference external\" href=\"http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery\" title=\"(in Celery v4.3)\"><code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">celery.Celery</span></code></a> constructor as its <code class=\"docutils literal notranslate\"><span class=\"pre\">config_source</span></code> argument.\n(See <a class=\"reference external\" href=\"https://docs.celeryproject.org/en/latest/userguide/configuration.html\">https://docs.celeryproject.org/en/latest/userguide/configuration.html</a> for details.)</p>\n<p>The executor also exposes the <code class=\"docutils literal notranslate\"><span class=\"pre\">broker</span></code>, <cite>backend</cite>, and <code class=\"docutils literal notranslate\"><span class=\"pre\">include</span></code> arguments to the\n<a class=\"reference external\" href=\"http://docs.celeryproject.org/en/latest/reference/celery.html#celery.Celery\" title=\"(in Celery v4.3)\"><code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">celery.Celery</span></code></a> constructor.</p>\n<p>In the most common case, you may want to modify the <code class=\"docutils literal notranslate\"><span class=\"pre\">broker</span></code> and <code class=\"docutils literal notranslate\"><span class=\"pre\">backend</span></code> (e.g., to use\nRedis instead of RabbitMQ). We expect that <code class=\"docutils literal notranslate\"><span class=\"pre\">config_source</span></code> will be less frequently\nmodified, but that when solid executions are especially fast or slow, or when there are\ndifferent requirements around idempotence or retry, it may make sense to execute pipelines\nwith variations on these settings.</p>\n<p>If you\u2019d like to configure a Celery Kubernetes Job executor in addition to the\n<a class=\"reference internal\" href=\"../../execution/#dagster.default_executors\" title=\"dagster.default_executors\"><code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">default_executors</span></code></a>, you should add it to the <code class=\"docutils literal notranslate\"><span class=\"pre\">executor_defs</span></code> defined on a\n<a class=\"reference internal\" href=\"../../modes-resources/#dagster.ModeDefinition\" title=\"dagster.ModeDefinition\"><code class=\"xref py py-class docutils literal notranslate\"><span class=\"pre\">ModeDefinition</span></code></a> as follows:</p>\n<p>Then you can configure the executor as follows:</p>\n<div class=\"highlight-YAML notranslate\"><div class=\"highlight\"><pre><span></span><span class=\"nt\">execution</span><span class=\"p\">:</span>\n  <span class=\"nt\">celery-k8s</span><span class=\"p\">:</span>\n    <span class=\"nt\">config</span><span class=\"p\">:</span>\n      <span class=\"nt\">job_image</span><span class=\"p\">:</span> <span class=\"s\">&#39;my_repo.com/image_name:latest&#39;</span>\n      <span class=\"nt\">job_namespace</span><span class=\"p\">:</span> <span class=\"s\">&#39;some-namespace&#39;</span>\n      <span class=\"nt\">broker</span><span class=\"p\">:</span> <span class=\"s\">&#39;pyamqp://guest@localhost//&#39;</span>  <span class=\"c1\"># Optional[str]: The URL of the Celery broker</span>\n      <span class=\"nt\">backend</span><span class=\"p\">:</span> <span class=\"s\">&#39;rpc://&#39;</span> <span class=\"c1\"># Optional[str]: The URL of the Celery results backend</span>\n      <span class=\"nt\">include</span><span class=\"p\">:</span> <span class=\"p p-Indicator\">[</span><span class=\"s\">&#39;my_module&#39;</span><span class=\"p p-Indicator\">]</span> <span class=\"c1\"># Optional[List[str]]: Modules every worker should import</span>\n      <span class=\"nt\">config_source</span><span class=\"p\">:</span> <span class=\"c1\"># Dict[str, Any]: Any additional parameters to pass to the</span>\n          <span class=\"c1\">#...       # Celery workers. This dict will be passed as the `config_source`</span>\n          <span class=\"c1\">#...       # argument of celery.Celery().</span>\n</pre></div>\n</div>\n<p>Note that the YAML you provide here must align with the configuration with which the Celery\nworkers on which you hope to run were started. If, for example, you point the executor at a\ndifferent broker than the one your workers are listening to, the workers will never be able to\npick up tasks for execution.</p>\n<p>In deployments where the celery_k8s_job_executor is used all appropriate celery and dagster_celery\ncommands must be invoked with the <cite>-A dagster_celery_k8s.app</cite> argument.</p>\n</dd></dl>\n\n</div>\n", "metatags": "", "rellinks": [["genindex", "General Index", "I", "index"], ["py-modindex", "Python Module Index", "", "modules"], ["sections/api/apidocs/libraries/dagster_cron", "Cron (dagster_cron)", "N", "next"], ["sections/api/apidocs/libraries/dagster_celery_docker", "Orchestration on Celery + Docker", "P", "previous"]], "sourcename": "sections/api/apidocs/libraries/dagster_celery_k8s.rst.txt", "toc": "<ul>\n<li><a class=\"reference internal\" href=\"#\">Orchestration on Celery + Kubernetes</a></li>\n<li><a class=\"reference internal\" href=\"#apis\">APIs</a></li>\n</ul>\n", "display_toc": true, "page_source_suffix": ".rst", "current_page_name": "sections/api/apidocs/libraries/dagster_celery_k8s", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}