{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_databricks.databricks", "body": "<h1>Source code for dagster_databricks.databricks</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">base64</span>\n<span class=\"kn\">import</span> <span class=\"nn\">time</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">dagster</span>\n<span class=\"kn\">import</span> <span class=\"nn\">requests.exceptions</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">databricks_api</span> <span class=\"kn\">import</span> <span class=\"n\">DatabricksAPI</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.types</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">DATABRICKS_RUN_TERMINATED_STATES</span><span class=\"p\">,</span>\n    <span class=\"n\">DatabricksRunLifeCycleState</span><span class=\"p\">,</span>\n    <span class=\"n\">DatabricksRunResultState</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"c1\"># wait at most 24 hours by default for run execution</span>\n<span class=\"n\">_DEFAULT_RUN_MAX_WAIT_TIME_SEC</span> <span class=\"o\">=</span> <span class=\"mi\">24</span> <span class=\"o\">*</span> <span class=\"mi\">60</span> <span class=\"o\">*</span> <span class=\"mi\">60</span>\n\n\n<div class=\"viewcode-block\" id=\"DatabricksError\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_databricks/#dagster_databricks.DatabricksError\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">DatabricksError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span>\n    <span class=\"k\">pass</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DatabricksClient</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;A thin wrapper over the Databricks REST API.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"p\">,</span> <span class=\"n\">workspace_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span> <span class=\"o\">=</span> <span class=\"n\">host</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">workspace_id</span> <span class=\"o\">=</span> <span class=\"n\">workspace_id</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">DatabricksAPI</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"o\">=</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"o\">=</span><span class=\"n\">token</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">submit_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Submit a run directly to the &#39;Runs Submit&#39; API.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">jobs</span><span class=\"o\">.</span><span class=\"n\">submit_run</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)[</span><span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">]</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">read_file</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">dbfs_path</span><span class=\"p\">,</span> <span class=\"n\">block_size</span><span class=\"o\">=</span><span class=\"mi\">1024</span> <span class=\"o\">**</span> <span class=\"mi\">2</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Read a file from DBFS to a **byte string**.&quot;&quot;&quot;</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">dbfs_path</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;dbfs://&quot;</span><span class=\"p\">):</span>\n            <span class=\"n\">dbfs_path</span> <span class=\"o\">=</span> <span class=\"n\">dbfs_path</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">:]</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"sa\">b</span><span class=\"s2\">&quot;&quot;</span>\n        <span class=\"n\">bytes_read</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">jdoc</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">dbfs</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">dbfs_path</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"o\">=</span><span class=\"n\">block_size</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n        <span class=\"n\">data</span> <span class=\"o\">+=</span> <span class=\"n\">base64</span><span class=\"o\">.</span><span class=\"n\">b64decode</span><span class=\"p\">(</span><span class=\"n\">jdoc</span><span class=\"p\">[</span><span class=\"s2\">&quot;data&quot;</span><span class=\"p\">])</span>\n        <span class=\"k\">while</span> <span class=\"n\">jdoc</span><span class=\"p\">[</span><span class=\"s2\">&quot;bytes_read&quot;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"n\">block_size</span><span class=\"p\">:</span>\n            <span class=\"n\">bytes_read</span> <span class=\"o\">+=</span> <span class=\"n\">jdoc</span><span class=\"p\">[</span><span class=\"s2\">&quot;bytes_read&quot;</span><span class=\"p\">]</span>\n            <span class=\"n\">jdoc</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">dbfs</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n                <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">dbfs_path</span><span class=\"p\">,</span> <span class=\"n\">offset</span><span class=\"o\">=</span><span class=\"n\">bytes_read</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"o\">=</span><span class=\"n\">block_size</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">data</span> <span class=\"o\">+=</span> <span class=\"n\">base64</span><span class=\"o\">.</span><span class=\"n\">b64decode</span><span class=\"p\">(</span><span class=\"n\">jdoc</span><span class=\"p\">[</span><span class=\"s2\">&quot;data&quot;</span><span class=\"p\">])</span>\n        <span class=\"k\">return</span> <span class=\"n\">data</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">put_file</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">file_obj</span><span class=\"p\">,</span> <span class=\"n\">dbfs_path</span><span class=\"p\">,</span> <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">block_size</span><span class=\"o\">=</span><span class=\"mi\">1024</span> <span class=\"o\">**</span> <span class=\"mi\">2</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Upload an arbitrary large file to DBFS.</span>\n\n<span class=\"sd\">        This doesn&#39;t use the DBFS `Put` API because that endpoint is limited to 1MB.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">dbfs_path</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;dbfs://&quot;</span><span class=\"p\">):</span>\n            <span class=\"n\">dbfs_path</span> <span class=\"o\">=</span> <span class=\"n\">dbfs_path</span><span class=\"p\">[</span><span class=\"mi\">7</span><span class=\"p\">:]</span>\n        <span class=\"n\">create_response</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">dbfs</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n            <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">dbfs_path</span><span class=\"p\">,</span> <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"n\">overwrite</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">handle</span> <span class=\"o\">=</span> <span class=\"n\">create_response</span><span class=\"p\">[</span><span class=\"s2\">&quot;handle&quot;</span><span class=\"p\">]</span>\n\n        <span class=\"n\">block</span> <span class=\"o\">=</span> <span class=\"n\">file_obj</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">block_size</span><span class=\"p\">)</span>\n        <span class=\"k\">while</span> <span class=\"n\">block</span><span class=\"p\">:</span>\n            <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">base64</span><span class=\"o\">.</span><span class=\"n\">b64encode</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">dbfs</span><span class=\"o\">.</span><span class=\"n\">add_block</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">handle</span><span class=\"o\">=</span><span class=\"n\">handle</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n            <span class=\"n\">block</span> <span class=\"o\">=</span> <span class=\"n\">file_obj</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">block_size</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">dbfs</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">(</span><span class=\"n\">handle</span><span class=\"o\">=</span><span class=\"n\">handle</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get the state of a run by Databricks run ID (_not_ dagster run ID).</span>\n\n<span class=\"sd\">        Return a `DatabricksRunState` object. Note that the `result_state`</span>\n<span class=\"sd\">        attribute may be `None` if the run hasn&#39;t yet terminated.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">jobs</span><span class=\"o\">.</span><span class=\"n\">get_run</span><span class=\"p\">(</span><span class=\"n\">databricks_run_id</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n        <span class=\"n\">state</span> <span class=\"o\">=</span> <span class=\"n\">run</span><span class=\"p\">[</span><span class=\"s2\">&quot;state&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">result_state</span> <span class=\"o\">=</span> <span class=\"n\">state</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;result_state&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">result_state</span><span class=\"p\">:</span>\n            <span class=\"n\">result_state</span> <span class=\"o\">=</span> <span class=\"n\">DatabricksRunResultState</span><span class=\"p\">(</span><span class=\"n\">result_state</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">DatabricksRunState</span><span class=\"p\">(</span>\n            <span class=\"n\">life_cycle_state</span><span class=\"o\">=</span><span class=\"n\">DatabricksRunLifeCycleState</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">[</span><span class=\"s2\">&quot;life_cycle_state&quot;</span><span class=\"p\">]),</span>\n            <span class=\"n\">result_state</span><span class=\"o\">=</span><span class=\"n\">result_state</span><span class=\"p\">,</span>\n            <span class=\"n\">state_message</span><span class=\"o\">=</span><span class=\"n\">state</span><span class=\"p\">[</span><span class=\"s2\">&quot;state_message&quot;</span><span class=\"p\">],</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DatabricksRunState</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;Represents the state of a Databricks job run.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">life_cycle_state</span><span class=\"p\">,</span> <span class=\"n\">result_state</span><span class=\"p\">,</span> <span class=\"n\">state_message</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">life_cycle_state</span> <span class=\"o\">=</span> <span class=\"n\">life_cycle_state</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">result_state</span> <span class=\"o\">=</span> <span class=\"n\">result_state</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">state_message</span> <span class=\"o\">=</span> <span class=\"n\">state_message</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_terminated</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Has the job terminated?&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">life_cycle_state</span> <span class=\"ow\">in</span> <span class=\"n\">DATABRICKS_RUN_TERMINATED_STATES</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">is_successful</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Was the job successful?&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">result_state</span> <span class=\"o\">==</span> <span class=\"n\">DatabricksRunResultState</span><span class=\"o\">.</span><span class=\"n\">Success</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DatabricksJobRunner</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;Submits jobs created using Dagster config to Databricks, and monitors their progress.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"p\">,</span> <span class=\"n\">poll_interval_sec</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">max_wait_time_sec</span><span class=\"o\">=</span><span class=\"n\">_DEFAULT_RUN_MAX_WAIT_TIME_SEC</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Args:</span>\n<span class=\"sd\">            host (str): Databricks host, e.g. https://uksouth.azuredatabricks.net</span>\n<span class=\"sd\">            token (str): Databricks token</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"s2\">&quot;host&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">token</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">token</span><span class=\"p\">,</span> <span class=\"s2\">&quot;token&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">poll_interval_sec</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">numeric_param</span><span class=\"p\">(</span><span class=\"n\">poll_interval_sec</span><span class=\"p\">,</span> <span class=\"s2\">&quot;poll_interval_sec&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">max_wait_time_sec</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">max_wait_time_sec</span><span class=\"p\">,</span> <span class=\"s2\">&quot;max_wait_time_sec&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_client</span> <span class=\"o\">=</span> <span class=\"n\">DatabricksClient</span><span class=\"p\">(</span><span class=\"n\">host</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">token</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">token</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">client</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the underlying `DatabricksClient` object.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_client</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">submit_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"n\">task</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Submit a new run using the &#39;Runs submit&#39; API.&quot;&quot;&quot;</span>\n        <span class=\"n\">existing_cluster_id</span> <span class=\"o\">=</span> <span class=\"n\">run_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;existing&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">new_cluster</span> <span class=\"o\">=</span> <span class=\"n\">run_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;new&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># The Databricks API needs different keys to be present in API calls depending</span>\n        <span class=\"c1\"># on new/existing cluster, so we need to process the new_cluster</span>\n        <span class=\"c1\"># config first.</span>\n        <span class=\"k\">if</span> <span class=\"n\">new_cluster</span><span class=\"p\">:</span>\n            <span class=\"n\">new_cluster</span> <span class=\"o\">=</span> <span class=\"n\">new_cluster</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n\n            <span class=\"n\">nodes</span> <span class=\"o\">=</span> <span class=\"n\">new_cluster</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"s2\">&quot;nodes&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"s2\">&quot;instance_pool_id&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">nodes</span><span class=\"p\">:</span>\n                <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;instance_pool_id&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">nodes</span><span class=\"p\">[</span><span class=\"s2\">&quot;instance_pool_id&quot;</span><span class=\"p\">]</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">node_types</span> <span class=\"o\">=</span> <span class=\"n\">nodes</span><span class=\"p\">[</span><span class=\"s2\">&quot;node_types&quot;</span><span class=\"p\">]</span>\n                <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;node_type_id&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">node_types</span><span class=\"p\">[</span><span class=\"s2\">&quot;node_type_id&quot;</span><span class=\"p\">]</span>\n                <span class=\"k\">if</span> <span class=\"s2\">&quot;driver_node_type_id&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">node_types</span><span class=\"p\">:</span>\n                    <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;driver_node_type_id&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">node_types</span><span class=\"p\">[</span><span class=\"s2\">&quot;driver_node_type_id&quot;</span><span class=\"p\">]</span>\n\n            <span class=\"n\">cluster_size</span> <span class=\"o\">=</span> <span class=\"n\">new_cluster</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"s2\">&quot;size&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"s2\">&quot;num_workers&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">cluster_size</span><span class=\"p\">:</span>\n                <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;num_workers&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">cluster_size</span><span class=\"p\">[</span><span class=\"s2\">&quot;num_workers&quot;</span><span class=\"p\">]</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;autoscale&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">cluster_size</span><span class=\"p\">[</span><span class=\"s2\">&quot;autoscale&quot;</span><span class=\"p\">]</span>\n\n            <span class=\"n\">tags</span> <span class=\"o\">=</span> <span class=\"n\">new_cluster</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;custom_tags&quot;</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n            <span class=\"n\">tags</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">({</span><span class=\"s2\">&quot;key&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;__dagster_version&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;value&quot;</span><span class=\"p\">:</span> <span class=\"n\">dagster</span><span class=\"o\">.</span><span class=\"n\">__version__</span><span class=\"p\">})</span>\n            <span class=\"n\">new_cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;custom_tags&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">tags</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">existing_cluster_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">or</span> <span class=\"n\">new_cluster</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;Invalid value for run_config.cluster&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"c1\"># We&#39;ll always need some libraries, namely dagster/dagster_databricks/dagster_pyspark,</span>\n        <span class=\"c1\"># since they&#39;re imported by our scripts.</span>\n        <span class=\"c1\"># Add them if they&#39;re not already added by users in config.</span>\n        <span class=\"n\">libraries</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">run_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;libraries&quot;</span><span class=\"p\">,</span> <span class=\"p\">[]))</span>\n        <span class=\"n\">python_libraries</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">x</span><span class=\"p\">[</span><span class=\"s2\">&quot;pypi&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;package&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"s2\">&quot;==&quot;</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">libraries</span> <span class=\"k\">if</span> <span class=\"s2\">&quot;pypi&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">x</span><span class=\"p\">}</span>\n        <span class=\"k\">for</span> <span class=\"n\">library</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;dagster_databricks&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;dagster_pyspark&quot;</span><span class=\"p\">]:</span>\n            <span class=\"k\">if</span> <span class=\"n\">library</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">python_libraries</span><span class=\"p\">:</span>\n                <span class=\"n\">libraries</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"p\">{</span><span class=\"s2\">&quot;pypi&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">&quot;package&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">==</span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">library</span><span class=\"p\">,</span> <span class=\"n\">dagster</span><span class=\"o\">.</span><span class=\"n\">__version__</span><span class=\"p\">)}}</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"c1\"># Only one task should be able to be chosen really; make sure of that here.</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"nb\">sum</span><span class=\"p\">(</span>\n                <span class=\"n\">task</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                <span class=\"k\">for</span> <span class=\"n\">key</span> <span class=\"ow\">in</span> <span class=\"p\">[</span>\n                    <span class=\"s2\">&quot;notebook_task&quot;</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;spark_python_task&quot;</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;spark_jar_task&quot;</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;spark_submit_task&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;Multiple tasks specified in Databricks run&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"nb\">dict</span><span class=\"p\">(</span>\n            <span class=\"n\">run_name</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;run_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">new_cluster</span><span class=\"o\">=</span><span class=\"n\">new_cluster</span><span class=\"p\">,</span>\n            <span class=\"n\">existing_cluster_id</span><span class=\"o\">=</span><span class=\"n\">existing_cluster_id</span><span class=\"p\">,</span>\n            <span class=\"n\">libraries</span><span class=\"o\">=</span><span class=\"n\">libraries</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">task</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">submit_run</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">config</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">retrieve_logs_for_run_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Retrieve the stdout and stderr logs for a run.&quot;&quot;&quot;</span>\n        <span class=\"n\">api_client</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">client</span>\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"n\">api_client</span><span class=\"o\">.</span><span class=\"n\">jobs</span><span class=\"o\">.</span><span class=\"n\">get_run</span><span class=\"p\">(</span><span class=\"n\">databricks_run_id</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n        <span class=\"n\">cluster</span> <span class=\"o\">=</span> <span class=\"n\">api_client</span><span class=\"o\">.</span><span class=\"n\">cluster</span><span class=\"o\">.</span><span class=\"n\">get_cluster</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-member</span>\n            <span class=\"n\">run</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster_instance&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;cluster_id&quot;</span><span class=\"p\">]</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">log_config</span> <span class=\"o\">=</span> <span class=\"n\">cluster</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;cluster_log_conf&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">log_config</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Logs not configured for cluster </span><span class=\"si\">{cluster}</span><span class=\"s2\"> used for run </span><span class=\"si\">{run}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">cluster</span><span class=\"o\">=</span><span class=\"n\">cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster_id&quot;</span><span class=\"p\">],</span> <span class=\"n\">run</span><span class=\"o\">=</span><span class=\"n\">databricks_run_id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;s3&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">log_config</span><span class=\"p\">:</span>\n            <span class=\"n\">logs_prefix</span> <span class=\"o\">=</span> <span class=\"n\">log_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;destination&quot;</span><span class=\"p\">]</span>\n            <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Retrieving S3 logs not yet implemented&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">elif</span> <span class=\"s2\">&quot;dbfs&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">log_config</span><span class=\"p\">:</span>\n            <span class=\"n\">logs_prefix</span> <span class=\"o\">=</span> <span class=\"n\">log_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;dbfs&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;destination&quot;</span><span class=\"p\">]</span>\n            <span class=\"n\">stdout</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">wait_for_dbfs_logs</span><span class=\"p\">(</span><span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">logs_prefix</span><span class=\"p\">,</span> <span class=\"n\">cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster_id&quot;</span><span class=\"p\">],</span> <span class=\"s2\">&quot;stdout&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">stderr</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">wait_for_dbfs_logs</span><span class=\"p\">(</span><span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">logs_prefix</span><span class=\"p\">,</span> <span class=\"n\">cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;cluster_id&quot;</span><span class=\"p\">],</span> <span class=\"s2\">&quot;stderr&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">stdout</span><span class=\"p\">,</span> <span class=\"n\">stderr</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wait_for_dbfs_logs</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"p\">,</span> <span class=\"n\">cluster_id</span><span class=\"p\">,</span> <span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"n\">waiter_delay</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span> <span class=\"n\">waiter_max_attempts</span><span class=\"o\">=</span><span class=\"mi\">10</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Attempt up to `waiter_max_attempts` attempts to get logs from DBFS.&quot;&quot;&quot;</span>\n        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;/&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">([</span><span class=\"n\">prefix</span><span class=\"p\">,</span> <span class=\"n\">cluster_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;driver&quot;</span><span class=\"p\">,</span> <span class=\"n\">filename</span><span class=\"p\">])</span>\n        <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Retrieving logs from </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">))</span>\n        <span class=\"n\">num_attempts</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"k\">while</span> <span class=\"n\">num_attempts</span> <span class=\"o\">&lt;=</span> <span class=\"n\">waiter_max_attempts</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">logs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">read_file</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">logs</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">HTTPError</span><span class=\"p\">:</span>\n                <span class=\"n\">num_attempts</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n                <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">waiter_delay</span><span class=\"p\">)</span>\n        <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Could not retrieve cluster logs!&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wait_for_run_to_complete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">wait_for_run_to_complete</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"p\">,</span> <span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">poll_interval_sec</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">max_wait_time_sec</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">wait_for_run_to_complete</span><span class=\"p\">(</span><span class=\"n\">client</span><span class=\"p\">,</span> <span class=\"n\">log</span><span class=\"p\">,</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">,</span> <span class=\"n\">poll_interval_sec</span><span class=\"p\">,</span> <span class=\"n\">max_wait_time_sec</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Wait for a Databricks run to complete.&quot;&quot;&quot;</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">databricks_run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;databricks_run_id&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Waiting for Databricks run </span><span class=\"si\">%s</span><span class=\"s2\"> to complete...&quot;</span> <span class=\"o\">%</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">)</span>\n    <span class=\"n\">start</span> <span class=\"o\">=</span> <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span>\n    <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n        <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">debug</span><span class=\"p\">(</span><span class=\"s2\">&quot;Waiting </span><span class=\"si\">%.1f</span><span class=\"s2\"> seconds...&quot;</span> <span class=\"o\">%</span> <span class=\"n\">poll_interval_sec</span><span class=\"p\">)</span>\n        <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">poll_interval_sec</span><span class=\"p\">)</span>\n        <span class=\"n\">run_state</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">get_run_state</span><span class=\"p\">(</span><span class=\"n\">databricks_run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">run_state</span><span class=\"o\">.</span><span class=\"n\">has_terminated</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">run_state</span><span class=\"o\">.</span><span class=\"n\">is_successful</span><span class=\"p\">():</span>\n                <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Run </span><span class=\"si\">%s</span><span class=\"s2\"> completed successfully&quot;</span> <span class=\"o\">%</span> <span class=\"n\">databricks_run_id</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">error_message</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;Run </span><span class=\"si\">%s</span><span class=\"s2\"> failed with result state: </span><span class=\"si\">%s</span><span class=\"s2\">. Message: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">databricks_run_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">run_state</span><span class=\"o\">.</span><span class=\"n\">result_state</span><span class=\"p\">,</span>\n                    <span class=\"n\">run_state</span><span class=\"o\">.</span><span class=\"n\">state_message</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"n\">error_message</span><span class=\"p\">)</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DatabricksError</span><span class=\"p\">(</span><span class=\"n\">error_message</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Run </span><span class=\"si\">%s</span><span class=\"s2\"> in state </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">databricks_run_id</span><span class=\"p\">,</span> <span class=\"n\">run_state</span><span class=\"p\">))</span>\n        <span class=\"k\">if</span> <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"n\">start</span> <span class=\"o\">&gt;</span> <span class=\"n\">max_wait_time_sec</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DatabricksError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Job run </span><span class=\"si\">{}</span><span class=\"s2\"> took more than </span><span class=\"si\">{}</span><span class=\"s2\">s to complete; failing&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">databricks_run_id</span><span class=\"p\">,</span> <span class=\"n\">max_wait_time_sec</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/dagster_databricks/databricks", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}