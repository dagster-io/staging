{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_databricks.solids", "body": "<h1>Source code for dagster_databricks.solids</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">InputDefinition</span><span class=\"p\">,</span> <span class=\"n\">Nothing</span><span class=\"p\">,</span> <span class=\"n\">OutputDefinition</span><span class=\"p\">,</span> <span class=\"n\">Permissive</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">solid</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.databricks</span> <span class=\"kn\">import</span> <span class=\"n\">wait_for_run_to_complete</span>\n\n<span class=\"n\">_START</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;start&quot;</span>\n\n<span class=\"n\">_DEFAULT_POLL_INTERVAL</span> <span class=\"o\">=</span> <span class=\"mi\">10</span>\n<span class=\"c1\"># wait at most 24 hours by default for run execution</span>\n<span class=\"n\">_DEFAULT_RUN_MAX_WAIT_TIME_SEC</span> <span class=\"o\">=</span> <span class=\"mi\">24</span> <span class=\"o\">*</span> <span class=\"mi\">60</span> <span class=\"o\">*</span> <span class=\"mi\">60</span>\n\n\n<div class=\"viewcode-block\" id=\"create_databricks_job_solid\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_databricks/#dagster_databricks.create_databricks_job_solid\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">create_databricks_job_solid</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;databricks_job&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">num_inputs</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n    <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"nb\">frozenset</span><span class=\"p\">([</span><span class=\"s2\">&quot;databricks_client&quot;</span><span class=\"p\">]),</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Creates a solid that launches a databricks job.</span>\n\n<span class=\"sd\">    As config, the solid accepts a blob of the form described in Databricks&#39; job API:</span>\n<span class=\"sd\">    https://docs.databricks.com/dev-tools/api/latest/jobs.html.</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        SolidDefinition: A solid definition.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">description</span><span class=\"p\">,</span> <span class=\"s2\">&quot;description&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">num_inputs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;num_inputs&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">set_param</span><span class=\"p\">(</span><span class=\"n\">required_resource_keys</span><span class=\"p\">,</span> <span class=\"s2\">&quot;required_resource_keys&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n\n    <span class=\"n\">input_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">InputDefinition</span><span class=\"p\">(</span><span class=\"s2\">&quot;input_&quot;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">),</span> <span class=\"n\">Nothing</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"n\">num_inputs</span><span class=\"p\">)]</span>\n\n    <span class=\"nd\">@solid</span><span class=\"p\">(</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"n\">description</span><span class=\"p\">,</span>\n        <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n            <span class=\"s2\">&quot;job&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n                <span class=\"n\">Permissive</span><span class=\"p\">(),</span>\n                <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;Databricks job run configuration, in the form described in &quot;</span>\n                <span class=\"s2\">&quot;Databricks&#39; job API: https://docs.databricks.com/dev-tools/api/latest/jobs.html&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">),</span>\n            <span class=\"s2\">&quot;poll_interval_sec&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n                <span class=\"nb\">float</span><span class=\"p\">,</span>\n                <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;Check whether the job is done at this interval.&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span>\n            <span class=\"p\">),</span>\n            <span class=\"s2\">&quot;max_wait_time_sec&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n                <span class=\"nb\">float</span><span class=\"p\">,</span>\n                <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;If the job is not complete after this length of time, raise an error.&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">24</span> <span class=\"o\">*</span> <span class=\"mi\">60</span> <span class=\"o\">*</span> <span class=\"mi\">60</span><span class=\"p\">),</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">},</span>\n        <span class=\"n\">input_defs</span><span class=\"o\">=</span><span class=\"n\">input_defs</span><span class=\"p\">,</span>\n        <span class=\"n\">output_defs</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">OutputDefinition</span><span class=\"p\">(</span><span class=\"n\">Nothing</span><span class=\"p\">)],</span>\n        <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"n\">required_resource_keys</span><span class=\"p\">,</span>\n        <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;kind&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;databricks&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">def</span> <span class=\"nf\">databricks_solid</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"n\">job_config</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;job&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">databricks_client</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">databricks_client</span>\n        <span class=\"n\">run_id</span> <span class=\"o\">=</span> <span class=\"n\">databricks_client</span><span class=\"o\">.</span><span class=\"n\">submit_run</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">job_config</span><span class=\"p\">)</span>\n\n        <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Launched databricks job with run id </span><span class=\"si\">{run_id}</span><span class=\"s2\">. UI: </span><span class=\"si\">{url}</span><span class=\"s2\">. Waiting to run to completion...&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">url</span><span class=\"o\">=</span><span class=\"n\">create_ui_url</span><span class=\"p\">(</span><span class=\"n\">databricks_client</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">wait_for_run_to_complete</span><span class=\"p\">(</span>\n            <span class=\"n\">databricks_client</span><span class=\"p\">,</span>\n            <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;poll_interval_sec&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;max_wait_time_sec&quot;</span><span class=\"p\">],</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">databricks_solid</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">create_ui_url</span><span class=\"p\">(</span><span class=\"n\">databricks_client</span><span class=\"p\">,</span> <span class=\"n\">solid_config</span><span class=\"p\">):</span>\n    <span class=\"n\">host</span> <span class=\"o\">=</span> <span class=\"n\">databricks_client</span><span class=\"o\">.</span><span class=\"n\">host</span>\n    <span class=\"n\">workspace_id</span> <span class=\"o\">=</span> <span class=\"n\">databricks_client</span><span class=\"o\">.</span><span class=\"n\">workspace_id</span> <span class=\"ow\">or</span> <span class=\"s2\">&quot;&lt;workspace_id&gt;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"s2\">&quot;existing_cluster_id&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;job&quot;</span><span class=\"p\">]:</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;https://</span><span class=\"si\">{host}</span><span class=\"s2\">/?o=</span><span class=\"si\">{workspace_id}</span><span class=\"s2\">#/setting/clusters/</span><span class=\"si\">{cluster_id}</span><span class=\"s2\">/sparkUi&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">host</span><span class=\"o\">=</span><span class=\"n\">host</span><span class=\"p\">,</span>\n            <span class=\"n\">workspace_id</span><span class=\"o\">=</span><span class=\"n\">workspace_id</span><span class=\"p\">,</span>\n            <span class=\"n\">cluster_id</span><span class=\"o\">=</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;job&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;existing_cluster_id&quot;</span><span class=\"p\">],</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;https://</span><span class=\"si\">{host}</span><span class=\"s2\">/?o=</span><span class=\"si\">{workspace_id}</span><span class=\"s2\">#joblist&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">host</span><span class=\"o\">=</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">workspace_id</span><span class=\"o\">=</span><span class=\"n\">workspace_id</span>\n        <span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/dagster_databricks/solids", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}