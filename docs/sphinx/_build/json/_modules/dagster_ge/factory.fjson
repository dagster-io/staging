{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_ge.factory", "body": "<h1>Source code for dagster_ge.factory</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">datetime</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">great_expectations</span> <span class=\"k\">as</span> <span class=\"nn\">ge</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">EventMetadataEntry</span><span class=\"p\">,</span>\n    <span class=\"n\">ExpectationResult</span><span class=\"p\">,</span>\n    <span class=\"n\">InputDefinition</span><span class=\"p\">,</span>\n    <span class=\"n\">Noneable</span><span class=\"p\">,</span>\n    <span class=\"n\">Output</span><span class=\"p\">,</span>\n    <span class=\"n\">OutputDefinition</span><span class=\"p\">,</span>\n    <span class=\"n\">StringSource</span><span class=\"p\">,</span>\n    <span class=\"n\">check</span><span class=\"p\">,</span>\n    <span class=\"n\">resource</span><span class=\"p\">,</span>\n    <span class=\"n\">solid</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster_pandas</span> <span class=\"kn\">import</span> <span class=\"n\">DataFrame</span>\n<span class=\"kn\">from</span> <span class=\"nn\">great_expectations.core</span> <span class=\"kn\">import</span> <span class=\"n\">convert_to_json_serializable</span>\n<span class=\"kn\">from</span> <span class=\"nn\">great_expectations.render.page_renderer_util</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">render_multiple_validation_result_pages_markdown</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"nd\">@resource</span><span class=\"p\">(</span><span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;ge_root_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">Noneable</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">)})</span>\n<span class=\"k\">def</span> <span class=\"nf\">ge_data_context</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;ge_root_dir&quot;</span><span class=\"p\">]</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">yield</span> <span class=\"n\">ge</span><span class=\"o\">.</span><span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">DataContext</span><span class=\"p\">()</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"k\">yield</span> <span class=\"n\">ge</span><span class=\"o\">.</span><span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">DataContext</span><span class=\"p\">(</span><span class=\"n\">context_root_dir</span><span class=\"o\">=</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;ge_root_dir&quot;</span><span class=\"p\">])</span>\n\n\n<div class=\"viewcode-block\" id=\"ge_validation_solid_factory\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_ge/#dagster_ge.ge_validation_solid_factory\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">ge_validation_solid_factory</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"p\">,</span>\n    <span class=\"n\">datasource_name</span><span class=\"p\">,</span>\n    <span class=\"n\">suite_name</span><span class=\"p\">,</span>\n    <span class=\"n\">validation_operator_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"n\">input_dagster_type</span><span class=\"o\">=</span><span class=\"n\">DataFrame</span><span class=\"p\">,</span>\n    <span class=\"n\">batch_kwargs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Generates solids for interacting with GE.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        name (str): the name of the solid</span>\n<span class=\"sd\">        datasource_name (str): the name of your DataSource, see your great_expectations.yml</span>\n<span class=\"sd\">        suite_name (str): the name of your expectation suite, see your great_expectations.yml</span>\n<span class=\"sd\">        validation_operator_name (Optional[str]): what validation operator to run  -- defaults to None,</span>\n<span class=\"sd\">                    which generates an ephemeral validator.</span>\n<span class=\"sd\">                    If you want to save data docs, use &#39;action_list_operator&#39;.</span>\n<span class=\"sd\">                    See https://docs.greatexpectations.io/en/latest/reference/core_concepts/validation_operators_and_actions.html</span>\n<span class=\"sd\">        input_dagster_type (DagsterType): the Dagster type used to type check the input to the</span>\n<span class=\"sd\">                    solid. Defaults to `dagster_pandas.DataFrame`.</span>\n<span class=\"sd\">        batch_kwargs (Optional[dict]): overrides the `batch_kwargs` parameter when calling the</span>\n<span class=\"sd\">                    `ge_data_context`&#39;s `get_batch` method. Defaults to `{&quot;dataset&quot;: dataset}`,</span>\n<span class=\"sd\">                    where `dataset` is the input to the generated solid.</span>\n\n<span class=\"sd\">    Returns:</span>\n<span class=\"sd\">        A solid that takes in a set of data and yields both an expectation with relevant metadata</span>\n<span class=\"sd\">        and an output with all the metadata (for user processing)</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">datasource_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;datasource_name&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">suite_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;suite_name&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">validation_operator_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;validation_operator_name&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">batch_kwargs</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">batch_kwargs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;batch_kwargs&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@solid</span><span class=\"p\">(</span>\n        <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">input_defs</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">InputDefinition</span><span class=\"p\">(</span><span class=\"s2\">&quot;dataset&quot;</span><span class=\"p\">,</span> <span class=\"n\">input_dagster_type</span><span class=\"p\">)],</span>\n        <span class=\"n\">output_defs</span><span class=\"o\">=</span><span class=\"p\">[</span>\n            <span class=\"n\">OutputDefinition</span><span class=\"p\">(</span>\n                <span class=\"n\">dagster_type</span><span class=\"o\">=</span><span class=\"nb\">dict</span><span class=\"p\">,</span>\n                <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;&quot;</span>\n<span class=\"s2\">        This solid yields an expectationResult with a structured dict of metadata from the GE suite,</span>\n<span class=\"s2\">        as well as the full result in case a user wants to process it differently.</span>\n<span class=\"s2\">        The structured dict contains both summary stats from the suite as well as expectation by expectation</span>\n<span class=\"s2\">        results/details.</span>\n<span class=\"s2\">        &quot;&quot;&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">],</span>\n        <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;ge_data_context&quot;</span><span class=\"p\">},</span>\n        <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;kind&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;ge&quot;</span><span class=\"p\">},</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">def</span> <span class=\"nf\">ge_validation_solid</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">dataset</span><span class=\"p\">):</span>\n        <span class=\"n\">data_context</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">ge_data_context</span>\n        <span class=\"k\">if</span> <span class=\"n\">validation_operator_name</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">validation_operator</span> <span class=\"o\">=</span> <span class=\"n\">validation_operator_name</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">add_validation_operator</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;ephemeral_validation&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">{</span><span class=\"s2\">&quot;class_name&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;ActionListValidationOperator&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;action_list&quot;</span><span class=\"p\">:</span> <span class=\"p\">[]},</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">validation_operator</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ephemeral_validation&quot;</span>\n        <span class=\"n\">suite</span> <span class=\"o\">=</span> <span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">get_expectation_suite</span><span class=\"p\">(</span><span class=\"n\">suite_name</span><span class=\"p\">)</span>\n        <span class=\"n\">final_batch_kwargs</span> <span class=\"o\">=</span> <span class=\"n\">batch_kwargs</span> <span class=\"ow\">or</span> <span class=\"p\">{</span><span class=\"s2\">&quot;dataset&quot;</span><span class=\"p\">:</span> <span class=\"n\">dataset</span><span class=\"p\">}</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;datasource&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">batch_kwargs</span><span class=\"p\">:</span>\n            <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;`datasource` field of `batch_kwargs` will be ignored; use the `datasource_name` &quot;</span>\n                <span class=\"s2\">&quot;parameter of the solid factory instead.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">final_batch_kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;datasource&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">datasource_name</span>\n        <span class=\"n\">batch</span> <span class=\"o\">=</span> <span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">get_batch</span><span class=\"p\">(</span><span class=\"n\">final_batch_kwargs</span><span class=\"p\">,</span> <span class=\"n\">suite</span><span class=\"p\">)</span>\n        <span class=\"n\">run_id</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;run_name&quot;</span><span class=\"p\">:</span> <span class=\"n\">datasource_name</span> <span class=\"o\">+</span> <span class=\"s2\">&quot; run&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;run_time&quot;</span><span class=\"p\">:</span> <span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">utcnow</span><span class=\"p\">(),</span>\n        <span class=\"p\">}</span>\n        <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">data_context</span><span class=\"o\">.</span><span class=\"n\">run_validation_operator</span><span class=\"p\">(</span>\n            <span class=\"n\">validation_operator</span><span class=\"p\">,</span> <span class=\"n\">assets_to_validate</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">batch</span><span class=\"p\">],</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">convert_to_json_serializable</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"o\">.</span><span class=\"n\">list_validation_results</span><span class=\"p\">())[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n        <span class=\"n\">md_str</span> <span class=\"o\">=</span> <span class=\"n\">render_multiple_validation_result_pages_markdown</span><span class=\"p\">(</span>\n            <span class=\"n\">validation_operator_result</span><span class=\"o\">=</span><span class=\"n\">results</span><span class=\"p\">,</span> <span class=\"n\">run_info_at_end</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">meta_stats</span> <span class=\"o\">=</span> <span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">md</span><span class=\"p\">(</span><span class=\"n\">md_str</span><span class=\"o\">=</span><span class=\"n\">md_str</span><span class=\"p\">,</span> <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"s2\">&quot;Expectation Results&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">yield</span> <span class=\"n\">ExpectationResult</span><span class=\"p\">(</span>\n            <span class=\"n\">success</span><span class=\"o\">=</span><span class=\"n\">res</span><span class=\"p\">[</span><span class=\"s2\">&quot;success&quot;</span><span class=\"p\">],</span> <span class=\"n\">metadata_entries</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">meta_stats</span><span class=\"p\">,],</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">yield</span> <span class=\"n\">Output</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">ge_validation_solid</span></div>\n</pre></div>", "current_page_name": "_modules/dagster_ge/factory", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}