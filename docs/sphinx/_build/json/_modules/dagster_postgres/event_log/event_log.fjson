{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_postgres.event_log.event_log", "body": "<h1>Source code for dagster_postgres.event_log.event_log</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">threading</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">psycopg2</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events.log</span> <span class=\"kn\">import</span> <span class=\"n\">EventRecord</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.event_log</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">AssetAwareSqlEventLogStorage</span><span class=\"p\">,</span>\n    <span class=\"n\">AssetKeyTable</span><span class=\"p\">,</span>\n    <span class=\"n\">SqlEventLogStorageMetadata</span><span class=\"p\">,</span>\n    <span class=\"n\">SqlEventLogStorageTable</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sql</span> <span class=\"kn\">import</span> <span class=\"n\">create_engine</span><span class=\"p\">,</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">,</span> <span class=\"n\">run_alembic_upgrade</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span>\n    <span class=\"n\">ConfigurableClassData</span><span class=\"p\">,</span>\n    <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..pynotify</span> <span class=\"kn\">import</span> <span class=\"n\">await_pg_notifications</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..utils</span> <span class=\"kn\">import</span> <span class=\"n\">create_pg_connection</span><span class=\"p\">,</span> <span class=\"n\">pg_config</span><span class=\"p\">,</span> <span class=\"n\">pg_statement_timeout</span><span class=\"p\">,</span> <span class=\"n\">pg_url_from_config</span>\n\n<span class=\"n\">CHANNEL_NAME</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;run_events&quot;</span>\n\n\n<div class=\"viewcode-block\" id=\"PostgresEventLogStorage\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_postgres/#dagster_postgres.PostgresEventLogStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PostgresEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">AssetAwareSqlEventLogStorage</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Postgres-backed event log storage.</span>\n\n<span class=\"sd\">    Users should not directly instantiate this class; it is instantiated by internal machinery when</span>\n<span class=\"sd\">    ``dagit`` and ``dagster-graphql`` load, based on the values in the ``dagster.yaml`` file in</span>\n<span class=\"sd\">    ``$DAGSTER_HOME``. Configuration of this class should be done by setting values in that file.</span>\n\n<span class=\"sd\">    To use Postgres for event log storage, you can add a block such as the following to your</span>\n<span class=\"sd\">    ``dagster.yaml``:</span>\n\n<span class=\"sd\">    .. literalinclude:: ../../../../../examples/docs_snippets/docs_snippets/deploying/dagster-pg.yaml</span>\n<span class=\"sd\">       :caption: dagster.yaml</span>\n<span class=\"sd\">       :lines: 12-21</span>\n<span class=\"sd\">       :language: YAML</span>\n\n<span class=\"sd\">    Note that the fields in this config are :py:class:`~dagster.StringSource` and</span>\n<span class=\"sd\">    :py:class:`~dagster.IntSource` and can be configured from environment variables.</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"s2\">&quot;postgres_url&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_disposed</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_watcher</span> <span class=\"o\">=</span> <span class=\"n\">PostgresEventWatcher</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Default to not holding any connections open to prevent accumulating connections per DagsterInstance</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"o\">.</span><span class=\"n\">NullPool</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">SqlEventLogStorageMetadata</span><span class=\"o\">.</span><span class=\"n\">create_all</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">statement_timeout</span><span class=\"p\">):</span>\n        <span class=\"c1\"># When running in dagit, hold an open connection and set statement_timeout</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span><span class=\"p\">,</span>\n            <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">pool_size</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n            <span class=\"n\">connect_args</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;options&quot;</span><span class=\"p\">:</span> <span class=\"n\">pg_statement_timeout</span><span class=\"p\">(</span><span class=\"n\">statement_timeout</span><span class=\"p\">)},</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">pg_config</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">PostgresEventLogStorage</span><span class=\"p\">(</span>\n            <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">postgres_url</span><span class=\"o\">=</span><span class=\"n\">pg_url_from_config</span><span class=\"p\">(</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">create_clean_storage</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">):</span>\n        <span class=\"n\">inst</span> <span class=\"o\">=</span> <span class=\"n\">PostgresEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">)</span>\n        <span class=\"n\">inst</span><span class=\"o\">.</span><span class=\"n\">wipe</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">inst</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">store_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Store an event corresponding to a pipeline run.</span>\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            event (EventRecord): The event to store.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event&quot;</span><span class=\"p\">,</span> <span class=\"n\">EventRecord</span><span class=\"p\">)</span>\n        <span class=\"n\">insert_event_statement</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prepare_insert_event</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span>  <span class=\"c1\"># from SqlEventLogStorage.py</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">result_proxy</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">insert_event_statement</span><span class=\"o\">.</span><span class=\"n\">returning</span><span class=\"p\">(</span>\n                    <span class=\"n\">SqlEventLogStorageTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">SqlEventLogStorageTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">()</span>\n            <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"sd\">&quot;&quot;&quot;NOTIFY {channel}, %s; &quot;&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">channel</span><span class=\"o\">=</span><span class=\"n\">CHANNEL_NAME</span><span class=\"p\">),</span>\n                <span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;_&quot;</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]),),</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">is_dagster_event</span> <span class=\"ow\">and</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"o\">.</span><span class=\"n\">asset_key</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">store_asset_key</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">store_asset_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event&quot;</span><span class=\"p\">,</span> <span class=\"n\">EventRecord</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">is_dagster_event</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"o\">.</span><span class=\"n\">asset_key</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">dialects</span><span class=\"o\">.</span><span class=\"n\">postgresql</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">AssetKeyTable</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"o\">=</span><span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"o\">.</span><span class=\"n\">asset_key</span><span class=\"o\">.</span><span class=\"n\">to_string</span><span class=\"p\">())</span>\n            <span class=\"o\">.</span><span class=\"n\">on_conflict_do_nothing</span><span class=\"p\">(</span><span class=\"n\">index_elements</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">AssetKeyTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">asset_key</span><span class=\"p\">])</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">create_pg_connection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span><span class=\"p\">,</span> <span class=\"vm\">__file__</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event log&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span><span class=\"p\">[</span><span class=\"n\">name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"nb\">super</span><span class=\"p\">(</span>\n                <span class=\"n\">PostgresEventLogStorage</span><span class=\"p\">,</span> <span class=\"bp\">self</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">has_secondary_index</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span><span class=\"p\">[</span><span class=\"n\">name</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">enable_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">PostgresEventLogStorage</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">enable_secondary_index</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span><span class=\"p\">:</span>\n            <span class=\"k\">del</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_secondary_index_cache</span><span class=\"p\">[</span><span class=\"n\">name</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_watcher</span><span class=\"o\">.</span><span class=\"n\">watch_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">end_watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">handler</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_watcher</span><span class=\"o\">.</span><span class=\"n\">unwatch_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">handler</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">event_watcher</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_watcher</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__del__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Keep the inherent limitations of __del__ in Python in mind!</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">dispose</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_disposed</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_disposed</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_watcher</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span></div>\n\n\n<span class=\"n\">EventWatcherProcessStartedEvent</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;EventWatcherProcessStartedEvent&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">EventWatcherStart</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;EventWatcherStart&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">EventWatcherEvent</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;EventWatcherEvent&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;payload&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">EventWatchFailed</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;EventWatchFailed&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;message&quot;</span><span class=\"p\">)</span>\n<span class=\"n\">EventWatcherEnd</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;EventWatcherEnd&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span>\n\n<span class=\"n\">EventWatcherThreadEvents</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n    <span class=\"n\">EventWatcherProcessStartedEvent</span><span class=\"p\">,</span>\n    <span class=\"n\">EventWatcherStart</span><span class=\"p\">,</span>\n    <span class=\"n\">EventWatcherEvent</span><span class=\"p\">,</span>\n    <span class=\"n\">EventWatchFailed</span><span class=\"p\">,</span>\n    <span class=\"n\">EventWatcherEnd</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"n\">EventWatcherThreadNoopEvents</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">EventWatcherProcessStartedEvent</span><span class=\"p\">,</span> <span class=\"n\">EventWatcherStart</span><span class=\"p\">)</span>\n<span class=\"n\">EventWatcherThreadEndEvents</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">EventWatchFailed</span><span class=\"p\">,</span> <span class=\"n\">EventWatcherEnd</span><span class=\"p\">)</span>\n\n<span class=\"n\">POLLING_CADENCE</span> <span class=\"o\">=</span> <span class=\"mf\">0.25</span>\n\n<span class=\"n\">TERMINATE_EVENT_LOOP</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;TERMINATE_EVENT_LOOP&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">watcher_thread</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">run_id_dict</span><span class=\"p\">,</span> <span class=\"n\">handlers_dict</span><span class=\"p\">,</span> <span class=\"n\">dict_lock</span><span class=\"p\">,</span> <span class=\"n\">watcher_thread_exit</span><span class=\"p\">):</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"k\">for</span> <span class=\"n\">notif</span> <span class=\"ow\">in</span> <span class=\"n\">await_pg_notifications</span><span class=\"p\">(</span>\n            <span class=\"n\">conn_string</span><span class=\"p\">,</span>\n            <span class=\"n\">channels</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">CHANNEL_NAME</span><span class=\"p\">],</span>\n            <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"n\">POLLING_CADENCE</span><span class=\"p\">,</span>\n            <span class=\"n\">yield_on_timeout</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">exit_event</span><span class=\"o\">=</span><span class=\"n\">watcher_thread_exit</span><span class=\"p\">,</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">notif</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">watcher_thread_exit</span><span class=\"o\">.</span><span class=\"n\">is_set</span><span class=\"p\">():</span>\n                    <span class=\"k\">break</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">index_str</span> <span class=\"o\">=</span> <span class=\"n\">notif</span><span class=\"o\">.</span><span class=\"n\">payload</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"s2\">&quot;_&quot;</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">run_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">run_id_dict</span><span class=\"p\">:</span>\n                    <span class=\"k\">continue</span>\n\n                <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">index_str</span><span class=\"p\">)</span>\n                <span class=\"k\">with</span> <span class=\"n\">dict_lock</span><span class=\"p\">:</span>\n                    <span class=\"n\">handlers</span> <span class=\"o\">=</span> <span class=\"n\">handlers_dict</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n                <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n                    <span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"o\">.</span><span class=\"n\">NullPool</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                        <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">SqlEventLogStorageTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">event</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n                            <span class=\"n\">SqlEventLogStorageTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span> <span class=\"o\">==</span> <span class=\"n\">index</span>\n                        <span class=\"p\">),</span>\n                    <span class=\"p\">)</span>\n                    <span class=\"n\">dagster_event</span> <span class=\"o\">=</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">()[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n                <span class=\"k\">finally</span><span class=\"p\">:</span>\n                    <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n\n                <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"n\">handlers</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">index</span> <span class=\"o\">&gt;=</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                        <span class=\"n\">callback</span><span class=\"p\">(</span><span class=\"n\">dagster_event</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">psycopg2</span><span class=\"o\">.</span><span class=\"n\">OperationalError</span><span class=\"p\">:</span>\n        <span class=\"k\">pass</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">PostgresEventWatcher</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">conn_string</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_dict_lock</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Lock</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span> <span class=\"o\">=</span> <span class=\"n\">conn_string</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread_exit</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_run_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_dict_lock</span><span class=\"p\">:</span>\n            <span class=\"n\">_has_run_id</span> <span class=\"o\">=</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span>\n        <span class=\"k\">return</span> <span class=\"n\">_has_run_id</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">watch_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread_exit</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Event</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Thread</span><span class=\"p\">(</span>\n                <span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">watcher_thread</span><span class=\"p\">,</span>\n                <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span><span class=\"p\">,</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span><span class=\"p\">,</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">,</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_dict_lock</span><span class=\"p\">,</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread_exit</span><span class=\"p\">,</span>\n                <span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span><span class=\"o\">.</span><span class=\"n\">daemon</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_dict_lock</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">))</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># See: https://docs.python.org/2/library/multiprocessing.html#multiprocessing.managers.SyncManager</span>\n                <span class=\"n\">run_id_dict</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span>\n                <span class=\"n\">run_id_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span> <span class=\"o\">=</span> <span class=\"n\">run_id_dict</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[(</span><span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">)]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">unwatch_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">handler</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_dict_lock</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                    <span class=\"p\">(</span><span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">)</span>\n                    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span>\n                    <span class=\"k\">if</span> <span class=\"n\">callback</span> <span class=\"o\">!=</span> <span class=\"n\">handler</span>\n                <span class=\"p\">]</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]:</span>\n                <span class=\"k\">del</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_handlers_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span>\n                <span class=\"n\">run_id_dict</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span>\n                <span class=\"k\">del</span> <span class=\"n\">run_id_dict</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_dict</span> <span class=\"o\">=</span> <span class=\"n\">run_id_dict</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">close</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread_exit</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread_exit</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watcher_thread</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</pre></div>", "current_page_name": "_modules/dagster_postgres/event_log/event_log", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}