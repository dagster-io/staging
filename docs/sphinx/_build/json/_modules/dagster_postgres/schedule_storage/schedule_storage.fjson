{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_postgres.schedule_storage.schedule_storage", "body": "<h1>Source code for dagster_postgres.schedule_storage.schedule_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.schedules</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleStorageSqlMetadata</span><span class=\"p\">,</span> <span class=\"n\">SqlScheduleStorage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sql</span> <span class=\"kn\">import</span> <span class=\"n\">create_engine</span><span class=\"p\">,</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">,</span> <span class=\"n\">run_alembic_upgrade</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..utils</span> <span class=\"kn\">import</span> <span class=\"n\">create_pg_connection</span><span class=\"p\">,</span> <span class=\"n\">pg_config</span><span class=\"p\">,</span> <span class=\"n\">pg_statement_timeout</span><span class=\"p\">,</span> <span class=\"n\">pg_url_from_config</span>\n\n\n<div class=\"viewcode-block\" id=\"PostgresScheduleStorage\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_postgres/#dagster_postgres.PostgresScheduleStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PostgresScheduleStorage</span><span class=\"p\">(</span><span class=\"n\">SqlScheduleStorage</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Postgres-backed run storage.</span>\n\n<span class=\"sd\">    Users should not directly instantiate this class; it is instantiated by internal machinery when</span>\n<span class=\"sd\">    ``dagit`` and ``dagster-graphql`` load, based on the values in the ``dagster.yaml`` file in</span>\n<span class=\"sd\">    ``$DAGSTER_HOME``. Configuration of this class should be done by setting values in that file.</span>\n\n<span class=\"sd\">    To use Postgres for schedule storage, you can add a block such as the following to your</span>\n<span class=\"sd\">    ``dagster.yaml``:</span>\n\n<span class=\"sd\">    .. literalinclude:: ../../../../../examples/docs_snippets/docs_snippets/deploying/dagster-pg.yaml</span>\n<span class=\"sd\">       :caption: dagster.yaml</span>\n<span class=\"sd\">       :lines: 23-32</span>\n<span class=\"sd\">       :language: YAML</span>\n\n<span class=\"sd\">    Note that the fields in this config are :py:class:`~dagster.StringSource` and</span>\n<span class=\"sd\">    :py:class:`~dagster.IntSource` and can be configured from environment variables.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span> <span class=\"o\">=</span> <span class=\"n\">postgres_url</span>\n\n        <span class=\"c1\"># Default to not holding any connections open to prevent accumulating connections per DagsterInstance</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"o\">.</span><span class=\"n\">NullPool</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">ScheduleStorageSqlMetadata</span><span class=\"o\">.</span><span class=\"n\">create_all</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">statement_timeout</span><span class=\"p\">):</span>\n        <span class=\"c1\"># When running in dagit, hold an open connection and set statement_timeout</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_url</span><span class=\"p\">,</span>\n            <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">pool_size</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span>\n            <span class=\"n\">connect_args</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;options&quot;</span><span class=\"p\">:</span> <span class=\"n\">pg_statement_timeout</span><span class=\"p\">(</span><span class=\"n\">statement_timeout</span><span class=\"p\">)},</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">pg_config</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">PostgresScheduleStorage</span><span class=\"p\">(</span>\n            <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">postgres_url</span><span class=\"o\">=</span><span class=\"n\">pg_url_from_config</span><span class=\"p\">(</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">create_clean_storage</span><span class=\"p\">(</span><span class=\"n\">postgres_url</span><span class=\"p\">):</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span>\n            <span class=\"n\">postgres_url</span><span class=\"p\">,</span> <span class=\"n\">isolation_level</span><span class=\"o\">=</span><span class=\"s2\">&quot;AUTOCOMMIT&quot;</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">pool</span><span class=\"o\">.</span><span class=\"n\">NullPool</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">ScheduleStorageSqlMetadata</span><span class=\"o\">.</span><span class=\"n\">drop_all</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">)</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">PostgresScheduleStorage</span><span class=\"p\">(</span><span class=\"n\">postgres_url</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>  <span class=\"c1\"># pylint: disable=arguments-differ, unused-argument</span>\n        <span class=\"k\">return</span> <span class=\"n\">create_pg_connection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span><span class=\"p\">,</span> <span class=\"vm\">__file__</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_engine</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster_postgres/schedule_storage/schedule_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}