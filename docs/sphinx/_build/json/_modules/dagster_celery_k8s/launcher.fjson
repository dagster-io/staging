{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_celery_k8s.launcher", "body": "<h1>Source code for dagster_celery_k8s.launcher</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n<span class=\"kn\">import</span> <span class=\"nn\">weakref</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">kubernetes</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">,</span> <span class=\"n\">EventMetadataEntry</span><span class=\"p\">,</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">Noneable</span><span class=\"p\">,</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config.field</span> <span class=\"kn\">import</span> <span class=\"n\">resolve_to_config_type</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config.validate</span> <span class=\"kn\">import</span> <span class=\"n\">process_config</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">EngineEventData</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.retries</span> <span class=\"kn\">import</span> <span class=\"n\">Retries</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">ExternalPipeline</span><span class=\"p\">,</span>\n    <span class=\"n\">GrpcServerRepositoryLocationHandle</span><span class=\"p\">,</span>\n    <span class=\"n\">GrpcServerRepositoryLocationOrigin</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.instance</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInstance</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.launcher</span> <span class=\"kn\">import</span> <span class=\"n\">RunLauncher</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.origin</span> <span class=\"kn\">import</span> <span class=\"n\">PipelinePythonOrigin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunStatus</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">,</span> <span class=\"n\">serialize_dagster_namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">frozentags</span><span class=\"p\">,</span> <span class=\"n\">merge_dicts</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils.error</span> <span class=\"kn\">import</span> <span class=\"n\">serializable_error_info_from_exc_info</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster_k8s.job</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">DagsterK8sJobConfig</span><span class=\"p\">,</span>\n    <span class=\"n\">construct_dagster_k8s_job</span><span class=\"p\">,</span>\n    <span class=\"n\">get_job_name_from_run_id</span><span class=\"p\">,</span>\n    <span class=\"n\">get_user_defined_k8s_config</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster_k8s.utils</span> <span class=\"kn\">import</span> <span class=\"n\">delete_job</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.config</span> <span class=\"kn\">import</span> <span class=\"n\">CELERY_K8S_CONFIG_KEY</span><span class=\"p\">,</span> <span class=\"n\">celery_k8s_config</span>\n\n\n<div class=\"viewcode-block\" id=\"CeleryK8sRunLauncher\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_celery_k8s/#dagster_celery_k8s.CeleryK8sRunLauncher\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">CeleryK8sRunLauncher</span><span class=\"p\">(</span><span class=\"n\">RunLauncher</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;In contrast to the :py:class:`K8sRunLauncher`, which launches pipeline runs as single K8s</span>\n<span class=\"sd\">    Jobs, this run launcher is intended for use in concert with</span>\n<span class=\"sd\">    :py:func:`dagster_celery_k8s.celery_k8s_job_executor`.</span>\n\n<span class=\"sd\">    With this run launcher, execution is delegated to:</span>\n\n<span class=\"sd\">        1. A run coordinator Kubernetes Job, which traverses the pipeline run execution plan and</span>\n<span class=\"sd\">           submits steps to Celery queues for execution;</span>\n<span class=\"sd\">        2. The step executions which are submitted to Celery queues are picked up by Celery workers,</span>\n<span class=\"sd\">           and each step execution spawns a step execution Kubernetes Job. See the implementation</span>\n<span class=\"sd\">           defined in :py:func:`dagster_celery_k8.executor.create_k8s_job_task`.</span>\n\n<span class=\"sd\">    You may configure a Dagster instance to use this RunLauncher by adding a section to your</span>\n<span class=\"sd\">    ``dagster.yaml`` like the following:</span>\n\n<span class=\"sd\">    .. code-block:: yaml</span>\n\n<span class=\"sd\">        run_launcher:</span>\n<span class=\"sd\">          module: dagster_k8s.launcher</span>\n<span class=\"sd\">          class: CeleryK8sRunLauncher</span>\n<span class=\"sd\">          config:</span>\n<span class=\"sd\">            instance_config_map: &quot;dagster-k8s-instance-config-map&quot;</span>\n<span class=\"sd\">            dagster_home: &quot;/some/path&quot;</span>\n<span class=\"sd\">            postgres_password_secret: &quot;dagster-k8s-pg-password&quot;</span>\n<span class=\"sd\">            broker: &quot;some_celery_broker_url&quot;</span>\n<span class=\"sd\">            backend: &quot;some_celery_backend_url&quot;</span>\n\n<span class=\"sd\">    As always when using a :py:class:`~dagster.serdes.ConfigurableClass`, the values</span>\n<span class=\"sd\">    under the ``config`` key of this YAML block will be passed to the constructor. The full list</span>\n<span class=\"sd\">    of acceptable values is given below by the constructor args.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        instance_config_map (str): The ``name`` of an existing Volume to mount into the pod in</span>\n<span class=\"sd\">            order to provide a ConfigMap for the Dagster instance. This Volume should contain a</span>\n<span class=\"sd\">            ``dagster.yaml`` with appropriate values for run storage, event log storage, etc.</span>\n<span class=\"sd\">        dagster_home (str): The location of DAGSTER_HOME in the Job container; this is where the</span>\n<span class=\"sd\">            ``dagster.yaml`` file will be mounted from the instance ConfigMap specified above.</span>\n<span class=\"sd\">        postgres_password_secret (str): The name of the Kubernetes Secret where the postgres</span>\n<span class=\"sd\">            password can be retrieved. Will be mounted and supplied as an environment variable to</span>\n<span class=\"sd\">            the Job Pod.</span>\n<span class=\"sd\">        load_incluster_config (Optional[bool]):  Set this value if you are running the launcher</span>\n<span class=\"sd\">            within a k8s cluster. If ``True``, we assume the launcher is running within the target</span>\n<span class=\"sd\">            cluster and load config using ``kubernetes.config.load_incluster_config``. Otherwise,</span>\n<span class=\"sd\">            we will use the k8s config specified in ``kubeconfig_file`` (using</span>\n<span class=\"sd\">            ``kubernetes.config.load_kube_config``) or fall back to the default kubeconfig. Default:</span>\n<span class=\"sd\">            ``True``.</span>\n<span class=\"sd\">        kubeconfig_file (Optional[str]): The kubeconfig file from which to load config. Defaults to</span>\n<span class=\"sd\">            None (using the default kubeconfig).</span>\n<span class=\"sd\">        broker (Optional[str]): The URL of the Celery broker.</span>\n<span class=\"sd\">        backend (Optional[str]): The URL of the Celery backend.</span>\n<span class=\"sd\">        include (List[str]): List of includes for the Celery workers</span>\n<span class=\"sd\">        config_source: (Optional[dict]): Additional settings for the Celery app.</span>\n<span class=\"sd\">        retries: (Optional[dict]): Default retry configuration for Celery tasks.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">instance_config_map</span><span class=\"p\">,</span>\n        <span class=\"n\">dagster_home</span><span class=\"p\">,</span>\n        <span class=\"n\">postgres_password_secret</span><span class=\"p\">,</span>\n        <span class=\"n\">load_incluster_config</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">kubeconfig_file</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">broker</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">config_source</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">retries</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">k8s_client_batch_api</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">load_incluster_config</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n                <span class=\"n\">kubeconfig_file</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;`kubeconfig_file` is set but `load_incluster_config` is True.&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">kubernetes</span><span class=\"o\">.</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">load_incluster_config</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">kubeconfig_file</span><span class=\"p\">,</span> <span class=\"s2\">&quot;kubeconfig_file&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">kubernetes</span><span class=\"o\">.</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">load_kube_config</span><span class=\"p\">(</span><span class=\"n\">kubeconfig_file</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_batch_api</span> <span class=\"o\">=</span> <span class=\"n\">k8s_client_batch_api</span> <span class=\"ow\">or</span> <span class=\"n\">kubernetes</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">BatchV1Api</span><span class=\"p\">()</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_config_map</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">instance_config_map</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance_config_map&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dagster_home</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">dagster_home</span><span class=\"p\">,</span> <span class=\"s2\">&quot;dagster_home&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_password_secret</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span>\n            <span class=\"n\">postgres_password_secret</span><span class=\"p\">,</span> <span class=\"s2\">&quot;postgres_password_secret&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">broker</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">broker</span><span class=\"p\">,</span> <span class=\"s2\">&quot;broker&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">backend</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">backend</span><span class=\"p\">,</span> <span class=\"s2\">&quot;backend&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">include</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_list_param</span><span class=\"p\">(</span><span class=\"n\">include</span><span class=\"p\">,</span> <span class=\"s2\">&quot;include&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config_source</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">config_source</span><span class=\"p\">,</span> <span class=\"s2\">&quot;config_source&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">retries</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">retries</span><span class=\"p\">,</span> <span class=\"s2\">&quot;retries&quot;</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">{</span><span class=\"s2\">&quot;enabled&quot;</span><span class=\"p\">:</span> <span class=\"p\">{}}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">retries</span> <span class=\"o\">=</span> <span class=\"n\">Retries</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">retries</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_ref</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Include all arguments required for DagsterK8sJobConfig along with additional arguments</span>\n<span class=\"sd\">        needed for the RunLauncher itself.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster_celery.executor</span> <span class=\"kn\">import</span> <span class=\"n\">CELERY_CONFIG</span>\n\n        <span class=\"n\">job_cfg</span> <span class=\"o\">=</span> <span class=\"n\">DagsterK8sJobConfig</span><span class=\"o\">.</span><span class=\"n\">config_type_run_launcher</span><span class=\"p\">()</span>\n\n        <span class=\"n\">run_launcher_extra_cfg</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;load_incluster_config&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;kubeconfig_file&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">Noneable</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">),</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">),</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">job_cfg</span><span class=\"p\">,</span> <span class=\"n\">run_launcher_extra_cfg</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">,</span> <span class=\"n\">CELERY_CONFIG</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_instance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_ref</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_ref</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">initialize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Store a weakref to avoid a circular reference / enable GC</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_ref</span> <span class=\"o\">=</span> <span class=\"n\">weakref</span><span class=\"o\">.</span><span class=\"n\">ref</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">launch_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">external_pipeline</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_pipeline&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalPipeline</span><span class=\"p\">)</span>\n\n        <span class=\"n\">job_name</span> <span class=\"o\">=</span> <span class=\"n\">get_job_name_from_run_id</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">pod_name</span> <span class=\"o\">=</span> <span class=\"n\">job_name</span>\n        <span class=\"n\">exc_config</span> <span class=\"o\">=</span> <span class=\"n\">_get_validated_celery_k8s_executor_config</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_config</span><span class=\"p\">)</span>\n\n        <span class=\"n\">job_image</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">pipeline_origin</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">env_vars</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span>\n            <span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">get_external_origin</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">external_repository_origin</span><span class=\"o\">.</span><span class=\"n\">repository_location_origin</span><span class=\"p\">,</span>\n            <span class=\"n\">GrpcServerRepositoryLocationOrigin</span><span class=\"p\">,</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;job_image&quot;</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Cannot specify job_image in executor config when loading pipeline &quot;</span>\n                    <span class=\"s2\">&quot;from GRPC server.&quot;</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">repository_location_handle</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">repository_handle</span><span class=\"o\">.</span><span class=\"n\">repository_location_handle</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_location_handle</span><span class=\"p\">,</span> <span class=\"n\">GrpcServerRepositoryLocationHandle</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Expected RepositoryLocationHandle to be of type &quot;</span>\n                    <span class=\"s2\">&quot;GrpcServerRepositoryLocationHandle but found type </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">repository_location_handle</span><span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">repository_name</span> <span class=\"o\">=</span> <span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">repository_handle</span><span class=\"o\">.</span><span class=\"n\">repository_name</span>\n\n            <span class=\"n\">repository_origin</span> <span class=\"o\">=</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">reload_repository_python_origin</span><span class=\"p\">(</span>\n                <span class=\"n\">repository_name</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">job_image</span> <span class=\"o\">=</span> <span class=\"n\">repository_origin</span><span class=\"o\">.</span><span class=\"n\">container_image</span>\n            <span class=\"n\">env_vars</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s2\">&quot;DAGSTER_CURRENT_IMAGE&quot;</span><span class=\"p\">:</span> <span class=\"n\">job_image</span><span class=\"p\">}</span>\n\n            <span class=\"n\">pipeline_origin</span> <span class=\"o\">=</span> <span class=\"n\">PipelinePythonOrigin</span><span class=\"p\">(</span>\n                <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">repository_origin</span><span class=\"o\">=</span><span class=\"n\">repository_origin</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">job_image</span> <span class=\"o\">=</span> <span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;job_image&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">job_image</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Cannot find job_image in celery-k8s executor config.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">pipeline_origin</span> <span class=\"o\">=</span> <span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">get_python_origin</span><span class=\"p\">()</span>\n\n        <span class=\"n\">job_config</span> <span class=\"o\">=</span> <span class=\"n\">DagsterK8sJobConfig</span><span class=\"p\">(</span>\n            <span class=\"n\">dagster_home</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dagster_home</span><span class=\"p\">,</span>\n            <span class=\"n\">instance_config_map</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_config_map</span><span class=\"p\">,</span>\n            <span class=\"n\">postgres_password_secret</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">postgres_password_secret</span><span class=\"p\">,</span>\n            <span class=\"n\">job_image</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">job_image</span><span class=\"p\">,</span> <span class=\"s2\">&quot;job_image&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">image_pull_policy</span><span class=\"o\">=</span><span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;image_pull_policy&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">image_pull_secrets</span><span class=\"o\">=</span><span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;image_pull_secrets&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">service_account_name</span><span class=\"o\">=</span><span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;service_account_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">env_config_maps</span><span class=\"o\">=</span><span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;env_config_maps&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">env_secrets</span><span class=\"o\">=</span><span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;env_secrets&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">user_defined_k8s_config</span> <span class=\"o\">=</span> <span class=\"n\">get_user_defined_k8s_config</span><span class=\"p\">(</span><span class=\"n\">frozentags</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">))</span>\n\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.cli.api</span> <span class=\"kn\">import</span> <span class=\"n\">ExecuteRunArgs</span>\n\n        <span class=\"n\">input_json</span> <span class=\"o\">=</span> <span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span>\n            <span class=\"c1\"># depends on DagsterInstance.get() returning the same instance</span>\n            <span class=\"c1\"># https://github.com/dagster-io/dagster/issues/2757</span>\n            <span class=\"n\">ExecuteRunArgs</span><span class=\"p\">(</span>\n                <span class=\"n\">pipeline_origin</span><span class=\"o\">=</span><span class=\"n\">pipeline_origin</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run_id</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">instance_ref</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">job</span> <span class=\"o\">=</span> <span class=\"n\">construct_dagster_k8s_job</span><span class=\"p\">(</span>\n            <span class=\"n\">job_config</span><span class=\"p\">,</span>\n            <span class=\"n\">command</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s2\">&quot;api&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execute_run_with_structured_logs&quot;</span><span class=\"p\">,</span> <span class=\"n\">input_json</span><span class=\"p\">],</span>\n            <span class=\"n\">job_name</span><span class=\"o\">=</span><span class=\"n\">job_name</span><span class=\"p\">,</span>\n            <span class=\"n\">pod_name</span><span class=\"o\">=</span><span class=\"n\">pod_name</span><span class=\"p\">,</span>\n            <span class=\"n\">component</span><span class=\"o\">=</span><span class=\"s2\">&quot;run_coordinator&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">user_defined_k8s_config</span><span class=\"o\">=</span><span class=\"n\">user_defined_k8s_config</span><span class=\"p\">,</span>\n            <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"n\">env_vars</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">job_namespace</span> <span class=\"o\">=</span> <span class=\"n\">exc_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;job_namespace&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_batch_api</span><span class=\"o\">.</span><span class=\"n\">create_namespaced_job</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"o\">=</span><span class=\"n\">job</span><span class=\"p\">,</span> <span class=\"n\">namespace</span><span class=\"o\">=</span><span class=\"n\">job_namespace</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Kubernetes run_coordinator job launched&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">run</span><span class=\"p\">,</span>\n            <span class=\"n\">EngineEventData</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span>\n                    <span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">(</span><span class=\"n\">job_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Kubernetes Job name&quot;</span><span class=\"p\">),</span>\n                    <span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">(</span><span class=\"n\">job_namespace</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Kubernetes Namespace&quot;</span><span class=\"p\">),</span>\n                    <span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">text</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Run ID&quot;</span><span class=\"p\">),</span>\n                <span class=\"p\">]</span>\n            <span class=\"p\">),</span>\n            <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">run</span>\n\n    <span class=\"c1\"># https://github.com/dagster-io/dagster/issues/2741</span>\n    <span class=\"k\">def</span> <span class=\"nf\">can_terminate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">pipeline_run</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">!=</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">STARTED</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">terminate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">run</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Received pipeline termination request.&quot;</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">can_terminate</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">can_terminate</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">can_terminate</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Unable to terminate pipeline: can_terminate returned </span><span class=\"si\">{}</span><span class=\"s2\">.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">can_terminate</span>\n                <span class=\"p\">),</span>\n                <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span>\n                <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">job_name</span> <span class=\"o\">=</span> <span class=\"n\">get_job_name_from_run_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n        <span class=\"n\">job_namespace</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_namespace_from_run_config</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">termination_result</span> <span class=\"o\">=</span> <span class=\"n\">delete_job</span><span class=\"p\">(</span><span class=\"n\">job_name</span><span class=\"o\">=</span><span class=\"n\">job_name</span><span class=\"p\">,</span> <span class=\"n\">namespace</span><span class=\"o\">=</span><span class=\"n\">job_namespace</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">termination_result</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                    <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Pipeline was terminated successfully.&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span>\n                    <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                    <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Pipeline was not terminated successfully; delete_job returned </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">termination_result</span>\n                    <span class=\"p\">),</span>\n                    <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span>\n                    <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">termination_result</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>  <span class=\"c1\"># pylint: disable=broad-except</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Pipeline was not terminated successfully; encountered error in delete_job&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span>\n                <span class=\"n\">engine_event_data</span><span class=\"o\">=</span><span class=\"n\">EngineEventData</span><span class=\"o\">.</span><span class=\"n\">engine_error</span><span class=\"p\">(</span>\n                    <span class=\"n\">serializable_error_info_from_exc_info</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">())</span>\n                <span class=\"p\">),</span>\n                <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_namespace_from_run_config</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">run_config</span> <span class=\"o\">=</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_config</span>\n        <span class=\"n\">executor_config</span> <span class=\"o\">=</span> <span class=\"n\">_get_validated_celery_k8s_executor_config</span><span class=\"p\">(</span><span class=\"n\">run_config</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">executor_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;job_namespace&quot;</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_get_validated_celery_k8s_executor_config</span><span class=\"p\">(</span><span class=\"n\">run_config</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">dict_param</span><span class=\"p\">(</span><span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_config&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n        <span class=\"n\">CELERY_K8S_CONFIG_KEY</span> <span class=\"ow\">in</span> <span class=\"n\">run_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;execution&quot;</span><span class=\"p\">,</span> <span class=\"p\">{}),</span>\n        <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\"> execution must be configured in pipeline execution config to launch runs with &quot;</span>\n        <span class=\"s2\">&quot;CeleryK8sRunLauncher&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">CELERY_K8S_CONFIG_KEY</span><span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"n\">execution_config_schema</span> <span class=\"o\">=</span> <span class=\"n\">resolve_to_config_type</span><span class=\"p\">(</span><span class=\"n\">celery_k8s_config</span><span class=\"p\">())</span>\n    <span class=\"n\">execution_run_config</span> <span class=\"o\">=</span> <span class=\"n\">run_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;execution&quot;</span><span class=\"p\">][</span><span class=\"n\">CELERY_K8S_CONFIG_KEY</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;config&quot;</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n    <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">process_config</span><span class=\"p\">(</span><span class=\"n\">execution_config_schema</span><span class=\"p\">,</span> <span class=\"n\">execution_run_config</span><span class=\"p\">)</span>\n\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n        <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Incorrect </span><span class=\"si\">{}</span><span class=\"s2\"> execution schema provided&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">CELERY_K8S_CONFIG_KEY</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">value</span>\n</pre></div>", "current_page_name": "_modules/dagster_celery_k8s/launcher", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}