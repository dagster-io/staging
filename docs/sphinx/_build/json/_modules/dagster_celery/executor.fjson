{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_celery.executor", "body": "<h1>Source code for dagster_celery.executor</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Executor</span><span class=\"p\">,</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">Noneable</span><span class=\"p\">,</span> <span class=\"n\">Permissive</span><span class=\"p\">,</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">executor</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.executor</span> <span class=\"kn\">import</span> <span class=\"n\">check_cross_process_constraints</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.retries</span> <span class=\"kn\">import</span> <span class=\"n\">Retries</span><span class=\"p\">,</span> <span class=\"n\">RetryMode</span><span class=\"p\">,</span> <span class=\"n\">get_retries_config</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.config</span> <span class=\"kn\">import</span> <span class=\"n\">DEFAULT_CONFIG</span><span class=\"p\">,</span> <span class=\"n\">dict_wrapper</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.defaults</span> <span class=\"kn\">import</span> <span class=\"n\">broker_url</span><span class=\"p\">,</span> <span class=\"n\">result_backend</span>\n\n<span class=\"n\">CELERY_CONFIG</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"s2\">&quot;broker&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n        <span class=\"n\">Noneable</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;The URL of the Celery broker. Default: &quot;</span>\n            <span class=\"s2\">&quot;&#39;pyamqp://guest@{os.getenv(&#39;DAGSTER_CELERY_BROKER_HOST&#39;,&quot;</span>\n            <span class=\"s2\">&quot;&#39;localhost&#39;)}//&#39;.&quot;</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">),</span>\n    <span class=\"s2\">&quot;backend&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n        <span class=\"n\">Noneable</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;rpc://&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;The URL of the Celery results backend. Default: &#39;rpc://&#39;.&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">),</span>\n    <span class=\"s2\">&quot;include&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n        <span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">],</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;List of modules every worker should import&quot;</span>\n    <span class=\"p\">),</span>\n    <span class=\"s2\">&quot;config_source&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n        <span class=\"n\">Noneable</span><span class=\"p\">(</span><span class=\"n\">Permissive</span><span class=\"p\">()),</span>\n        <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;Additional settings for the Celery app.&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">),</span>\n    <span class=\"s2\">&quot;retries&quot;</span><span class=\"p\">:</span> <span class=\"n\">get_retries_config</span><span class=\"p\">(),</span>\n<span class=\"p\">}</span>\n\n\n<div class=\"viewcode-block\" id=\"celery_executor\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_celery/#dagster_celery.celery_executor\">[docs]</a><span class=\"nd\">@executor</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;celery&quot;</span><span class=\"p\">,</span> <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"n\">CELERY_CONFIG</span><span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">celery_executor</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Celery-based executor.</span>\n\n<span class=\"sd\">    The Celery executor exposes config settings for the underlying Celery app under</span>\n<span class=\"sd\">    the ``config_source`` key. This config corresponds to the &quot;new lowercase settings&quot; introduced</span>\n<span class=\"sd\">    in Celery version 4.0 and the object constructed from config will be passed to the</span>\n<span class=\"sd\">    :py:class:`celery.Celery` constructor as its ``config_source`` argument.</span>\n<span class=\"sd\">    (See https://docs.celeryproject.org/en/latest/userguide/configuration.html for details.)</span>\n\n<span class=\"sd\">    The executor also exposes the ``broker``, `backend`, and ``include`` arguments to the</span>\n<span class=\"sd\">    :py:class:`celery.Celery` constructor.</span>\n\n<span class=\"sd\">    In the most common case, you may want to modify the ``broker`` and ``backend`` (e.g., to use</span>\n<span class=\"sd\">    Redis instead of RabbitMQ). We expect that ``config_source`` will be less frequently</span>\n<span class=\"sd\">    modified, but that when solid executions are especially fast or slow, or when there are</span>\n<span class=\"sd\">    different requirements around idempotence or retry, it may make sense to execute pipelines</span>\n<span class=\"sd\">    with variations on these settings.</span>\n\n<span class=\"sd\">    If you&#39;d like to configure a celery executor in addition to the</span>\n<span class=\"sd\">    :py:class:`~dagster.default_executors`, you should add it to the ``executor_defs`` defined on a</span>\n<span class=\"sd\">    :py:class:`~dagster.ModeDefinition` as follows:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        from dagster import ModeDefinition, default_executors, pipeline</span>\n<span class=\"sd\">        from dagster_celery import celery_executor</span>\n\n<span class=\"sd\">        @pipeline(mode_defs=[ModeDefinition(executor_defs=default_executors + [celery_executor])])</span>\n<span class=\"sd\">        def celery_enabled_pipeline():</span>\n<span class=\"sd\">            pass</span>\n\n<span class=\"sd\">    Then you can configure the executor as follows:</span>\n\n<span class=\"sd\">    .. code-block:: YAML</span>\n\n<span class=\"sd\">        execution:</span>\n<span class=\"sd\">          celery:</span>\n<span class=\"sd\">            config:</span>\n<span class=\"sd\">              broker: &#39;pyamqp://guest@localhost//&#39;  # Optional[str]: The URL of the Celery broker</span>\n<span class=\"sd\">              backend: &#39;rpc://&#39; # Optional[str]: The URL of the Celery results backend</span>\n<span class=\"sd\">              include: [&#39;my_module&#39;] # Optional[List[str]]: Modules every worker should import</span>\n<span class=\"sd\">              config_source: # Dict[str, Any]: Any additional parameters to pass to the</span>\n<span class=\"sd\">                  #...       # Celery workers. This dict will be passed as the `config_source`</span>\n<span class=\"sd\">                  #...       # argument of celery.Celery().</span>\n\n<span class=\"sd\">    Note that the YAML you provide here must align with the configuration with which the Celery</span>\n<span class=\"sd\">    workers on which you hope to run were started. If, for example, you point the executor at a</span>\n<span class=\"sd\">    different broker than the one your workers are listening to, the workers will never be able to</span>\n<span class=\"sd\">    pick up tasks for execution.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">check_cross_process_constraints</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">CeleryExecutor</span><span class=\"p\">(</span>\n        <span class=\"n\">broker</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">executor_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;broker&quot;</span><span class=\"p\">),</span>\n        <span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">executor_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;backend&quot;</span><span class=\"p\">),</span>\n        <span class=\"n\">config_source</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">executor_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;config_source&quot;</span><span class=\"p\">),</span>\n        <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">executor_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;include&quot;</span><span class=\"p\">),</span>\n        <span class=\"n\">retries</span><span class=\"o\">=</span><span class=\"n\">Retries</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">executor_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;retries&quot;</span><span class=\"p\">]),</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_submit_task</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">,</span> <span class=\"n\">pipeline_context</span><span class=\"p\">,</span> <span class=\"n\">step</span><span class=\"p\">,</span> <span class=\"n\">queue</span><span class=\"p\">,</span> <span class=\"n\">priority</span><span class=\"p\">):</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">.tasks</span> <span class=\"kn\">import</span> <span class=\"n\">create_task</span>\n\n    <span class=\"n\">task</span> <span class=\"o\">=</span> <span class=\"n\">create_task</span><span class=\"p\">(</span><span class=\"n\">app</span><span class=\"p\">)</span>\n\n    <span class=\"n\">task_signature</span> <span class=\"o\">=</span> <span class=\"n\">task</span><span class=\"o\">.</span><span class=\"n\">si</span><span class=\"p\">(</span>\n        <span class=\"n\">instance_ref_dict</span><span class=\"o\">=</span><span class=\"n\">pipeline_context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_ref</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">to_dict</span><span class=\"p\">(),</span>\n        <span class=\"n\">executable_dict</span><span class=\"o\">=</span><span class=\"n\">pipeline_context</span><span class=\"o\">.</span><span class=\"n\">pipeline</span><span class=\"o\">.</span><span class=\"n\">to_dict</span><span class=\"p\">(),</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">step_keys</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">step</span><span class=\"o\">.</span><span class=\"n\">key</span><span class=\"p\">],</span>\n        <span class=\"n\">retries_dict</span><span class=\"o\">=</span><span class=\"n\">pipeline_context</span><span class=\"o\">.</span><span class=\"n\">executor</span><span class=\"o\">.</span><span class=\"n\">retries</span><span class=\"o\">.</span><span class=\"n\">for_inner_plan</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">to_config</span><span class=\"p\">(),</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">task_signature</span><span class=\"o\">.</span><span class=\"n\">apply_async</span><span class=\"p\">(</span>\n        <span class=\"n\">priority</span><span class=\"o\">=</span><span class=\"n\">priority</span><span class=\"p\">,</span> <span class=\"n\">queue</span><span class=\"o\">=</span><span class=\"n\">queue</span><span class=\"p\">,</span> <span class=\"n\">routing_key</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"si\">{queue}</span><span class=\"s2\">.execute_plan&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">queue</span><span class=\"o\">=</span><span class=\"n\">queue</span><span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">CeleryExecutor</span><span class=\"p\">(</span><span class=\"n\">Executor</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">retries</span><span class=\"p\">,</span> <span class=\"n\">broker</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">config_source</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">broker</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">broker</span><span class=\"p\">,</span> <span class=\"s2\">&quot;broker&quot;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"n\">broker_url</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">backend</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">backend</span><span class=\"p\">,</span> <span class=\"s2\">&quot;backend&quot;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"n\">result_backend</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">include</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_list_param</span><span class=\"p\">(</span><span class=\"n\">include</span><span class=\"p\">,</span> <span class=\"s2\">&quot;include&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config_source</span> <span class=\"o\">=</span> <span class=\"n\">dict_wrapper</span><span class=\"p\">(</span>\n            <span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">DEFAULT_CONFIG</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">config_source</span><span class=\"p\">,</span> <span class=\"s2\">&quot;config_source&quot;</span><span class=\"p\">))</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_retries</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">retries</span><span class=\"p\">,</span> <span class=\"s2\">&quot;retries&quot;</span><span class=\"p\">,</span> <span class=\"n\">Retries</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">retries</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_retries</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_context</span><span class=\"p\">,</span> <span class=\"n\">execution_plan</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">.core_execution_loop</span> <span class=\"kn\">import</span> <span class=\"n\">core_celery_execution_loop</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">core_celery_execution_loop</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_context</span><span class=\"p\">,</span> <span class=\"n\">execution_plan</span><span class=\"p\">,</span> <span class=\"n\">step_execution_fn</span><span class=\"o\">=</span><span class=\"n\">_submit_task</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">for_cli</span><span class=\"p\">(</span><span class=\"n\">broker</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">config_source</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">CeleryExecutor</span><span class=\"p\">(</span>\n            <span class=\"n\">retries</span><span class=\"o\">=</span><span class=\"n\">Retries</span><span class=\"p\">(</span><span class=\"n\">RetryMode</span><span class=\"o\">.</span><span class=\"n\">DISABLED</span><span class=\"p\">),</span>\n            <span class=\"n\">broker</span><span class=\"o\">=</span><span class=\"n\">broker</span><span class=\"p\">,</span>\n            <span class=\"n\">backend</span><span class=\"o\">=</span><span class=\"n\">backend</span><span class=\"p\">,</span>\n            <span class=\"n\">include</span><span class=\"o\">=</span><span class=\"n\">include</span><span class=\"p\">,</span>\n            <span class=\"n\">config_source</span><span class=\"o\">=</span><span class=\"n\">config_source</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">app_args</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span>\n            <span class=\"s2\">&quot;broker&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">broker</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;backend&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">backend</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;include&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">include</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;config_source&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config_source</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;retries&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">retries</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n</pre></div>", "current_page_name": "_modules/dagster_celery/executor", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}