{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_aws.s3.system_storage", "body": "<h1>Source code for dagster_aws.s3.system_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">,</span> <span class=\"n\">intermediate_storage</span><span class=\"p\">,</span> <span class=\"n\">system_storage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.system_storage</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_system_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">mem_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">mem_system_storage</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.file_manager</span> <span class=\"kn\">import</span> <span class=\"n\">S3FileManager</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.intermediate_storage</span> <span class=\"kn\">import</span> <span class=\"n\">S3IntermediateStorage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.object_store</span> <span class=\"kn\">import</span> <span class=\"n\">S3ObjectStore</span>\n\n\n<span class=\"nd\">@intermediate_storage</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;s3_bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;s3_prefix&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">s3_intermediate_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Persistent intermediate storage using S3 for storage.</span>\n\n<span class=\"sd\">        Suitable for intermediates storage for distributed executors, so long as</span>\n<span class=\"sd\">        each execution node has network connectivity and credentials for S3 and</span>\n<span class=\"sd\">        the backing bucket.</span>\n\n<span class=\"sd\">        Attach this storage definition, as well as the :py:data:`~dagster_aws.s3_resource` it</span>\n<span class=\"sd\">        requires, to a :py:class:`~dagster.ModeDefinition` in order to make it available to your</span>\n<span class=\"sd\">        pipeline:</span>\n\n<span class=\"sd\">        .. code-block:: python</span>\n\n<span class=\"sd\">            pipeline_def = PipelineDefinition(</span>\n<span class=\"sd\">                mode_defs=[</span>\n<span class=\"sd\">                    ModeDefinition(</span>\n<span class=\"sd\">                        resource_defs={&#39;s3&#39;: s3_resource, ...},</span>\n<span class=\"sd\">                        intermediate_storage_defs=[s3_intermediate_storage],</span>\n<span class=\"sd\">                        ...</span>\n<span class=\"sd\">                    ), ...</span>\n<span class=\"sd\">                ], ...</span>\n<span class=\"sd\">            )</span>\n\n<span class=\"sd\">        You may configure this storage as follows:</span>\n\n<span class=\"sd\">        .. code-block:: YAML</span>\n\n<span class=\"sd\">            intermediate_storage:</span>\n<span class=\"sd\">              s3:</span>\n<span class=\"sd\">                config:</span>\n<span class=\"sd\">                  s3_bucket: my-cool-bucket</span>\n<span class=\"sd\">                  s3_prefix: good/prefix-for-files-</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n    <span class=\"n\">s3_session</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">s3</span>\n    <span class=\"n\">s3_bucket</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">intermediate_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_bucket&quot;</span><span class=\"p\">]</span>\n    <span class=\"n\">object_store</span> <span class=\"o\">=</span> <span class=\"n\">S3ObjectStore</span><span class=\"p\">(</span><span class=\"n\">s3_bucket</span><span class=\"p\">,</span> <span class=\"n\">s3_session</span><span class=\"o\">=</span><span class=\"n\">s3_session</span><span class=\"p\">)</span>\n    <span class=\"n\">s3_prefix</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">intermediate_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_prefix&quot;</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">root_for_run_id</span><span class=\"p\">(</span><span class=\"n\">r_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">object_store</span><span class=\"o\">.</span><span class=\"n\">key_for_paths</span><span class=\"p\">([</span><span class=\"n\">s3_prefix</span><span class=\"p\">,</span> <span class=\"s2\">&quot;storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">r_id</span><span class=\"p\">])</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">(</span>\n        <span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"p\">,</span> <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"n\">root_for_run_id</span>\n    <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"s3_system_storage\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_aws/#dagster_aws.s3.s3_system_storage\">[docs]</a><span class=\"nd\">@system_storage</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;s3_bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;s3_prefix&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">s3_system_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Persistent system storage using S3 for storage.</span>\n\n<span class=\"sd\">    Suitable for intermediates storage for distributed executors, so long as</span>\n<span class=\"sd\">    each execution node has network connectivity and credentials for S3 and</span>\n<span class=\"sd\">    the backing bucket.</span>\n\n<span class=\"sd\">    Attach this system storage definition, as well as the :py:data:`~dagster_aws.s3_resource` it</span>\n<span class=\"sd\">    requires, to a :py:class:`~dagster.ModeDefinition` in order to make it available to your</span>\n<span class=\"sd\">    pipeline:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        pipeline_def = PipelineDefinition(</span>\n<span class=\"sd\">            mode_defs=[</span>\n<span class=\"sd\">                ModeDefinition(</span>\n<span class=\"sd\">                    resource_defs={&#39;s3&#39;: s3_resource, ...},</span>\n<span class=\"sd\">                    system_storage_defs=[s3_system_storage],</span>\n<span class=\"sd\">                    ...</span>\n<span class=\"sd\">                ), ...</span>\n<span class=\"sd\">            ], ...</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">    You may configure this storage as follows:</span>\n\n<span class=\"sd\">    .. code-block:: YAML</span>\n\n<span class=\"sd\">        storage:</span>\n<span class=\"sd\">          s3:</span>\n<span class=\"sd\">            config:</span>\n<span class=\"sd\">              s3_bucket: my-cool-bucket</span>\n<span class=\"sd\">              s3_prefix: good/prefix-for-files-</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">s3_session</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">s3</span>\n    <span class=\"n\">s3_key</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{prefix}</span><span class=\"s2\">/storage/</span><span class=\"si\">{run_id}</span><span class=\"s2\">/files&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n        <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_prefix&quot;</span><span class=\"p\">],</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">(</span>\n        <span class=\"n\">file_manager</span><span class=\"o\">=</span><span class=\"n\">S3FileManager</span><span class=\"p\">(</span>\n            <span class=\"n\">s3_session</span><span class=\"o\">=</span><span class=\"n\">s3_session</span><span class=\"p\">,</span>\n            <span class=\"n\">s3_bucket</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_bucket&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">s3_base_key</span><span class=\"o\">=</span><span class=\"n\">s3_key</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">intermediate_storage</span><span class=\"o\">=</span><span class=\"n\">S3IntermediateStorage</span><span class=\"p\">(</span>\n            <span class=\"n\">s3_session</span><span class=\"o\">=</span><span class=\"n\">s3_session</span><span class=\"p\">,</span>\n            <span class=\"n\">s3_bucket</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_bucket&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">s3_prefix</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;s3_prefix&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"n\">s3_plus_default_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">mem_system_storage</span><span class=\"p\">,</span> <span class=\"n\">fs_system_storage</span><span class=\"p\">,</span> <span class=\"n\">s3_system_storage</span><span class=\"p\">]</span>\n<span class=\"n\">s3_plus_default_intermediate_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n    <span class=\"n\">mem_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">s3_intermediate_storage</span><span class=\"p\">,</span>\n<span class=\"p\">]</span>\n</pre></div>", "current_page_name": "_modules/dagster_aws/s3/system_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}