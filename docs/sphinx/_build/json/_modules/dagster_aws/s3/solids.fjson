{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_aws.s3.solids", "body": "<h1>Source code for dagster_aws.s3.solids</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">AssetMaterialization</span><span class=\"p\">,</span>\n    <span class=\"n\">EventMetadataEntry</span><span class=\"p\">,</span>\n    <span class=\"n\">Field</span><span class=\"p\">,</span>\n    <span class=\"n\">FileHandle</span><span class=\"p\">,</span>\n    <span class=\"n\">InputDefinition</span><span class=\"p\">,</span>\n    <span class=\"n\">Output</span><span class=\"p\">,</span>\n    <span class=\"n\">OutputDefinition</span><span class=\"p\">,</span>\n    <span class=\"n\">StringSource</span><span class=\"p\">,</span>\n    <span class=\"n\">check</span><span class=\"p\">,</span>\n    <span class=\"n\">dagster_type_loader</span><span class=\"p\">,</span>\n    <span class=\"n\">solid</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.types.dagster_type</span> <span class=\"kn\">import</span> <span class=\"n\">PythonObjectDagsterType</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.file_manager</span> <span class=\"kn\">import</span> <span class=\"n\">S3FileHandle</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">dict_with_fields</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">dict_param</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fields&quot;</span><span class=\"p\">,</span> <span class=\"n\">key_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n    <span class=\"n\">field_names</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n\n    <span class=\"nd\">@dagster_type_loader</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_input_schema</span><span class=\"p\">(</span><span class=\"n\">_context</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">dict_param</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;value&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">param_invariant</span><span class=\"p\">(</span><span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span> <span class=\"o\">==</span> <span class=\"n\">field_names</span><span class=\"p\">,</span> <span class=\"s2\">&quot;value&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">value</span>\n\n    <span class=\"k\">class</span> <span class=\"nc\">_DictWithSchema</span><span class=\"p\">(</span><span class=\"n\">PythonObjectDagsterType</span><span class=\"p\">):</span>\n        <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n            <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">_DictWithSchema</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">python_type</span><span class=\"o\">=</span><span class=\"nb\">dict</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">loader</span><span class=\"o\">=</span><span class=\"n\">_input_schema</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">_DictWithSchema</span><span class=\"p\">()</span>\n\n\n<span class=\"n\">S3Coordinate</span> <span class=\"o\">=</span> <span class=\"n\">dict_with_fields</span><span class=\"p\">(</span>\n    <span class=\"s2\">&quot;S3Coordinate&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;S3 bucket name&quot;</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;key&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;S3 key name&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">last_key</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"s2\">&quot;/&quot;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">key</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">key</span>\n    <span class=\"n\">comps</span> <span class=\"o\">=</span> <span class=\"n\">key</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"s2\">&quot;/&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">comps</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n\n\n<span class=\"nd\">@solid</span><span class=\"p\">(</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;Bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;The name of the bucket to upload to.&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;Key&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;The name of the key to upload to.&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n    <span class=\"n\">input_defs</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">InputDefinition</span><span class=\"p\">(</span><span class=\"s2\">&quot;file_handle&quot;</span><span class=\"p\">,</span> <span class=\"n\">FileHandle</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;The file to upload.&quot;</span><span class=\"p\">)],</span>\n    <span class=\"n\">output_defs</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">OutputDefinition</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;s3_file_handle&quot;</span><span class=\"p\">,</span> <span class=\"n\">dagster_type</span><span class=\"o\">=</span><span class=\"n\">S3FileHandle</span><span class=\"p\">)],</span>\n    <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;&quot;Take a file handle and upload it to s3. Returns an S3FileHandle.&quot;&quot;&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">file_handle_to_s3</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">file_handle</span><span class=\"p\">):</span>\n    <span class=\"n\">bucket</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;Bucket&quot;</span><span class=\"p\">]</span>\n    <span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">solid_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;Key&quot;</span><span class=\"p\">]</span>\n\n    <span class=\"k\">with</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">file_manager</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">(</span><span class=\"n\">file_handle</span><span class=\"p\">,</span> <span class=\"s2\">&quot;rb&quot;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">fileobj</span><span class=\"p\">:</span>\n        <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">s3</span><span class=\"o\">.</span><span class=\"n\">upload_fileobj</span><span class=\"p\">(</span><span class=\"n\">fileobj</span><span class=\"p\">,</span> <span class=\"n\">bucket</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">)</span>\n        <span class=\"n\">s3_file_handle</span> <span class=\"o\">=</span> <span class=\"n\">S3FileHandle</span><span class=\"p\">(</span><span class=\"n\">bucket</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">)</span>\n\n        <span class=\"k\">yield</span> <span class=\"n\">AssetMaterialization</span><span class=\"p\">(</span>\n            <span class=\"n\">asset_key</span><span class=\"o\">=</span><span class=\"n\">s3_file_handle</span><span class=\"o\">.</span><span class=\"n\">s3_path</span><span class=\"p\">,</span>\n            <span class=\"n\">metadata_entries</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">(</span><span class=\"n\">s3_file_handle</span><span class=\"o\">.</span><span class=\"n\">s3_path</span><span class=\"p\">,</span> <span class=\"n\">label</span><span class=\"o\">=</span><span class=\"n\">last_key</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">))],</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">yield</span> <span class=\"n\">Output</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">s3_file_handle</span><span class=\"p\">,</span> <span class=\"n\">output_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;s3_file_handle&quot;</span><span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/dagster_aws/s3/solids", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}