{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_aws.s3.file_cache", "body": "<h1>Source code for dagster_aws.s3.file_cache</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">boto3</span>\n<span class=\"kn\">from</span> <span class=\"nn\">botocore.exceptions</span> <span class=\"kn\">import</span> <span class=\"n\">ClientError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">resource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.file_cache</span> <span class=\"kn\">import</span> <span class=\"n\">FileCache</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.file_manager</span> <span class=\"kn\">import</span> <span class=\"n\">S3FileHandle</span>\n\n\n<div class=\"viewcode-block\" id=\"S3FileCache\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_aws/#dagster_aws.s3.S3FileCache\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">S3FileCache</span><span class=\"p\">(</span><span class=\"n\">FileCache</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">s3_bucket</span><span class=\"p\">,</span> <span class=\"n\">s3_key</span><span class=\"p\">,</span> <span class=\"n\">s3_session</span><span class=\"p\">,</span> <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">S3FileCache</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"n\">overwrite</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_bucket</span> <span class=\"o\">=</span> <span class=\"n\">s3_bucket</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_key</span> <span class=\"o\">=</span> <span class=\"n\">s3_key</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3</span> <span class=\"o\">=</span> <span class=\"n\">s3_session</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_file_object</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">file_key</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;file_key&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3</span><span class=\"o\">.</span><span class=\"n\">get_object</span><span class=\"p\">(</span><span class=\"n\">Bucket</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_bucket</span><span class=\"p\">,</span> <span class=\"n\">Key</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_full_key</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">))</span>\n        <span class=\"k\">except</span> <span class=\"n\">ClientError</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_full_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">file_key</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">{base_key}</span><span class=\"s2\">/</span><span class=\"si\">{file_key}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">base_key</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_key</span><span class=\"p\">,</span> <span class=\"n\">file_key</span><span class=\"o\">=</span><span class=\"n\">file_key</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">write_file_object</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">file_key</span><span class=\"p\">,</span> <span class=\"n\">source_file_object</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;file_key&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3</span><span class=\"o\">.</span><span class=\"n\">put_object</span><span class=\"p\">(</span>\n            <span class=\"n\">Body</span><span class=\"o\">=</span><span class=\"n\">source_file_object</span><span class=\"p\">,</span> <span class=\"n\">Bucket</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_bucket</span><span class=\"p\">,</span> <span class=\"n\">Key</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_full_key</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_file_handle</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_file_handle</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">file_key</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;file_key&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">S3FileHandle</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">s3_bucket</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_full_key</span><span class=\"p\">(</span><span class=\"n\">file_key</span><span class=\"p\">))</span></div>\n\n\n<span class=\"nd\">@resource</span><span class=\"p\">(</span>\n    <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;key&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;overwrite&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">s3_file_cache</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">S3FileCache</span><span class=\"p\">(</span>\n        <span class=\"n\">s3_bucket</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;bucket&quot;</span><span class=\"p\">],</span>\n        <span class=\"n\">s3_key</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;key&quot;</span><span class=\"p\">],</span>\n        <span class=\"n\">overwrite</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;overwrite&quot;</span><span class=\"p\">],</span>\n        <span class=\"c1\"># TODO: resource dependencies</span>\n        <span class=\"n\">s3_session</span><span class=\"o\">=</span><span class=\"n\">boto3</span><span class=\"o\">.</span><span class=\"n\">resource</span><span class=\"p\">(</span><span class=\"s2\">&quot;s3&quot;</span><span class=\"p\">,</span> <span class=\"n\">use_ssl</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">meta</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/dagster_aws/s3/file_cache", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}