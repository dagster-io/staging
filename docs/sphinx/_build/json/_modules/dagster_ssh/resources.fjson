{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_ssh.resources", "body": "<h1>Source code for dagster_ssh.resources</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">getpass</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">paramiko</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">resource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">merge_dicts</span><span class=\"p\">,</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">paramiko.config</span> <span class=\"kn\">import</span> <span class=\"n\">SSH_PORT</span>\n<span class=\"kn\">from</span> <span class=\"nn\">six</span> <span class=\"kn\">import</span> <span class=\"n\">StringIO</span>\n<span class=\"kn\">from</span> <span class=\"nn\">sshtunnel</span> <span class=\"kn\">import</span> <span class=\"n\">SSHTunnelForwarder</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">key_from_str</span><span class=\"p\">(</span><span class=\"n\">key_str</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Creates a paramiko SSH key from a string.&quot;&quot;&quot;</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">key_str</span><span class=\"p\">,</span> <span class=\"s2\">&quot;key_str&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># py2 StringIO doesn&#39;t support with</span>\n    <span class=\"n\">key_file</span> <span class=\"o\">=</span> <span class=\"n\">StringIO</span><span class=\"p\">(</span><span class=\"n\">key_str</span><span class=\"p\">)</span>\n    <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">paramiko</span><span class=\"o\">.</span><span class=\"n\">RSAKey</span><span class=\"o\">.</span><span class=\"n\">from_private_key</span><span class=\"p\">(</span><span class=\"n\">key_file</span><span class=\"p\">)</span>\n    <span class=\"n\">key_file</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">result</span>\n\n\n<div class=\"viewcode-block\" id=\"SSHResource\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_ssh/#dagster_ssh.SSHResource\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SSHResource</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Resource for ssh remote execution using Paramiko.</span>\n<span class=\"sd\">    ref: https://github.com/paramiko/paramiko</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">remote_host</span><span class=\"p\">,</span>\n        <span class=\"n\">remote_port</span><span class=\"p\">,</span>\n        <span class=\"n\">username</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">password</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">key_file</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">key_string</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span>\n        <span class=\"n\">keepalive_interval</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">,</span>\n        <span class=\"n\">compress</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">no_host_key_check</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n        <span class=\"n\">allow_host_key_change</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">logger</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">remote_host</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_host&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_port</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">remote_port</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_port&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">username</span><span class=\"p\">,</span> <span class=\"s2\">&quot;username&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">password</span><span class=\"p\">,</span> <span class=\"s2\">&quot;password&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">key_file</span><span class=\"p\">,</span> <span class=\"s2\">&quot;key_file&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">timeout</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">timeout</span><span class=\"p\">,</span> <span class=\"s2\">&quot;timeout&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">keepalive_interval</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">keepalive_interval</span><span class=\"p\">,</span> <span class=\"s2\">&quot;keepalive_interval&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">compress</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_bool_param</span><span class=\"p\">(</span><span class=\"n\">compress</span><span class=\"p\">,</span> <span class=\"s2\">&quot;compress&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">no_host_key_check</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_bool_param</span><span class=\"p\">(</span><span class=\"n\">no_host_key_check</span><span class=\"p\">,</span> <span class=\"s2\">&quot;no_host_key_check&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">allow_host_key_change</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_bool_param</span><span class=\"p\">(</span>\n            <span class=\"n\">allow_host_key_change</span><span class=\"p\">,</span> <span class=\"s2\">&quot;allow_host_key_change&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span> <span class=\"o\">=</span> <span class=\"n\">logger</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n        <span class=\"c1\"># Create RSAKey object from private key string</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_obj</span> <span class=\"o\">=</span> <span class=\"n\">key_from_str</span><span class=\"p\">(</span><span class=\"n\">key_string</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">key_string</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n        <span class=\"c1\"># Auto detecting username values from system</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">:</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">debug</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;username to ssh to host: </span><span class=\"si\">%s</span><span class=\"s2\"> is not specified. Using system&#39;s default provided by&quot;</span>\n                <span class=\"s2\">&quot; getpass.getuser()&quot;</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span> <span class=\"o\">=</span> <span class=\"n\">getpass</span><span class=\"o\">.</span><span class=\"n\">getuser</span><span class=\"p\">()</span>\n\n        <span class=\"n\">user_ssh_config_filename</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">expanduser</span><span class=\"p\">(</span><span class=\"s2\">&quot;~/.ssh/config&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span><span class=\"p\">(</span><span class=\"n\">user_ssh_config_filename</span><span class=\"p\">):</span>\n            <span class=\"n\">ssh_conf</span> <span class=\"o\">=</span> <span class=\"n\">paramiko</span><span class=\"o\">.</span><span class=\"n\">SSHConfig</span><span class=\"p\">()</span>\n            <span class=\"n\">ssh_conf</span><span class=\"o\">.</span><span class=\"n\">parse</span><span class=\"p\">(</span><span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">user_ssh_config_filename</span><span class=\"p\">))</span>\n            <span class=\"n\">host_info</span> <span class=\"o\">=</span> <span class=\"n\">ssh_conf</span><span class=\"o\">.</span><span class=\"n\">lookup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">host_info</span> <span class=\"ow\">and</span> <span class=\"n\">host_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;proxycommand&quot;</span><span class=\"p\">):</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span> <span class=\"o\">=</span> <span class=\"n\">paramiko</span><span class=\"o\">.</span><span class=\"n\">ProxyCommand</span><span class=\"p\">(</span><span class=\"n\">host_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;proxycommand&quot;</span><span class=\"p\">))</span>\n\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span><span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"n\">host_info</span> <span class=\"ow\">and</span> <span class=\"n\">host_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;identityfile&quot;</span><span class=\"p\">):</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span> <span class=\"o\">=</span> <span class=\"n\">host_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;identityfile&quot;</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_connection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Opens a SSH connection to the remote host.</span>\n\n<span class=\"sd\">        :rtype: paramiko.client.SSHClient</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">paramiko</span><span class=\"o\">.</span><span class=\"n\">SSHClient</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">allow_host_key_change</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Remote Identification Change is not verified. This won&#39;t protect against &quot;</span>\n                <span class=\"s2\">&quot;Man-In-The-Middle attacks&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">load_system_host_keys</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">no_host_key_check</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;No Host Key Verification. This won&#39;t protect against Man-In-The-Middle attacks&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"c1\"># Default is RejectPolicy</span>\n            <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">set_missing_host_key_policy</span><span class=\"p\">(</span><span class=\"n\">paramiko</span><span class=\"o\">.</span><span class=\"n\">AutoAddPolicy</span><span class=\"p\">())</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">():</span>\n            <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span>\n                <span class=\"n\">hostname</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span><span class=\"p\">,</span>\n                <span class=\"n\">username</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">,</span>\n                <span class=\"n\">password</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span><span class=\"p\">,</span>\n                <span class=\"n\">key_filename</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span><span class=\"p\">,</span>\n                <span class=\"n\">pkey</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_obj</span><span class=\"p\">,</span>\n                <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">timeout</span><span class=\"p\">,</span>\n                <span class=\"n\">compress</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">compress</span><span class=\"p\">,</span>\n                <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_port</span><span class=\"p\">,</span>\n                <span class=\"n\">sock</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span><span class=\"p\">,</span>\n                <span class=\"n\">look_for_keys</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span>\n                <span class=\"n\">hostname</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span><span class=\"p\">,</span>\n                <span class=\"n\">username</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">,</span>\n                <span class=\"n\">key_filename</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span><span class=\"p\">,</span>\n                <span class=\"n\">pkey</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_obj</span><span class=\"p\">,</span>\n                <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">timeout</span><span class=\"p\">,</span>\n                <span class=\"n\">compress</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">compress</span><span class=\"p\">,</span>\n                <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_port</span><span class=\"p\">,</span>\n                <span class=\"n\">sock</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">keepalive_interval</span><span class=\"p\">:</span>\n            <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">get_transport</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">set_keepalive</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">keepalive_interval</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">client</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_tunnel</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">remote_port</span><span class=\"p\">,</span> <span class=\"n\">remote_host</span><span class=\"o\">=</span><span class=\"s2\">&quot;localhost&quot;</span><span class=\"p\">,</span> <span class=\"n\">local_port</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">remote_port</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_port&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">remote_host</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_host&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">local_port</span><span class=\"p\">,</span> <span class=\"s2\">&quot;local_port&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">local_port</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">local_bind_address</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s2\">&quot;localhost&quot;</span><span class=\"p\">,</span> <span class=\"n\">local_port</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">local_bind_address</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"s2\">&quot;localhost&quot;</span><span class=\"p\">,)</span>\n\n        <span class=\"c1\"># Will prefer key string if specified, otherwise use the key file</span>\n        <span class=\"n\">pkey</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_obj</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_obj</span> <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key_file</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">():</span>\n            <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">SSHTunnelForwarder</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_port</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_port</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_username</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_password</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">password</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_pkey</span><span class=\"o\">=</span><span class=\"n\">pkey</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_proxy</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span><span class=\"p\">,</span>\n                <span class=\"n\">local_bind_address</span><span class=\"o\">=</span><span class=\"n\">local_bind_address</span><span class=\"p\">,</span>\n                <span class=\"n\">remote_bind_address</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">remote_host</span><span class=\"p\">,</span> <span class=\"n\">remote_port</span><span class=\"p\">),</span>\n                <span class=\"n\">logger</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">SSHTunnelForwarder</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_host</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_port</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_port</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_username</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">username</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_pkey</span><span class=\"o\">=</span><span class=\"n\">pkey</span><span class=\"p\">,</span>\n                <span class=\"n\">ssh_proxy</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host_proxy</span><span class=\"p\">,</span>\n                <span class=\"n\">local_bind_address</span><span class=\"o\">=</span><span class=\"n\">local_bind_address</span><span class=\"p\">,</span>\n                <span class=\"n\">remote_bind_address</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">remote_host</span><span class=\"p\">,</span> <span class=\"n\">remote_port</span><span class=\"p\">),</span>\n                <span class=\"n\">host_pkey_directories</span><span class=\"o\">=</span><span class=\"p\">[],</span>\n                <span class=\"n\">logger</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">client</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">sftp_get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"n\">local_filepath</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_filepath&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">local_filepath</span><span class=\"p\">,</span> <span class=\"s2\">&quot;local_filepath&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_connection</span><span class=\"p\">()</span>\n        <span class=\"k\">with</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">open_sftp</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">sftp_client</span><span class=\"p\">:</span>\n            <span class=\"n\">local_folder</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">local_filepath</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Create intermediate directories if they don&#39;t exist</span>\n            <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">local_folder</span><span class=\"p\">)</span>\n\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Starting to transfer from </span><span class=\"si\">{0}</span><span class=\"s2\"> to </span><span class=\"si\">{1}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"n\">local_filepath</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">sftp_client</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"n\">local_filepath</span><span class=\"p\">)</span>\n\n        <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">local_filepath</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">sftp_put</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"n\">local_filepath</span><span class=\"p\">,</span> <span class=\"n\">confirm</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"s2\">&quot;remote_filepath&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">local_filepath</span><span class=\"p\">,</span> <span class=\"s2\">&quot;local_filepath&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_connection</span><span class=\"p\">()</span>\n        <span class=\"k\">with</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">open_sftp</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">sftp_client</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Starting to transfer file from </span><span class=\"si\">{0}</span><span class=\"s2\"> to </span><span class=\"si\">{1}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">local_filepath</span><span class=\"p\">,</span> <span class=\"n\">remote_filepath</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">sftp_client</span><span class=\"o\">.</span><span class=\"n\">put</span><span class=\"p\">(</span><span class=\"n\">local_filepath</span><span class=\"p\">,</span> <span class=\"n\">remote_filepath</span><span class=\"p\">,</span> <span class=\"n\">confirm</span><span class=\"o\">=</span><span class=\"n\">confirm</span><span class=\"p\">)</span>\n\n        <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">local_filepath</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ssh_resource\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_ssh/#dagster_ssh.ssh_resource\">[docs]</a><span class=\"nd\">@resource</span><span class=\"p\">(</span>\n    <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;remote_host&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;remote host to connect to&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">True</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;remote_port&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"nb\">int</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;port of remote host to connect (Default is paramiko SSH_PORT)&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"n\">SSH_PORT</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;username&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;username to connect to the remote_host&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;password&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;password of the username to connect to the remote_host&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;key_file&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;key file to use to connect to the remote_host.&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;key_string&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"n\">StringSource</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;key string to use to connect to remote_host&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;timeout&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"nb\">int</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;timeout for the attempt to connect to the remote_host.&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"mi\">10</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;keepalive_interval&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span>\n            <span class=\"nb\">int</span><span class=\"p\">,</span>\n            <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;send a keepalive packet to remote host every keepalive_interval seconds&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;compress&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;no_host_key_check&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;allow_host_key_change&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">bool</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">),</span>\n    <span class=\"p\">}</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">ssh_resource</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span>\n    <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">,</span> <span class=\"p\">{</span><span class=\"s2\">&quot;logger&quot;</span><span class=\"p\">:</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">log_manager</span><span class=\"p\">})</span>\n    <span class=\"k\">return</span> <span class=\"n\">SSHResource</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">args</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster_ssh/resources", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}