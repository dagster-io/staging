{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_snowflake.resources", "body": "<h1>Source code for dagster_snowflake.resources</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">closing</span><span class=\"p\">,</span> <span class=\"n\">contextmanager</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">resource</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.configs</span> <span class=\"kn\">import</span> <span class=\"n\">define_snowflake_config</span>\n\n<span class=\"k\">try</span><span class=\"p\">:</span>\n    <span class=\"kn\">import</span> <span class=\"nn\">snowflake.connector</span>\n<span class=\"k\">except</span> <span class=\"ne\">ImportError</span><span class=\"p\">:</span>\n    <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;Could not import snowflake.connector. This could mean you have an incompatible version &quot;</span>\n        <span class=\"s2\">&quot;of azure-storage-blob installed. dagster-snowflake requires azure-storage-blob&lt;12.0.0; &quot;</span>\n        <span class=\"s2\">&quot;this conflicts with dagster-azure which requires azure-storage-blob~=12.0.0 and is &quot;</span>\n        <span class=\"s2\">&quot;incompatible with dagster-snowflake. Please uninstall dagster-azure and reinstall &quot;</span>\n        <span class=\"s2\">&quot;dagster-snowflake to fix this error.&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n    <span class=\"k\">raise</span>\n\n\n<div class=\"viewcode-block\" id=\"SnowflakeConnection\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.SnowflakeConnection\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SnowflakeConnection</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>  <span class=\"c1\"># pylint: disable=too-many-locals</span>\n        <span class=\"c1\"># Extract parameters from resource config. Note that we can&#39;t pass None values to</span>\n        <span class=\"c1\"># snowflake.connector.connect() because they will override the default values set within the</span>\n        <span class=\"c1\"># connector; remove them from the conn_args dict.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conn_args</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">k</span> <span class=\"ow\">in</span> <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;account&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;user&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;password&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;database&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;schema&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;role&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;warehouse&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;autocommit&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;client_prefetch_threads&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;client_session_keep_alive&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;login_timeout&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;network_timeout&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;ocsp_response_cache_filename&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;validate_default_parameters&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;paramstyle&quot;</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;timezone&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">autocommit</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conn_args</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;autocommit&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">log_manager</span>\n\n<div class=\"viewcode-block\" id=\"SnowflakeConnection.get_connection\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.SnowflakeConnection.get_connection\">[docs]</a>    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_connection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">snowflake</span><span class=\"o\">.</span><span class=\"n\">connector</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conn_args</span><span class=\"p\">)</span>\n        <span class=\"k\">yield</span> <span class=\"n\">conn</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">autocommit</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">commit</span><span class=\"p\">()</span>\n        <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span></div>\n\n<div class=\"viewcode-block\" id=\"SnowflakeConnection.execute_query\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.SnowflakeConnection.execute_query\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">execute_query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">parameters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">fetch_results</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"s2\">&quot;sql&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">parameters</span><span class=\"p\">,</span> <span class=\"s2\">&quot;parameters&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">bool_param</span><span class=\"p\">(</span><span class=\"n\">fetch_results</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fetch_results&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_connection</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"n\">closing</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">())</span> <span class=\"k\">as</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">version_info</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">&lt;</span> <span class=\"mi\">3</span><span class=\"p\">:</span>\n                    <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">)</span>\n\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Executing query: &quot;</span> <span class=\"o\">+</span> <span class=\"n\">sql</span><span class=\"p\">)</span>\n                <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">parameters</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=E1101</span>\n                <span class=\"k\">if</span> <span class=\"n\">fetch_results</span><span class=\"p\">:</span>\n                    <span class=\"k\">return</span> <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=E1101</span></div>\n\n<div class=\"viewcode-block\" id=\"SnowflakeConnection.execute_queries\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.SnowflakeConnection.execute_queries\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">execute_queries</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sql_queries</span><span class=\"p\">,</span> <span class=\"n\">parameters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">fetch_results</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">sql_queries</span><span class=\"p\">,</span> <span class=\"s2\">&quot;sql_queries&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">parameters</span><span class=\"p\">,</span> <span class=\"s2\">&quot;parameters&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">bool_param</span><span class=\"p\">(</span><span class=\"n\">fetch_results</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fetch_results&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_connection</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"n\">closing</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">())</span> <span class=\"k\">as</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"n\">sql_queries</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">version_info</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"o\">&lt;</span> <span class=\"mi\">3</span><span class=\"p\">:</span>\n                        <span class=\"n\">sql</span> <span class=\"o\">=</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">)</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">log</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span><span class=\"s2\">&quot;Executing query: &quot;</span> <span class=\"o\">+</span> <span class=\"n\">sql</span><span class=\"p\">)</span>\n                    <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">,</span> <span class=\"n\">parameters</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=E1101</span>\n                    <span class=\"k\">if</span> <span class=\"n\">fetch_results</span><span class=\"p\">:</span>\n                        <span class=\"n\">results</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=E1101</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">results</span> <span class=\"k\">if</span> <span class=\"n\">fetch_results</span> <span class=\"k\">else</span> <span class=\"kc\">None</span></div>\n\n<div class=\"viewcode-block\" id=\"SnowflakeConnection.load_table_from_local_parquet\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.SnowflakeConnection.load_table_from_local_parquet\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">load_table_from_local_parquet</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">src</span><span class=\"p\">,</span> <span class=\"n\">table</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"p\">,</span> <span class=\"s2\">&quot;src&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"p\">,</span> <span class=\"s2\">&quot;table&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">sql_queries</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"s2\">&quot;CREATE OR REPLACE TABLE </span><span class=\"si\">{table}</span><span class=\"s2\"> ( data VARIANT DEFAULT NULL);&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;CREATE OR REPLACE FILE FORMAT parquet_format TYPE = &#39;parquet&#39;;&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;PUT </span><span class=\"si\">{src}</span><span class=\"s2\"> @%</span><span class=\"si\">{table}</span><span class=\"s2\">;&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">src</span><span class=\"o\">=</span><span class=\"n\">src</span><span class=\"p\">,</span> <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">table</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;COPY INTO </span><span class=\"si\">{table}</span><span class=\"s2\"> FROM @%</span><span class=\"si\">{table}</span><span class=\"s2\"> FILE_FORMAT = (FORMAT_NAME = &#39;parquet_format&#39;);&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">table</span><span class=\"o\">=</span><span class=\"n\">table</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">]</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute_queries</span><span class=\"p\">(</span><span class=\"n\">sql_queries</span><span class=\"p\">)</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"snowflake_resource\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_snowflake/#dagster_snowflake.snowflake_resource\">[docs]</a><span class=\"nd\">@resource</span><span class=\"p\">(</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"n\">define_snowflake_config</span><span class=\"p\">(),</span>\n    <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;This resource is for connecting to the Snowflake data warehouse&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">snowflake_resource</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;A resource for connecting to the Snowflake data warehouse.</span>\n\n<span class=\"sd\">    A simple example of loading data into Snowflake and subsequently querying that data is shown below:</span>\n\n<span class=\"sd\">    Examples:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        from dagster import execute_pipeline, pipeline, DependencyDefinition, ModeDefinition</span>\n<span class=\"sd\">        from dagster_snowflake import snowflake_resource</span>\n\n<span class=\"sd\">        @solid(required_resource_keys={&#39;snowflake&#39;})</span>\n<span class=\"sd\">        def get_one(context):</span>\n<span class=\"sd\">            context.resources.snowflake.execute_query(&#39;SELECT 1&#39;)</span>\n\n<span class=\"sd\">        @pipeline(</span>\n<span class=\"sd\">            mode_defs=[ModeDefinition(resource_defs={&#39;snowflake&#39;: snowflake_resource})],</span>\n<span class=\"sd\">        )</span>\n<span class=\"sd\">        def snowflake_pipeline():</span>\n<span class=\"sd\">            get_one()</span>\n\n<span class=\"sd\">        result = execute_pipeline(</span>\n<span class=\"sd\">            snowflake_pipeline,</span>\n<span class=\"sd\">            {</span>\n<span class=\"sd\">                &#39;resources&#39;: {</span>\n<span class=\"sd\">                    &#39;snowflake&#39;: {</span>\n<span class=\"sd\">                        &#39;config&#39;: {</span>\n<span class=\"sd\">                            &#39;account&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_ACCOUNT&#39;},</span>\n<span class=\"sd\">                            &#39;user&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_USER&#39;},</span>\n<span class=\"sd\">                            &#39;password&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_PASSWORD&#39;},</span>\n<span class=\"sd\">                            &#39;database&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_DATABASE&#39;},</span>\n<span class=\"sd\">                            &#39;schema&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_SCHEMA&#39;},</span>\n<span class=\"sd\">                            &#39;warehouse&#39;: {&#39;env&#39;: &#39;SNOWFLAKE_WAREHOUSE&#39;},</span>\n<span class=\"sd\">                        }</span>\n<span class=\"sd\">                    }</span>\n<span class=\"sd\">                }</span>\n<span class=\"sd\">            },</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">SnowflakeConnection</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_filter_password</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Remove password from connection args for logging&quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"n\">v</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">args</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"n\">k</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;password&quot;</span><span class=\"p\">}</span>\n</pre></div>", "current_page_name": "_modules/dagster_snowflake/resources", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}