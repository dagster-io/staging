{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster.serdes", "body": "<h1>Source code for dagster.serdes</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">Serialization &amp; deserialization for Dagster objects.</span>\n\n<span class=\"sd\">Why have custom serialization?</span>\n\n<span class=\"sd\">* Default json serialization doesn&#39;t work well on namedtuples, which we use extensively to create</span>\n<span class=\"sd\">  immutable value types. Namedtuples serialize like tuples as flat lists.</span>\n<span class=\"sd\">* Explicit whitelisting should help ensure we are only persisting or communicating across a</span>\n<span class=\"sd\">  serialization boundary the types we expect to.</span>\n\n<span class=\"sd\">Why not pickle?</span>\n\n<span class=\"sd\">* This isn&#39;t meant to replace pickle in the conditions that pickle is reasonable to use</span>\n<span class=\"sd\">  (in memory, not human readable, etc) just handle the json case effectively.</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">hashlib</span>\n<span class=\"kn\">import</span> <span class=\"nn\">importlib</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n<span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">ABCMeta</span><span class=\"p\">,</span> <span class=\"n\">abstractmethod</span><span class=\"p\">,</span> <span class=\"n\">abstractproperty</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">enum</span> <span class=\"kn\">import</span> <span class=\"n\">Enum</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">import</span> <span class=\"nn\">yaml</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">seven</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">compose</span>\n\n<span class=\"n\">_WHITELIST_MAP</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"s2\">&quot;types&quot;</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">:</span> <span class=\"p\">{},</span> <span class=\"s2\">&quot;enum&quot;</span><span class=\"p\">:</span> <span class=\"p\">{}},</span>\n    <span class=\"s2\">&quot;persistence&quot;</span><span class=\"p\">:</span> <span class=\"p\">{},</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">create_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">snapshot</span><span class=\"p\">):</span>\n    <span class=\"n\">json_rep</span> <span class=\"o\">=</span> <span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">snapshot</span><span class=\"p\">)</span>\n    <span class=\"n\">m</span> <span class=\"o\">=</span> <span class=\"n\">hashlib</span><span class=\"o\">.</span><span class=\"n\">sha1</span><span class=\"p\">()</span>  <span class=\"c1\"># so that hexdigest is 40, not 64 bytes</span>\n    <span class=\"n\">m</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">json_rep</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">())</span>\n    <span class=\"k\">return</span> <span class=\"n\">m</span><span class=\"o\">.</span><span class=\"n\">hexdigest</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">serialize_pp</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">indent</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"n\">separators</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"s2\">&quot;,&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;: &quot;</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">register_serdes_tuple_fallbacks</span><span class=\"p\">(</span><span class=\"n\">fallback_map</span><span class=\"p\">):</span>\n    <span class=\"k\">for</span> <span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"n\">klass</span> <span class=\"ow\">in</span> <span class=\"n\">fallback_map</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n        <span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">][</span><span class=\"n\">class_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">klass</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_get_dunder_new_params_dict</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">version_info</span><span class=\"o\">.</span><span class=\"n\">major</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"s2\">&quot;This function can only be run in python 3&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># only pulled in by python 3</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">inspect</span> <span class=\"kn\">import</span> <span class=\"n\">signature</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">signature</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">parameters</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_get_dunder_new_params</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">_get_dunder_new_params_dict</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SerdesClassUsageError</span><span class=\"p\">(</span><span class=\"ne\">Exception</span><span class=\"p\">):</span>\n    <span class=\"k\">pass</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">Persistable</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">to_storage_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">default_to_storage_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_storage_dict</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">storage_dict</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">default_from_storage_dict</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">storage_dict</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_check_serdes_tuple_class_invariants</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">version_info</span><span class=\"o\">.</span><span class=\"n\">major</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">3</span><span class=\"p\">,</span> <span class=\"s2\">&quot;This function can only be run in python 3&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># pull this in dynamically because this method is only called in python 3 contexts</span>\n    <span class=\"kn\">from</span> <span class=\"nn\">inspect</span> <span class=\"kn\">import</span> <span class=\"n\">Parameter</span>\n\n    <span class=\"n\">dunder_new_params</span> <span class=\"o\">=</span> <span class=\"n\">_get_dunder_new_params</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">)</span>\n\n    <span class=\"n\">cls_param</span> <span class=\"o\">=</span> <span class=\"n\">dunder_new_params</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_with_header</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;For namedtuple </span><span class=\"si\">{class_name}</span><span class=\"s2\">: </span><span class=\"si\">{msg}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">class_name</span><span class=\"o\">=</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">cls_param</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">{</span><span class=\"s2\">&quot;cls&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_cls&quot;</span><span class=\"p\">}:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">SerdesClassUsageError</span><span class=\"p\">(</span>\n            <span class=\"n\">_with_header</span><span class=\"p\">(</span>\n                <span class=\"s1\">&#39;First parameter must be _cls or cls. Got &quot;</span><span class=\"si\">{name}</span><span class=\"s1\">&quot;.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">cls_param</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"n\">value_params</span> <span class=\"o\">=</span> <span class=\"n\">dunder_new_params</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:]</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">index</span><span class=\"p\">,</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">):</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">index</span> <span class=\"o\">&gt;=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">value_params</span><span class=\"p\">):</span>\n            <span class=\"n\">error_msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Missing parameters to __new__. You have declared fields &quot;</span>\n                <span class=\"s2\">&quot;in the named tuple that are not present as parameters to the &quot;</span>\n                <span class=\"s2\">&quot;to the __new__ method. In order for &quot;</span>\n                <span class=\"s2\">&quot;both serdes serialization and pickling to work, &quot;</span>\n                <span class=\"s2\">&quot;these must match. Missing: </span><span class=\"si\">{missing_fields}</span><span class=\"s2\">&quot;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">missing_fields</span><span class=\"o\">=</span><span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">:])))</span>\n\n            <span class=\"k\">raise</span> <span class=\"n\">SerdesClassUsageError</span><span class=\"p\">(</span><span class=\"n\">_with_header</span><span class=\"p\">(</span><span class=\"n\">error_msg</span><span class=\"p\">))</span>\n\n        <span class=\"n\">value_param</span> <span class=\"o\">=</span> <span class=\"n\">value_params</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">value_param</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"n\">field</span><span class=\"p\">:</span>\n            <span class=\"n\">error_msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Params to __new__ must match the order of field declaration in the namedtuple. &quot;</span>\n                <span class=\"s1\">&#39;Declared field number </span><span class=\"si\">{one_based_index}</span><span class=\"s1\"> in the namedtuple is &quot;</span><span class=\"si\">{field_name}</span><span class=\"s1\">&quot;. &#39;</span>\n                <span class=\"s1\">&#39;Parameter </span><span class=\"si\">{one_based_index}</span><span class=\"s1\"> in __new__ method is &quot;</span><span class=\"si\">{param_name}</span><span class=\"s1\">&quot;.&#39;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">one_based_index</span><span class=\"o\">=</span><span class=\"n\">index</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"o\">=</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">param_name</span><span class=\"o\">=</span><span class=\"n\">value_param</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span> <span class=\"n\">SerdesClassUsageError</span><span class=\"p\">(</span><span class=\"n\">_with_header</span><span class=\"p\">(</span><span class=\"n\">error_msg</span><span class=\"p\">))</span>\n\n    <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">value_params</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Ensure that remaining parameters have default values</span>\n        <span class=\"k\">for</span> <span class=\"n\">extra_param_index</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">),</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">value_params</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">value_params</span><span class=\"p\">[</span><span class=\"n\">extra_param_index</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">default</span> <span class=\"o\">==</span> <span class=\"n\">Parameter</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"p\">:</span>\n                <span class=\"n\">error_msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                    <span class=\"s1\">&#39;Parameter &quot;</span><span class=\"si\">{param_name}</span><span class=\"s1\">&quot; is a parameter to the __new__ &#39;</span>\n                    <span class=\"s2\">&quot;method but is not a field in this namedtuple. The only &quot;</span>\n                    <span class=\"s2\">&quot;reason why this should exist is that &quot;</span>\n                    <span class=\"s2\">&quot;it is a field that used to exist (we refer to this as the graveyard) &quot;</span>\n                    <span class=\"s2\">&quot;but no longer does. However it might exist in historical storage. This &quot;</span>\n                    <span class=\"s2\">&quot;parameter existing ensures that serdes continues to work. However these &quot;</span>\n                    <span class=\"s2\">&quot;must come at the end and have a default value for pickling to work.&quot;</span>\n                <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">param_name</span><span class=\"o\">=</span><span class=\"n\">value_params</span><span class=\"p\">[</span><span class=\"n\">extra_param_index</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"k\">raise</span> <span class=\"n\">SerdesClassUsageError</span><span class=\"p\">(</span><span class=\"n\">_with_header</span><span class=\"p\">(</span><span class=\"n\">error_msg</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_whitelist_for_persistence</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">__whitelist_for_persistence</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">subclass_param</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"s2\">&quot;klass&quot;</span><span class=\"p\">,</span> <span class=\"n\">Persistable</span><span class=\"p\">)</span>\n        <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;persistence&quot;</span><span class=\"p\">][</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">klass</span>\n        <span class=\"k\">return</span> <span class=\"n\">klass</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">__whitelist_for_persistence</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_whitelist_for_serdes</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">__whitelist_for_serdes</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"n\">Enum</span><span class=\"p\">):</span>\n            <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;enum&quot;</span><span class=\"p\">][</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">klass</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">):</span>\n            <span class=\"c1\"># only catch this in python 3 dev environments</span>\n            <span class=\"c1\"># no need to do backwards compat since this is</span>\n            <span class=\"c1\"># only for development time</span>\n            <span class=\"k\">if</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">version_info</span><span class=\"o\">.</span><span class=\"n\">major</span> <span class=\"o\">&gt;=</span> <span class=\"mi\">3</span><span class=\"p\">:</span>\n                <span class=\"n\">_check_serdes_tuple_class_invariants</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">)</span>\n            <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">][</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">klass</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span><span class=\"s2\">&quot;Can not whitelist class </span><span class=\"si\">{klass}</span><span class=\"s2\"> for serdes&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">=</span><span class=\"n\">klass</span><span class=\"p\">))</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">klass</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">__whitelist_for_serdes</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">whitelist_for_serdes</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">class_param</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"s2\">&quot;klass&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">_whitelist_for_serdes</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">)(</span><span class=\"n\">klass</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">whitelist_for_persistence</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">class_param</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"s2\">&quot;klass&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">compose</span><span class=\"p\">(</span>\n        <span class=\"n\">_whitelist_for_persistence</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">),</span>\n        <span class=\"n\">_whitelist_for_serdes</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">),</span>\n    <span class=\"p\">)(</span><span class=\"n\">klass</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">pack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">]</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">):</span>\n        <span class=\"n\">klass_name</span> <span class=\"o\">=</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">klass_name</span> <span class=\"ow\">in</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;Can only serialize whitelisted namedtuples, received tuple </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">klass_name</span> <span class=\"ow\">in</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;persistence&quot;</span><span class=\"p\">]:</span>\n            <span class=\"k\">return</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">to_storage_value</span><span class=\"p\">()</span>\n        <span class=\"n\">base_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">_asdict</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()}</span>\n        <span class=\"n\">base_dict</span><span class=\"p\">[</span><span class=\"s2\">&quot;__class__&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">klass_name</span>\n        <span class=\"k\">return</span> <span class=\"n\">base_dict</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">Enum</span><span class=\"p\">):</span>\n        <span class=\"n\">klass_name</span> <span class=\"o\">=</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">klass_name</span> <span class=\"ow\">in</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;enum&quot;</span><span class=\"p\">],</span>\n            <span class=\"s2\">&quot;Can only serialize whitelisted Enums, received </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">klass_name</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;__enum__&quot;</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">)}</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">set</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;__set__&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">]}</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">frozenset</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;__frozenset__&quot;</span><span class=\"p\">:</span> <span class=\"p\">[</span><span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">]}</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">val</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">nt</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">json_kwargs</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">nt</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">),</span> <span class=\"o\">**</span><span class=\"n\">json_kwargs</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">serialize_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span><span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">deserialize_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">_unpack_value</span><span class=\"p\">(</span>\n        <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"s2\">&quot;val&quot;</span><span class=\"p\">)),</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">nt</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">json_kwargs</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">_serialize_dagster_namedtuple</span><span class=\"p\">(</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">tuple_param</span><span class=\"p\">(</span><span class=\"n\">nt</span><span class=\"p\">,</span> <span class=\"s2\">&quot;nt&quot;</span><span class=\"p\">),</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">json_kwargs</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">unpack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span><span class=\"p\">,)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">]</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;__class__&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">klass_name</span> <span class=\"o\">=</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"s2\">&quot;__class__&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">klass_name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">]:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span>\n                <span class=\"s1\">&#39;Attempted to deserialize class &quot;</span><span class=\"si\">{}</span><span class=\"s1\">&quot; which is not in the serdes whitelist.&#39;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">klass_name</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"n\">klass</span> <span class=\"o\">=</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;tuple&quot;</span><span class=\"p\">][</span><span class=\"n\">klass_name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">klass</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"n\">unpacked_val</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()}</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">klass_name</span> <span class=\"ow\">in</span> <span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;persistence&quot;</span><span class=\"p\">]:</span>\n            <span class=\"k\">return</span> <span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">from_storage_dict</span><span class=\"p\">(</span><span class=\"n\">unpacked_val</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Naively implements backwards compatibility by filtering arguments that aren&#39;t present in</span>\n        <span class=\"c1\"># the constructor. If a property is present in the serialized object, but doesn&#39;t exist in</span>\n        <span class=\"c1\"># the version of the class loaded into memory, that property will be completely ignored.</span>\n        <span class=\"c1\"># The call to seven.get_args turns out to be pretty expensive -- we should probably turn</span>\n        <span class=\"c1\"># to, e.g., manually managing the deprecated keys on the serdes constructor.</span>\n        <span class=\"n\">args_for_class</span> <span class=\"o\">=</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">get_args</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">)</span>\n        <span class=\"n\">filtered_val</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"n\">v</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">unpacked_val</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"n\">k</span> <span class=\"ow\">in</span> <span class=\"n\">args_for_class</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">klass</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">filtered_val</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;__enum__&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">member</span> <span class=\"o\">=</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"s2\">&quot;__enum__&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"s2\">&quot;.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">whitelist_map</span><span class=\"p\">[</span><span class=\"s2\">&quot;types&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;enum&quot;</span><span class=\"p\">][</span><span class=\"n\">name</span><span class=\"p\">],</span> <span class=\"n\">member</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;__set__&quot;</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"nb\">set</span><span class=\"p\">([</span><span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"s2\">&quot;__set__&quot;</span><span class=\"p\">]])</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;__frozenset__&quot;</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"nb\">frozenset</span><span class=\"p\">([</span><span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"p\">[</span><span class=\"s2\">&quot;__frozenset__&quot;</span><span class=\"p\">]])</span>\n    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()}</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">val</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">json_str</span><span class=\"p\">):</span>\n    <span class=\"n\">dagster_namedtuple</span> <span class=\"o\">=</span> <span class=\"n\">_deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">json_str</span><span class=\"p\">,</span> <span class=\"s2\">&quot;json_str&quot;</span><span class=\"p\">),</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">_WHITELIST_MAP</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n        <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">dagster_namedtuple</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;Output of deserialized json_str was not a namedtuple. Received type </span><span class=\"si\">{}</span><span class=\"s2\">.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">dagster_namedtuple</span><span class=\"p\">)</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">dagster_namedtuple</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">json_str</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">_unpack_value</span><span class=\"p\">(</span><span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">json_str</span><span class=\"p\">),</span> <span class=\"n\">whitelist_map</span><span class=\"o\">=</span><span class=\"n\">whitelist_map</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">default_to_storage_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">):</span>\n    <span class=\"n\">base_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">key</span><span class=\"p\">:</span> <span class=\"n\">_pack_value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">whitelist_map</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">_asdict</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()}</span>\n    <span class=\"n\">base_dict</span><span class=\"p\">[</span><span class=\"s2\">&quot;__class__&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n    <span class=\"k\">return</span> <span class=\"n\">base_dict</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">default_from_storage_dict</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">storage_dict</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">storage_dict</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"ConfigurableClassData\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/internals/#dagster.serdes.ConfigurableClassData\">[docs]</a><span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">ConfigurableClassData</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;_ConfigurableClassData&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;module_name class_name config_yaml&quot;</span><span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Serializable tuple describing where to find a class and the config fragment that should</span>\n<span class=\"sd\">    be used to instantiate it.</span>\n\n<span class=\"sd\">    Users should not instantiate this class directly.</span>\n\n<span class=\"sd\">    Classes intended to be serialized in this way should implement the</span>\n<span class=\"sd\">    :py:class:`dagster.serdes.ConfigurableClass` mixin.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">module_name</span><span class=\"p\">,</span> <span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"n\">config_yaml</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ConfigurableClassData</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">module_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;module_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;class_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">config_yaml</span><span class=\"p\">,</span> <span class=\"s2\">&quot;config_yaml&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">info_str</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">{p}</span><span class=\"s2\">module: </span><span class=\"si\">{module}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">{p}</span><span class=\"s2\">class: </span><span class=\"si\">{cls}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">{p}</span><span class=\"s2\">config:</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">{p}</span><span class=\"s2\">  </span><span class=\"si\">{config}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">p</span><span class=\"o\">=</span><span class=\"n\">prefix</span><span class=\"p\">,</span> <span class=\"n\">module</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config_yaml</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">rehydrate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInvalidConfigError</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.config.field</span> <span class=\"kn\">import</span> <span class=\"n\">resolve_to_config_type</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.config.validate</span> <span class=\"kn\">import</span> <span class=\"n\">process_config</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">module</span> <span class=\"o\">=</span> <span class=\"n\">importlib</span><span class=\"o\">.</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">ModuleNotFoundError</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Couldn&#39;t import module </span><span class=\"si\">{module_name}</span><span class=\"s2\"> when attempting to load the &quot;</span>\n                <span class=\"s2\">&quot;configurable class </span><span class=\"si\">{configurable_class}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">module_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span><span class=\"p\">,</span>\n                    <span class=\"n\">configurable_class</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;.&quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">klass</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Couldn&#39;t find class </span><span class=\"si\">{class_name}</span><span class=\"s2\"> in module when attempting to load the &quot;</span>\n                <span class=\"s2\">&quot;configurable class </span><span class=\"si\">{configurable_class}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">class_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">,</span>\n                    <span class=\"n\">configurable_class</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;.&quot;</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">CheckError</span><span class=\"p\">(</span>\n                <span class=\"n\">klass</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;class </span><span class=\"si\">{class_name}</span><span class=\"s2\"> in module </span><span class=\"si\">{module_name}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">class_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_name</span><span class=\"p\">,</span> <span class=\"n\">module_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">module_name</span>\n                <span class=\"p\">),</span>\n                <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"n\">config_dict</span> <span class=\"o\">=</span> <span class=\"n\">yaml</span><span class=\"o\">.</span><span class=\"n\">safe_load</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config_yaml</span><span class=\"p\">)</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">process_config</span><span class=\"p\">(</span><span class=\"n\">resolve_to_config_type</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">config_type</span><span class=\"p\">()),</span> <span class=\"n\">config_dict</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvalidConfigError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Errors whilst loading configuration for </span><span class=\"si\">{}</span><span class=\"s2\">.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">config_type</span><span class=\"p\">()),</span>\n                <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">errors</span><span class=\"p\">,</span>\n                <span class=\"n\">config_dict</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">klass</span><span class=\"o\">.</span><span class=\"n\">from_config_value</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"ConfigurableClass\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/internals/#dagster.serdes.ConfigurableClass\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ConfigurableClass</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Abstract mixin for classes that can be loaded from config.</span>\n\n<span class=\"sd\">    This supports a powerful plugin pattern which avoids both a) a lengthy, hard-to-synchronize list</span>\n<span class=\"sd\">    of conditional imports / optional extras_requires in dagster core and b) a magic directory or</span>\n<span class=\"sd\">    file in which third parties can place plugin packages. Instead, the intention is to make, e.g.,</span>\n<span class=\"sd\">    run storage, pluggable with a config chunk like:</span>\n\n<span class=\"sd\">    .. code-block:: yaml</span>\n\n<span class=\"sd\">        run_storage:</span>\n<span class=\"sd\">            module: very_cool_package.run_storage</span>\n<span class=\"sd\">            class: SplendidRunStorage</span>\n<span class=\"sd\">            config:</span>\n<span class=\"sd\">                magic_word: &quot;quux&quot;</span>\n\n<span class=\"sd\">    This same pattern should eventually be viable for other system components, e.g. engines.</span>\n\n<span class=\"sd\">    The ``ConfigurableClass`` mixin provides the necessary hooks for classes to be instantiated from</span>\n<span class=\"sd\">    an instance of ``ConfigurableClassData``.</span>\n\n<span class=\"sd\">    Pieces of the Dagster system which we wish to make pluggable in this way should consume a config</span>\n<span class=\"sd\">    type such as:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        {&#39;module&#39;: str, &#39;class&#39;: str, &#39;config&#39;: Field(Permissive())}</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractproperty</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Subclass must be able to return the inst_data as a property if it has been constructed</span>\n<span class=\"sd\">        through the from_config_value code path.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n<div class=\"viewcode-block\" id=\"ConfigurableClass.config_type\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/internals/#dagster.serdes.ConfigurableClass.config_type\">[docs]</a>    <span class=\"nd\">@classmethod</span>\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;dagster.ConfigType: The config type against which to validate a config yaml fragment</span>\n<span class=\"sd\">        serialized in an instance of ``ConfigurableClassData``.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span></div>\n\n<div class=\"viewcode-block\" id=\"ConfigurableClass.from_config_value\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/internals/#dagster.serdes.ConfigurableClass.from_config_value\">[docs]</a>    <span class=\"nd\">@staticmethod</span>\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;New up an instance of the ConfigurableClass from a validated config value.</span>\n\n<span class=\"sd\">        Called by ConfigurableClassData.rehydrate.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            config_value (dict): The validated config value to use. Typically this should be the</span>\n<span class=\"sd\">                ``value`` attribute of a</span>\n<span class=\"sd\">                :py:class:`~dagster.core.types.evaluator.evaluation.EvaluateValueResult`.</span>\n\n\n<span class=\"sd\">        A common pattern is for the implementation to align the config_value with the signature</span>\n<span class=\"sd\">        of the ConfigurableClass&#39;s constructor:</span>\n\n<span class=\"sd\">        .. code-block:: python</span>\n\n<span class=\"sd\">            @staticmethod</span>\n<span class=\"sd\">            def from_config_value(inst_data, config_value):</span>\n<span class=\"sd\">                return MyConfigurableClass(inst_data=inst_data, **config_value)</span>\n\n<span class=\"sd\">        &quot;&quot;&quot;</span></div></div>\n</pre></div>", "current_page_name": "_modules/dagster/serdes", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}