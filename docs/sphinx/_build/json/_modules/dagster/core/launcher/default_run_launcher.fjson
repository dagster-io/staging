{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.launcher.default_run_launcher", "body": "<h1>Source code for dagster.core.launcher.default_run_launcher</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">time</span>\n<span class=\"kn\">import</span> <span class=\"nn\">weakref</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">grpc</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">seven</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterLaunchFailedError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"n\">ExternalPipeline</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation.handle</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">GrpcServerRepositoryLocationHandle</span><span class=\"p\">,</span>\n    <span class=\"n\">ManagedGrpcPythonEnvRepositoryLocationHandle</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.instance</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInstance</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.tags</span> <span class=\"kn\">import</span> <span class=\"n\">GRPC_INFO_TAG</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.grpc.client</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterGrpcClient</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.grpc.types</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">CanCancelExecutionRequest</span><span class=\"p\">,</span>\n    <span class=\"n\">CancelExecutionRequest</span><span class=\"p\">,</span>\n    <span class=\"n\">ExecuteExternalPipelineArgs</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">merge_dicts</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.base</span> <span class=\"kn\">import</span> <span class=\"n\">RunLauncher</span>\n\n<span class=\"n\">GRPC_REPOSITORY_LOCATION_HANDLE_TYPES</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n    <span class=\"n\">GrpcServerRepositoryLocationHandle</span><span class=\"p\">,</span>\n    <span class=\"n\">ManagedGrpcPythonEnvRepositoryLocationHandle</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"DefaultRunLauncher\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/internals/#dagster.core.launcher.DefaultRunLauncher\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">DefaultRunLauncher</span><span class=\"p\">(</span><span class=\"n\">RunLauncher</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Launches runs against running GRPC servers.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_weakref</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">inst_data</span>\n\n        <span class=\"c1\"># Used for test cleanup purposes only</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_to_repository_location_handle_cache</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">DefaultRunLauncher</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_instance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_weakref</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_weakref</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">initialize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Must only call initialize once&quot;</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Store a weakref to avoid a circular reference / enable GC</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_weakref</span> <span class=\"o\">=</span> <span class=\"n\">weakref</span><span class=\"o\">.</span><span class=\"n\">ref</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">launch_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Subclasses must implement this method.&quot;&quot;&quot;</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">external_pipeline</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_pipeline&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalPipeline</span><span class=\"p\">)</span>\n\n        <span class=\"n\">repository_location_handle</span> <span class=\"o\">=</span> <span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">repository_handle</span><span class=\"o\">.</span><span class=\"n\">repository_location_handle</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst</span><span class=\"p\">(</span>\n            <span class=\"n\">repository_location_handle</span><span class=\"p\">,</span>\n            <span class=\"n\">GRPC_REPOSITORY_LOCATION_HANDLE_TYPES</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;DefaultRunLauncher: Can&#39;t launch runs for pipeline not loaded from a GRPC server&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">add_run_tags</span><span class=\"p\">(</span>\n            <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"p\">{</span>\n                <span class=\"n\">GRPC_INFO_TAG</span><span class=\"p\">:</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">dumps</span><span class=\"p\">(</span>\n                    <span class=\"n\">merge_dicts</span><span class=\"p\">(</span>\n                        <span class=\"p\">{</span><span class=\"s2\">&quot;host&quot;</span><span class=\"p\">:</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">},</span>\n                        <span class=\"p\">{</span><span class=\"s2\">&quot;port&quot;</span><span class=\"p\">:</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">}</span>\n                        <span class=\"k\">if</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">port</span>\n                        <span class=\"k\">else</span> <span class=\"p\">{</span><span class=\"s2\">&quot;socket&quot;</span><span class=\"p\">:</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">socket</span><span class=\"p\">},</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">},</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">start_run</span><span class=\"p\">(</span>\n            <span class=\"n\">ExecuteExternalPipelineArgs</span><span class=\"p\">(</span>\n                <span class=\"n\">pipeline_origin</span><span class=\"o\">=</span><span class=\"n\">external_pipeline</span><span class=\"o\">.</span><span class=\"n\">get_external_origin</span><span class=\"p\">(),</span>\n                <span class=\"n\">pipeline_run_id</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n                <span class=\"n\">instance_ref</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_ref</span><span class=\"p\">(),</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">success</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"p\">(</span>\n                <span class=\"n\">DagsterLaunchFailedError</span><span class=\"p\">(</span>\n                    <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">serializable_error_info</span><span class=\"o\">=</span><span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">serializable_error_info</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_to_repository_location_handle_cache</span><span class=\"p\">[</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">repository_location_handle</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">run</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_grpc_client_for_termination</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">run</span> <span class=\"ow\">or</span> <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">is_finished</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"n\">tags</span> <span class=\"o\">=</span> <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">tags</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">GRPC_INFO_TAG</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"n\">grpc_info</span> <span class=\"o\">=</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">tags</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">GRPC_INFO_TAG</span><span class=\"p\">))</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">DagsterGrpcClient</span><span class=\"p\">(</span>\n            <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"n\">grpc_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;port&quot;</span><span class=\"p\">),</span> <span class=\"n\">socket</span><span class=\"o\">=</span><span class=\"n\">grpc_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;socket&quot;</span><span class=\"p\">),</span> <span class=\"n\">host</span><span class=\"o\">=</span><span class=\"n\">grpc_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;host&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">can_terminate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_grpc_client_for_termination</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">client</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">can_cancel_execution</span><span class=\"p\">(</span><span class=\"n\">CanCancelExecutionRequest</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">),</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">5</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">grpc</span><span class=\"o\">.</span><span class=\"n\">_channel</span><span class=\"o\">.</span><span class=\"n\">_InactiveRpcError</span><span class=\"p\">:</span>  <span class=\"c1\"># pylint: disable=protected-access</span>\n            <span class=\"c1\"># Server that created the run may no longer exist</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">can_cancel</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">terminate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">run</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Received pipeline termination request.&quot;</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_grpc_client_for_termination</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">client</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"s2\">&quot;Unable to get grpc client to send termination request to.&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">pipeline_run</span><span class=\"o\">=</span><span class=\"n\">run</span><span class=\"p\">,</span>\n                <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">cancel_execution</span><span class=\"p\">(</span><span class=\"n\">CancelExecutionRequest</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">res</span><span class=\"o\">.</span><span class=\"n\">success</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">timeout</span><span class=\"o\">=</span><span class=\"mi\">30</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If this hasn&#39;t been initialized at all, we can just do a noop</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">total_time</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">interval</span> <span class=\"o\">=</span> <span class=\"mf\">0.01</span>\n\n        <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n            <span class=\"n\">active_run_ids</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"n\">run_id</span>\n                <span class=\"k\">for</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_to_repository_location_handle_cache</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">()</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n                    <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">is_finished</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">]</span>\n\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">active_run_ids</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">total_time</span> <span class=\"o\">&gt;=</span> <span class=\"n\">timeout</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">Exception</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Timed out waiting for these runs to finish: </span><span class=\"si\">{active_run_ids}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">active_run_ids</span><span class=\"o\">=</span><span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">active_run_ids</span><span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">total_time</span> <span class=\"o\">+=</span> <span class=\"n\">interval</span>\n            <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">interval</span><span class=\"p\">)</span>\n            <span class=\"n\">interval</span> <span class=\"o\">=</span> <span class=\"n\">interval</span> <span class=\"o\">*</span> <span class=\"mi\">2</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">cleanup_managed_grpc_servers</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Shut down any managed grpc servers that used this run launcher to start a run.</span>\n<span class=\"sd\">        Should only be used for teardown purposes within tests (generally it&#39;s fine for a server</span>\n<span class=\"sd\">        to out-live the host process, since it might be finishing an execution and will</span>\n<span class=\"sd\">        automatically shut itself down once it no longer receives a heartbeat from the host</span>\n<span class=\"sd\">        process). But in tests, gRPC servers access the DagsterInstance during execution, so we need</span>\n<span class=\"sd\">        to shut them down before we can safely remove the temporary directory created for the</span>\n<span class=\"sd\">        DagsterInstance.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">for</span> <span class=\"n\">repository_location_handle</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id_to_repository_location_handle_cache</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_location_handle</span><span class=\"p\">,</span> <span class=\"n\">ManagedGrpcPythonEnvRepositoryLocationHandle</span><span class=\"p\">):</span>\n                <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n                    <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">is_cleaned_up</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;ManagedGrpcPythonRepositoryLocationHandle was not cleaned up &quot;</span>\n                    <span class=\"s2\">&quot;before test teardown. This may indicate that the handle is not &quot;</span>\n                    <span class=\"s2\">&quot;being used as a contextmanager.&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">repository_location_handle</span><span class=\"o\">.</span><span class=\"n\">grpc_server_process</span><span class=\"o\">.</span><span class=\"n\">wait</span><span class=\"p\">()</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/launcher/default_run_launcher", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}