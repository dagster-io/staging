{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster.core.instance", "body": "<h1>Source code for dagster.core.instance</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n<span class=\"kn\">import</span> <span class=\"nn\">time</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">defaultdict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">enum</span> <span class=\"kn\">import</span> <span class=\"n\">Enum</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">yaml</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">seven</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.events</span> <span class=\"kn\">import</span> <span class=\"n\">AssetKey</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.pipeline</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineDefinition</span><span class=\"p\">,</span> <span class=\"n\">PipelineSubsetDefinition</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">,</span>\n    <span class=\"n\">DagsterRunAlreadyExists</span><span class=\"p\">,</span>\n    <span class=\"n\">DagsterRunConflict</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.resolve_versions</span> <span class=\"kn\">import</span> <span class=\"n\">resolve_step_output_versions</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.migration.utils</span> <span class=\"kn\">import</span> <span class=\"n\">upgrading_instance</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunStatus</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.tags</span> <span class=\"kn\">import</span> <span class=\"n\">MEMOIZED_RUN_TAG</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.system_config.objects</span> <span class=\"kn\">import</span> <span class=\"n\">EnvironmentConfig</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.utils</span> <span class=\"kn\">import</span> <span class=\"n\">str_format_list</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.seven</span> <span class=\"kn\">import</span> <span class=\"n\">get_current_datetime_in_utc</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils.error</span> <span class=\"kn\">import</span> <span class=\"n\">serializable_error_info_from_exc_info</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.config</span> <span class=\"kn\">import</span> <span class=\"n\">DAGSTER_CONFIG_YAML_FILENAME</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.ref</span> <span class=\"kn\">import</span> <span class=\"n\">InstanceRef</span>\n\n<span class=\"c1\"># &#39;airflow_execution_date&#39; and &#39;is_airflow_ingest_pipeline&#39; are hardcoded tags used in the</span>\n<span class=\"c1\"># airflow ingestion logic (see: dagster_pipeline_factory.py). &#39;airflow_execution_date&#39; stores the</span>\n<span class=\"c1\"># &#39;execution_date&#39; used in Airflow operator execution and &#39;is_airflow_ingest_pipeline&#39; determines</span>\n<span class=\"c1\"># whether &#39;airflow_execution_date&#39; is needed.</span>\n<span class=\"c1\"># https://github.com/dagster-io/dagster/issues/2403</span>\n<span class=\"n\">AIRFLOW_EXECUTION_DATE_STR</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;airflow_execution_date&quot;</span>\n<span class=\"n\">IS_AIRFLOW_INGEST_PIPELINE_STR</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;is_airflow_ingest_pipeline&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_is_dagster_home_set</span><span class=\"p\">():</span>\n    <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getenv</span><span class=\"p\">(</span><span class=\"s2\">&quot;DAGSTER_HOME&quot;</span><span class=\"p\">))</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">is_memoized_run</span><span class=\"p\">(</span><span class=\"n\">tags</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">tags</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">MEMOIZED_RUN_TAG</span> <span class=\"ow\">in</span> <span class=\"n\">tags</span> <span class=\"ow\">and</span> <span class=\"n\">tags</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">MEMOIZED_RUN_TAG</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;true&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_dagster_home</span><span class=\"p\">():</span>\n    <span class=\"n\">dagster_home_path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getenv</span><span class=\"p\">(</span><span class=\"s2\">&quot;DAGSTER_HOME&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">dagster_home_path</span><span class=\"p\">:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;The environment variable $DAGSTER_HOME is not set. Dagster requires this &quot;</span>\n                <span class=\"s2\">&quot;environment variable to be set to an existing directory in your filesystem &quot;</span>\n                <span class=\"s2\">&quot;that contains your dagster instance configuration file (dagster.yaml).</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n                <span class=\"s2\">&quot;You can resolve this error by exporting the environment variable.&quot;</span>\n                <span class=\"s2\">&quot;For example, you can run the following command in your shell or &quot;</span>\n                <span class=\"s2\">&quot;include it in your shell configuration file:</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n                <span class=\"s1\">&#39;</span><span class=\"se\">\\t</span><span class=\"s1\">export DAGSTER_HOME=&quot;~/dagster_home&quot;&#39;</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"n\">dagster_home_path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">expanduser</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isabs</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">):</span>\n        <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;$DAGSTER_HOME &quot;</span><span class=\"si\">{}</span><span class=\"s1\">&quot; must be an absolute path. Dagster requires this &#39;</span>\n                <span class=\"s2\">&quot;environment variable to be set to an existing directory in your filesystem that&quot;</span>\n                <span class=\"s2\">&quot;contains your dagster instance configuration file (dagster.yaml).&quot;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">)):</span>\n        <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span>\n                <span class=\"s1\">&#39;$DAGSTER_HOME &quot;</span><span class=\"si\">{}</span><span class=\"s1\">&quot; is not a directory or does not exist. Dagster requires this &#39;</span>\n                <span class=\"s2\">&quot;environment variable to be set to an existing directory in your filesystem that &quot;</span>\n                <span class=\"s2\">&quot;contains your dagster instance configuration file (dagster.yaml).&quot;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">dagster_home_path</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">dagster_home_path</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_check_run_equality</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">candidate_run</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">candidate_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;candidate_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n\n    <span class=\"n\">field_diff</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">:</span>\n        <span class=\"n\">expected_value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">)</span>\n        <span class=\"n\">candidate_value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">candidate_run</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">expected_value</span> <span class=\"o\">!=</span> <span class=\"n\">candidate_value</span><span class=\"p\">:</span>\n            <span class=\"n\">field_diff</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">expected_value</span><span class=\"p\">,</span> <span class=\"n\">candidate_value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">field_diff</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_format_field_diff</span><span class=\"p\">(</span><span class=\"n\">field_diff</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n        <span class=\"p\">[</span>\n            <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;    </span><span class=\"si\">{field_name}</span><span class=\"s2\">:</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n                <span class=\"o\">+</span> <span class=\"s2\">&quot;        Expected: </span><span class=\"si\">{expected_value}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n                <span class=\"o\">+</span> <span class=\"s2\">&quot;        Received: </span><span class=\"si\">{candidate_value}</span><span class=\"s2\">&quot;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">field_name</span><span class=\"o\">=</span><span class=\"n\">field_name</span><span class=\"p\">,</span>\n                <span class=\"n\">expected_value</span><span class=\"o\">=</span><span class=\"n\">expected_value</span><span class=\"p\">,</span>\n                <span class=\"n\">candidate_value</span><span class=\"o\">=</span><span class=\"n\">candidate_value</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">field_name</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">expected_value</span><span class=\"p\">,</span> <span class=\"n\">candidate_value</span><span class=\"p\">,)</span> <span class=\"ow\">in</span> <span class=\"n\">field_diff</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n        <span class=\"p\">]</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_EventListenerLogHandler</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Handler</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span> <span class=\"o\">=</span> <span class=\"n\">instance</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">_EventListenerLogHandler</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">emit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">record</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events.log</span> <span class=\"kn\">import</span> <span class=\"n\">construct_event_record</span><span class=\"p\">,</span> <span class=\"n\">StructuredLoggerMessage</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">event</span> <span class=\"o\">=</span> <span class=\"n\">construct_event_record</span><span class=\"p\">(</span>\n                <span class=\"n\">StructuredLoggerMessage</span><span class=\"p\">(</span>\n                    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">msg</span><span class=\"p\">,</span>\n                    <span class=\"n\">level</span><span class=\"o\">=</span><span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">levelno</span><span class=\"p\">,</span>\n                    <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">record</span><span class=\"o\">.</span><span class=\"n\">dagster_meta</span><span class=\"p\">,</span>\n                    <span class=\"n\">record</span><span class=\"o\">=</span><span class=\"n\">record</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance</span><span class=\"o\">.</span><span class=\"n\">handle_new_event</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span>\n\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>  <span class=\"c1\"># pylint: disable=W0703</span>\n            <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">critical</span><span class=\"p\">(</span><span class=\"s2\">&quot;Error during instance event listen&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">exception</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">))</span>\n            <span class=\"k\">raise</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">InstanceType</span><span class=\"p\">(</span><span class=\"n\">Enum</span><span class=\"p\">):</span>\n    <span class=\"n\">PERSISTENT</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;PERSISTENT&quot;</span>\n    <span class=\"n\">EPHEMERAL</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;EPHEMERAL&quot;</span>\n\n\n<div class=\"viewcode-block\" id=\"DagsterInstance\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">DagsterInstance</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;Core abstraction for managing Dagster&#39;s access to storage and other resources.</span>\n\n<span class=\"sd\">    Use DagsterInstance.get() to grab the current DagsterInstance which will load based on</span>\n<span class=\"sd\">    the values in the ``dagster.yaml`` file in ``$DAGSTER_HOME`` if set, otherwise fallback</span>\n<span class=\"sd\">    to using an ephemeral in-memory set of components.</span>\n\n<span class=\"sd\">    Configuration of this class should be done by setting values in ``$DAGSTER_HOME/dagster.yaml``.</span>\n<span class=\"sd\">    For example, to use Postgres for run and event log storage, you can write a ``dagster.yaml``</span>\n<span class=\"sd\">    such as the following:</span>\n\n<span class=\"sd\">    .. literalinclude:: ../../../../docs/sections/deploying/postgres_dagster.yaml</span>\n<span class=\"sd\">       :caption: dagster.yaml</span>\n<span class=\"sd\">       :language: YAML</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        instance_type (InstanceType): Indicates whether the instance is ephemeral or persistent.</span>\n<span class=\"sd\">            Users should not attempt to set this value directly or in their ``dagster.yaml`` files.</span>\n<span class=\"sd\">        local_artifact_storage (LocalArtifactStorage): The local artifact storage is used to</span>\n<span class=\"sd\">            configure storage for any artifacts that require a local disk, such as schedules, or</span>\n<span class=\"sd\">            when using the filesystem system storage to manage files and intermediates. By default,</span>\n<span class=\"sd\">            this will be a :py:class:`dagster.core.storage.root.LocalArtifactStorage`. Configurable</span>\n<span class=\"sd\">            in ``dagster.yaml`` using the :py:class:`~dagster.serdes.ConfigurableClass`</span>\n<span class=\"sd\">            machinery.</span>\n<span class=\"sd\">        run_storage (RunStorage): The run storage is used to store metadata about ongoing and past</span>\n<span class=\"sd\">            pipeline runs. By default, this will be a</span>\n<span class=\"sd\">            :py:class:`dagster.core.storage.runs.SqliteRunStorage`. Configurable in ``dagster.yaml``</span>\n<span class=\"sd\">            using the :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>\n<span class=\"sd\">        event_storage (EventLogStorage): Used to store the structured event logs generated by</span>\n<span class=\"sd\">            pipeline runs. By default, this will be a</span>\n<span class=\"sd\">            :py:class:`dagster.core.storage.event_log.SqliteEventLogStorage`. Configurable in</span>\n<span class=\"sd\">            ``dagster.yaml`` using the :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>\n<span class=\"sd\">        compute_log_manager (ComputeLogManager): The compute log manager handles stdout and stderr</span>\n<span class=\"sd\">            logging for solid compute functions. By default, this will be a</span>\n<span class=\"sd\">            :py:class:`dagster.core.storage.local_compute_log_manager.LocalComputeLogManager`.</span>\n<span class=\"sd\">            Configurable in ``dagster.yaml`` using the</span>\n<span class=\"sd\">            :py:class:`~dagster.serdes.ConfigurableClass` machinery.</span>\n<span class=\"sd\">        run_coordinator (RunCoordinator): A runs coordinator may be used to manage the execution</span>\n<span class=\"sd\">            of pipeline runs.</span>\n<span class=\"sd\">        run_launcher (Optional[RunLauncher]): Optionally, a run launcher may be used to enable</span>\n<span class=\"sd\">            a Dagster instance to launch pipeline runs, e.g. on a remote Kubernetes cluster, in</span>\n<span class=\"sd\">            addition to running them locally.</span>\n<span class=\"sd\">        settings (Optional[Dict]): Specifies certain per-instance settings,</span>\n<span class=\"sd\">            such as feature flags. These are set in the ``dagster.yaml`` under a set of whitelisted</span>\n<span class=\"sd\">            keys.</span>\n<span class=\"sd\">        ref (Optional[InstanceRef]): Used by internal machinery to pass instances across process</span>\n<span class=\"sd\">            boundaries.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">_PROCESS_TEMPDIR</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">instance_type</span><span class=\"p\">,</span>\n        <span class=\"n\">local_artifact_storage</span><span class=\"p\">,</span>\n        <span class=\"n\">run_storage</span><span class=\"p\">,</span>\n        <span class=\"n\">event_storage</span><span class=\"p\">,</span>\n        <span class=\"n\">compute_log_manager</span><span class=\"p\">,</span>\n        <span class=\"n\">schedule_storage</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">scheduler</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">run_coordinator</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">run_launcher</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">settings</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">ref</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.compute_log_manager</span> <span class=\"kn\">import</span> <span class=\"n\">ComputeLogManager</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.event_log</span> <span class=\"kn\">import</span> <span class=\"n\">EventLogStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.root</span> <span class=\"kn\">import</span> <span class=\"n\">LocalArtifactStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.runs</span> <span class=\"kn\">import</span> <span class=\"n\">RunStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.schedules</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.scheduler</span> <span class=\"kn\">import</span> <span class=\"n\">Scheduler</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.run_coordinator</span> <span class=\"kn\">import</span> <span class=\"n\">RunCoordinator</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.launcher</span> <span class=\"kn\">import</span> <span class=\"n\">RunLauncher</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_type</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance_type</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance_type&quot;</span><span class=\"p\">,</span> <span class=\"n\">InstanceType</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">local_artifact_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;local_artifact_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">LocalArtifactStorage</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">event_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">EventLogStorage</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">run_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">RunStorage</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_compute_log_manager</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">compute_log_manager</span><span class=\"p\">,</span> <span class=\"s2\">&quot;compute_log_manager&quot;</span><span class=\"p\">,</span> <span class=\"n\">ComputeLogManager</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">schedule_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleStorage</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">scheduler</span><span class=\"p\">,</span> <span class=\"s2\">&quot;scheduler&quot;</span><span class=\"p\">,</span> <span class=\"n\">Scheduler</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_coordinator</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">run_coordinator</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_coordinator&quot;</span><span class=\"p\">,</span> <span class=\"n\">RunCoordinator</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_coordinator</span><span class=\"o\">.</span><span class=\"n\">initialize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">run_launcher</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_launcher&quot;</span><span class=\"p\">,</span> <span class=\"n\">RunLauncher</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span><span class=\"o\">.</span><span class=\"n\">initialize</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">settings</span><span class=\"p\">,</span> <span class=\"s2\">&quot;settings&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_ref</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">ref</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ref&quot;</span><span class=\"p\">,</span> <span class=\"n\">InstanceRef</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_subscribers</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># ctors</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">ephemeral</span><span class=\"p\">(</span><span class=\"n\">tempdir</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">preload</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.run_coordinator</span> <span class=\"kn\">import</span> <span class=\"n\">DefaultRunCoordinator</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.launcher.sync_in_memory_run_launcher</span> <span class=\"kn\">import</span> <span class=\"n\">SyncInMemoryRunLauncher</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.event_log</span> <span class=\"kn\">import</span> <span class=\"n\">InMemoryEventLogStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.root</span> <span class=\"kn\">import</span> <span class=\"n\">LocalArtifactStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.runs</span> <span class=\"kn\">import</span> <span class=\"n\">InMemoryRunStorage</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.noop_compute_log_manager</span> <span class=\"kn\">import</span> <span class=\"n\">NoOpComputeLogManager</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">tempdir</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">tempdir</span> <span class=\"o\">=</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">temp_storage</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">(</span>\n            <span class=\"n\">InstanceType</span><span class=\"o\">.</span><span class=\"n\">EPHEMERAL</span><span class=\"p\">,</span>\n            <span class=\"n\">local_artifact_storage</span><span class=\"o\">=</span><span class=\"n\">LocalArtifactStorage</span><span class=\"p\">(</span><span class=\"n\">tempdir</span><span class=\"p\">),</span>\n            <span class=\"n\">run_storage</span><span class=\"o\">=</span><span class=\"n\">InMemoryRunStorage</span><span class=\"p\">(</span><span class=\"n\">preload</span><span class=\"o\">=</span><span class=\"n\">preload</span><span class=\"p\">),</span>\n            <span class=\"n\">event_storage</span><span class=\"o\">=</span><span class=\"n\">InMemoryEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">preload</span><span class=\"o\">=</span><span class=\"n\">preload</span><span class=\"p\">),</span>\n            <span class=\"n\">compute_log_manager</span><span class=\"o\">=</span><span class=\"n\">NoOpComputeLogManager</span><span class=\"p\">(),</span>\n            <span class=\"n\">run_coordinator</span><span class=\"o\">=</span><span class=\"n\">DefaultRunCoordinator</span><span class=\"p\">(),</span>\n            <span class=\"n\">run_launcher</span><span class=\"o\">=</span><span class=\"n\">SyncInMemoryRunLauncher</span><span class=\"p\">(),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get</span><span class=\"p\">(</span><span class=\"n\">fallback_storage</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"c1\"># 1. Use $DAGSTER_HOME to determine instance if set.</span>\n        <span class=\"k\">if</span> <span class=\"n\">_is_dagster_home_set</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">_dagster_home</span><span class=\"p\">())</span>\n\n        <span class=\"c1\"># 2. If that is not set use the fallback storage directory if provided.</span>\n        <span class=\"c1\"># This allows us to have a nice out of the box dagit experience where runs are persisted</span>\n        <span class=\"c1\"># across restarts in a tempdir that gets cleaned up when the dagit watchdog process exits.</span>\n        <span class=\"k\">elif</span> <span class=\"n\">fallback_storage</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">from_config</span><span class=\"p\">(</span><span class=\"n\">fallback_storage</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># 3. If all else fails create an ephemeral in memory instance.</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">ephemeral</span><span class=\"p\">(</span><span class=\"n\">fallback_storage</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">local_temp</span><span class=\"p\">(</span><span class=\"n\">tempdir</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">overrides</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;To create a local DagsterInstance for a test, use the instance_for_test &quot;</span>\n            <span class=\"s2\">&quot;context manager instead, which ensures that resoures are cleaned up afterwards&quot;</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">tempdir</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">tempdir</span> <span class=\"o\">=</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">temp_storage</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">from_ref</span><span class=\"p\">(</span><span class=\"n\">InstanceRef</span><span class=\"o\">.</span><span class=\"n\">from_dir</span><span class=\"p\">(</span><span class=\"n\">tempdir</span><span class=\"p\">,</span> <span class=\"n\">overrides</span><span class=\"o\">=</span><span class=\"n\">overrides</span><span class=\"p\">))</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config</span><span class=\"p\">(</span><span class=\"n\">config_dir</span><span class=\"p\">,</span> <span class=\"n\">config_filename</span><span class=\"o\">=</span><span class=\"n\">DAGSTER_CONFIG_YAML_FILENAME</span><span class=\"p\">):</span>\n        <span class=\"n\">instance_ref</span> <span class=\"o\">=</span> <span class=\"n\">InstanceRef</span><span class=\"o\">.</span><span class=\"n\">from_dir</span><span class=\"p\">(</span><span class=\"n\">config_dir</span><span class=\"p\">,</span> <span class=\"n\">config_filename</span><span class=\"o\">=</span><span class=\"n\">config_filename</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">from_ref</span><span class=\"p\">(</span><span class=\"n\">instance_ref</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_ref</span><span class=\"p\">(</span><span class=\"n\">instance_ref</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance_ref</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance_ref&quot;</span><span class=\"p\">,</span> <span class=\"n\">InstanceRef</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">(</span>\n            <span class=\"n\">instance_type</span><span class=\"o\">=</span><span class=\"n\">InstanceType</span><span class=\"o\">.</span><span class=\"n\">PERSISTENT</span><span class=\"p\">,</span>\n            <span class=\"n\">local_artifact_storage</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">local_artifact_storage</span><span class=\"p\">,</span>\n            <span class=\"n\">run_storage</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">run_storage</span><span class=\"p\">,</span>\n            <span class=\"n\">event_storage</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">event_storage</span><span class=\"p\">,</span>\n            <span class=\"n\">compute_log_manager</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">compute_log_manager</span><span class=\"p\">,</span>\n            <span class=\"n\">schedule_storage</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">schedule_storage</span><span class=\"p\">,</span>\n            <span class=\"n\">scheduler</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">scheduler</span><span class=\"p\">,</span>\n            <span class=\"n\">run_coordinator</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">run_coordinator</span><span class=\"p\">,</span>\n            <span class=\"n\">run_launcher</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">run_launcher</span><span class=\"p\">,</span>\n            <span class=\"n\">settings</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"o\">.</span><span class=\"n\">settings</span><span class=\"p\">,</span>\n            <span class=\"n\">ref</span><span class=\"o\">=</span><span class=\"n\">instance_ref</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># flags</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_persistent</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_type</span> <span class=\"o\">==</span> <span class=\"n\">InstanceType</span><span class=\"o\">.</span><span class=\"n\">PERSISTENT</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_ephemeral</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_type</span> <span class=\"o\">==</span> <span class=\"n\">InstanceType</span><span class=\"o\">.</span><span class=\"n\">EPHEMERAL</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_ref</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_ref</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_ref</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;Attempted to prepare an ineligible DagsterInstance (</span><span class=\"si\">{inst_type}</span><span class=\"s2\">) for cross &quot;</span>\n            <span class=\"s2\">&quot;process communication.</span><span class=\"si\">{dagster_home_msg}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">inst_type</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_instance_type</span><span class=\"p\">,</span>\n                <span class=\"n\">dagster_home_msg</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">DAGSTER_HOME environment variable is not set, set it to &quot;</span>\n                <span class=\"s2\">&quot;a directory on the filesystem for dagster to use for storage and cross &quot;</span>\n                <span class=\"s2\">&quot;process coordination.&quot;</span>\n                <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getenv</span><span class=\"p\">(</span><span class=\"s2\">&quot;DAGSTER_HOME&quot;</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n                <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">root_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span><span class=\"o\">.</span><span class=\"n\">base_dir</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">temp_storage</span><span class=\"p\">():</span>\n        <span class=\"k\">if</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">_PROCESS_TEMPDIR</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">_PROCESS_TEMPDIR</span> <span class=\"o\">=</span> <span class=\"n\">seven</span><span class=\"o\">.</span><span class=\"n\">TemporaryDirectory</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">DagsterInstance</span><span class=\"o\">.</span><span class=\"n\">_PROCESS_TEMPDIR</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">component</span><span class=\"p\">):</span>\n        <span class=\"n\">prefix</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;     &quot;</span>\n        <span class=\"c1\"># ConfigurableClass may not have inst_data if it&#39;s a direct instantiation</span>\n        <span class=\"c1\"># which happens for ephemeral instances</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">component</span><span class=\"o\">.</span><span class=\"n\">inst_data</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">component</span><span class=\"o\">.</span><span class=\"n\">inst_data</span><span class=\"o\">.</span><span class=\"n\">info_str</span><span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"nb\">dict</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"n\">yaml</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"p\">,</span> <span class=\"n\">default_flow_style</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span> <span class=\"n\">prefix</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}{}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">,</span> <span class=\"n\">component</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">info_str_for_component</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">component_name</span><span class=\"p\">,</span> <span class=\"n\">component</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">{component_name}</span><span class=\"s2\">:</span><span class=\"se\">\\n</span><span class=\"si\">{component}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">component_name</span><span class=\"o\">=</span><span class=\"n\">component_name</span><span class=\"p\">,</span> <span class=\"n\">component</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">info_str</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n\n        <span class=\"n\">settings</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span> <span class=\"k\">else</span> <span class=\"p\">{}</span>\n\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;local_artifact_storage:</span><span class=\"se\">\\n</span><span class=\"si\">{artifact}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;run_storage:</span><span class=\"se\">\\n</span><span class=\"si\">{run}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;event_log_storage:</span><span class=\"se\">\\n</span><span class=\"si\">{event}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;compute_logs:</span><span class=\"se\">\\n</span><span class=\"si\">{compute}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;schedule_storage:</span><span class=\"se\">\\n</span><span class=\"si\">{schedule_storage}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;scheduler:</span><span class=\"se\">\\n</span><span class=\"si\">{scheduler}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;run_coordinator:</span><span class=\"se\">\\n</span><span class=\"si\">{run_coordinator}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;run_launcher:</span><span class=\"se\">\\n</span><span class=\"si\">{run_launcher}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">artifact</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span><span class=\"p\">),</span>\n                <span class=\"n\">run</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"p\">),</span>\n                <span class=\"n\">event</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"p\">),</span>\n                <span class=\"n\">compute</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_compute_log_manager</span><span class=\"p\">),</span>\n                <span class=\"n\">schedule_storage</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"p\">),</span>\n                <span class=\"n\">scheduler</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"p\">),</span>\n                <span class=\"n\">run_coordinator</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_coordinator</span><span class=\"p\">),</span>\n                <span class=\"n\">run_launcher</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">+</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">{settings_key}</span><span class=\"s2\">:</span><span class=\"se\">\\n</span><span class=\"si\">{settings_value}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">settings_key</span><span class=\"o\">=</span><span class=\"n\">settings_key</span><span class=\"p\">,</span> <span class=\"n\">settings_value</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_info</span><span class=\"p\">(</span><span class=\"n\">settings_value</span><span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                    <span class=\"k\">for</span> <span class=\"n\">settings_key</span><span class=\"p\">,</span> <span class=\"n\">settings_value</span> <span class=\"ow\">in</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n                <span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># schedule storage</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">schedule_storage</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span>\n\n    <span class=\"c1\"># schedule storage</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">scheduler</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span>\n\n    <span class=\"c1\"># run coordinator</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">run_coordinator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_coordinator</span>\n\n    <span class=\"c1\"># run launcher</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">run_launcher</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span>\n\n    <span class=\"c1\"># compute logs</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">compute_log_manager</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_compute_log_manager</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_settings</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">settings_key</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">settings_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;settings_key&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span> <span class=\"ow\">and</span> <span class=\"n\">settings_key</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_settings</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">settings_key</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">{}</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">telemetry_enabled</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_ephemeral</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">dagster_telemetry_enabled_default</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n        <span class=\"n\">telemetry_settings</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_settings</span><span class=\"p\">(</span><span class=\"s2\">&quot;telemetry&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">telemetry_settings</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">dagster_telemetry_enabled_default</span>\n\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;enabled&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">telemetry_settings</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">telemetry_settings</span><span class=\"p\">[</span><span class=\"s2\">&quot;enabled&quot;</span><span class=\"p\">]</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">dagster_telemetry_enabled_default</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">print_fn</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"n\">upgrading_instance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n\n            <span class=\"n\">print_fn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Updating run storage...&quot;</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">upgrade</span><span class=\"p\">()</span>\n\n            <span class=\"n\">print_fn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Updating event storage...&quot;</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">upgrade</span><span class=\"p\">()</span>\n\n            <span class=\"n\">print_fn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Updating schedule storage...&quot;</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">upgrade</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">statement_timeout</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"n\">statement_timeout</span><span class=\"o\">=</span><span class=\"n\">statement_timeout</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"n\">statement_timeout</span><span class=\"o\">=</span><span class=\"n\">statement_timeout</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"n\">statement_timeout</span><span class=\"o\">=</span><span class=\"n\">statement_timeout</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reindex</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">print_fn</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">print_fn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Checking for reindexing...&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">reindex</span><span class=\"p\">(</span><span class=\"n\">print_fn</span><span class=\"p\">)</span>\n        <span class=\"n\">print_fn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Done.&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">dispose</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_coordinator</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_compute_log_manager</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># run storage</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_by_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_historical_pipeline</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"n\">HistoricalPipeline</span>\n\n        <span class=\"n\">snapshot</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n        <span class=\"n\">parent_snapshot</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span><span class=\"o\">.</span><span class=\"n\">parent_snapshot_id</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span>\n            <span class=\"k\">else</span> <span class=\"kc\">None</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">HistoricalPipeline</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">),</span> <span class=\"n\">snapshot_id</span><span class=\"p\">,</span> <span class=\"n\">parent_snapshot</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_historical_pipeline</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_stats</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_stats_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_step_stats</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">step_keys</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_step_stats_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">step_keys</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_tags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_run_tags</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_group</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_run_group</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"DagsterInstance.resolve_memoized_execution_plan\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance.resolve_memoized_execution_plan\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">resolve_memoized_execution_plan</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">execution_plan</span><span class=\"p\">,</span> <span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"n\">mode</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            ExecutionPlan: Execution plan configured to only run unmemoized steps.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">pipeline_def</span> <span class=\"o\">=</span> <span class=\"n\">execution_plan</span><span class=\"o\">.</span><span class=\"n\">pipeline</span><span class=\"o\">.</span><span class=\"n\">get_definition</span><span class=\"p\">()</span>\n        <span class=\"n\">pipeline_name</span> <span class=\"o\">=</span> <span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n        <span class=\"n\">step_output_versions</span> <span class=\"o\">=</span> <span class=\"n\">resolve_step_output_versions</span><span class=\"p\">(</span>\n            <span class=\"n\">execution_plan</span><span class=\"p\">,</span>\n            <span class=\"n\">EnvironmentConfig</span><span class=\"o\">.</span><span class=\"n\">build</span><span class=\"p\">(</span><span class=\"n\">pipeline_def</span><span class=\"p\">,</span> <span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"n\">mode</span><span class=\"p\">),</span>\n            <span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_mode_definition</span><span class=\"p\">(</span><span class=\"n\">mode</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">all</span><span class=\"p\">(</span><span class=\"n\">version</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"k\">for</span> <span class=\"n\">version</span> <span class=\"ow\">in</span> <span class=\"n\">step_output_versions</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">()):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;While creating a memoized pipeline run, no steps have versions. At least one step &quot;</span>\n                <span class=\"s2\">&quot;must have a version.&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"n\">step_output_addresses</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_addresses_for_step_output_versions</span><span class=\"p\">(</span>\n            <span class=\"p\">{</span>\n                <span class=\"p\">(</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span> <span class=\"n\">step_output_handle</span><span class=\"p\">):</span> <span class=\"n\">version</span>\n                <span class=\"k\">for</span> <span class=\"n\">step_output_handle</span><span class=\"p\">,</span> <span class=\"n\">version</span> <span class=\"ow\">in</span> <span class=\"n\">step_output_versions</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n                <span class=\"k\">if</span> <span class=\"n\">version</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">step_keys_to_execute</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span>\n            <span class=\"p\">{</span>\n                <span class=\"n\">step_output_handle</span><span class=\"o\">.</span><span class=\"n\">step_key</span>\n                <span class=\"k\">for</span> <span class=\"n\">step_output_handle</span> <span class=\"ow\">in</span> <span class=\"n\">step_output_versions</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">()</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span> <span class=\"n\">step_output_handle</span><span class=\"p\">)</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">step_output_addresses</span>\n            <span class=\"p\">}</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">execution_plan</span><span class=\"o\">.</span><span class=\"n\">build_memoized_plan</span><span class=\"p\">(</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span> <span class=\"n\">step_output_addresses</span><span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_run_for_pipeline</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_def</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_plan</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">step_keys_to_execute</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">root_run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.api</span> <span class=\"kn\">import</span> <span class=\"n\">create_execution_plan</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.plan.plan</span> <span class=\"kn\">import</span> <span class=\"n\">ExecutionPlan</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.snap</span> <span class=\"kn\">import</span> <span class=\"n\">snapshot_from_execution_plan</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_def</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_def&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineDefinition</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">execution_plan</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_plan&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExecutionPlan</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># note that solids_to_execute is required to execute the solid subset, which is the</span>\n        <span class=\"c1\"># frozenset version of the previous solid_subset.</span>\n        <span class=\"c1\"># solid_selection is not required and will not be converted to solids_to_execute here.</span>\n        <span class=\"c1\"># i.e. this function doesn&#39;t handle solid queries.</span>\n        <span class=\"c1\"># solid_selection is only used to pass the user queries further down.</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_set_param</span><span class=\"p\">(</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span> <span class=\"s2\">&quot;solids_to_execute&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_list_param</span><span class=\"p\">(</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span> <span class=\"s2\">&quot;solid_selection&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">solids_to_execute</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">pipeline_def</span><span class=\"p\">,</span> <span class=\"n\">PipelineSubsetDefinition</span><span class=\"p\">):</span>\n                <span class=\"c1\"># for the case when pipeline_def is created by IPipeline or ExternalPipeline</span>\n                <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n                    <span class=\"n\">solids_to_execute</span> <span class=\"o\">==</span> <span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;Cannot create a PipelineRun from pipeline subset </span><span class=\"si\">{pipeline_solids_to_execute}</span><span class=\"s2\"> &quot;</span>\n                    <span class=\"s2\">&quot;that conflicts with solids_to_execute arg </span><span class=\"si\">{solids_to_execute}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">pipeline_solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">str_format_list</span><span class=\"p\">(</span><span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">solids_to_execute</span><span class=\"p\">),</span>\n                        <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">str_format_list</span><span class=\"p\">(</span><span class=\"n\">solids_to_execute</span><span class=\"p\">),</span>\n                    <span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># for cases when `create_run_for_pipeline` is directly called</span>\n                <span class=\"n\">pipeline_def</span> <span class=\"o\">=</span> <span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_subset_def</span><span class=\"p\">(</span>\n                    <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">solids_to_execute</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"n\">full_execution_plan</span> <span class=\"o\">=</span> <span class=\"n\">execution_plan</span> <span class=\"ow\">or</span> <span class=\"n\">create_execution_plan</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_def</span><span class=\"p\">,</span> <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">full_execution_plan</span><span class=\"o\">.</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">full_execution_plan</span><span class=\"o\">.</span><span class=\"n\">steps</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">is_memoized_run</span><span class=\"p\">(</span><span class=\"n\">tags</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">step_keys_to_execute</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;step_keys_to_execute parameter cannot be used in conjunction with memoized &quot;</span>\n                    <span class=\"s2\">&quot;pipeline runs.&quot;</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">subsetted_execution_plan</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">resolve_memoized_execution_plan</span><span class=\"p\">(</span>\n                <span class=\"n\">full_execution_plan</span><span class=\"p\">,</span> <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span> <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>  <span class=\"c1\"># TODO: tighter integration with existing step_keys_to_execute functionality</span>\n            <span class=\"n\">step_keys_to_execute</span> <span class=\"o\">=</span> <span class=\"n\">subsetted_execution_plan</span><span class=\"o\">.</span><span class=\"n\">step_keys_to_execute</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">subsetted_execution_plan</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"n\">full_execution_plan</span><span class=\"o\">.</span><span class=\"n\">build_subset_plan</span><span class=\"p\">(</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">step_keys_to_execute</span>\n                <span class=\"k\">else</span> <span class=\"n\">full_execution_plan</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create_run</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">mode</span><span class=\"p\">,</span> <span class=\"s2\">&quot;mode&quot;</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_default_mode_name</span><span class=\"p\">()),</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">step_keys_to_execute</span><span class=\"o\">=</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"n\">tags</span><span class=\"p\">,</span>\n            <span class=\"n\">root_run_id</span><span class=\"o\">=</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_run_id</span><span class=\"o\">=</span><span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot</span><span class=\"p\">(),</span>\n            <span class=\"n\">execution_plan_snapshot</span><span class=\"o\">=</span><span class=\"n\">snapshot_from_execution_plan</span><span class=\"p\">(</span>\n                <span class=\"n\">subsetted_execution_plan</span><span class=\"p\">,</span> <span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_pipeline_snapshot_id</span><span class=\"p\">()</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">parent_pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">pipeline_def</span><span class=\"o\">.</span><span class=\"n\">get_parent_pipeline_snapshot</span><span class=\"p\">(),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_construct_run_with_snapshots</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"p\">,</span>\n        <span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">status</span><span class=\"p\">,</span>\n        <span class=\"n\">tags</span><span class=\"p\">,</span>\n        <span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">external_pipeline_origin</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n\n        <span class=\"c1\"># https://github.com/dagster-io/dagster/issues/2403</span>\n        <span class=\"k\">if</span> <span class=\"n\">tags</span> <span class=\"ow\">and</span> <span class=\"n\">IS_AIRFLOW_INGEST_PIPELINE_STR</span> <span class=\"ow\">in</span> <span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">AIRFLOW_EXECUTION_DATE_STR</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">tags</span><span class=\"p\">:</span>\n                <span class=\"n\">tags</span><span class=\"p\">[</span><span class=\"n\">AIRFLOW_EXECUTION_DATE_STR</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">get_current_datetime_in_utc</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">isoformat</span><span class=\"p\">()</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">pipeline_snapshot</span> <span class=\"ow\">and</span> <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;It is illegal to have an execution plan snapshot and not have a pipeline snapshot. &quot;</span>\n            <span class=\"s2\">&quot;It is possible to have no execution plan snapshot since we persist runs &quot;</span>\n            <span class=\"s2\">&quot;that do not successfully compile execution plans in the scheduled case.&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">pipeline_snapshot_id</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_ensure_persisted_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span> <span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">pipeline_snapshot</span>\n            <span class=\"k\">else</span> <span class=\"kc\">None</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">execution_plan_snapshot_id</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_ensure_persisted_execution_plan_snapshot</span><span class=\"p\">(</span>\n                <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"n\">step_keys_to_execute</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">execution_plan_snapshot</span> <span class=\"ow\">and</span> <span class=\"n\">pipeline_snapshot_id</span>\n            <span class=\"k\">else</span> <span class=\"kc\">None</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">PipelineRun</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">step_keys_to_execute</span><span class=\"o\">=</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"n\">tags</span><span class=\"p\">,</span>\n            <span class=\"n\">root_run_id</span><span class=\"o\">=</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_run_id</span><span class=\"o\">=</span><span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_snapshot_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span>\n            <span class=\"n\">execution_plan_snapshot_id</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">,</span>\n            <span class=\"n\">external_pipeline_origin</span><span class=\"o\">=</span><span class=\"n\">external_pipeline_origin</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_ensure_persisted_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span> <span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.snap</span> <span class=\"kn\">import</span> <span class=\"n\">create_pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"n\">PipelineSnapshot</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_snapshot&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineSnapshot</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span> <span class=\"s2\">&quot;parent_pipeline_snapshot&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineSnapshot</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">pipeline_snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_pipeline_snapshot</span><span class=\"p\">(</span>\n                <span class=\"n\">pipeline_snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span><span class=\"o\">.</span><span class=\"n\">parent_snapshot_id</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n                    <span class=\"n\">create_pipeline_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">)</span>\n                    <span class=\"o\">==</span> <span class=\"n\">pipeline_snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span><span class=\"o\">.</span><span class=\"n\">parent_snapshot_id</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;Parent pipeline snapshot id out of sync with passed parent pipeline snapshot&quot;</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n\n                <span class=\"n\">returned_pipeline_snapshot_id</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_pipeline_snapshot</span><span class=\"p\">(</span>\n                    <span class=\"n\">parent_pipeline_snapshot</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n                    <span class=\"n\">pipeline_snapshot</span><span class=\"o\">.</span><span class=\"n\">lineage_snapshot</span><span class=\"o\">.</span><span class=\"n\">parent_snapshot_id</span>\n                    <span class=\"o\">==</span> <span class=\"n\">returned_pipeline_snapshot_id</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"n\">pipeline_snapshot_id</span> <span class=\"o\">=</span> <span class=\"n\">create_pipeline_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">):</span>\n            <span class=\"n\">returned_pipeline_snapshot_id</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_pipeline_snapshot</span><span class=\"p\">(</span>\n                <span class=\"n\">pipeline_snapshot</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">returned_pipeline_snapshot_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">pipeline_snapshot_id</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_ensure_persisted_execution_plan_snapshot</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"n\">step_keys_to_execute</span>\n    <span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.snap.execution_plan_snapshot</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n            <span class=\"n\">ExecutionPlanSnapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">create_execution_plan_snapshot_id</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_plan_snapshot&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExecutionPlanSnapshot</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_list_param</span><span class=\"p\">(</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span> <span class=\"s2\">&quot;step_keys_to_execute&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">execution_plan_snapshot</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span>\n            <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Snapshot mismatch: Snapshot ID in execution plan snapshot is &quot;</span>\n                <span class=\"s1\">&#39;&quot;</span><span class=\"si\">{ep_pipeline_snapshot_id}</span><span class=\"s1\">&quot; and snapshot_id created in memory is &#39;</span>\n                <span class=\"s1\">&#39;&quot;</span><span class=\"si\">{pipeline_snapshot_id}</span><span class=\"s1\">&quot;&#39;</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">ep_pipeline_snapshot_id</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span>\n                <span class=\"n\">pipeline_snapshot_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"o\">.</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">step_keys_to_execute</span>\n            <span class=\"k\">else</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"o\">.</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">)</span>\n            <span class=\"o\">==</span> <span class=\"nb\">set</span><span class=\"p\">([</span><span class=\"n\">step</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"k\">for</span> <span class=\"n\">step</span> <span class=\"ow\">in</span> <span class=\"n\">execution_plan_snapshot</span><span class=\"o\">.</span><span class=\"n\">steps</span><span class=\"p\">]),</span>\n            <span class=\"s2\">&quot;We encode step_keys_to_execute twice in our stack, unfortunately. This check &quot;</span>\n            <span class=\"s2\">&quot;ensures that they are consistent. We check that step_keys_to_execute in the plan &quot;</span>\n            <span class=\"s2\">&quot;matches the step_keys_to_execute params if it is set. If it is not, this indicates &quot;</span>\n            <span class=\"s2\">&quot;a full execution plan, and so we verify that.&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">execution_plan_snapshot_id</span> <span class=\"o\">=</span> <span class=\"n\">create_execution_plan_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">):</span>\n            <span class=\"n\">returned_execution_plan_snapshot_id</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_execution_plan_snapshot</span><span class=\"p\">(</span>\n                <span class=\"n\">execution_plan_snapshot</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">returned_execution_plan_snapshot_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">execution_plan_snapshot_id</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_run</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"p\">,</span>\n        <span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">status</span><span class=\"p\">,</span>\n        <span class=\"n\">tags</span><span class=\"p\">,</span>\n        <span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">external_pipeline_origin</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n\n        <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_construct_run_with_snapshots</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">step_keys_to_execute</span><span class=\"o\">=</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"n\">tags</span><span class=\"p\">,</span>\n            <span class=\"n\">root_run_id</span><span class=\"o\">=</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_run_id</span><span class=\"o\">=</span><span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">execution_plan_snapshot</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">external_pipeline_origin</span><span class=\"o\">=</span><span class=\"n\">external_pipeline_origin</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_run</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">register_managed_run</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"p\">,</span>\n        <span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">tags</span><span class=\"p\">,</span>\n        <span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"c1\"># The usage of this method is limited to dagster-airflow, specifically in Dagster</span>\n        <span class=\"c1\"># Operators that are executed in Airflow. Because a common workflow in Airflow is to</span>\n        <span class=\"c1\"># retry dags from arbitrary tasks, we need any node to be capable of creating a</span>\n        <span class=\"c1\"># PipelineRun.</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># The try-except DagsterRunAlreadyExists block handles the race when multiple &quot;root&quot; tasks</span>\n        <span class=\"c1\"># simultaneously execute self._run_storage.add_run(pipeline_run). When this happens, only</span>\n        <span class=\"c1\"># one task succeeds in creating the run, while the others get DagsterRunAlreadyExists</span>\n        <span class=\"c1\"># error; at this point, the failed tasks try again to fetch the existing run.</span>\n        <span class=\"c1\"># https://github.com/dagster-io/dagster/issues/2412</span>\n\n        <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_construct_run_with_snapshots</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config</span><span class=\"o\">=</span><span class=\"n\">run_config</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">solids_to_execute</span><span class=\"o\">=</span><span class=\"n\">solids_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">step_keys_to_execute</span><span class=\"o\">=</span><span class=\"n\">step_keys_to_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">MANAGED</span><span class=\"p\">,</span>\n            <span class=\"n\">tags</span><span class=\"o\">=</span><span class=\"n\">tags</span><span class=\"p\">,</span>\n            <span class=\"n\">root_run_id</span><span class=\"o\">=</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_run_id</span><span class=\"o\">=</span><span class=\"n\">parent_run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">execution_plan_snapshot</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">parent_pipeline_snapshot</span><span class=\"o\">=</span><span class=\"n\">parent_pipeline_snapshot</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">get_run</span><span class=\"p\">():</span>\n            <span class=\"n\">candidate_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n            <span class=\"n\">field_diff</span> <span class=\"o\">=</span> <span class=\"n\">_check_run_equality</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">candidate_run</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">field_diff</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterRunConflict</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Found conflicting existing run with same id </span><span class=\"si\">{run_id}</span><span class=\"s2\">. Runs differ in:&quot;</span>\n                    <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"si\">{field_diff}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">field_diff</span><span class=\"o\">=</span><span class=\"n\">_format_field_diff</span><span class=\"p\">(</span><span class=\"n\">field_diff</span><span class=\"p\">),</span>\n                    <span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">candidate_run</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">has_run</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"n\">get_run</span><span class=\"p\">()</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_run</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">DagsterRunAlreadyExists</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">get_run</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_run</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">handle_run_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">handle_run_event</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_run_tags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">new_tags</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">add_run_tags</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">new_tags</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">has_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_runs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_runs</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_runs_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_runs_count</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_groups</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">get_run_groups</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"n\">limit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">wipe</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">wipe</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">delete_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">delete_events</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># event storage</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">logs_after</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"n\">cursor</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">all_logs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">watch_event_logs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">cb</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">watch</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">cb</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># asset storage</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_asset_aware</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">is_asset_aware</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">check_asset_aware</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_asset_aware</span><span class=\"p\">,</span>\n            <span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Asset queries can only be performed on instances with asset-aware event log &quot;</span>\n                <span class=\"s2\">&quot;storage. Use `instance.is_asset_aware` to verify that the instance is configured &quot;</span>\n                <span class=\"s2\">&quot;with an EventLogStorage that implements `AssetAwareEventLogStorage`&quot;</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">all_asset_keys</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">prefix_path</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_asset_aware</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_all_asset_keys</span><span class=\"p\">(</span><span class=\"n\">prefix_path</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_asset_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_asset_aware</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">has_asset_key</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">events_for_asset_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_key&quot;</span><span class=\"p\">,</span> <span class=\"n\">AssetKey</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_asset_aware</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_asset_events</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">run_ids_for_asset_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_key&quot;</span><span class=\"p\">,</span> <span class=\"n\">AssetKey</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_asset_aware</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_asset_run_ids</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe_assets</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_keys</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">asset_keys</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_keys&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"n\">AssetKey</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">check_asset_aware</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">asset_key</span> <span class=\"ow\">in</span> <span class=\"n\">asset_keys</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">wipe_asset</span><span class=\"p\">(</span><span class=\"n\">asset_key</span><span class=\"p\">)</span>\n\n    <span class=\"c1\"># event subscriptions</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_logger</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">Logger</span><span class=\"p\">(</span><span class=\"s2\">&quot;__event_listener&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">addHandler</span><span class=\"p\">(</span><span class=\"n\">_EventListenerLogHandler</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">))</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">setLevel</span><span class=\"p\">(</span><span class=\"mi\">10</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">logger</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">handle_new_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"n\">run_id</span> <span class=\"o\">=</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">store_event</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">is_dagster_event</span> <span class=\"ow\">and</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"o\">.</span><span class=\"n\">is_pipeline_event</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_storage</span><span class=\"o\">.</span><span class=\"n\">handle_run_event</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"p\">)</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">sub</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_subscribers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]:</span>\n            <span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_event_listener</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cb</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_subscribers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">cb</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"DagsterInstance.report_engine_event\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance.report_engine_event\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">report_engine_event</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">engine_event_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Report a EngineEvent that occurred outside of a pipeline execution context.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">EngineEventData</span><span class=\"p\">,</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">,</span> <span class=\"n\">DagsterEventType</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events.log</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterEventRecord</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">class_param</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cls&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"s2\">&quot;message&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n        <span class=\"n\">engine_event_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">engine_event_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;engine_event_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">EngineEventData</span><span class=\"p\">,</span> <span class=\"n\">EngineEventData</span><span class=\"p\">([]),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"p\">:</span>\n            <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;[</span><span class=\"si\">{}</span><span class=\"s2\">] </span><span class=\"si\">{}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">)</span>\n\n        <span class=\"n\">log_level</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">INFO</span>\n        <span class=\"k\">if</span> <span class=\"n\">engine_event_data</span> <span class=\"ow\">and</span> <span class=\"n\">engine_event_data</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">:</span>\n            <span class=\"n\">log_level</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">ERROR</span>\n\n        <span class=\"n\">dagster_event</span> <span class=\"o\">=</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">(</span>\n            <span class=\"n\">event_type_value</span><span class=\"o\">=</span><span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">ENGINE_EVENT</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n            <span class=\"n\">event_specific_data</span><span class=\"o\">=</span><span class=\"n\">engine_event_data</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">event_record</span> <span class=\"o\">=</span> <span class=\"n\">DagsterEventRecord</span><span class=\"p\">(</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n            <span class=\"n\">user_message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n            <span class=\"n\">level</span><span class=\"o\">=</span><span class=\"n\">log_level</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">error_info</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n            <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">(),</span>\n            <span class=\"n\">step_key</span><span class=\"o\">=</span><span class=\"n\">step_key</span><span class=\"p\">,</span>\n            <span class=\"n\">dagster_event</span><span class=\"o\">=</span><span class=\"n\">dagster_event</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle_new_event</span><span class=\"p\">(</span><span class=\"n\">event_record</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">dagster_event</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">report_run_failed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">,</span> <span class=\"n\">DagsterEventType</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events.log</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterEventRecord</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n        <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;This pipeline run has been marked as failed from outside the execution context.&quot;</span>\n\n        <span class=\"n\">dagster_event</span> <span class=\"o\">=</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">(</span>\n            <span class=\"n\">event_type_value</span><span class=\"o\">=</span><span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_FAILURE</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">event_record</span> <span class=\"o\">=</span> <span class=\"n\">DagsterEventRecord</span><span class=\"p\">(</span>\n            <span class=\"n\">message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n            <span class=\"n\">user_message</span><span class=\"o\">=</span><span class=\"n\">message</span><span class=\"p\">,</span>\n            <span class=\"n\">level</span><span class=\"o\">=</span><span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">ERROR</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">error_info</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n            <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"p\">(),</span>\n            <span class=\"n\">dagster_event</span><span class=\"o\">=</span><span class=\"n\">dagster_event</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">handle_new_event</span><span class=\"p\">(</span><span class=\"n\">event_record</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">dagster_event</span>\n\n    <span class=\"c1\"># directories</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">file_manager_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span><span class=\"o\">.</span><span class=\"n\">file_manager_dir</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">intermediates_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span><span class=\"o\">.</span><span class=\"n\">intermediates_dir</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">schedules_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_local_artifact_storage</span><span class=\"o\">.</span><span class=\"n\">schedules_dir</span>\n\n    <span class=\"c1\"># Runs coordinator</span>\n\n<div class=\"viewcode-block\" id=\"DagsterInstance.submit_run\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance.submit_run\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">submit_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Submit a pipeline run to the coordinator.</span>\n\n<span class=\"sd\">        This method delegates to the ``RunCoordinator``, configured on the instance, and will</span>\n<span class=\"sd\">        call its implementation of ``RunCoordinator.submit_run()`` to send the run to the</span>\n<span class=\"sd\">        coordinator for execution. Runs should be created in the instance (e.g., by calling</span>\n<span class=\"sd\">        ``DagsterInstance.create_run()``) *before* this method is called, and</span>\n<span class=\"sd\">        should be in the ``PipelineRunStatus.NOT_STARTED`` state. They also must have a non-null</span>\n<span class=\"sd\">        ExternalPipelineOrigin.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the run.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"n\">ExternalPipelineOrigin</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst</span><span class=\"p\">(</span>\n            <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">external_pipeline_origin</span><span class=\"p\">,</span>\n            <span class=\"n\">ExternalPipelineOrigin</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;External pipeline origin must be set for submitted runs&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">submitted_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_coordinator</span><span class=\"o\">.</span><span class=\"n\">submit_run</span><span class=\"p\">(</span>\n                <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"o\">=</span><span class=\"n\">external_pipeline</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">EngineEventData</span>\n\n            <span class=\"n\">error</span> <span class=\"o\">=</span> <span class=\"n\">serializable_error_info_from_exc_info</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">())</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                <span class=\"n\">error</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">EngineEventData</span><span class=\"o\">.</span><span class=\"n\">engine_error</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">report_run_failed</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">submitted_run</span></div>\n\n    <span class=\"c1\"># Run launcher</span>\n\n<div class=\"viewcode-block\" id=\"DagsterInstance.launch_run\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance.launch_run\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">launch_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Launch a pipeline run.</span>\n\n<span class=\"sd\">        This method is typically called using `instance.submit_run` rather than being invoked</span>\n<span class=\"sd\">        directly. This method delegates to the ``RunLauncher``, if any, configured on the instance,</span>\n<span class=\"sd\">        and will call its implementation of ``RunLauncher.launch_run()`` to begin the execution of</span>\n<span class=\"sd\">        the specified run. Runs should be created in the instance (e.g., by calling</span>\n<span class=\"sd\">        ``DagsterInstance.create_run()``) *before* this method is called, and should be in the</span>\n<span class=\"sd\">        ``PipelineRunStatus.NOT_STARTED`` state.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the run the launch.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">launched_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_launcher</span><span class=\"o\">.</span><span class=\"n\">launch_run</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">external_pipeline</span><span class=\"o\">=</span><span class=\"n\">external_pipeline</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">except</span><span class=\"p\">:</span>\n            <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">EngineEventData</span>\n\n            <span class=\"n\">error</span> <span class=\"o\">=</span> <span class=\"n\">serializable_error_info_from_exc_info</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">())</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">report_engine_event</span><span class=\"p\">(</span>\n                <span class=\"n\">error</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">,</span> <span class=\"n\">run</span><span class=\"p\">,</span> <span class=\"n\">EngineEventData</span><span class=\"o\">.</span><span class=\"n\">engine_error</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">report_run_failed</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">launched_run</span></div>\n\n    <span class=\"c1\"># Scheduler</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reconcile_scheduler_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">external_repository</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">reconcile_scheduler_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">external_repository</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">start_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">start_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">stop_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule_and_delete_from_storage</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">stop_schedule_and_delete_from_storage</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">running_schedule_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"mi\">0</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">scheduler_debug_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">dagster.core.scheduler</span> <span class=\"kn\">import</span> <span class=\"n\">SchedulerDebugInfo</span><span class=\"p\">,</span> <span class=\"n\">ScheduleStatus</span>\n\n        <span class=\"n\">errors</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n        <span class=\"n\">schedules</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">schedule_state</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">all_stored_schedule_state</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span>\n                <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Schedule </span><span class=\"si\">{schedule_name}</span><span class=\"s2\"> is set to be running, but the scheduler is not &quot;</span>\n                    <span class=\"s2\">&quot;running the schedule.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">STOPPED</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span>\n                <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span>\n            <span class=\"p\">):</span>\n                <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Schedule </span><span class=\"si\">{schedule_name}</span><span class=\"s2\"> is set to be stopped, but the scheduler is still running &quot;</span>\n                    <span class=\"s2\">&quot;the schedule.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Duplicate jobs found: More than one job for schedule </span><span class=\"si\">{schedule_name}</span><span class=\"s2\"> are &quot;</span>\n                    <span class=\"s2\">&quot;running on the scheduler.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">schedule_info</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">:</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;cron_schedule&quot;</span><span class=\"p\">:</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;repository_pointer&quot;</span><span class=\"p\">:</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">schedule_origin</span><span class=\"o\">.</span><span class=\"n\">get_repo_cli_args</span><span class=\"p\">(),</span>\n                    <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">:</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;repository_origin_id&quot;</span><span class=\"p\">:</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">repository_origin_id</span><span class=\"p\">,</span>\n                <span class=\"p\">}</span>\n            <span class=\"p\">}</span>\n\n            <span class=\"n\">schedules</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">yaml</span><span class=\"o\">.</span><span class=\"n\">safe_dump</span><span class=\"p\">(</span><span class=\"n\">schedule_info</span><span class=\"p\">,</span> <span class=\"n\">default_flow_style</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">))</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">SchedulerDebugInfo</span><span class=\"p\">(</span>\n            <span class=\"n\">scheduler_config_info</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">info_str_for_component</span><span class=\"p\">(</span><span class=\"s2\">&quot;Scheduler&quot;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">scheduler</span><span class=\"p\">),</span>\n            <span class=\"n\">scheduler_info</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">scheduler</span><span class=\"o\">.</span><span class=\"n\">debug_info</span><span class=\"p\">(),</span>\n            <span class=\"n\">schedule_storage</span><span class=\"o\">=</span><span class=\"n\">schedules</span><span class=\"p\">,</span>\n            <span class=\"n\">errors</span><span class=\"o\">=</span><span class=\"n\">errors</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># Schedule Storage</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_schedule_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_tick_data</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">create_schedule_tick</span><span class=\"p\">(</span><span class=\"n\">schedule_tick_data</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update_schedule_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">tick</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">update_schedule_tick</span><span class=\"p\">(</span><span class=\"n\">tick</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_schedule_ticks</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">get_schedule_ticks</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_latest_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">get_latest_tick</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_schedule_tick_stats</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">get_schedule_tick_stats</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">all_stored_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">repository_origin_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">all_stored_schedule_state</span><span class=\"p\">(</span><span class=\"n\">repository_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_stored_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_state</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">add_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_state</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">update_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">delete_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe_all_schedules</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_schedule_storage</span><span class=\"o\">.</span><span class=\"n\">wipe</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">logs_path_for_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_scheduler</span><span class=\"o\">.</span><span class=\"n\">get_logs_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__enter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">exception_type</span><span class=\"p\">,</span> <span class=\"n\">exception_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n\n<div class=\"viewcode-block\" id=\"DagsterInstance.get_addresses_for_step_output_versions\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/internals/#dagster.DagsterInstance.get_addresses_for_step_output_versions\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">get_addresses_for_step_output_versions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">step_output_versions</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        For each given step output, finds whether an output exists with the given</span>\n<span class=\"sd\">        version, and returns its address if it does.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            step_output_versions (Dict[(str, StepOutputHandle), str]):</span>\n<span class=\"sd\">                (pipeline name, step output handle) -&gt; version.</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Dict[(str, StepOutputHandle), str]: (pipeline name, step output handle) -&gt; address.</span>\n<span class=\"sd\">                For each step output, an address if there is one and None otherwise.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_storage</span><span class=\"o\">.</span><span class=\"n\">get_addresses_for_step_output_versions</span><span class=\"p\">(</span><span class=\"n\">step_output_versions</span><span class=\"p\">)</span></div></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/instance", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}