{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.scheduler.scheduler", "body": "<h1>Source code for dagster.core.scheduler.scheduler</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">abc</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">datetime</span> <span class=\"kn\">import</span> <span class=\"n\">datetime</span>\n<span class=\"kn\">from</span> <span class=\"nn\">enum</span> <span class=\"kn\">import</span> <span class=\"n\">Enum</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config.source</span> <span class=\"kn\">import</span> <span class=\"n\">IntSource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"n\">ExternalSchedule</span><span class=\"p\">,</span> <span class=\"n\">ExternalScheduleOrigin</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.instance</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInstance</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">whitelist_for_serdes</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.seven</span> <span class=\"kn\">import</span> <span class=\"n\">get_current_datetime_in_utc</span><span class=\"p\">,</span> <span class=\"n\">get_timestamp_from_utc_datetime</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils.error</span> <span class=\"kn\">import</span> <span class=\"n\">SerializableErrorInfo</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DagsterSchedulerError</span><span class=\"p\">(</span><span class=\"n\">DagsterError</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Base class for all Dagster Scheduler errors&quot;&quot;&quot;</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DagsterScheduleReconciliationError</span><span class=\"p\">(</span><span class=\"n\">DagsterError</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Error raised during schedule state reconcilation. During reconcilation, exceptions that are</span>\n<span class=\"sd\">    raised when trying to start or stop a schedule are collected and passed to this wrapper exception.</span>\n<span class=\"sd\">    The individual exceptions can be accessed by the `errors` property. &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">preamble</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">errors</span> <span class=\"o\">=</span> <span class=\"n\">errors</span>\n\n        <span class=\"n\">error_msg</span> <span class=\"o\">=</span> <span class=\"n\">preamble</span>\n        <span class=\"n\">error_messages</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">i_error</span><span class=\"p\">,</span> <span class=\"n\">error</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">errors</span><span class=\"p\">):</span>\n            <span class=\"n\">error_messages</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">))</span>\n            <span class=\"n\">error_msg</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">    Error </span><span class=\"si\">{i_error}</span><span class=\"s2\">: </span><span class=\"si\">{error_message}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">i_error</span><span class=\"o\">=</span><span class=\"n\">i_error</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"n\">error_message</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">error_msg</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error_messages</span> <span class=\"o\">=</span> <span class=\"n\">error_messages</span>\n\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">DagsterScheduleReconciliationError</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">error_msg</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DagsterScheduleDoesNotExist</span><span class=\"p\">(</span><span class=\"n\">DagsterSchedulerError</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Errors raised when ending a job for a schedule.&quot;&quot;&quot;</span>\n\n\n<span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleStatus</span><span class=\"p\">(</span><span class=\"n\">Enum</span><span class=\"p\">):</span>\n    <span class=\"n\">RUNNING</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;RUNNING&quot;</span>\n    <span class=\"n\">STOPPED</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;STOPPED&quot;</span>\n    <span class=\"n\">ENDED</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;ENDED&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_schedule_change_set</span><span class=\"p\">(</span><span class=\"n\">schedule_states</span><span class=\"p\">,</span> <span class=\"n\">external_schedules</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">schedule_states</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_states&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleState</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">external_schedules</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_schedules&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalSchedule</span><span class=\"p\">)</span>\n\n    <span class=\"n\">external_schedules_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">():</span> <span class=\"n\">s</span> <span class=\"k\">for</span> <span class=\"n\">s</span> <span class=\"ow\">in</span> <span class=\"n\">external_schedules</span><span class=\"p\">}</span>\n    <span class=\"n\">schedule_states_dict</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">:</span> <span class=\"n\">s</span> <span class=\"k\">for</span> <span class=\"n\">s</span> <span class=\"ow\">in</span> <span class=\"n\">schedule_states</span><span class=\"p\">}</span>\n\n    <span class=\"n\">external_schedule_origin_ids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">external_schedules_dict</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n    <span class=\"n\">schedule_state_ids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">schedule_states_dict</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n\n    <span class=\"n\">added_schedules</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule_origin_ids</span> <span class=\"o\">-</span> <span class=\"n\">schedule_state_ids</span>\n    <span class=\"n\">changed_schedules</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule_origin_ids</span> <span class=\"o\">&amp;</span> <span class=\"n\">schedule_state_ids</span>\n    <span class=\"n\">removed_schedules</span> <span class=\"o\">=</span> <span class=\"n\">schedule_state_ids</span> <span class=\"o\">-</span> <span class=\"n\">external_schedule_origin_ids</span>\n\n    <span class=\"n\">changeset</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">schedule_origin_id</span> <span class=\"ow\">in</span> <span class=\"n\">added_schedules</span><span class=\"p\">:</span>\n        <span class=\"n\">changeset</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"s2\">&quot;add&quot;</span><span class=\"p\">,</span> <span class=\"n\">external_schedules_dict</span><span class=\"p\">[</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">schedule_origin_id</span> <span class=\"ow\">in</span> <span class=\"n\">changed_schedules</span><span class=\"p\">:</span>\n        <span class=\"n\">changes</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n        <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">schedule_states_dict</span><span class=\"p\">[</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span>\n        <span class=\"n\">external_schedule</span> <span class=\"o\">=</span> <span class=\"n\">external_schedules_dict</span><span class=\"p\">[</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span> <span class=\"o\">!=</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">:</span>\n            <span class=\"n\">changes</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                <span class=\"p\">(</span><span class=\"s2\">&quot;cron_schedule&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">))</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">changes</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"n\">changeset</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n                <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;change&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">external_schedules_dict</span><span class=\"p\">[</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">changes</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">schedule_origin_id</span> <span class=\"ow\">in</span> <span class=\"n\">removed_schedules</span><span class=\"p\">:</span>\n        <span class=\"n\">changeset</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"s2\">&quot;remove&quot;</span><span class=\"p\">,</span> <span class=\"n\">schedule_states_dict</span><span class=\"p\">[</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">changeset</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SchedulerDebugInfo</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;SchedulerDebugInfo&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;errors scheduler_config_info scheduler_info schedule_storage&quot;</span><span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">scheduler_config_info</span><span class=\"p\">,</span> <span class=\"n\">scheduler_info</span><span class=\"p\">,</span> <span class=\"n\">schedule_storage</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">SchedulerDebugInfo</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">errors</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"s2\">&quot;errors&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">),</span>\n            <span class=\"n\">scheduler_config_info</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">scheduler_config_info</span><span class=\"p\">,</span> <span class=\"s2\">&quot;scheduler_config_info&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">scheduler_info</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">scheduler_info</span><span class=\"p\">,</span> <span class=\"s2\">&quot;scheduler_info&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">schedule_storage</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">list_param</span><span class=\"p\">(</span><span class=\"n\">schedule_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleState</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;_StoredScheduleState&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;origin status cron_schedule start_timestamp&quot;</span><span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"p\">,</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">cron_schedule</span><span class=\"p\">,</span> <span class=\"n\">start_timestamp</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ScheduleState</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"c1\"># Using the term &quot;origin&quot; to leave flexibility in handling future types</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">origin</span><span class=\"p\">,</span> <span class=\"s2\">&quot;origin&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalScheduleOrigin</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleStatus</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cron_schedule&quot;</span><span class=\"p\">),</span>\n            <span class=\"c1\"># Time in UTC at which the user started running the schedule (distinct from</span>\n            <span class=\"c1\"># `start_date` on partition-based schedules, which is used to define</span>\n            <span class=\"c1\"># the range of partitions)</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_float_param</span><span class=\"p\">(</span><span class=\"n\">start_timestamp</span><span class=\"p\">,</span> <span class=\"s2\">&quot;start_timestamp&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span><span class=\"o\">.</span><span class=\"n\">schedule_name</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">schedule_origin</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Set up for future proofing</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span><span class=\"p\">,</span> <span class=\"n\">ExternalScheduleOrigin</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">schedule_origin_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span><span class=\"o\">.</span><span class=\"n\">get_id</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">repository_origin_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span><span class=\"o\">.</span><span class=\"n\">external_repository_origin</span><span class=\"o\">.</span><span class=\"n\">get_id</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">with_status</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">start_time_utc</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleStatus</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">start_time_utc</span><span class=\"p\">,</span> <span class=\"s2\">&quot;start_time_utc&quot;</span><span class=\"p\">,</span> <span class=\"n\">datetime</span><span class=\"p\">)</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"n\">start_time_utc</span> <span class=\"o\">!=</span> <span class=\"kc\">None</span><span class=\"p\">),</span>\n            <span class=\"s2\">&quot;start_time_utc must be set if and only if the schedule is being started&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">ScheduleState</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">origin</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n            <span class=\"n\">start_timestamp</span><span class=\"o\">=</span><span class=\"n\">get_timestamp_from_utc_datetime</span><span class=\"p\">(</span><span class=\"n\">start_time_utc</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">start_time_utc</span>\n            <span class=\"k\">else</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"Scheduler\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/internals/#dagster.core.scheduler.Scheduler\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Scheduler</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">abc</span><span class=\"o\">.</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Abstract base class for a scheduler. This component is responsible for interfacing with</span>\n<span class=\"sd\">    an external system such as cron to ensure scheduled repeated execution according.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_stored_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">schedule_state</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterScheduleDoesNotExist</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;You have attempted to start the job for schedule id </span><span class=\"si\">{id}</span><span class=\"s2\">, but its state is not in storage.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">schedule_origin_id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">schedule_state</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_new_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">ScheduleState</span><span class=\"p\">(</span>\n            <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin</span><span class=\"p\">(),</span>\n            <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">STOPPED</span><span class=\"p\">,</span>\n            <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n            <span class=\"n\">start_timestamp</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">add_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">schedule_state</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reconcile_scheduler_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_repository</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Reconcile the ExternalSchedule list from the repository and ScheduleStorage</span>\n<span class=\"sd\">        on the instance to ensure there is a 1-1 correlation between ExternalSchedule and</span>\n<span class=\"sd\">        ScheduleStates, where the ExternalSchedule list is the source of truth.</span>\n\n<span class=\"sd\">        If a new ExternalSchedule is introduced, a new ScheduleState is added to storage with status</span>\n<span class=\"sd\">        ScheduleStatus.STOPPED.</span>\n\n<span class=\"sd\">        For every previously existing ExternalSchedule (where target id is the primary key),</span>\n<span class=\"sd\">        any changes to the definition are persisted in the corresponding ScheduleState and the status is</span>\n<span class=\"sd\">        left unchanged. The schedule is also restarted to make sure the external artifacts (such</span>\n<span class=\"sd\">        as a cron job) are up to date.</span>\n\n<span class=\"sd\">        For every ScheduleDefinitions that is removed, the corresponding ScheduleState is removed from</span>\n<span class=\"sd\">        the storage and the corresponding ScheduleState is ended.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">schedules_to_restart</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">external_schedule</span> <span class=\"ow\">in</span> <span class=\"n\">external_repository</span><span class=\"o\">.</span><span class=\"n\">get_external_schedules</span><span class=\"p\">():</span>\n            <span class=\"c1\"># If a schedule already exists for schedule_def, overwrite bash script and</span>\n            <span class=\"c1\"># metadata file</span>\n            <span class=\"n\">existing_schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_stored_schedule_state</span><span class=\"p\">(</span>\n                <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">existing_schedule_state</span><span class=\"p\">:</span>\n\n                <span class=\"n\">new_timestamp</span> <span class=\"o\">=</span> <span class=\"n\">existing_schedule_state</span><span class=\"o\">.</span><span class=\"n\">start_timestamp</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">new_timestamp</span> <span class=\"ow\">and</span> <span class=\"n\">existing_schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span><span class=\"p\">:</span>\n                    <span class=\"n\">new_timestamp</span> <span class=\"o\">=</span> <span class=\"n\">get_timestamp_from_utc_datetime</span><span class=\"p\">(</span><span class=\"n\">get_current_datetime_in_utc</span><span class=\"p\">())</span>\n\n                <span class=\"c1\"># Keep the status, update target and cron schedule</span>\n                <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">ScheduleState</span><span class=\"p\">(</span>\n                    <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin</span><span class=\"p\">(),</span>\n                    <span class=\"n\">existing_schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"p\">,</span>\n                    <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n                    <span class=\"n\">new_timestamp</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n\n                <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">update_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_state</span><span class=\"p\">)</span>\n                <span class=\"n\">schedules_to_restart</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">existing_schedule_state</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">))</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_new_schedule_state</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Delete all existing schedules that are not in external schedules</span>\n        <span class=\"n\">external_schedule_origin_ids</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span> <span class=\"k\">for</span> <span class=\"n\">s</span> <span class=\"ow\">in</span> <span class=\"n\">external_repository</span><span class=\"o\">.</span><span class=\"n\">get_external_schedules</span><span class=\"p\">()</span>\n        <span class=\"p\">}</span>\n        <span class=\"n\">existing_schedule_origin_ids</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span>\n            <span class=\"p\">[</span>\n                <span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span>\n                <span class=\"k\">for</span> <span class=\"n\">s</span> <span class=\"ow\">in</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">all_stored_schedule_state</span><span class=\"p\">(</span>\n                    <span class=\"n\">external_repository</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">]</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">schedule_origin_ids_to_delete</span> <span class=\"o\">=</span> <span class=\"n\">existing_schedule_origin_ids</span> <span class=\"o\">-</span> <span class=\"n\">external_schedule_origin_ids</span>\n\n        <span class=\"n\">schedule_reconciliation_errors</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">schedule_state</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span> <span class=\"ow\">in</span> <span class=\"n\">schedules_to_restart</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Restart is only needed if the schedule was previously running</span>\n            <span class=\"k\">if</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span><span class=\"p\">:</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">refresh_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n                <span class=\"k\">except</span> <span class=\"n\">DagsterSchedulerError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n                    <span class=\"n\">schedule_reconciliation_errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">STOPPED</span><span class=\"p\">:</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">stop_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">())</span>\n                <span class=\"k\">except</span> <span class=\"n\">DagsterSchedulerError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n                    <span class=\"n\">schedule_reconciliation_errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">schedule_origin_id</span> <span class=\"ow\">in</span> <span class=\"n\">schedule_origin_ids_to_delete</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">stop_schedule_and_delete_from_storage</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">DagsterSchedulerError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n                <span class=\"n\">schedule_reconciliation_errors</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">schedule_reconciliation_errors</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterScheduleReconciliationError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;One or more errors were encountered by the Scheduler while starting or stopping schedules. &quot;</span>\n                <span class=\"s2\">&quot;Individual error messages follow:&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">errors</span><span class=\"o\">=</span><span class=\"n\">schedule_reconciliation_errors</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">start_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Updates the status of the given schedule to `ScheduleStatus.RUNNING` in schedule storage,</span>\n<span class=\"sd\">        then calls `start_schedule`.</span>\n\n<span class=\"sd\">        This should not be overridden by subclasses.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            external_schedule (ExternalSchedule): The schedule to start</span>\n\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">external_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_schedule&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalSchedule</span><span class=\"p\">)</span>\n\n        <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_stored_schedule_state</span><span class=\"p\">(</span>\n            <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">schedule_state</span><span class=\"p\">:</span>\n            <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_new_schedule_state</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterSchedulerError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;You have attempted to start schedule </span><span class=\"si\">{name}</span><span class=\"s2\">, but it is already running&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">name</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">start_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n        <span class=\"n\">started_schedule</span> <span class=\"o\">=</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">with_status</span><span class=\"p\">(</span>\n            <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span><span class=\"p\">,</span> <span class=\"n\">start_time_utc</span><span class=\"o\">=</span><span class=\"n\">get_current_datetime_in_utc</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">update_schedule_state</span><span class=\"p\">(</span><span class=\"n\">started_schedule</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">started_schedule</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule_and_update_storage_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Updates the status of the given schedule to `ScheduleStatus.STOPPED` in schedule storage,</span>\n<span class=\"sd\">        then calls `stop_schedule`.</span>\n\n<span class=\"sd\">        This should not be overridden by subclasses.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            schedule_origin_id (string): The id of the schedule target to stop running.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">schedule_state</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">stop_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"n\">stopped_schedule</span> <span class=\"o\">=</span> <span class=\"n\">schedule_state</span><span class=\"o\">.</span><span class=\"n\">with_status</span><span class=\"p\">(</span><span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">STOPPED</span><span class=\"p\">)</span>\n        <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">update_schedule_state</span><span class=\"p\">(</span><span class=\"n\">stopped_schedule</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">stopped_schedule</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule_and_delete_from_storage</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Deletes a schedule from schedule storage, then calls `stop_schedule`.</span>\n\n<span class=\"sd\">        This should not be overridden by subclasses.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            schedule_origin_id (string): The id of the schedule target to start running.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">schedule</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">stop_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">delete_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">schedule</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">refresh_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Refresh a running schedule. This is called when user reconciles the schedule state.</span>\n\n<span class=\"sd\">        By default, this method will call stop_schedule and then start_schedule but can be</span>\n<span class=\"sd\">        overriden. For example, in the K8s Scheduler we patch the existing cronjob</span>\n<span class=\"sd\">        (without stopping it) to minimize downtime.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            external_schedule (ExternalSchedule): The schedule to start running.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">external_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_schedule&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalSchedule</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">stop_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">())</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">start_schedule</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@abc</span><span class=\"o\">.</span><span class=\"n\">abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">debug_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Returns debug information about the scheduler</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abc</span><span class=\"o\">.</span><span class=\"n\">abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">start_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Start running a schedule. This method is called by `start_schedule_and_update_storage_state`,</span>\n<span class=\"sd\">        which first updates the status of the schedule in schedule storage to `ScheduleStatus.RUNNING`,</span>\n<span class=\"sd\">        then calls this method.</span>\n\n<span class=\"sd\">        For example, in the cron scheduler, this method writes a cron job to the cron tab</span>\n<span class=\"sd\">        for the given schedule.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            external_schedule (ExternalSchedule): The schedule to start running.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abc</span><span class=\"o\">.</span><span class=\"n\">abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Stop running a schedule.</span>\n\n<span class=\"sd\">        This method is called by</span>\n<span class=\"sd\">        1) `stop_schedule_and_update_storage_state`,</span>\n<span class=\"sd\">        which first updates the status of the schedule in schedule storage to `ScheduleStatus.STOPPED`,</span>\n<span class=\"sd\">        then calls this method.</span>\n<span class=\"sd\">        2) `stop_schedule_and_delete_from_storage`, which deletes the schedule from schedule storage</span>\n<span class=\"sd\">        then calls this method.</span>\n\n<span class=\"sd\">        For example, in the cron scheduler, this method deletes the cron job for a given scheduler</span>\n<span class=\"sd\">        from the cron tab.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            schedule_origin_id (string): The id of the schedule target to stop running.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abc</span><span class=\"o\">.</span><span class=\"n\">abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">running_schedule_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Returns the number of jobs currently running for the given schedule. This method is used</span>\n<span class=\"sd\">        for detecting when the scheduler is out of sync with schedule storage.</span>\n\n<span class=\"sd\">        For example, when:</span>\n<span class=\"sd\">        - There are duplicate jobs runnning for a single schedule</span>\n<span class=\"sd\">        - There are no jobs runnning for a schedule that is set to be running</span>\n<span class=\"sd\">        - There are still jobs running for a schedule that is set to be stopped</span>\n\n<span class=\"sd\">        When the scheduler and schedule storage are in sync, this method should return:</span>\n<span class=\"sd\">        - 1 when a schedule is set to be running</span>\n<span class=\"sd\">        - 0 when a schedule is set to be stopped</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            instance (DagsterInstance): The current instance.</span>\n<span class=\"sd\">            schedule_origin_id (string): The id of the schedule target to return the number of jobs for</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abc</span><span class=\"o\">.</span><span class=\"n\">abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_logs_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get path to store logs for schedule</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            schedule_origin_id (string): The id of the schedule target to retrieve the log path for</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DagsterDaemonScheduler</span><span class=\"p\">(</span><span class=\"n\">Scheduler</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Scheduler implementation that launches runs from the `dagster scheduler run`</span>\n<span class=\"sd\">    long-lived process.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">max_catchup_runs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">max_catchup_runs</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">max_catchup_runs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;max_catchup_runs&quot;</span><span class=\"p\">,</span> <span class=\"mi\">5</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">inst_data</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;max_catchup_runs&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">IntSource</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">DagsterDaemonScheduler</span><span class=\"p\">(</span>\n            <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">max_catchup_runs</span><span class=\"o\">=</span><span class=\"n\">config_value</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;max_catchup_runs&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">debug_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">start_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Automatically picked up by the `dagster scheduler run` command</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Automatically picked up by the `dagster scheduler run` command</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">running_schedule_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">state</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_stored_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">state</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"mi\">0</span>\n        <span class=\"k\">return</span> <span class=\"mi\">1</span> <span class=\"k\">if</span> <span class=\"n\">state</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleStatus</span><span class=\"o\">.</span><span class=\"n\">RUNNING</span> <span class=\"k\">else</span> <span class=\"mi\">0</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_or_create_logs_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">schedules_directory</span><span class=\"p\">(),</span> <span class=\"s2\">&quot;logs&quot;</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">):</span>\n            <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">logs_directory</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_logs_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_or_create_logs_directory</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">,</span> <span class=\"s2\">&quot;scheduler.log&quot;</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleTickStatsSnapshot</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span>\n        <span class=\"s2\">&quot;ScheduleTickStatsSnapshot&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s2\">&quot;ticks_started ticks_succeeded ticks_skipped ticks_failed&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span>\n        <span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">ticks_started</span><span class=\"p\">,</span> <span class=\"n\">ticks_succeeded</span><span class=\"p\">,</span> <span class=\"n\">ticks_skipped</span><span class=\"p\">,</span> <span class=\"n\">ticks_failed</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickStatsSnapshot</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">ticks_started</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">ticks_started</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ticks_started&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_succeeded</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">ticks_succeeded</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ticks_succeeded&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_skipped</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">ticks_skipped</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ticks_skipped&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_failed</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">ticks_failed</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ticks_failed&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleTickStatus</span><span class=\"p\">(</span><span class=\"n\">Enum</span><span class=\"p\">):</span>\n    <span class=\"n\">STARTED</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;STARTED&quot;</span>\n    <span class=\"n\">SKIPPED</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;SKIPPED&quot;</span>\n    <span class=\"n\">SUCCESS</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;SUCCESS&quot;</span>\n    <span class=\"n\">FAILURE</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;FAILURE&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_validate_schedule_tick_args</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickStatus</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">SUCCESS</span><span class=\"p\">:</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">error</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">desc</span><span class=\"o\">=</span><span class=\"s2\">&quot;Schedule tick status is SUCCESS, but error was provided&quot;</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">elif</span> <span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">FAILURE</span><span class=\"p\">:</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">,</span> <span class=\"s2\">&quot;error&quot;</span><span class=\"p\">,</span> <span class=\"n\">SerializableErrorInfo</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span>\n            <span class=\"n\">error</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Schedule tick status was not FAILURE but error was provided&quot;</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleTickData</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span>\n        <span class=\"s2\">&quot;Schedule&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id schedule_name cron_schedule timestamp status run_id error&quot;</span>\n    <span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span>\n        <span class=\"bp\">cls</span><span class=\"p\">,</span>\n        <span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n        <span class=\"n\">schedule_name</span><span class=\"p\">,</span>\n        <span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n        <span class=\"n\">timestamp</span><span class=\"p\">,</span>\n        <span class=\"n\">status</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        This class defines the data that is serialized and stored in ``ScheduleStorage``. We depend</span>\n<span class=\"sd\">        on the schedule storage implementation to provide schedule tick ids, and therefore</span>\n<span class=\"sd\">        separate all other data into this serializable class that can be stored independently of the</span>\n<span class=\"sd\">        id</span>\n\n<span class=\"sd\">        Arguments:</span>\n<span class=\"sd\">            schedule_origin_id (str): The id of the schedule target for this tick</span>\n<span class=\"sd\">            schedule_name (str): The name of the schedule for this tick</span>\n<span class=\"sd\">            cron_schedule (str): The cron schedule of the ``ScheduleDefinition`` for tracking</span>\n<span class=\"sd\">                purposes. This is helpful when debugging changes in the cron schedule.</span>\n<span class=\"sd\">            timestamp (float): The timestamp at which this schedule execution started</span>\n<span class=\"sd\">            status (ScheduleTickStatus): The status of the tick, which can be updated</span>\n\n<span class=\"sd\">        Keyword Arguments:</span>\n<span class=\"sd\">            run_id (str): The run created by the tick.</span>\n<span class=\"sd\">            error (SerializableErrorInfo): The error caught during schedule execution. This is set</span>\n<span class=\"sd\">                only when the status is ``ScheduleTickStatus.Failure``</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">_validate_schedule_tick_args</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickData</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cron_schedule&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">float_param</span><span class=\"p\">(</span><span class=\"n\">timestamp</span><span class=\"p\">,</span> <span class=\"s2\">&quot;timestamp&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">error</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">with_status</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickStatus</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">ScheduleTickData</span><span class=\"p\">(</span>\n            <span class=\"n\">schedule_origin_id</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n            <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_name</span><span class=\"p\">,</span>\n            <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"n\">cron_schedule</span> <span class=\"k\">if</span> <span class=\"n\">cron_schedule</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n            <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">timestamp</span><span class=\"p\">,</span>\n            <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">status</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span> <span class=\"k\">if</span> <span class=\"n\">run_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"n\">error</span> <span class=\"k\">if</span> <span class=\"n\">error</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ScheduleTick</span><span class=\"p\">(</span><span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;Schedule&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tick_id schedule_tick_data&quot;</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A scheduler is configured to run at an multiple intervals set by the `cron_schedule`</span>\n<span class=\"sd\">    properties on ``ScheduleDefinition``. We define a schedule tick as each time the scheduler</span>\n<span class=\"sd\">    runs for a specific schedule.</span>\n\n<span class=\"sd\">    When the schedule is being executed to create a pipeline run, we create a``ScheduleTick``</span>\n<span class=\"sd\">    object and store it in ``ScheduleStorage``. This is needed because not every tick results</span>\n<span class=\"sd\">    in creating a run, due to skips or errors.</span>\n\n<span class=\"sd\">    At the beginning of schedule execution, we create a ``ScheduleTick`` object in the</span>\n<span class=\"sd\">    ``ScheduleTickStatus.STARTED`` state.</span>\n\n<span class=\"sd\">    A schedule definition has a `should_execute` argument, where users can define a function</span>\n<span class=\"sd\">    which defines whether to create a run for the current tick. In the case where</span>\n<span class=\"sd\">    ``should_execute`` returns false, schedule execution is short-circuited, a run is not created,</span>\n<span class=\"sd\">    and the status of the schedule tick is updated to be ``ScheduleTickStatus.SKIPPED``.</span>\n\n<span class=\"sd\">    There are also several errors that can occur during schedule execution, which are important</span>\n<span class=\"sd\">    to track for observability and alerting. There are several user defined functions that</span>\n<span class=\"sd\">    are run during schedule execution, which are each wrapped with a ``user_error_boundary``.</span>\n<span class=\"sd\">    There is also the possibility of a framework error. These errors are caught,</span>\n<span class=\"sd\">    serialized, and stored on the ``ScheduleTick``.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">tick_id</span><span class=\"p\">,</span> <span class=\"n\">schedule_tick_data</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ScheduleTick</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">tick_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tick_id&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">schedule_tick_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_tick_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickData</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">with_status</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"s2\">&quot;status&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickStatus</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_replace</span><span class=\"p\">(</span>\n            <span class=\"n\">schedule_tick_data</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">with_status</span><span class=\"p\">(</span>\n                <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">error</span><span class=\"o\">=</span><span class=\"n\">error</span><span class=\"p\">,</span> <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"n\">cron_schedule</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">schedule_origin_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">schedule_name</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">schedule_name</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">cron_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">timestamp</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">timestamp</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">status</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">status</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">run_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">error</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">error</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/scheduler/scheduler", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}