{"parents": [{"link": "../../../../../", "title": "Module code"}], "title": "dagster.core.definitions.decorators.repository", "body": "<h1>Source code for dagster.core.definitions.decorators.repository</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">functools</span> <span class=\"kn\">import</span> <span class=\"n\">update_wrapper</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInvalidDefinitionError</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..job</span> <span class=\"kn\">import</span> <span class=\"n\">JobDefinition</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..partition</span> <span class=\"kn\">import</span> <span class=\"n\">PartitionSetDefinition</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..pipeline</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineDefinition</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..repository</span> <span class=\"kn\">import</span> <span class=\"n\">VALID_REPOSITORY_DATA_DICT_KEYS</span><span class=\"p\">,</span> <span class=\"n\">RepositoryData</span><span class=\"p\">,</span> <span class=\"n\">RepositoryDefinition</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..schedule</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleDefinition</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_Repository</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">description</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">description</span><span class=\"p\">,</span> <span class=\"s2\">&quot;description&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">fn</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">fn</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fn&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">fn</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n\n        <span class=\"n\">repository_definitions</span> <span class=\"o\">=</span> <span class=\"n\">fn</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"n\">RepositoryData</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvalidDefinitionError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Bad return value of type </span><span class=\"si\">{type_}</span><span class=\"s2\"> from repository construction function: must &quot;</span>\n                <span class=\"s2\">&quot;return list, dict, or RepositoryData. See the @repository decorator docstring for &quot;</span>\n                <span class=\"s2\">&quot;details and examples&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">)),</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n            <span class=\"n\">bad_definitions</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n            <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">definition</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n                    <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">PipelineDefinition</span><span class=\"p\">)</span>\n                    <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span><span class=\"p\">)</span>\n                    <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">ScheduleDefinition</span><span class=\"p\">)</span>\n                    <span class=\"ow\">or</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">definition</span><span class=\"p\">,</span> <span class=\"n\">JobDefinition</span><span class=\"p\">)</span>\n                <span class=\"p\">):</span>\n                    <span class=\"n\">bad_definitions</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">definition</span><span class=\"p\">)))</span>\n            <span class=\"k\">if</span> <span class=\"n\">bad_definitions</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvalidDefinitionError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Bad return value from repository construction function: all elements of list &quot;</span>\n                    <span class=\"s2\">&quot;must be of type PipelineDefinition, PartitionSetDefinition, &quot;</span>\n                    <span class=\"s2\">&quot;ScheduleDefinition, or JobDefinition. Got </span><span class=\"si\">{bad_definitions_formatted}</span><span class=\"s2\">.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">bad_definitions_formatted</span><span class=\"o\">=</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                            <span class=\"p\">[</span>\n                                <span class=\"s2\">&quot;value of type </span><span class=\"si\">{type_}</span><span class=\"s2\"> at index </span><span class=\"si\">{i}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">type_</span><span class=\"o\">=</span><span class=\"n\">type_</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"o\">=</span><span class=\"n\">i</span><span class=\"p\">)</span>\n                                <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">type_</span> <span class=\"ow\">in</span> <span class=\"n\">bad_definitions</span>\n                            <span class=\"p\">]</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">repository_data</span> <span class=\"o\">=</span> <span class=\"n\">RepositoryData</span><span class=\"o\">.</span><span class=\"n\">from_list</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">)</span>\n\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">issubset</span><span class=\"p\">(</span><span class=\"n\">VALID_REPOSITORY_DATA_DICT_KEYS</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvalidDefinitionError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Bad return value from repository construction function: dict must not contain &quot;</span>\n                    <span class=\"s2\">&quot;keys other than {{&#39;pipelines&#39;, &#39;partition_sets&#39;, &#39;schedules&#39;, &#39;jobs&#39;}}: found &quot;</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">{bad_keys}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">bad_keys</span><span class=\"o\">=</span><span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                            <span class=\"p\">[</span>\n                                <span class=\"s2\">&quot;&#39;</span><span class=\"si\">{key}</span><span class=\"s2\">&#39;&quot;</span>\n                                <span class=\"k\">for</span> <span class=\"n\">key</span> <span class=\"ow\">in</span> <span class=\"n\">repository_definitions</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">()</span>\n                                <span class=\"k\">if</span> <span class=\"n\">key</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">VALID_REPOSITORY_DATA_DICT_KEYS</span>\n                            <span class=\"p\">]</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">repository_data</span> <span class=\"o\">=</span> <span class=\"n\">RepositoryData</span><span class=\"o\">.</span><span class=\"n\">from_dict</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">repository_definitions</span><span class=\"p\">,</span> <span class=\"n\">RepositoryData</span><span class=\"p\">):</span>\n            <span class=\"n\">repository_data</span> <span class=\"o\">=</span> <span class=\"n\">repository_definitions</span>\n\n        <span class=\"n\">repository_def</span> <span class=\"o\">=</span> <span class=\"n\">RepositoryDefinition</span><span class=\"p\">(</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">description</span><span class=\"p\">,</span> <span class=\"n\">repository_data</span><span class=\"o\">=</span><span class=\"n\">repository_data</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">update_wrapper</span><span class=\"p\">(</span><span class=\"n\">repository_def</span><span class=\"p\">,</span> <span class=\"n\">fn</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">repository_def</span>\n\n\n<div class=\"viewcode-block\" id=\"repository\"><a class=\"viewcode-back\" href=\"../../../../../../sections/api/apidocs/repositories/#dagster.repository\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">repository</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Create a repository from the decorated function.</span>\n\n<span class=\"sd\">    The decorated function should take no arguments and its return value should one of:</span>\n\n<span class=\"sd\">    1. ``List[Union[PipelineDefinition, PartitionSetDefinition, ScheduleDefinition]]``. Use this</span>\n<span class=\"sd\">        form when you have no need to lazy load pipelines or other definitions. This is the</span>\n<span class=\"sd\">        typical use case.</span>\n\n<span class=\"sd\">    2. A dict of the form:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        {</span>\n<span class=\"sd\">            &#39;pipelines&#39;: Dict[str, Callable[[], PipelineDefinition]],</span>\n<span class=\"sd\">            &#39;partition_sets&#39;: Dict[str, Callable[[], PartitionSetDefinition]],</span>\n<span class=\"sd\">            &#39;schedules&#39;: Dict[str, Callable[[], ScheduleDefinition]]</span>\n<span class=\"sd\">        }</span>\n\n<span class=\"sd\">    This form is intended to allow definitions to be created lazily when accessed by name,</span>\n<span class=\"sd\">    which can be helpful for performance when there are many definitions in a repository, or</span>\n<span class=\"sd\">    when constructing the definitions is costly.</span>\n\n<span class=\"sd\">    3. An object of type :py:class:`RepositoryData`. Return this object if you need fine-grained</span>\n<span class=\"sd\">        control over the construction and indexing of definitions within the repository, e.g., to</span>\n<span class=\"sd\">        create definitions dynamically from .yaml files in a directory.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        name (Optional[str]): The name of the repository. Defaults to the name of the decorated</span>\n<span class=\"sd\">            function.</span>\n<span class=\"sd\">        description (Optional[str]): A string description of the repository.</span>\n\n<span class=\"sd\">    Example:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        ######################################################################</span>\n<span class=\"sd\">        # A simple repository using the first form of the decorated function</span>\n<span class=\"sd\">        ######################################################################</span>\n\n<span class=\"sd\">        @solid(config_schema={n: Field(Int)})</span>\n<span class=\"sd\">        def return_n(context):</span>\n<span class=\"sd\">            return context.solid_config[&#39;n&#39;]</span>\n\n<span class=\"sd\">        @pipeline(name=&#39;simple_pipeline&#39;)</span>\n<span class=\"sd\">        def simple_pipeline():</span>\n<span class=\"sd\">            return_n()</span>\n\n<span class=\"sd\">        simple_partition_set = PartitionSetDefinition(</span>\n<span class=\"sd\">            name=&#39;simple_partition_set&#39;,</span>\n<span class=\"sd\">            pipeline_name=&#39;simple_pipeline&#39;,</span>\n<span class=\"sd\">            partition_fn=lambda: range(10),</span>\n<span class=\"sd\">            run_config_fn_for_partition=(</span>\n<span class=\"sd\">                lambda partition: {</span>\n<span class=\"sd\">                    &#39;solids&#39;: {&#39;return_n&#39;: {&#39;config&#39;: {&#39;n&#39;: partition}}}</span>\n<span class=\"sd\">                }</span>\n<span class=\"sd\">            ),</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">        simple_schedule = simple_partition_set.create_schedule_definition(</span>\n<span class=\"sd\">            schedule_name=&#39;simple_daily_10_pm_schedule&#39;,</span>\n<span class=\"sd\">            cron_schedule=&#39;0 22 * * *&#39;,</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">        @repository</span>\n<span class=\"sd\">        def simple_repository():</span>\n<span class=\"sd\">            return [simple_pipeline, simple_partition_set, simple_schedule]</span>\n\n\n<span class=\"sd\">        ######################################################################</span>\n<span class=\"sd\">        # A lazy-loaded repository</span>\n<span class=\"sd\">        ######################################################################</span>\n\n<span class=\"sd\">        def make_expensive_pipeline():</span>\n<span class=\"sd\">            @pipeline(name=&#39;expensive_pipeline&#39;)</span>\n<span class=\"sd\">            def expensive_pipeline():</span>\n<span class=\"sd\">                for i in range(10000):</span>\n<span class=\"sd\">                    return_n.alias(&#39;return_n_{i}&#39;.format(i=i))()</span>\n\n<span class=\"sd\">            return expensive_pipeline</span>\n\n<span class=\"sd\">        expensive_partition_set = PartitionSetDefinition(</span>\n<span class=\"sd\">            name=&#39;expensive_partition_set&#39;,</span>\n<span class=\"sd\">            pipeline_name=&#39;expensive_pipeline&#39;,</span>\n<span class=\"sd\">            partition_fn=lambda: range(10),</span>\n<span class=\"sd\">            run_config_fn_for_partition=(</span>\n<span class=\"sd\">                lambda partition: {</span>\n<span class=\"sd\">                    &#39;solids&#39;: {</span>\n<span class=\"sd\">                        &#39;return_n_{i}&#39;.format(i=i): {&#39;config&#39;: {&#39;n&#39;: partition}}</span>\n<span class=\"sd\">                        for i in range(10000)</span>\n<span class=\"sd\">                    }</span>\n<span class=\"sd\">                }</span>\n<span class=\"sd\">            ),</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">        def make_expensive_schedule():</span>\n<span class=\"sd\">            expensive_partition_set.create_schedule_definition(</span>\n<span class=\"sd\">                schedule_name=&#39;expensive_schedule&#39;,</span>\n<span class=\"sd\">                cron_schedule=&#39;0 22 * * *&#39;,</span>\n<span class=\"sd\">        )</span>\n\n<span class=\"sd\">        @repository</span>\n<span class=\"sd\">        def lazy_loaded_repository():</span>\n<span class=\"sd\">            return {</span>\n<span class=\"sd\">                &#39;pipelines&#39;: {&#39;expensive_pipeline&#39;: make_expensive_pipeline},</span>\n<span class=\"sd\">                &#39;partition_sets&#39;: {</span>\n<span class=\"sd\">                    &#39;expensive_partition_set&#39;: expensive_partition_set</span>\n<span class=\"sd\">                },</span>\n<span class=\"sd\">                &#39;schedules&#39;: {&#39;expensive_schedule: make_expensive_schedule}</span>\n<span class=\"sd\">            }</span>\n\n\n<span class=\"sd\">        ######################################################################</span>\n<span class=\"sd\">        # A complex repository that lazily construct pipelines from a directory</span>\n<span class=\"sd\">        # of files in a bespoke YAML format</span>\n<span class=\"sd\">        ######################################################################</span>\n\n<span class=\"sd\">        class ComplexRepositoryData(RepositoryData):</span>\n<span class=\"sd\">            def __init__(self, yaml_directory):</span>\n<span class=\"sd\">                self._yaml_directory = yaml_directory</span>\n\n<span class=\"sd\">            def get_pipeline(self, pipeline_name):</span>\n<span class=\"sd\">                return self._construct_pipeline_def_from_yaml_file(</span>\n<span class=\"sd\">                    self._yaml_file_for_pipeline_name(pipeline_name)</span>\n<span class=\"sd\">                )</span>\n\n<span class=\"sd\">            ...</span>\n\n<span class=\"sd\">        @repository</span>\n<span class=\"sd\">        def complex_repository():</span>\n<span class=\"sd\">            return ComplexRepositoryData(&#39;some_directory&#39;)</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"n\">callable</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">description</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">_Repository</span><span class=\"p\">()(</span><span class=\"n\">name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">_Repository</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"n\">description</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/definitions/decorators/repository", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}