{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.definitions.partition", "body": "<h1>Source code for dagster.core.definitions.partition</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.schedule</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleDefinition</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInvalidDefinitionError</span><span class=\"p\">,</span> <span class=\"n\">DagsterInvariantViolationError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunStatus</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunsFilter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.tags</span> <span class=\"kn\">import</span> <span class=\"n\">check_tags</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">merge_dicts</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.mode</span> <span class=\"kn\">import</span> <span class=\"n\">DEFAULT_MODE_NAME</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.utils</span> <span class=\"kn\">import</span> <span class=\"n\">check_valid_name</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">by_name</span><span class=\"p\">(</span><span class=\"n\">partition</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">partition</span><span class=\"o\">.</span><span class=\"n\">name</span>\n\n\n<div class=\"viewcode-block\" id=\"Partition\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/partitions/#dagster.Partition\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Partition</span><span class=\"p\">(</span><span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;_Partition&quot;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"s2\">&quot;value name&quot;</span><span class=\"p\">))):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Partition is the representation of a logical slice across an axis of a pipeline&#39;s work</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        value (Any): The object for this partition</span>\n<span class=\"sd\">        name (str): Name for this partition</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">Partition</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;name&quot;</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)),</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span>\n        <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">create_default_partition_selector_fn</span><span class=\"p\">(</span>\n    <span class=\"n\">delta_fn</span><span class=\"p\">,</span> <span class=\"n\">fmt</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">delta_fn</span><span class=\"p\">,</span> <span class=\"s2\">&quot;delta_fn&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">fmt</span><span class=\"p\">,</span> <span class=\"s2\">&quot;fmt&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">default_partition_selector</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">partition_set_def</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">partition_set_def</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_set_def&quot;</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">scheduled_execution_time</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">last_partition</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">partition_set_def</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># The tick at a given datetime corresponds to the time for the previous partition</span>\n        <span class=\"c1\"># e.g. midnight on 12/31 is actually the 12/30 partition</span>\n        <span class=\"n\">partition_time</span> <span class=\"o\">=</span> <span class=\"n\">delta_fn</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">scheduled_execution_time</span><span class=\"p\">)</span>\n\n        <span class=\"n\">partition_name</span> <span class=\"o\">=</span> <span class=\"n\">partition_time</span><span class=\"o\">.</span><span class=\"n\">strftime</span><span class=\"p\">(</span><span class=\"n\">fmt</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">partition_name</span> <span class=\"ow\">in</span> <span class=\"n\">partition_set_def</span><span class=\"o\">.</span><span class=\"n\">get_partition_names</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">partition_set_def</span><span class=\"o\">.</span><span class=\"n\">get_partition</span><span class=\"p\">(</span><span class=\"n\">partition_name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">default_partition_selector</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">last_partition</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">partition_set_def</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">partition_set_def</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_set_def&quot;</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span><span class=\"p\">)</span>\n\n    <span class=\"n\">partitions</span> <span class=\"o\">=</span> <span class=\"n\">partition_set_def</span><span class=\"o\">.</span><span class=\"n\">get_partitions</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">partitions</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n    <span class=\"k\">return</span> <span class=\"n\">partitions</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">last_empty_partition</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">partition_set_def</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n    <span class=\"n\">partition_set_def</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n        <span class=\"n\">partition_set_def</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_set_def&quot;</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">partitions</span> <span class=\"o\">=</span> <span class=\"n\">partition_set_def</span><span class=\"o\">.</span><span class=\"n\">get_partitions</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">partitions</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n    <span class=\"n\">selected</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"k\">for</span> <span class=\"n\">partition</span> <span class=\"ow\">in</span> <span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"n\">partitions</span><span class=\"p\">):</span>\n        <span class=\"n\">filters</span> <span class=\"o\">=</span> <span class=\"n\">PipelineRunsFilter</span><span class=\"o\">.</span><span class=\"n\">for_partition</span><span class=\"p\">(</span><span class=\"n\">partition_set_def</span><span class=\"p\">,</span> <span class=\"n\">partition</span><span class=\"p\">)</span>\n        <span class=\"n\">matching</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">get_runs</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">SUCCESS</span> <span class=\"k\">for</span> <span class=\"n\">run</span> <span class=\"ow\">in</span> <span class=\"n\">matching</span><span class=\"p\">):</span>\n            <span class=\"n\">selected</span> <span class=\"o\">=</span> <span class=\"n\">partition</span>\n            <span class=\"k\">break</span>\n    <span class=\"k\">return</span> <span class=\"n\">selected</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">first_partition</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">partition_set_def</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n    <span class=\"n\">partition_set_def</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n        <span class=\"n\">partition_set_def</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_set_def&quot;</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"n\">partitions</span> <span class=\"o\">=</span> <span class=\"n\">partition_set_def</span><span class=\"o\">.</span><span class=\"n\">get_partitions</span><span class=\"p\">()</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">partitions</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">partitions</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n\n<div class=\"viewcode-block\" id=\"PartitionSetDefinition\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/partitions/#dagster.PartitionSetDefinition\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">PartitionSetDefinition</span><span class=\"p\">(</span>\n    <span class=\"n\">namedtuple</span><span class=\"p\">(</span>\n        <span class=\"s2\">&quot;_PartitionSetDefinition&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;name pipeline_name partition_fn solid_selection mode &quot;</span>\n            <span class=\"s2\">&quot;user_defined_run_config_fn_for_partition user_defined_tags_fn_for_partition&quot;</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Defines a partition set, representing the set of slices making up an axis of a pipeline</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        name (str): Name for this partition set</span>\n<span class=\"sd\">        pipeline_name (str): The name of the pipeline definition</span>\n<span class=\"sd\">        partition_fn (Callable[void, List[Partition]]): User-provided function to define the set of</span>\n<span class=\"sd\">            valid partition objects.</span>\n<span class=\"sd\">        solid_selection (Optional[List[str]]): A list of solid subselection (including single</span>\n<span class=\"sd\">            solid names) to execute with this partition. e.g. ``[&#39;*some_solid+&#39;, &#39;other_solid&#39;]``</span>\n<span class=\"sd\">        mode (Optional[str]): The mode to apply when executing this partition. (default: &#39;default&#39;)</span>\n<span class=\"sd\">        run_config_fn_for_partition (Callable[[Partition], [Dict]]): A</span>\n<span class=\"sd\">            function that takes a :py:class:`~dagster.Partition` and returns the run</span>\n<span class=\"sd\">            configuration that parameterizes the execution for this partition, as a dict</span>\n<span class=\"sd\">        tags_fn_for_partition (Callable[[Partition], Optional[dict[str, str]]]): A function that</span>\n<span class=\"sd\">            takes a :py:class:`~dagster.Partition` and returns a list of key value pairs that will</span>\n<span class=\"sd\">            be added to the generated run for this partition.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span>\n        <span class=\"bp\">cls</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n        <span class=\"n\">partition_fn</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config_fn_for_partition</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_partition</span><span class=\"p\">:</span> <span class=\"p\">{},</span>\n        <span class=\"n\">tags_fn_for_partition</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_partition</span><span class=\"p\">:</span> <span class=\"p\">{},</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">def</span> <span class=\"nf\">_wrap</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">Partition</span><span class=\"p\">):</span>\n                <span class=\"k\">return</span> <span class=\"n\">x</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n                <span class=\"k\">return</span> <span class=\"n\">Partition</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvalidDefinitionError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Expected &lt;Partition&gt; | &lt;str&gt;, received </span><span class=\"si\">{type}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"o\">=</span><span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">))</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">PartitionSetDefinition</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">check_valid_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_name&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">partition_fn</span><span class=\"o\">=</span><span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n                <span class=\"n\">_wrap</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">x</span> <span class=\"ow\">in</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">partition_fn</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_fn&quot;</span><span class=\"p\">)()</span>\n            <span class=\"p\">],</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_nullable_list_param</span><span class=\"p\">(</span>\n                <span class=\"n\">solid_selection</span><span class=\"p\">,</span> <span class=\"s2\">&quot;solid_selection&quot;</span><span class=\"p\">,</span> <span class=\"n\">of_type</span><span class=\"o\">=</span><span class=\"nb\">str</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">mode</span><span class=\"p\">,</span> <span class=\"s2\">&quot;mode&quot;</span><span class=\"p\">,</span> <span class=\"n\">DEFAULT_MODE_NAME</span><span class=\"p\">),</span>\n            <span class=\"n\">user_defined_run_config_fn_for_partition</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span>\n                <span class=\"n\">run_config_fn_for_partition</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_config_fn_for_partition&quot;</span>\n            <span class=\"p\">),</span>\n            <span class=\"n\">user_defined_tags_fn_for_partition</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span>\n                <span class=\"n\">tags_fn_for_partition</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tags_fn_for_partition&quot;</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">run_config_for_partition</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">partition</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">user_defined_run_config_fn_for_partition</span><span class=\"p\">(</span><span class=\"n\">partition</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">tags_for_partition</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">partition</span><span class=\"p\">):</span>\n        <span class=\"n\">user_tags</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">user_defined_tags_fn_for_partition</span><span class=\"p\">(</span><span class=\"n\">partition</span><span class=\"p\">)</span>\n        <span class=\"n\">check_tags</span><span class=\"p\">(</span><span class=\"n\">user_tags</span><span class=\"p\">,</span> <span class=\"s2\">&quot;user_tags&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">tags</span> <span class=\"o\">=</span> <span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">user_tags</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"o\">.</span><span class=\"n\">tags_for_partition_set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">partition</span><span class=\"p\">))</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">tags</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_partitions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">partition_fn</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_partition</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n        <span class=\"k\">for</span> <span class=\"n\">partition</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_partitions</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">partition</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"n\">name</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">partition</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">failed</span><span class=\"p\">(</span><span class=\"s2\">&quot;Partition name </span><span class=\"si\">{}</span><span class=\"s2\"> not found!&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_partition_names</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">part</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">part</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_partitions</span><span class=\"p\">()]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_schedule_definition</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">schedule_name</span><span class=\"p\">,</span>\n        <span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n        <span class=\"n\">should_execute</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">partition_selector</span><span class=\"o\">=</span><span class=\"n\">last_partition</span><span class=\"p\">,</span>\n        <span class=\"n\">environment_vars</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_timezone</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Create a ScheduleDefinition from a PartitionSetDefinition.</span>\n\n<span class=\"sd\">        Arguments:</span>\n<span class=\"sd\">            schedule_name (str): The name of the schedule.</span>\n<span class=\"sd\">            cron_schedule (str): A valid cron string for the schedule</span>\n<span class=\"sd\">            should_execute (Optional[function]): Function that runs at schedule execution time that</span>\n<span class=\"sd\">            determines whether a schedule should execute. Defaults to a function that always returns</span>\n<span class=\"sd\">            ``True``.</span>\n<span class=\"sd\">            partition_selector (Callable[ScheduleExecutionContext, PartitionSetDefinition],</span>\n<span class=\"sd\">            Partition): A partition selector for the schedule.</span>\n<span class=\"sd\">            environment_vars (Optional[dict]): The environment variables to set for the schedule.</span>\n<span class=\"sd\">            execution_timezone (Optional[str]): Timezone in which the schedule should run. Only works</span>\n<span class=\"sd\">                with DagsterDaemonScheduler, and must be set when using that scheduler.</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            ScheduleDefinition: The generated ScheduleDefinition for the partition selector</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_name&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cron_schedule&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_callable_param</span><span class=\"p\">(</span><span class=\"n\">should_execute</span><span class=\"p\">,</span> <span class=\"s2\">&quot;should_execute&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">environment_vars</span><span class=\"p\">,</span> <span class=\"s2\">&quot;environment_vars&quot;</span><span class=\"p\">,</span> <span class=\"n\">key_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">value_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">partition_selector</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_selector&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">execution_timezone</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_timezone&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">_should_execute_wrapper</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n            <span class=\"n\">selected_partition</span> <span class=\"o\">=</span> <span class=\"n\">partition_selector</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">selected_partition</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">selected_partition</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_partition_names</span><span class=\"p\">():</span>\n                <span class=\"k\">return</span> <span class=\"kc\">False</span>\n            <span class=\"k\">elif</span> <span class=\"ow\">not</span> <span class=\"n\">should_execute</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"kc\">True</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">should_execute</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">_run_config_fn_wrapper</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n            <span class=\"n\">selected_partition</span> <span class=\"o\">=</span> <span class=\"n\">partition_selector</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">selected_partition</span> <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">selected_partition</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_partition_names</span><span class=\"p\">():</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;The partition selection function `</span><span class=\"si\">{selector}</span><span class=\"s2\">` did not return &quot;</span>\n                    <span class=\"s2\">&quot;a partition from PartitionSet </span><span class=\"si\">{partition_set}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">selector</span><span class=\"o\">=</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">partition_selector</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__name__&quot;</span><span class=\"p\">,</span> <span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">partition_selector</span><span class=\"p\">)),</span>\n                        <span class=\"n\">partition_set</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_config_for_partition</span><span class=\"p\">(</span><span class=\"n\">selected_partition</span><span class=\"p\">)</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">_tags_fn_wrapper</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleExecutionContext</span><span class=\"p\">)</span>\n            <span class=\"n\">selected_partition</span> <span class=\"o\">=</span> <span class=\"n\">partition_selector</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">selected_partition</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;The partition selection function `</span><span class=\"si\">{selector}</span><span class=\"s2\">` did not return &quot;</span>\n                    <span class=\"s2\">&quot;a partition from PartitionSet </span><span class=\"si\">{partition_set}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                        <span class=\"n\">selector</span><span class=\"o\">=</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">partition_selector</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__name__&quot;</span><span class=\"p\">,</span> <span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">partition_selector</span><span class=\"p\">)),</span>\n                        <span class=\"n\">partition_set</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">tags_for_partition</span><span class=\"p\">(</span><span class=\"n\">selected_partition</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">PartitionScheduleDefinition</span><span class=\"p\">(</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">schedule_name</span><span class=\"p\">,</span>\n            <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config_fn</span><span class=\"o\">=</span><span class=\"n\">_run_config_fn_wrapper</span><span class=\"p\">,</span>\n            <span class=\"n\">tags_fn</span><span class=\"o\">=</span><span class=\"n\">_tags_fn_wrapper</span><span class=\"p\">,</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"n\">should_execute</span><span class=\"o\">=</span><span class=\"n\">_should_execute_wrapper</span><span class=\"p\">,</span>\n            <span class=\"n\">environment_vars</span><span class=\"o\">=</span><span class=\"n\">environment_vars</span><span class=\"p\">,</span>\n            <span class=\"n\">partition_set</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"p\">,</span>\n            <span class=\"n\">execution_timezone</span><span class=\"o\">=</span><span class=\"n\">execution_timezone</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">PartitionScheduleDefinition</span><span class=\"p\">(</span><span class=\"n\">ScheduleDefinition</span><span class=\"p\">):</span>\n    <span class=\"vm\">__slots__</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;_partition_set&quot;</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">name</span><span class=\"p\">,</span>\n        <span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n        <span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n        <span class=\"n\">tags_fn</span><span class=\"p\">,</span>\n        <span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n        <span class=\"n\">mode</span><span class=\"p\">,</span>\n        <span class=\"n\">should_execute</span><span class=\"p\">,</span>\n        <span class=\"n\">environment_vars</span><span class=\"p\">,</span>\n        <span class=\"n\">partition_set</span><span class=\"p\">,</span>\n        <span class=\"n\">run_config_fn</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">execution_timezone</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">PartitionScheduleDefinition</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span>\n            <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"n\">check_valid_name</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">),</span>\n            <span class=\"n\">cron_schedule</span><span class=\"o\">=</span><span class=\"n\">cron_schedule</span><span class=\"p\">,</span>\n            <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n            <span class=\"n\">run_config_fn</span><span class=\"o\">=</span><span class=\"n\">run_config_fn</span><span class=\"p\">,</span>\n            <span class=\"n\">tags_fn</span><span class=\"o\">=</span><span class=\"n\">tags_fn</span><span class=\"p\">,</span>\n            <span class=\"n\">solid_selection</span><span class=\"o\">=</span><span class=\"n\">solid_selection</span><span class=\"p\">,</span>\n            <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"n\">mode</span><span class=\"p\">,</span>\n            <span class=\"n\">should_execute</span><span class=\"o\">=</span><span class=\"n\">should_execute</span><span class=\"p\">,</span>\n            <span class=\"n\">environment_vars</span><span class=\"o\">=</span><span class=\"n\">environment_vars</span><span class=\"p\">,</span>\n            <span class=\"n\">execution_timezone</span><span class=\"o\">=</span><span class=\"n\">execution_timezone</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_partition_set</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">partition_set</span><span class=\"p\">,</span> <span class=\"s2\">&quot;partition_set&quot;</span><span class=\"p\">,</span> <span class=\"n\">PartitionSetDefinition</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_partition_set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_partition_set</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/definitions/partition", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}