{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.storage.system_storage", "body": "<h1>Source code for dagster.core.storage.system_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.intermediate_storage</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">intermediate_storage</span> <span class=\"k\">as</span> <span class=\"n\">intermediate_storage_fn</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.system_storage</span> <span class=\"kn\">import</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">,</span> <span class=\"n\">system_storage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.type_storage</span> <span class=\"kn\">import</span> <span class=\"n\">TypeStoragePluginRegistry</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.file_manager</span> <span class=\"kn\">import</span> <span class=\"n\">LocalFileManager</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.init</span> <span class=\"kn\">import</span> <span class=\"n\">InitIntermediateStorageContext</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.intermediate_storage</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">ObjectStoreIntermediateStorage</span><span class=\"p\">,</span>\n    <span class=\"n\">build_fs_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">build_in_mem_intermediates_storage</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.object_store</span> <span class=\"kn\">import</span> <span class=\"n\">FilesystemObjectStore</span><span class=\"p\">,</span> <span class=\"n\">InMemoryObjectStore</span><span class=\"p\">,</span> <span class=\"n\">ObjectStore</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">create_mem_system_storage_data</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">(</span>\n        <span class=\"n\">intermediate_storage</span><span class=\"o\">=</span><span class=\"n\">build_in_mem_intermediates_storage</span><span class=\"p\">(</span>\n            <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">file_manager</span><span class=\"o\">=</span><span class=\"n\">LocalFileManager</span><span class=\"o\">.</span><span class=\"n\">for_instance</span><span class=\"p\">(</span>\n            <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">build_intermediate_storage_from_object_store</span><span class=\"p\">(</span>\n    <span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"p\">,</span> <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;constructs an IntermediateStorage object from an object store and an init_context</span>\n<span class=\"sd\">        Call from within an intermediate_storage_definition</span>\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            object_store(ObjectStore): The object store on which to base the intermediate store.</span>\n<span class=\"sd\">            init_context(InitIntermediateStorageContext):  the context from which to create the intermediates manager</span>\n<span class=\"sd\">            root_for_run_id_creator(Callable[[str], str]):</span>\n<span class=\"sd\">                        a function that converts from your run ID to the root of your object storage paths</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n    <span class=\"n\">object_store</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"s2\">&quot;object_store&quot;</span><span class=\"p\">,</span> <span class=\"n\">ObjectStore</span><span class=\"p\">)</span>\n    <span class=\"n\">root_for_run_id</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">root_for_run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;root_for_run_id&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">init_context</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;init_context&quot;</span><span class=\"p\">,</span> <span class=\"n\">InitIntermediateStorageContext</span><span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">ObjectStoreIntermediateStorage</span><span class=\"p\">(</span>\n        <span class=\"n\">object_store</span><span class=\"o\">=</span><span class=\"n\">object_store</span><span class=\"p\">,</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"n\">root_for_run_id</span><span class=\"p\">,</span>\n        <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span>\n        <span class=\"k\">if</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span>\n        <span class=\"k\">else</span> <span class=\"n\">TypeStoragePluginRegistry</span><span class=\"p\">(</span><span class=\"n\">types_to_register</span><span class=\"o\">=</span><span class=\"p\">[]),</span>\n    <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"mem_system_storage\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/execution/#dagster.mem_system_storage\">[docs]</a><span class=\"nd\">@system_storage</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;in_memory&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"nb\">set</span><span class=\"p\">())</span>\n<span class=\"k\">def</span> <span class=\"nf\">mem_system_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;The default in-memory system storage.</span>\n\n<span class=\"sd\">    In most Dagster environments, this will be the default system storage. It is available by</span>\n<span class=\"sd\">    default on any :py:class:`ModeDefinition` that does not provide custom system storages. To</span>\n<span class=\"sd\">    select it explicitly, include the following top-level fragment in config:</span>\n\n<span class=\"sd\">    .. code-block:: yaml</span>\n\n<span class=\"sd\">        storage:</span>\n<span class=\"sd\">          in_memory:</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">create_mem_system_storage_data</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"mem_intermediate_storage\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/execution/#dagster.mem_intermediate_storage\">[docs]</a><span class=\"nd\">@intermediate_storage_fn</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;in_memory&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"nb\">set</span><span class=\"p\">())</span>\n<span class=\"k\">def</span> <span class=\"nf\">mem_intermediate_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;The default in-memory intermediate storage.</span>\n\n<span class=\"sd\">    In-memory intermediate storage is the default on any pipeline run that does</span>\n<span class=\"sd\">    not configure any custom intermediate storage.</span>\n\n<span class=\"sd\">    Keep in mind when using this storage that intermediates will not be persisted after the pipeline</span>\n<span class=\"sd\">    run ends. Use a persistent intermediate storage like :py:func:`fs_intermediate_storage` to</span>\n<span class=\"sd\">    persist intermediates and take advantage of advanced features like pipeline re-execution.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">object_store</span> <span class=\"o\">=</span> <span class=\"n\">InMemoryObjectStore</span><span class=\"p\">()</span>\n    <span class=\"k\">return</span> <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">(</span>\n        <span class=\"n\">object_store</span><span class=\"o\">=</span><span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"o\">=</span><span class=\"n\">init_context</span>\n    <span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"fs_system_storage\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/execution/#dagster.fs_system_storage\">[docs]</a><span class=\"nd\">@system_storage</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;filesystem&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"nb\">set</span><span class=\"p\">(),</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">fs_system_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;The default filesystem system storage.</span>\n\n<span class=\"sd\">    Filesystem system storage is available by default on any :py:class:`ModeDefinition` that does</span>\n<span class=\"sd\">    not provide custom system storages. To select it, include a fragment such as the following in</span>\n<span class=\"sd\">    config:</span>\n\n<span class=\"sd\">    .. code-block:: yaml</span>\n\n<span class=\"sd\">        storage:</span>\n<span class=\"sd\">          filesystem:</span>\n<span class=\"sd\">            base_dir: &#39;/path/to/dir/&#39;</span>\n\n<span class=\"sd\">    You may omit the ``base_dir`` config value, in which case the filesystem storage will use</span>\n<span class=\"sd\">    the :py:class:`DagsterInstance`-provided default.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">override_dir</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">override_dir</span><span class=\"p\">:</span>\n        <span class=\"n\">file_manager</span> <span class=\"o\">=</span> <span class=\"n\">LocalFileManager</span><span class=\"p\">(</span><span class=\"n\">override_dir</span><span class=\"p\">)</span>\n        <span class=\"n\">intermediate_storage</span> <span class=\"o\">=</span> <span class=\"n\">build_fs_intermediate_storage</span><span class=\"p\">(</span>\n            <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"n\">override_dir</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">file_manager</span> <span class=\"o\">=</span> <span class=\"n\">LocalFileManager</span><span class=\"o\">.</span><span class=\"n\">for_instance</span><span class=\"p\">(</span>\n            <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">intermediate_storage</span> <span class=\"o\">=</span> <span class=\"n\">build_fs_intermediate_storage</span><span class=\"p\">(</span>\n            <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">intermediates_directory</span><span class=\"p\">,</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">(</span><span class=\"n\">file_manager</span><span class=\"o\">=</span><span class=\"n\">file_manager</span><span class=\"p\">,</span> <span class=\"n\">intermediate_storage</span><span class=\"o\">=</span><span class=\"n\">intermediate_storage</span><span class=\"p\">,)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"fs_intermediate_storage\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/execution/#dagster.fs_intermediate_storage\">[docs]</a><span class=\"nd\">@intermediate_storage_fn</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;filesystem&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"nb\">set</span><span class=\"p\">(),</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">fs_intermediate_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;The default filesystem intermediate storage.</span>\n\n<span class=\"sd\">    Filesystem system storage is available by default on any :py:class:`ModeDefinition` that does</span>\n<span class=\"sd\">    not provide custom system storages. To select it, include a fragment such as the following in</span>\n<span class=\"sd\">    config:</span>\n\n<span class=\"sd\">    .. code-block:: yaml</span>\n\n<span class=\"sd\">        intermediate_storage:</span>\n<span class=\"sd\">          filesystem:</span>\n<span class=\"sd\">            base_dir: &#39;/path/to/dir/&#39;</span>\n\n<span class=\"sd\">    You may omit the ``base_dir`` config value, in which case the filesystem storage will use</span>\n<span class=\"sd\">    the :py:class:`DagsterInstance`-provided default.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">object_store</span> <span class=\"o\">=</span> <span class=\"n\">FilesystemObjectStore</span><span class=\"p\">()</span>\n    <span class=\"n\">override_dir</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">intermediate_storage_config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">override_dir</span><span class=\"p\">:</span>\n        <span class=\"n\">root_for_run_id</span> <span class=\"o\">=</span> <span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"n\">override_dir</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">root_for_run_id</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">intermediates_directory</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">(</span>\n        <span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"p\">,</span> <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"n\">root_for_run_id</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"n\">default_system_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">mem_system_storage</span><span class=\"p\">,</span> <span class=\"n\">fs_system_storage</span><span class=\"p\">]</span>\n\n<span class=\"sd\">&quot;&quot;&quot;The default &#39;in_memory&#39; and &#39;filesystem&#39; system storage definitions.</span>\n\n<span class=\"sd\">Framework authors seeking to add their own system storage definitions can extend this list as follows:</span>\n\n<span class=\"sd\">.. code-block:: python</span>\n\n<span class=\"sd\">    custom_storage_mode = ModeDefinition(</span>\n<span class=\"sd\">        ...,</span>\n<span class=\"sd\">        system_storage_defs=default_system_storage_defs + [custom_system_storage_def]</span>\n<span class=\"sd\">    )</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n\n<span class=\"n\">default_intermediate_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">mem_intermediate_storage</span><span class=\"p\">,</span> <span class=\"n\">fs_intermediate_storage</span><span class=\"p\">]</span>\n<span class=\"sd\">&quot;&quot;&quot;The default &#39;in_memory&#39; and &#39;filesystem&#39; intermediate storage definitions.</span>\n\n<span class=\"sd\">Framework authors seeking to add their own intermediate storage definitions can extend this list as follows:</span>\n\n<span class=\"sd\">.. code-block:: python</span>\n\n<span class=\"sd\">    custom_storage_mode = ModeDefinition(</span>\n<span class=\"sd\">        ...,</span>\n<span class=\"sd\">        intermediate_storage_defs=default_intermediate_storage_defs + [custom_intermediate_storage_def]</span>\n<span class=\"sd\">    )</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/system_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}