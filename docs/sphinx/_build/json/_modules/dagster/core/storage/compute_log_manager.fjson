{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.storage.compute_log_manager", "body": "<h1>Source code for dagster.core.storage.compute_log_manager</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">atexit</span>\n<span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">ABCMeta</span><span class=\"p\">,</span> <span class=\"n\">abstractmethod</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n<span class=\"kn\">from</span> <span class=\"nn\">enum</span> <span class=\"kn\">import</span> <span class=\"n\">Enum</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span>\n<span class=\"kn\">from</span> <span class=\"nn\">rx</span> <span class=\"kn\">import</span> <span class=\"n\">Observable</span>\n\n<span class=\"n\">MAX_BYTES_FILE_READ</span> <span class=\"o\">=</span> <span class=\"mi\">33554432</span>  <span class=\"c1\"># 32 MB</span>\n<span class=\"n\">MAX_BYTES_CHUNK_READ</span> <span class=\"o\">=</span> <span class=\"mi\">4194304</span>  <span class=\"c1\"># 4 MB</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ComputeIOType</span><span class=\"p\">(</span><span class=\"n\">Enum</span><span class=\"p\">):</span>\n    <span class=\"n\">STDOUT</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;stdout&quot;</span>\n    <span class=\"n\">STDERR</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;stderr&quot;</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ComputeLogFileData</span><span class=\"p\">(</span><span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;ComputeLogFileData&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;path data cursor size download_url&quot;</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Representation of a chunk of compute execution log data&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">size</span><span class=\"p\">,</span> <span class=\"n\">download_url</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">ComputeLogFileData</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">path</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s2\">&quot;path&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;data&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cursor&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">size</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">int_param</span><span class=\"p\">(</span><span class=\"n\">size</span><span class=\"p\">,</span> <span class=\"s2\">&quot;size&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">download_url</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">download_url</span><span class=\"p\">,</span> <span class=\"s2\">&quot;download_url&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"ComputeLogManager\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/internals/#dagster.core.storage.compute_log_manager.ComputeLogManager\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">ComputeLogManager</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Abstract base class for storing unstructured compute logs (stdout/stderr) from the compute</span>\n<span class=\"sd\">    steps of pipeline solids.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Watch the stdout/stderr for a given execution for a given run_id / step_key and persist it.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            pipeline_run (PipelineRun): The pipeline run config</span>\n<span class=\"sd\">            step_key (Optional[String]): The step_key for a compute step</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">step_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;step_key&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">enabled</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">):</span>\n            <span class=\"k\">yield</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">on_watch_start</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watch_logs</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">):</span>\n            <span class=\"k\">yield</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">on_watch_finish</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_watch_logs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Method to watch the stdout/stderr logs for a given run_id / step_key.  Kept separate from</span>\n<span class=\"sd\">        blessed `watch` method, which triggers all the start/finish hooks that are necessary to</span>\n<span class=\"sd\">        implement the different remote implementations.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            pipeline_run (PipelineRun): The pipeline run config</span>\n<span class=\"sd\">            step_key (Optional[String]): The step_key for a compute step</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_local_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get the local path of the logfile for a given execution step.  This determines the</span>\n<span class=\"sd\">        location on the local filesystem to which stdout/stderr will be rerouted.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the pipeline run.</span>\n<span class=\"sd\">            key (str): The unique descriptor of the execution step (e.g. `solid_invocation.compute`)</span>\n<span class=\"sd\">            io_type (ComputeIOType): Flag indicating the I/O type, either ComputeIOType.STDOUT or</span>\n<span class=\"sd\">                ComputeIOType.STDERR</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            str</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_watch_completed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Flag indicating when computation for a given execution step has completed.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the pipeline run.</span>\n<span class=\"sd\">            key (str): The unique descriptor of the execution step (e.g. `solid_invocation.compute`)</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Boolean</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">on_watch_start</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Hook called when starting to watch compute logs.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            pipeline_run (PipelineRun): The pipeline run config</span>\n<span class=\"sd\">            step_key (Optional[String]): The step_key for a compute step</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">on_watch_finish</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">step_key</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Hook called when computation for a given execution step is finished.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            pipeline_run (PipelineRun): The pipeline run config</span>\n<span class=\"sd\">            step_key (Optional[String]): The step_key for a compute step</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">download_url</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get a URL where the logs can be downloaded.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the pipeline run.</span>\n<span class=\"sd\">            key (str): The unique descriptor of the execution step (e.g. `solid_invocation.compute`)</span>\n<span class=\"sd\">            io_type (ComputeIOType): Flag indicating the I/O type, either stdout or stderr</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            String</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">read_logs_file</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">max_bytes</span><span class=\"o\">=</span><span class=\"n\">MAX_BYTES_FILE_READ</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get compute log data for a given compute step.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the pipeline run.</span>\n<span class=\"sd\">            key (str): The unique descriptor of the execution step (e.g. `solid_invocation.compute`)</span>\n<span class=\"sd\">            io_type (ComputeIOType): Flag indicating the I/O type, either stdout or stderr</span>\n<span class=\"sd\">            cursor (Optional[Int]): Starting cursor (byte) of log file</span>\n<span class=\"sd\">            max_bytes (Optional[Int]): Maximum number of bytes to be read and returned</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            ComputeLogFileData</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">enabled</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">_pipeline_run</span><span class=\"p\">,</span> <span class=\"n\">_step_key</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Hook for disabling compute log capture.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            _step_key (Optional[String]): The step_key for a compute step</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Boolean</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">on_subscribe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">subscription</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Hook for managing streaming subscriptions for log data from `dagit`</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            subscription (ComputeLogSubscription): subscription object which manages when to send</span>\n<span class=\"sd\">                back data to the subscriber</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">observable</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return an Observable which streams back log data from the execution logs for a given</span>\n<span class=\"sd\">        compute step.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the pipeline run.</span>\n<span class=\"sd\">            key (str): The unique descriptor of the execution step (e.g. `solid_invocation.compute`)</span>\n<span class=\"sd\">            io_type (ComputeIOType): Flag indicating the I/O type, either stdout or stderr</span>\n<span class=\"sd\">            cursor (Optional[Int]): Starting cursor (byte) of log file</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Observable</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;key&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"s2\">&quot;io_type&quot;</span><span class=\"p\">,</span> <span class=\"n\">ComputeIOType</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cursor&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n            <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n\n        <span class=\"n\">subscription</span> <span class=\"o\">=</span> <span class=\"n\">ComputeLogSubscription</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">on_subscribe</span><span class=\"p\">(</span><span class=\"n\">subscription</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">Observable</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">subscription</span><span class=\"p\">)</span>  <span class=\"c1\"># pylint: disable=E1101</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">dispose</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ComputeLogSubscription</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Observable object that generates ComputeLogFileData objects as compute step execution logs</span>\n<span class=\"sd\">    are written</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">manager</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"n\">manager</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">=</span> <span class=\"n\">run_id</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"o\">=</span> <span class=\"n\">key</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">io_type</span> <span class=\"o\">=</span> <span class=\"n\">io_type</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">cursor</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"n\">atexit</span><span class=\"o\">.</span><span class=\"n\">register</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_clean</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">observer</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span> <span class=\"o\">=</span> <span class=\"n\">observer</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetch</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">is_watch_completed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key</span><span class=\"p\">):</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">complete</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">fetch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">should_fetch</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">while</span> <span class=\"n\">should_fetch</span><span class=\"p\">:</span>\n            <span class=\"n\">update</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">read_logs_file</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">io_type</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">max_bytes</span><span class=\"o\">=</span><span class=\"n\">MAX_BYTES_CHUNK_READ</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cursor</span> <span class=\"ow\">or</span> <span class=\"n\">update</span><span class=\"o\">.</span><span class=\"n\">cursor</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span><span class=\"o\">.</span><span class=\"n\">on_next</span><span class=\"p\">(</span><span class=\"n\">update</span><span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">update</span><span class=\"o\">.</span><span class=\"n\">cursor</span>\n            <span class=\"n\">should_fetch</span> <span class=\"o\">=</span> <span class=\"n\">update</span><span class=\"o\">.</span><span class=\"n\">data</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">update</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">))</span> <span class=\"o\">&gt;=</span> <span class=\"n\">MAX_BYTES_CHUNK_READ</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">complete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span><span class=\"o\">.</span><span class=\"n\">on_completed</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_clean</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">complete</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">observer</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/compute_log_manager", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}