{"parents": [{"link": "../../../../../", "title": "Module code"}], "title": "dagster.core.storage.schedules.sql_schedule_storage", "body": "<h1>Source code for dagster.core.storage.schedules.sql_schedule_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">abstractmethod</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInvariantViolationError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.scheduler</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleState</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTick</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.scheduler.scheduler</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">ScheduleTickData</span><span class=\"p\">,</span>\n    <span class=\"n\">ScheduleTickStatsSnapshot</span><span class=\"p\">,</span>\n    <span class=\"n\">ScheduleTickStatus</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">,</span> <span class=\"n\">serialize_dagster_namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">utc_datetime_from_timestamp</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.base</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleStorage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.schema</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleTable</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickTable</span>\n\n\n<div class=\"viewcode-block\" id=\"SqlScheduleStorage\"><a class=\"viewcode-back\" href=\"../../../../../../sections/api/apidocs/internals/#dagster.core.storage.schedules.SqlScheduleStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SqlScheduleStorage</span><span class=\"p\">(</span><span class=\"n\">ScheduleStorage</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Base class for SQL backed schedule storage</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Context manager yielding a sqlalchemy.engine.Connection.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">execute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">result_proxy</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n            <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">res</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_deserialize_rows</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"k\">lambda</span> <span class=\"n\">r</span><span class=\"p\">:</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]),</span> <span class=\"n\">rows</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">all_stored_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">repository_origin_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">base_query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span>\n            <span class=\"p\">[</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_body</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">]</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">repository_origin_id</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">base_query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">repository_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">repository_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">base_query</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deserialize_rows</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_body</span><span class=\"p\">])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">])</span> <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_latest_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">tick_body</span><span class=\"p\">])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">timestamp</span><span class=\"o\">.</span><span class=\"n\">desc</span><span class=\"p\">())</span>\n            <span class=\"o\">.</span><span class=\"n\">limit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">ScheduleTick</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">]))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_schedule_ticks</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">tick_body</span><span class=\"p\">])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"o\">.</span><span class=\"n\">desc</span><span class=\"p\">())</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span>\n            <span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"k\">lambda</span> <span class=\"n\">r</span><span class=\"p\">:</span> <span class=\"n\">ScheduleTick</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">])),</span> <span class=\"n\">rows</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_schedule_tick_stats</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">func</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">group_by</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n        <span class=\"n\">counts</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">status</span><span class=\"p\">,</span> <span class=\"n\">count</span> <span class=\"ow\">in</span> <span class=\"n\">rows</span><span class=\"p\">:</span>\n            <span class=\"n\">counts</span><span class=\"p\">[</span><span class=\"n\">status</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">count</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">ScheduleTickStatsSnapshot</span><span class=\"p\">(</span>\n            <span class=\"n\">ticks_started</span><span class=\"o\">=</span><span class=\"n\">counts</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">STARTED</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_succeeded</span><span class=\"o\">=</span><span class=\"n\">counts</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">SUCCESS</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_skipped</span><span class=\"o\">=</span><span class=\"n\">counts</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">SKIPPED</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span>\n            <span class=\"n\">ticks_failed</span><span class=\"o\">=</span><span class=\"n\">counts</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickStatus</span><span class=\"o\">.</span><span class=\"n\">FAILURE</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_schedule_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_tick_data</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">schedule_tick_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_tick_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTickData</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">tick_insert</span> <span class=\"o\">=</span> <span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"n\">schedule_origin_id</span><span class=\"o\">=</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">timestamp</span><span class=\"o\">=</span><span class=\"n\">utc_datetime_from_timestamp</span><span class=\"p\">(</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">timestamp</span><span class=\"p\">),</span>\n                    <span class=\"n\">tick_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">schedule_tick_data</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">tick_insert</span><span class=\"p\">)</span>\n                <span class=\"n\">tick_id</span> <span class=\"o\">=</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">inserted_primary_key</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n                <span class=\"k\">return</span> <span class=\"n\">ScheduleTick</span><span class=\"p\">(</span><span class=\"n\">tick_id</span><span class=\"p\">,</span> <span class=\"n\">schedule_tick_data</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">exc</span><span class=\"o\">.</span><span class=\"n\">IntegrityError</span> <span class=\"k\">as</span> <span class=\"n\">exc</span><span class=\"p\">:</span>\n                <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">raise_from</span><span class=\"p\">(</span>\n                    <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;Unable to insert ScheduleTick for schedule </span><span class=\"si\">{schedule_name}</span><span class=\"s2\"> in storage&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                            <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">schedule_tick_data</span><span class=\"o\">.</span><span class=\"n\">schedule_name</span><span class=\"p\">,</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">),</span>\n                    <span class=\"n\">exc</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update_schedule_tick</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">tick</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">tick</span><span class=\"p\">,</span> <span class=\"s2\">&quot;tick&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleTick</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span> <span class=\"o\">==</span> <span class=\"n\">tick</span><span class=\"o\">.</span><span class=\"n\">tick_id</span><span class=\"p\">)</span>\n                <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">tick</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">tick_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">tick</span><span class=\"o\">.</span><span class=\"n\">schedule_tick_data</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">tick</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleState</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">schedule_insert</span> <span class=\"o\">=</span> <span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"n\">schedule_origin_id</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">repository_origin_id</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">repository_origin_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">schedule_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">schedule</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">schedule_insert</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">exc</span><span class=\"o\">.</span><span class=\"n\">IntegrityError</span> <span class=\"k\">as</span> <span class=\"n\">exc</span><span class=\"p\">:</span>\n                <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">raise_from</span><span class=\"p\">(</span>\n                    <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;ScheduleState </span><span class=\"si\">{id}</span><span class=\"s2\"> is already present &quot;</span>\n                        <span class=\"s2\">&quot;in storage&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,)</span>\n                    <span class=\"p\">),</span>\n                    <span class=\"n\">exc</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">schedule</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule&quot;</span><span class=\"p\">,</span> <span class=\"n\">ScheduleState</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;ScheduleState </span><span class=\"si\">{id}</span><span class=\"s2\"> is not present in storage&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n                <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">schedule_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">schedule</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_schedule_state</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterInvariantViolationError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;ScheduleState </span><span class=\"si\">{id}</span><span class=\"s2\"> is not present in storage&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"nb\">id</span><span class=\"o\">=</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">schedule_origin_id</span> <span class=\"o\">==</span> <span class=\"n\">schedule_origin_id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Clears the schedule storage.&quot;&quot;&quot;</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"c1\"># https://stackoverflow.com/a/54386260/324449</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">ScheduleTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">ScheduleTickTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/schedules/sql_schedule_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}