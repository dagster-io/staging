{"parents": [{"link": "../../../../", "title": "Module code"}], "title": "dagster.core.storage.asset_store", "body": "<h1>Source code for dagster.core.storage.asset_store</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">import</span> <span class=\"nn\">pickle</span>\n<span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">ABCMeta</span><span class=\"p\">,</span> <span class=\"n\">abstractmethod</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.config.source</span> <span class=\"kn\">import</span> <span class=\"n\">StringSource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.events</span> <span class=\"kn\">import</span> <span class=\"n\">AssetKey</span><span class=\"p\">,</span> <span class=\"n\">EventMetadataEntry</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.definitions.resource</span> <span class=\"kn\">import</span> <span class=\"n\">resource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">AssetMaterialization</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.context.system</span> <span class=\"kn\">import</span> <span class=\"n\">AssetStoreContext</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">whitelist_for_serdes</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">PICKLE_PROTOCOL</span><span class=\"p\">,</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils.backcompat</span> <span class=\"kn\">import</span> <span class=\"n\">experimental</span>\n\n\n<span class=\"nd\">@whitelist_for_serdes</span>\n<span class=\"k\">class</span> <span class=\"nc\">AssetStoreHandle</span><span class=\"p\">(</span><span class=\"n\">namedtuple</span><span class=\"p\">(</span><span class=\"s2\">&quot;_AssetStoreHandle&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_store_key asset_metadata&quot;</span><span class=\"p\">)):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__new__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">asset_store_key</span><span class=\"p\">,</span> <span class=\"n\">asset_metadata</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">AssetStoreHandle</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__new__</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"p\">,</span>\n            <span class=\"n\">asset_store_key</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">asset_store_key</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_store_key&quot;</span><span class=\"p\">),</span>\n            <span class=\"n\">asset_metadata</span><span class=\"o\">=</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_dict_param</span><span class=\"p\">(</span><span class=\"n\">asset_metadata</span><span class=\"p\">,</span> <span class=\"s2\">&quot;asset_metadata&quot;</span><span class=\"p\">,</span> <span class=\"n\">key_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"AssetStore\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.AssetStore\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">AssetStore</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Base class for user-provided asset store.</span>\n\n<span class=\"sd\">    Extend this class to handle asset operations. Users should implement ``set_asset`` to store a</span>\n<span class=\"sd\">    data object that can be tracked by the Dagster machinery and ``get_asset`` to retrieve a data</span>\n<span class=\"sd\">    object.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n<div class=\"viewcode-block\" id=\"AssetStore.set_asset\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.AssetStore.set_asset\">[docs]</a>    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">set_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;The user-definied write method that stores a data object.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            context (AssetStoreContext): The context of the step output that produces this asset.</span>\n<span class=\"sd\">            obj (Any): The data object to be stored.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span></div>\n\n<div class=\"viewcode-block\" id=\"AssetStore.get_asset\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.AssetStore.get_asset\">[docs]</a>    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;The user-defined read method that loads data given its metadata.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            context (AssetStoreContext): The context of the step output that produces this asset.</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Any: The data object.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span></div></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">InMemoryAssetStore</span><span class=\"p\">(</span><span class=\"n\">AssetStore</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">values</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">set_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"n\">keys</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">get_run_scoped_output_identifier</span><span class=\"p\">())</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">keys</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"n\">keys</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">get_run_scoped_output_identifier</span><span class=\"p\">())</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">keys</span><span class=\"p\">]</span>\n\n\n<div class=\"viewcode-block\" id=\"mem_asset_store\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.mem_asset_store\">[docs]</a><span class=\"nd\">@resource</span>\n<span class=\"k\">def</span> <span class=\"nf\">mem_asset_store</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">InMemoryAssetStore</span><span class=\"p\">()</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">PickledObjectFilesystemAssetStore</span><span class=\"p\">(</span><span class=\"n\">AssetStore</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Built-in filesystem asset store that stores and retrieves values using pickling.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        base_dir (Optional[str]): base directory where all the step outputs which use this asset</span>\n<span class=\"sd\">            store will be stored in.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">base_dir</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_dir</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">write_mode</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;wb&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">read_mode</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;rb&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Automatically construct filepath.&quot;&quot;&quot;</span>\n        <span class=\"n\">keys</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">get_run_scoped_output_identifier</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">keys</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">set_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Pickle the data and store the object to a file.</span>\n\n<span class=\"sd\">        This method omits the AssetMaterialization event so assets generated by it won&#39;t be tracked</span>\n<span class=\"sd\">        by the Asset Catalog.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">AssetStoreContext</span><span class=\"p\">)</span>\n\n        <span class=\"n\">filepath</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_path</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Ensure path exists</span>\n        <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">))</span>\n\n        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">write_mode</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">write_obj</span><span class=\"p\">:</span>\n            <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">write_obj</span><span class=\"p\">,</span> <span class=\"n\">PICKLE_PROTOCOL</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Unpickle the file and Load it to a data object.&quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">AssetStoreContext</span><span class=\"p\">)</span>\n\n        <span class=\"n\">filepath</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_path</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">read_mode</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">read_obj</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">read_obj</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"fs_asset_store\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.fs_asset_store\">[docs]</a><span class=\"nd\">@resource</span><span class=\"p\">(</span><span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;.&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)})</span>\n<span class=\"nd\">@experimental</span>\n<span class=\"k\">def</span> <span class=\"nf\">fs_asset_store</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Built-in filesystem asset store that stores and retrieves values using pickling.</span>\n\n<span class=\"sd\">    It allows users to specify a base directory where all the step output will be stored in. It</span>\n<span class=\"sd\">    serializes and deserializes output values (assets) using pickling and automatically constructs</span>\n<span class=\"sd\">    the filepaths for the assets.</span>\n\n<span class=\"sd\">    Example usage:</span>\n\n<span class=\"sd\">    1. Specify a pipeline-level asset store using the reserved resource key ``&quot;asset_store&quot;``,</span>\n<span class=\"sd\">    which will set the given asset store on all solids across a pipeline.</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        @solid</span>\n<span class=\"sd\">        def solid_a(context, df):</span>\n<span class=\"sd\">            return df</span>\n\n<span class=\"sd\">        @solid</span>\n<span class=\"sd\">        def solid_b(context, df):</span>\n<span class=\"sd\">            return df[:5]</span>\n\n<span class=\"sd\">        @pipeline(mode_defs=[ModeDefinition(resource_defs={&quot;asset_store&quot;: fs_asset_store})])</span>\n<span class=\"sd\">        def pipe():</span>\n<span class=\"sd\">            solid_b(solid_a())</span>\n\n\n<span class=\"sd\">    2. Specify asset store on :py:class:`OutputDefinition`, which allows the user to set different</span>\n<span class=\"sd\">    asset stores on different step outputs.</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        @solid(output_defs=[OutputDefinition(asset_store_key=&quot;my_asset_store&quot;)])</span>\n<span class=\"sd\">        def solid_a(context, df):</span>\n<span class=\"sd\">            return df</span>\n\n<span class=\"sd\">        @solid</span>\n<span class=\"sd\">        def solid_b(context, df):</span>\n<span class=\"sd\">            return df[:5]</span>\n\n<span class=\"sd\">        @pipeline(</span>\n<span class=\"sd\">            mode_defs=[ModeDefinition(resource_defs={&quot;my_asset_store&quot;: fs_asset_store})]</span>\n<span class=\"sd\">        )</span>\n<span class=\"sd\">        def pipe():</span>\n<span class=\"sd\">            solid_b(solid_a())</span>\n\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">PickledObjectFilesystemAssetStore</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">])</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">CustomPathPickledObjectFilesystemAssetStore</span><span class=\"p\">(</span><span class=\"n\">AssetStore</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Built-in filesystem asset store that stores and retrieves values using pickling and</span>\n<span class=\"sd\">    allow users to specify file path for outputs.</span>\n\n<span class=\"sd\">    Args:</span>\n<span class=\"sd\">        base_dir (Optional[str]): base directory where all the step outputs which use this asset</span>\n<span class=\"sd\">            store will be stored in.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">base_dir</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_dir</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">write_mode</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;wb&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">read_mode</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;rb&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">set_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Pickle the data and store the object to a custom file path.</span>\n\n<span class=\"sd\">        This method emits an AssetMaterialization event so the assets will be tracked by the</span>\n<span class=\"sd\">        Asset Catalog.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"s2\">&quot;context&quot;</span><span class=\"p\">,</span> <span class=\"n\">AssetStoreContext</span><span class=\"p\">)</span>\n        <span class=\"n\">asset_metadata</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">asset_metadata</span>\n        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">asset_metadata</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;path&quot;</span><span class=\"p\">),</span> <span class=\"s2\">&quot;asset_metadata.path&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">filepath</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_path</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Ensure path exists</span>\n        <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">))</span>\n\n        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">write_mode</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">write_obj</span><span class=\"p\">:</span>\n            <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">dump</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">write_obj</span><span class=\"p\">,</span> <span class=\"n\">PICKLE_PROTOCOL</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">AssetMaterialization</span><span class=\"p\">(</span>\n            <span class=\"n\">asset_key</span><span class=\"o\">=</span><span class=\"n\">AssetKey</span><span class=\"p\">([</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">step_key</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">output_name</span><span class=\"p\">]),</span>\n            <span class=\"n\">metadata_entries</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">EventMetadataEntry</span><span class=\"o\">.</span><span class=\"n\">fspath</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">abspath</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">))],</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Unpickle the file from a given file path and Load it to a data object.&quot;&quot;&quot;</span>\n        <span class=\"n\">asset_metadata</span> <span class=\"o\">=</span> <span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">asset_metadata</span>\n        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">asset_metadata</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;path&quot;</span><span class=\"p\">),</span> <span class=\"s2\">&quot;asset_metadata.path&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">filepath</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_path</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"n\">filepath</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">read_mode</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">read_obj</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">pickle</span><span class=\"o\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">read_obj</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"custom_path_fs_asset_store\"><a class=\"viewcode-back\" href=\"../../../../../sections/api/apidocs/assets/#dagster.custom_path_fs_asset_store\">[docs]</a><span class=\"nd\">@resource</span><span class=\"p\">(</span><span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;.&quot;</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)})</span>\n<span class=\"nd\">@experimental</span>\n<span class=\"k\">def</span> <span class=\"nf\">custom_path_fs_asset_store</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Built-in asset store that allows users to custom output file path per output definition.</span>\n\n<span class=\"sd\">    It also allows users to specify a base directory where all the step output will be stored in. It</span>\n<span class=\"sd\">    serializes and deserializes output values (assets) using pickling and stores the pickled object</span>\n<span class=\"sd\">    in the user-provided file paths.</span>\n\n<span class=\"sd\">    Example usage:</span>\n\n<span class=\"sd\">    .. code-block:: python</span>\n\n<span class=\"sd\">        @solid(</span>\n<span class=\"sd\">            output_defs=[</span>\n<span class=\"sd\">                OutputDefinition(</span>\n<span class=\"sd\">                    asset_store_key=&quot;asset_store&quot;, asset_metadata={&quot;path&quot;: &quot;path/to/sample_output&quot;}</span>\n<span class=\"sd\">                )</span>\n<span class=\"sd\">            ]</span>\n<span class=\"sd\">        )</span>\n<span class=\"sd\">        def sample_data(context, df):</span>\n<span class=\"sd\">            return df[:5]</span>\n\n<span class=\"sd\">        @pipeline(</span>\n<span class=\"sd\">            mode_defs=[</span>\n<span class=\"sd\">                ModeDefinition(resource_defs={&quot;asset_store&quot;: custom_path_fs_asset_store}),</span>\n<span class=\"sd\">            ],</span>\n<span class=\"sd\">        )</span>\n<span class=\"sd\">        def pipe():</span>\n<span class=\"sd\">            sample_data()</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">CustomPathPickledObjectFilesystemAssetStore</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">])</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/asset_store", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}