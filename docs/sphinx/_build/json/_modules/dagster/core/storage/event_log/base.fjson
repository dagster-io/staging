{"parents": [{"link": "../../../../../", "title": "Module code"}], "title": "dagster.core.storage.event_log.base", "body": "<h1>Source code for dagster.core.storage.event_log.base</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">ABCMeta</span><span class=\"p\">,</span> <span class=\"n\">abstractmethod</span><span class=\"p\">,</span> <span class=\"n\">abstractproperty</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">pyrsistent</span>\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events.log</span> <span class=\"kn\">import</span> <span class=\"n\">EventRecord</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.execution.stats</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">build_run_stats_from_events</span><span class=\"p\">,</span>\n    <span class=\"n\">build_run_step_stats_from_events</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">EventLogSequence</span><span class=\"p\">(</span><span class=\"n\">pyrsistent</span><span class=\"o\">.</span><span class=\"n\">CheckedPVector</span><span class=\"p\">):</span>\n    <span class=\"n\">__type__</span> <span class=\"o\">=</span> <span class=\"n\">EventRecord</span>\n\n\n<div class=\"viewcode-block\" id=\"EventLogStorage\"><a class=\"viewcode-back\" href=\"../../../../../../sections/api/apidocs/internals/#dagster.core.storage.event_log.EventLogStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">EventLogStorage</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Abstract base class for storing structured event logs from pipeline runs.</span>\n\n<span class=\"sd\">    Note that event log storages using SQL databases as backing stores should implement</span>\n<span class=\"sd\">    :py:class:`~dagster.core.storage.event_log.SqlEventLogStorage`.</span>\n\n<span class=\"sd\">    Users should not directly instantiate concrete subclasses of this class; they are instantiated</span>\n<span class=\"sd\">    by internal machinery when ``dagit`` and ``dagster-graphql`` load, based on the values in the</span>\n<span class=\"sd\">    ``dagster.yaml`` file in ``$DAGSTER_HOME``. Configuration of concrete subclasses of this class</span>\n<span class=\"sd\">    should be done by setting values in that file.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=-</span><span class=\"mi\">1</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get all of the logs corresponding to a run.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the run for which to fetch logs.</span>\n<span class=\"sd\">            cursor (Optional[int]): Zero-indexed logs will be returned starting from cursor + 1,</span>\n<span class=\"sd\">                i.e., if cursor is -1, all logs will be returned. (default: -1)</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_stats_for_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get a summary of events that have ocurred in a run.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">build_run_stats_from_events</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_step_stats_for_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">step_keys</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get per-step stats for a pipeline run.&quot;&quot;&quot;</span>\n        <span class=\"n\">logs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">step_keys</span><span class=\"p\">:</span>\n            <span class=\"n\">logs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"n\">event</span>\n                <span class=\"k\">for</span> <span class=\"n\">event</span> <span class=\"ow\">in</span> <span class=\"n\">logs</span>\n                <span class=\"k\">if</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">is_dagster_event</span> <span class=\"ow\">and</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">dagster_event</span><span class=\"o\">.</span><span class=\"n\">step_key</span> <span class=\"ow\">in</span> <span class=\"n\">step_keys</span>\n            <span class=\"p\">]</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">build_run_step_stats_from_events</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">logs</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">store_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Store an event corresponding to a pipeline run.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the run that generated the event.</span>\n<span class=\"sd\">            event (EventRecord): The event to store.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">delete_events</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Remove events for a given run id&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;This method should perform any schema migrations necessary to bring an</span>\n<span class=\"sd\">        out-of-date instance of the storage up to date.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">reindex</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">print_fn</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">_</span><span class=\"p\">:</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">force</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Call this method to run any data migrations, reindexing to build summary tables.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Clear the log storage.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Call this method to start watching.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">end_watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">handler</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Call this method to stop watching.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">has_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Whether the secondary index for a given name is enabled.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">enable_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Call to enable the secondary index for a given name.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractproperty</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_persistent</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;bool: Whether the storage is persistent.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">dispose</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Explicit lifecycle management.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">is_asset_aware</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">AssetAwareEventLogStorage</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_addresses_for_step_output_versions</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">step_output_versions</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        For each given step output, finds whether an output exists with the given</span>\n<span class=\"sd\">        version, and returns its address if it does.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            step_output_versions (Dict[(str, StepOutputHandle), str]):</span>\n<span class=\"sd\">                (pipeline name, step output handle) -&gt; version.</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Dict[(str, StepOutputHandle), str]: (pipeline name, step output handle) -&gt; address.</span>\n<span class=\"sd\">                For each step output, an address if there is one and None otherwise.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">optimize_for_dagit</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">statement_timeout</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Allows for optimizing database connection / use in the context of a long lived dagit process&quot;&quot;&quot;</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">AssetAwareEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">with_metaclass</span><span class=\"p\">(</span><span class=\"n\">ABCMeta</span><span class=\"p\">)):</span>\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">has_asset_key</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_all_asset_keys</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">prefix_path</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset_events</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_asset_run_ids</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">wipe_asset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">asset_key</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Remove asset index history from event log for given asset_key&quot;&quot;&quot;</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/event_log/base", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}