{"parents": [{"link": "../../../../../../", "title": "Module code"}], "title": "dagster.core.storage.event_log.sqlite.sqlite_event_log", "body": "<h1>Source code for dagster.core.storage.event_log.sqlite.sqlite_event_log</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">glob</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sqlite3</span>\n<span class=\"kn\">import</span> <span class=\"nn\">threading</span>\n<span class=\"kn\">import</span> <span class=\"nn\">time</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">defaultdict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRunStatus</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sql</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">check_alembic_revision</span><span class=\"p\">,</span>\n    <span class=\"n\">create_engine</span><span class=\"p\">,</span>\n    <span class=\"n\">get_alembic_config</span><span class=\"p\">,</span>\n    <span class=\"n\">handle_schema_errors</span><span class=\"p\">,</span>\n    <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">,</span>\n    <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sqlite</span> <span class=\"kn\">import</span> <span class=\"n\">create_db_conn_string</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">sqlalchemy.pool</span> <span class=\"kn\">import</span> <span class=\"n\">NullPool</span>\n<span class=\"kn\">from</span> <span class=\"nn\">tqdm</span> <span class=\"kn\">import</span> <span class=\"n\">tqdm</span>\n<span class=\"kn\">from</span> <span class=\"nn\">watchdog.events</span> <span class=\"kn\">import</span> <span class=\"n\">PatternMatchingEventHandler</span>\n<span class=\"kn\">from</span> <span class=\"nn\">watchdog.observers</span> <span class=\"kn\">import</span> <span class=\"n\">Observer</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..schema</span> <span class=\"kn\">import</span> <span class=\"n\">SqlEventLogStorageMetadata</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..sql_event_log</span> <span class=\"kn\">import</span> <span class=\"n\">SqlEventLogStorage</span>\n\n\n<div class=\"viewcode-block\" id=\"SqliteEventLogStorage\"><a class=\"viewcode-back\" href=\"../../../../../../../sections/api/apidocs/internals/#dagster.core.storage.event_log.SqliteEventLogStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SqliteEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">SqlEventLogStorage</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;SQLite-backed event log storage.</span>\n\n<span class=\"sd\">    Users should not directly instantiate this class; it is instantiated by internal machinery when</span>\n<span class=\"sd\">    ``dagit`` and ``dagster-graphql`` load, based on the values in the ``dagster.yaml`` file in</span>\n<span class=\"sd\">    ``$DAGSTER_HOME``. Configuration of this class should be done by setting values in that file.</span>\n\n<span class=\"sd\">    This is the default event log storage when none is specified in the ``dagster.yaml``.</span>\n\n<span class=\"sd\">    To explicitly specify SQLite for event log storage, you can add a block such as the following</span>\n<span class=\"sd\">    to your ``dagster.yaml``:</span>\n\n<span class=\"sd\">    .. code-block:: YAML</span>\n\n<span class=\"sd\">        event_log_storage:</span>\n<span class=\"sd\">          module: dagster.core.storage.event_log</span>\n<span class=\"sd\">          class: SqliteEventLogStorage</span>\n<span class=\"sd\">          config:</span>\n<span class=\"sd\">            base_dir: /path/to/dir</span>\n\n<span class=\"sd\">    The ``base_dir`` param tells the event log storage where on disk to store the databases. To</span>\n<span class=\"sd\">    improve concurrent performance, event logs are stored in a separate SQLite database for each</span>\n<span class=\"sd\">    run.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Note that idempotent initialization of the SQLite database is done on a per-run_id</span>\n<span class=\"sd\">        basis in the body of connect, since each run is stored in a separate database.&quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">abspath</span><span class=\"p\">(</span><span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">))</span>\n        <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watchers</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span><span class=\"p\">(</span><span class=\"nb\">dict</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_obs</span> <span class=\"o\">=</span> <span class=\"n\">Observer</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_obs</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Used to ensure that each run ID attempts to initialize its DB the first time it connects,</span>\n        <span class=\"c1\"># ensuring that the database will be created if it doesn&#39;t exist</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initialized_dbs</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Ensure that multiple threads (like the event log watcher) interact safely with each other</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db_lock</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Lock</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">all_run_ids</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_all_run_ids</span><span class=\"p\">()</span>\n        <span class=\"nb\">print</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=print-call</span>\n            <span class=\"s2\">&quot;Updating event log storage for </span><span class=\"si\">{n_runs}</span><span class=\"s2\"> runs on disk...&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                <span class=\"n\">n_runs</span><span class=\"o\">=</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">all_run_ids</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"n\">tqdm</span><span class=\"p\">(</span><span class=\"n\">all_run_ids</span><span class=\"p\">):</span>\n            <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n                <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initialized_dbs</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">StringSource</span><span class=\"p\">}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">SqliteEventLogStorage</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_all_run_ids</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">all_filenames</span> <span class=\"o\">=</span> <span class=\"n\">glob</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;*.db&quot;</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">splitext</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">basename</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">))[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"n\">all_filenames</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">path_for_run_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"si\">{run_id}</span><span class=\"s2\">.db&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">conn_string_for_run_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">create_db_conn_string</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_initdb</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">engine</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n\n        <span class=\"n\">retry_limit</span> <span class=\"o\">=</span> <span class=\"mi\">10</span>\n\n        <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">SqlEventLogStorageMetadata</span><span class=\"o\">.</span><span class=\"n\">create_all</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">)</span>\n                <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s2\">&quot;PRAGMA journal_mode=WAL;&quot;</span><span class=\"p\">)</span>\n\n                <span class=\"k\">with</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">connection</span><span class=\"p\">:</span>\n                    <span class=\"n\">db_revision</span><span class=\"p\">,</span> <span class=\"n\">head_revision</span> <span class=\"o\">=</span> <span class=\"n\">check_alembic_revision</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">)</span>\n\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">db_revision</span> <span class=\"ow\">and</span> <span class=\"n\">head_revision</span><span class=\"p\">):</span>\n                    <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">engine</span><span class=\"p\">)</span>\n\n                <span class=\"k\">break</span>\n            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">exc</span><span class=\"o\">.</span><span class=\"n\">DatabaseError</span><span class=\"p\">,</span> <span class=\"n\">sqlite3</span><span class=\"o\">.</span><span class=\"n\">DatabaseError</span><span class=\"p\">,</span> <span class=\"n\">sqlite3</span><span class=\"o\">.</span><span class=\"n\">OperationalError</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">exc</span><span class=\"p\">:</span>\n                <span class=\"c1\"># This is SQLite-specific handling for concurrency issues that can arise when</span>\n                <span class=\"c1\"># multiple processes (e.g. the dagit process and user code process) contend with</span>\n                <span class=\"c1\"># each other to init the db. When we hit the following errors, we know that another</span>\n                <span class=\"c1\"># process is on the case and we should retry.</span>\n                <span class=\"n\">err_msg</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">exc</span><span class=\"p\">)</span>\n\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;table asset_keys already exists&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                    <span class=\"ow\">or</span> <span class=\"s2\">&quot;table secondary_indexes already exists&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                    <span class=\"ow\">or</span> <span class=\"s2\">&quot;table event_logs already exists&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                    <span class=\"ow\">or</span> <span class=\"s2\">&quot;database is locked&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                    <span class=\"ow\">or</span> <span class=\"s2\">&quot;table alembic_version already exists&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                    <span class=\"ow\">or</span> <span class=\"s2\">&quot;UNIQUE constraint failed: alembic_version.version_num&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">err_msg</span>\n                <span class=\"p\">):</span>\n                    <span class=\"k\">raise</span>\n\n                <span class=\"k\">if</span> <span class=\"n\">retry_limit</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                    <span class=\"k\">raise</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">info</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;SqliteEventLogStorage._initdb: Encountered apparent concurrent init, &quot;</span>\n                        <span class=\"s2\">&quot;retrying (</span><span class=\"si\">{retry_limit}</span><span class=\"s2\"> retries left). Exception: </span><span class=\"si\">{str_exc}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                            <span class=\"n\">retry_limit</span><span class=\"o\">=</span><span class=\"n\">retry_limit</span><span class=\"p\">,</span> <span class=\"n\">str_exc</span><span class=\"o\">=</span><span class=\"n\">err_msg</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                    <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mf\">0.2</span><span class=\"p\">)</span>\n                    <span class=\"n\">retry_limit</span> <span class=\"o\">-=</span> <span class=\"mi\">1</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db_lock</span><span class=\"p\">:</span>\n            <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n            <span class=\"n\">conn_string</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conn_string_for_run_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n            <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">NullPool</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">run_id</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initialized_dbs</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initdb</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initialized_dbs</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n\n            <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span>\n\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"k\">with</span> <span class=\"n\">handle_schema_errors</span><span class=\"p\">(</span>\n                    <span class=\"n\">conn</span><span class=\"p\">,</span>\n                    <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">),</span>\n                    <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"s2\">&quot;SqliteEventLogStorage for run </span><span class=\"si\">{run_id}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">),</span>\n                <span class=\"p\">):</span>\n                    <span class=\"k\">yield</span> <span class=\"n\">conn</span>\n            <span class=\"k\">finally</span><span class=\"p\">:</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n            <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">dispose</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">enable_secondary_index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">for</span> <span class=\"n\">filename</span> <span class=\"ow\">in</span> <span class=\"p\">(</span>\n            <span class=\"n\">glob</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;*.db&quot;</span><span class=\"p\">))</span>\n            <span class=\"o\">+</span> <span class=\"n\">glob</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;*.db-wal&quot;</span><span class=\"p\">))</span>\n            <span class=\"o\">+</span> <span class=\"n\">glob</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;*.db-shm&quot;</span><span class=\"p\">))</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">unlink</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_initialized_dbs</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">):</span>\n        <span class=\"n\">watchdog</span> <span class=\"o\">=</span> <span class=\"n\">SqliteEventLogStorageWatchdog</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watchers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">][</span><span class=\"n\">callback</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">watchdog</span><span class=\"p\">,</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_obs</span><span class=\"o\">.</span><span class=\"n\">schedule</span><span class=\"p\">(</span><span class=\"n\">watchdog</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_base_dir</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">end_watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">handler</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">handler</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watchers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">]:</span>\n            <span class=\"n\">event_handler</span><span class=\"p\">,</span> <span class=\"n\">watch</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watchers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">][</span><span class=\"n\">handler</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_obs</span><span class=\"o\">.</span><span class=\"n\">remove_handler_for_watch</span><span class=\"p\">(</span><span class=\"n\">event_handler</span><span class=\"p\">,</span> <span class=\"n\">watch</span><span class=\"p\">)</span>\n            <span class=\"k\">del</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_watchers</span><span class=\"p\">[</span><span class=\"n\">run_id</span><span class=\"p\">][</span><span class=\"n\">handler</span><span class=\"p\">]</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SqliteEventLogStorageWatchdog</span><span class=\"p\">(</span><span class=\"n\">PatternMatchingEventHandler</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event_log_storage</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">,</span> <span class=\"n\">start_cursor</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_log_storage</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">event_log_storage</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event_log_storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">SqliteEventLogStorage</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cb</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">callable_param</span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">,</span> <span class=\"s2\">&quot;callback&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_log_path</span> <span class=\"o\">=</span> <span class=\"n\">event_log_storage</span><span class=\"o\">.</span><span class=\"n\">path_for_run_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cursor</span> <span class=\"o\">=</span> <span class=\"n\">start_cursor</span> <span class=\"k\">if</span> <span class=\"n\">start_cursor</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"k\">else</span> <span class=\"o\">-</span><span class=\"mi\">1</span>\n        <span class=\"nb\">super</span><span class=\"p\">(</span><span class=\"n\">SqliteEventLogStorageWatchdog</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">patterns</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_log_path</span><span class=\"p\">],</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_process_log</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">events</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_log_storage</span><span class=\"o\">.</span><span class=\"n\">get_logs_for_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cursor</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cursor</span> <span class=\"o\">+=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">events</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">event</span> <span class=\"ow\">in</span> <span class=\"n\">events</span><span class=\"p\">:</span>\n            <span class=\"n\">status</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cb</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">SUCCESS</span> <span class=\"ow\">or</span> <span class=\"n\">status</span> <span class=\"o\">==</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">FAILURE</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_event_log_storage</span><span class=\"o\">.</span><span class=\"n\">end_watch</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_run_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cb</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">on_modified</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">invariant</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">src_path</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_log_path</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_process_log</span><span class=\"p\">()</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/event_log/sqlite/sqlite_event_log", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}