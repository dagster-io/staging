{"parents": [{"link": "../../../../../../", "title": "Module code"}], "title": "dagster.core.storage.schedules.sqlite.sqlite_schedule_storage", "body": "<h1>Source code for dagster.core.storage.schedules.sqlite.sqlite_schedule_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sql</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">check_alembic_revision</span><span class=\"p\">,</span>\n    <span class=\"n\">create_engine</span><span class=\"p\">,</span>\n    <span class=\"n\">get_alembic_config</span><span class=\"p\">,</span>\n    <span class=\"n\">handle_schema_errors</span><span class=\"p\">,</span>\n    <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">,</span>\n    <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sqlite</span> <span class=\"kn\">import</span> <span class=\"n\">create_db_conn_string</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">sqlalchemy.pool</span> <span class=\"kn\">import</span> <span class=\"n\">NullPool</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..schema</span> <span class=\"kn\">import</span> <span class=\"n\">ScheduleStorageSqlMetadata</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..sql_schedule_storage</span> <span class=\"kn\">import</span> <span class=\"n\">SqlScheduleStorage</span>\n\n\n<div class=\"viewcode-block\" id=\"SqliteScheduleStorage\"><a class=\"viewcode-back\" href=\"../../../../../../../sections/api/apidocs/internals/#dagster.core.storage.schedules.SqliteScheduleStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SqliteScheduleStorage</span><span class=\"p\">(</span><span class=\"n\">SqlScheduleStorage</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Local SQLite backed schedule storage</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"s2\">&quot;conn_string&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span> <span class=\"o\">=</span> <span class=\"n\">conn_string</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">StringSource</span><span class=\"p\">}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">SqliteScheduleStorage</span><span class=\"o\">.</span><span class=\"n\">from_local</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_local</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">)</span>\n        <span class=\"n\">conn_string</span> <span class=\"o\">=</span> <span class=\"n\">create_db_conn_string</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedules&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">NullPool</span><span class=\"p\">)</span>\n        <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s2\">&quot;PRAGMA journal_mode=WAL;&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">ScheduleStorageSqlMetadata</span><span class=\"o\">.</span><span class=\"n\">create_all</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">)</span>\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"n\">db_revision</span><span class=\"p\">,</span> <span class=\"n\">head_revision</span> <span class=\"o\">=</span> <span class=\"n\">check_alembic_revision</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">db_revision</span> <span class=\"ow\">and</span> <span class=\"n\">head_revision</span><span class=\"p\">):</span>\n            <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">engine</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">SqliteScheduleStorage</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">NullPool</span><span class=\"p\">)</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"n\">handle_schema_errors</span><span class=\"p\">(</span>\n                <span class=\"n\">conn</span><span class=\"p\">,</span>\n                <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">),</span>\n                <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"s2\">&quot;Sqlite schedule storage requires migration&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">):</span>\n                <span class=\"k\">yield</span> <span class=\"n\">conn</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/schedules/sqlite/sqlite_schedule_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}