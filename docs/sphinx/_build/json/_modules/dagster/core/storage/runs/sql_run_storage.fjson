{"parents": [{"link": "../../../../../", "title": "Module code"}], "title": "dagster.core.storage.runs.sql_run_storage", "body": "<h1>Source code for dagster.core.storage.runs.sql_run_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">zlib</span>\n<span class=\"kn\">from</span> <span class=\"nn\">abc</span> <span class=\"kn\">import</span> <span class=\"n\">abstractmethod</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">defaultdict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">datetime</span> <span class=\"kn\">import</span> <span class=\"n\">datetime</span>\n<span class=\"kn\">from</span> <span class=\"nn\">enum</span> <span class=\"kn\">import</span> <span class=\"n\">Enum</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.errors</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterRunAlreadyExists</span><span class=\"p\">,</span> <span class=\"n\">DagsterSnapshotDoesNotExist</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.events</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">,</span> <span class=\"n\">DagsterEventType</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.snap</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">ExecutionPlanSnapshot</span><span class=\"p\">,</span>\n    <span class=\"n\">PipelineSnapshot</span><span class=\"p\">,</span>\n    <span class=\"n\">create_execution_plan_snapshot_id</span><span class=\"p\">,</span>\n    <span class=\"n\">create_pipeline_snapshot_id</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.tags</span> <span class=\"kn\">import</span> <span class=\"n\">ROOT_RUN_ID_TAG</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">,</span> <span class=\"n\">serialize_dagster_namedtuple</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.seven</span> <span class=\"kn\">import</span> <span class=\"n\">JSONDecodeError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">merge_dicts</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..pipeline_run</span> <span class=\"kn\">import</span> <span class=\"n\">PipelineRun</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunStatus</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunsFilter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.base</span> <span class=\"kn\">import</span> <span class=\"n\">RunStorage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.schema</span> <span class=\"kn\">import</span> <span class=\"n\">RunTagsTable</span><span class=\"p\">,</span> <span class=\"n\">RunsTable</span><span class=\"p\">,</span> <span class=\"n\">SnapshotsTable</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SnapshotType</span><span class=\"p\">(</span><span class=\"n\">Enum</span><span class=\"p\">):</span>\n    <span class=\"n\">PIPELINE</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;PIPELINE&quot;</span>\n    <span class=\"n\">EXECUTION_PLAN</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;EXECUTION_PLAN&quot;</span>\n\n\n<div class=\"viewcode-block\" id=\"SqlRunStorage\"><a class=\"viewcode-back\" href=\"../../../../../../sections/api/apidocs/internals/#dagster.core.storage.runs.SqlRunStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SqlRunStorage</span><span class=\"p\">(</span><span class=\"n\">RunStorage</span><span class=\"p\">):</span>  <span class=\"c1\"># pylint: disable=no-init</span>\n    <span class=\"sd\">&quot;&quot;&quot;Base class for SQL based run storages</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Context manager yielding a sqlalchemy.engine.Connection.&quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@abstractmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;This method should perform any schema or data migrations necessary to bring an</span>\n<span class=\"sd\">        out-of-date instance of the storage up to date.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">fetchall</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">result_proxy</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n            <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">res</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">fetchone</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">result_proxy</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n            <span class=\"n\">row</span> <span class=\"o\">=</span> <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">()</span>\n            <span class=\"n\">result_proxy</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">row</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_run</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_run&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRun</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">has_pipeline_snapshot</span><span class=\"p\">(</span>\n            <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterSnapshotDoesNotExist</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Snapshot </span><span class=\"si\">{ss_id}</span><span class=\"s2\"> does not exist in run storage&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">ss_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">runs_insert</span> <span class=\"o\">=</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">pipeline_name</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">,</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">run_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">),</span>\n                    <span class=\"n\">snapshot_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">runs_insert</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">exc</span><span class=\"o\">.</span><span class=\"n\">IntegrityError</span> <span class=\"k\">as</span> <span class=\"n\">exc</span><span class=\"p\">:</span>\n                <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">raise_from</span><span class=\"p\">(</span><span class=\"n\">DagsterRunAlreadyExists</span><span class=\"p\">,</span> <span class=\"n\">exc</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">tags</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                    <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">(),</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"p\">[</span>\n                        <span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">v</span><span class=\"p\">)</span>\n                        <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n                    <span class=\"p\">],</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">pipeline_run</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">handle_run_event</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">event</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">,</span> <span class=\"s2\">&quot;event&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterEvent</span><span class=\"p\">)</span>\n\n        <span class=\"n\">lookup</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n            <span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_START</span><span class=\"p\">:</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">STARTED</span><span class=\"p\">,</span>\n            <span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_SUCCESS</span><span class=\"p\">:</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">SUCCESS</span><span class=\"p\">,</span>\n            <span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_FAILURE</span><span class=\"p\">:</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">FAILURE</span><span class=\"p\">,</span>\n            <span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_ENQUEUED</span><span class=\"p\">:</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">QUEUED</span><span class=\"p\">,</span>\n            <span class=\"n\">DagsterEventType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE_DEQUEUED</span><span class=\"p\">:</span> <span class=\"n\">PipelineRunStatus</span><span class=\"o\">.</span><span class=\"n\">NOT_STARTED</span><span class=\"p\">,</span>\n        <span class=\"p\">}</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">event_type</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">lookup</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">run</span><span class=\"p\">:</span>\n            <span class=\"c1\"># TODO log?</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">new_pipeline_status</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"p\">[</span><span class=\"n\">event</span><span class=\"o\">.</span><span class=\"n\">event_type</span><span class=\"p\">]</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n                <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>\n                    <span class=\"n\">status</span><span class=\"o\">=</span><span class=\"n\">new_pipeline_status</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n                    <span class=\"n\">run_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">with_status</span><span class=\"p\">(</span><span class=\"n\">new_pipeline_status</span><span class=\"p\">)),</span>\n                    <span class=\"n\">update_timestamp</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_row_to_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_rows_to_runs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_row_to_run</span><span class=\"p\">,</span> <span class=\"n\">rows</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_add_cursor_limit_to_query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot; Helper function to deal with cursor/limit pagination args &quot;&quot;&quot;</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n            <span class=\"n\">cursor_query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">cursor</span><span class=\"p\">)</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span> <span class=\"o\">&lt;</span> <span class=\"n\">cursor_query</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">limit</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">limit</span><span class=\"p\">(</span><span class=\"n\">limit</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"o\">.</span><span class=\"n\">desc</span><span class=\"p\">())</span>\n        <span class=\"k\">return</span> <span class=\"n\">query</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_add_filters_to_query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"s2\">&quot;filters&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunsFilter</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">run_ids</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"o\">.</span><span class=\"n\">in_</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">run_ids</span><span class=\"p\">))</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span> <span class=\"o\">==</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">pipeline_name</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">statuses</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n                <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">in_</span><span class=\"p\">([</span><span class=\"n\">status</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"k\">for</span> <span class=\"n\">status</span> <span class=\"ow\">in</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">statuses</span><span class=\"p\">])</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n                <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">or_</span><span class=\"p\">(</span>\n                    <span class=\"o\">*</span><span class=\"p\">(</span>\n                        <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">and_</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"o\">==</span> <span class=\"n\">value</span><span class=\"p\">)</span>\n                        <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">group_by</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_body</span><span class=\"p\">,</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">having</span><span class=\"p\">(</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">func</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">))</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">query</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_runs_query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n\n        <span class=\"n\">filters</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span>\n            <span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"s2\">&quot;filters&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineRunsFilter</span><span class=\"p\">,</span> <span class=\"n\">default</span><span class=\"o\">=</span><span class=\"n\">PipelineRunsFilter</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_str_param</span><span class=\"p\">(</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cursor&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_int_param</span><span class=\"p\">(</span><span class=\"n\">limit</span><span class=\"p\">,</span> <span class=\"s2\">&quot;limit&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_list_param</span><span class=\"p\">(</span><span class=\"n\">columns</span><span class=\"p\">,</span> <span class=\"s2\">&quot;columns&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">columns</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s2\">&quot;run_body&quot;</span><span class=\"p\">]</span>\n\n        <span class=\"n\">base_query_columns</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"p\">,</span> <span class=\"n\">column</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">column</span> <span class=\"ow\">in</span> <span class=\"n\">columns</span><span class=\"p\">]</span>\n\n        <span class=\"c1\"># If we have a tags filter, then we need to select from a joined table</span>\n        <span class=\"k\">if</span> <span class=\"n\">filters</span><span class=\"o\">.</span><span class=\"n\">tags</span><span class=\"p\">:</span>\n            <span class=\"n\">base_query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span><span class=\"n\">base_query_columns</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span>\n                <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"p\">,</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">base_query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span><span class=\"n\">base_query_columns</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_filters_to_query</span><span class=\"p\">(</span><span class=\"n\">base_query</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_cursor_limit_to_query</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">query</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_runs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_runs_query</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"p\">)</span>\n\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_rows_to_runs</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_runs_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">subquery</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_runs_query</span><span class=\"p\">(</span><span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"n\">filters</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;subquery&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># We use an alias here because Postgres requires subqueries to be</span>\n        <span class=\"c1\"># aliased.</span>\n        <span class=\"n\">subquery</span> <span class=\"o\">=</span> <span class=\"n\">subquery</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;subquery&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">func</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">()])</span><span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">subquery</span><span class=\"p\">)</span>\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"n\">count</span> <span class=\"o\">=</span> <span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"n\">count</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_by_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Get a run by its id.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            run_id (str): The id of the run</span>\n\n<span class=\"sd\">        Returns:</span>\n<span class=\"sd\">            Optional[PipelineRun]</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_body</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">])</span> <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">rows</span><span class=\"p\">)</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_tags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span><span class=\"p\">(</span><span class=\"nb\">set</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">distinct</span><span class=\"p\">(</span>\n            <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">r</span> <span class=\"ow\">in</span> <span class=\"n\">rows</span><span class=\"p\">:</span>\n            <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"n\">r</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]]</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">r</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">])</span>\n        <span class=\"k\">return</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">([(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()]),</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"k\">lambda</span> <span class=\"n\">x</span><span class=\"p\">:</span> <span class=\"n\">x</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_run_tags</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">new_tags</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">dict_param</span><span class=\"p\">(</span><span class=\"n\">new_tags</span><span class=\"p\">,</span> <span class=\"s2\">&quot;new_tags&quot;</span><span class=\"p\">,</span> <span class=\"n\">key_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">,</span> <span class=\"n\">value_type</span><span class=\"o\">=</span><span class=\"nb\">str</span><span class=\"p\">)</span>\n\n        <span class=\"n\">run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">current_tags</span> <span class=\"o\">=</span> <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">tags</span> <span class=\"k\">if</span> <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">tags</span> <span class=\"k\">else</span> <span class=\"p\">{}</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n                <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>\n                    <span class=\"n\">run_body</span><span class=\"o\">=</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span>\n                        <span class=\"n\">run</span><span class=\"o\">.</span><span class=\"n\">with_tags</span><span class=\"p\">(</span><span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">current_tags</span><span class=\"p\">,</span> <span class=\"n\">new_tags</span><span class=\"p\">))</span>\n                    <span class=\"p\">),</span>\n                    <span class=\"n\">update_timestamp</span><span class=\"o\">=</span><span class=\"n\">datetime</span><span class=\"o\">.</span><span class=\"n\">now</span><span class=\"p\">(),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">current_tags_set</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">current_tags</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n            <span class=\"n\">new_tags_set</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">new_tags</span><span class=\"o\">.</span><span class=\"n\">keys</span><span class=\"p\">())</span>\n\n            <span class=\"n\">existing_tags</span> <span class=\"o\">=</span> <span class=\"n\">current_tags_set</span> <span class=\"o\">&amp;</span> <span class=\"n\">new_tags_set</span>\n            <span class=\"n\">added_tags</span> <span class=\"o\">=</span> <span class=\"n\">new_tags_set</span><span class=\"o\">.</span><span class=\"n\">difference</span><span class=\"p\">(</span><span class=\"n\">existing_tags</span><span class=\"p\">)</span>\n\n            <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">existing_tags</span><span class=\"p\">:</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                    <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">()</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">and_</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"n\">tag</span><span class=\"p\">))</span>\n                    <span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">new_tags</span><span class=\"p\">[</span><span class=\"n\">tag</span><span class=\"p\">])</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">added_tags</span><span class=\"p\">:</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span>\n                    <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">(),</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                    <span class=\"p\">[</span><span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">key</span><span class=\"o\">=</span><span class=\"n\">tag</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">new_tags</span><span class=\"p\">[</span><span class=\"n\">tag</span><span class=\"p\">])</span> <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">added_tags</span><span class=\"p\">],</span>\n                <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_group</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">pipeline_run</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n        <span class=\"c1\"># find root_run</span>\n        <span class=\"n\">root_run_id</span> <span class=\"o\">=</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">root_run_id</span> <span class=\"k\">if</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">root_run_id</span> <span class=\"k\">else</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n        <span class=\"n\">root_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">root_run_id</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># root_run_id to run_id 1:1 mapping</span>\n        <span class=\"n\">root_to_run</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;root_run_id&quot;</span><span class=\"p\">),</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)]</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n                <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">and_</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"n\">ROOT_RUN_ID_TAG</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"o\">==</span> <span class=\"n\">root_run_id</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;root_to_run&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"c1\"># get run group</span>\n        <span class=\"n\">run_group_query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_body</span><span class=\"p\">])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span>\n                <span class=\"n\">root_to_run</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"n\">RunsTable</span><span class=\"p\">,</span> <span class=\"n\">root_to_run</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"n\">isouter</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;run_group&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">run_group_query</span><span class=\"p\">)</span>\n            <span class=\"n\">run_group</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_rows_to_runs</span><span class=\"p\">(</span><span class=\"n\">res</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"p\">(</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"n\">root_run</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"n\">run_group</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_run_groups</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"c1\"># The runs that would be returned by calling RunStorage.get_runs with the same arguments</span>\n        <span class=\"n\">runs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_runs_query</span><span class=\"p\">(</span>\n            <span class=\"n\">filters</span><span class=\"o\">=</span><span class=\"n\">filters</span><span class=\"p\">,</span> <span class=\"n\">cursor</span><span class=\"o\">=</span><span class=\"n\">cursor</span><span class=\"p\">,</span> <span class=\"n\">limit</span><span class=\"o\">=</span><span class=\"n\">limit</span><span class=\"p\">,</span> <span class=\"n\">columns</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"s2\">&quot;run_body&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">]</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;runs&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Gets us the run_id and associated root_run_id for every run in storage that is a</span>\n        <span class=\"c1\"># descendant run of some root</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># pseudosql:</span>\n        <span class=\"c1\">#   with all_descendant_runs as (</span>\n        <span class=\"c1\">#     select *</span>\n        <span class=\"c1\">#     from run_tags</span>\n        <span class=\"c1\">#     where key = @ROOT_RUN_ID_TAG</span>\n        <span class=\"c1\">#   )</span>\n\n        <span class=\"n\">all_descendant_runs</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunTagsTable</span><span class=\"p\">])</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">key</span> <span class=\"o\">==</span> <span class=\"n\">ROOT_RUN_ID_TAG</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;all_descendant_runs&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"c1\"># Augment the runs in our query, for those runs that are the descendant of some root run,</span>\n        <span class=\"c1\"># with the root_run_id</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># pseudosql:</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\">#   with runs_augmented as (</span>\n        <span class=\"c1\">#     select</span>\n        <span class=\"c1\">#       runs.run_id as run_id,</span>\n        <span class=\"c1\">#       all_descendant_runs.value as root_run_id</span>\n        <span class=\"c1\">#     from runs</span>\n        <span class=\"c1\">#     left outer join all_descendant_runs</span>\n        <span class=\"c1\">#       on all_descendant_runs.run_id = runs.run_id</span>\n        <span class=\"c1\">#   )</span>\n\n        <span class=\"n\">runs_augmented</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span><span class=\"n\">runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">),</span> <span class=\"n\">all_descendant_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;root_run_id&quot;</span><span class=\"p\">),]</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span>\n                <span class=\"n\">runs</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"n\">all_descendant_runs</span><span class=\"p\">,</span>\n                    <span class=\"n\">all_descendant_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">isouter</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;runs_augmented&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"c1\"># Get all the runs our query will return. This includes runs as well as their root runs.</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># pseudosql:</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\">#    with runs_and_root_runs as (</span>\n        <span class=\"c1\">#      select runs.run_id as run_id</span>\n        <span class=\"c1\">#      from runs, runs_augmented</span>\n        <span class=\"c1\">#      where</span>\n        <span class=\"c1\">#        runs.run_id = runs_augmented.run_id or</span>\n        <span class=\"c1\">#        runs.run_id = runs_augmented.root_run_id</span>\n        <span class=\"c1\">#    )</span>\n\n        <span class=\"n\">runs_and_root_runs</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)])</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span><span class=\"n\">runs_augmented</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n                <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">or_</span><span class=\"p\">(</span>\n                    <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">runs_augmented</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">runs_augmented</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">root_run_id</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">distinct</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">(</span><span class=\"s2\">&quot;runs_and_root_runs&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># We count the descendants of all of the runs in our query that are roots so that</span>\n        <span class=\"c1\"># we can accurately display when a root run has more descendants than are returned by this</span>\n        <span class=\"c1\"># query and afford a drill-down. This might be an unnecessary complication, but the</span>\n        <span class=\"c1\"># alternative isn&#39;t obvious -- we could go and fetch *all* the runs in any group that we&#39;re</span>\n        <span class=\"c1\"># going to return in this query, and then append those.</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\"># pseudosql:</span>\n        <span class=\"c1\">#</span>\n        <span class=\"c1\">#    select runs.run_body, count(all_descendant_runs.id) as child_counts</span>\n        <span class=\"c1\">#    from runs</span>\n        <span class=\"c1\">#    join runs_and_root_runs on runs.run_id = runs_and_root_runs.run_id</span>\n        <span class=\"c1\">#    left outer join all_descendant_runs</span>\n        <span class=\"c1\">#      on all_descendant_runs.value = runs_and_root_runs.run_id</span>\n        <span class=\"c1\">#    group by runs.run_body</span>\n        <span class=\"c1\">#    order by child_counts desc</span>\n\n        <span class=\"n\">runs_and_root_runs_with_descendant_counts</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span>\n                    <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_body</span><span class=\"p\">,</span>\n                    <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">func</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">all_descendant_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">id</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">label</span><span class=\"p\">(</span><span class=\"s2\">&quot;child_counts&quot;</span><span class=\"p\">),</span>\n                <span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">select_from</span><span class=\"p\">(</span>\n                <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"n\">runs_and_root_runs</span><span class=\"p\">,</span> <span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">runs_and_root_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span>\n                <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"n\">all_descendant_runs</span><span class=\"p\">,</span>\n                    <span class=\"n\">all_descendant_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">value</span> <span class=\"o\">==</span> <span class=\"n\">runs_and_root_runs</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n                    <span class=\"n\">isouter</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">group_by</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_body</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">desc</span><span class=\"p\">(</span><span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">(</span><span class=\"s2\">&quot;child_counts&quot;</span><span class=\"p\">)))</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">res</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">runs_and_root_runs_with_descendant_counts</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">fetchall</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Postprocess: descendant runs get aggregated with their roots</span>\n        <span class=\"n\">run_groups</span> <span class=\"o\">=</span> <span class=\"n\">defaultdict</span><span class=\"p\">(</span><span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"p\">{</span><span class=\"s2\">&quot;runs&quot;</span><span class=\"p\">:</span> <span class=\"p\">[],</span> <span class=\"s2\">&quot;count&quot;</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">})</span>\n        <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"n\">run_body</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"n\">res</span><span class=\"p\">:</span>\n            <span class=\"n\">row</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">run_body</span><span class=\"p\">,)</span>\n            <span class=\"n\">pipeline_run</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_row_to_run</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n            <span class=\"n\">root_run_id</span> <span class=\"o\">=</span> <span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">get_root_run_id</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">root_run_id</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">run_groups</span><span class=\"p\">[</span><span class=\"n\">root_run_id</span><span class=\"p\">][</span><span class=\"s2\">&quot;runs&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">run_groups</span><span class=\"p\">[</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">][</span><span class=\"s2\">&quot;runs&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">pipeline_run</span><span class=\"p\">)</span>\n                <span class=\"n\">run_groups</span><span class=\"p\">[</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">][</span><span class=\"s2\">&quot;count&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">count</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">run_groups</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_run_by_id</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_has_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_snapshot&quot;</span><span class=\"p\">,</span> <span class=\"n\">PipelineSnapshot</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_snapshot</span><span class=\"p\">(</span>\n            <span class=\"n\">snapshot_id</span><span class=\"o\">=</span><span class=\"n\">create_pipeline_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">),</span>\n            <span class=\"n\">snapshot_obj</span><span class=\"o\">=</span><span class=\"n\">pipeline_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">snapshot_type</span><span class=\"o\">=</span><span class=\"n\">SnapshotType</span><span class=\"o\">.</span><span class=\"n\">PIPELINE</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_pipeline_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pipeline_snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_snapshot</span><span class=\"p\">(</span><span class=\"n\">pipeline_snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_plan_snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">execution_plan_snapshot</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_plan_snapshot&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExecutionPlanSnapshot</span><span class=\"p\">)</span>\n        <span class=\"n\">execution_plan_snapshot_id</span> <span class=\"o\">=</span> <span class=\"n\">create_execution_plan_snapshot_id</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_add_snapshot</span><span class=\"p\">(</span>\n            <span class=\"n\">snapshot_id</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">,</span>\n            <span class=\"n\">snapshot_obj</span><span class=\"o\">=</span><span class=\"n\">execution_plan_snapshot</span><span class=\"p\">,</span>\n            <span class=\"n\">snapshot_type</span><span class=\"o\">=</span><span class=\"n\">SnapshotType</span><span class=\"o\">.</span><span class=\"n\">EXECUTION_PLAN</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_execution_plan_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;execution_plan_snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_snapshot</span><span class=\"p\">(</span><span class=\"n\">execution_plan_snapshot_id</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_add_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">,</span> <span class=\"n\">snapshot_obj</span><span class=\"p\">,</span> <span class=\"n\">snapshot_type</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">snapshot_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;snapshot_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">not_none_param</span><span class=\"p\">(</span><span class=\"n\">snapshot_obj</span><span class=\"p\">,</span> <span class=\"s2\">&quot;snapshot_obj&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">snapshot_type</span><span class=\"p\">,</span> <span class=\"s2\">&quot;snapshot_type&quot;</span><span class=\"p\">,</span> <span class=\"n\">SnapshotType</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">snapshot_insert</span> <span class=\"o\">=</span> <span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n                <span class=\"n\">snapshot_id</span><span class=\"o\">=</span><span class=\"n\">snapshot_id</span><span class=\"p\">,</span>\n                <span class=\"n\">snapshot_body</span><span class=\"o\">=</span><span class=\"n\">zlib</span><span class=\"o\">.</span><span class=\"n\">compress</span><span class=\"p\">(</span><span class=\"n\">serialize_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">snapshot_obj</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">()),</span>\n                <span class=\"n\">snapshot_type</span><span class=\"o\">=</span><span class=\"n\">snapshot_type</span><span class=\"o\">.</span><span class=\"n\">value</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">snapshot_insert</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">snapshot_id</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_has_snapshot_id</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n            <span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">snapshot_id</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">row</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_snapshot</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">snapshot_id</span><span class=\"p\">):</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">([</span><span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">snapshot_body</span><span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span>\n            <span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">snapshot_id</span> <span class=\"o\">==</span> <span class=\"n\">snapshot_id</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"n\">row</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fetchone</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">defensively_unpack_pipeline_snapshot_query</span><span class=\"p\">(</span><span class=\"n\">logging</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">row</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Clears the run storage.&quot;&quot;&quot;</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"c1\"># https://stackoverflow.com/a/54386260/324449</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">SnapshotsTable</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">())</span>  <span class=\"c1\"># pylint: disable=no-value-for-parameter</span></div>\n\n\n<span class=\"n\">GET_PIPELINE_SNAPSHOT_QUERY_ID</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;get-pipeline-snapshot&quot;</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">defensively_unpack_pipeline_snapshot_query</span><span class=\"p\">(</span><span class=\"n\">logger</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">):</span>\n    <span class=\"c1\"># no checking here because sqlalchemy returns a special</span>\n    <span class=\"c1\"># row proxy and don&#39;t want to instance check on an internal</span>\n    <span class=\"c1\"># implementation detail</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_warn</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">):</span>\n        <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"s2\">&quot;get-pipeline-snapshot: </span><span class=\"si\">{msg}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">))</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">binary_type</span><span class=\"p\">):</span>\n        <span class=\"n\">_warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;First entry in row is not a binary type.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">uncompressed_bytes</span> <span class=\"o\">=</span> <span class=\"n\">zlib</span><span class=\"o\">.</span><span class=\"n\">decompress</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n    <span class=\"k\">except</span> <span class=\"n\">zlib</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">:</span>\n        <span class=\"n\">_warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Could not decompress bytes stored in snapshot table.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">decoded_str</span> <span class=\"o\">=</span> <span class=\"n\">uncompressed_bytes</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">()</span>\n    <span class=\"k\">except</span> <span class=\"ne\">UnicodeDecodeError</span><span class=\"p\">:</span>\n        <span class=\"n\">_warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Could not unicode decode decompressed bytes stored in snapshot table.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">deserialize_json_to_dagster_namedtuple</span><span class=\"p\">(</span><span class=\"n\">decoded_str</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n        <span class=\"n\">_warn</span><span class=\"p\">(</span><span class=\"s2\">&quot;Could not parse json in snapshot table.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/runs/sql_run_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}