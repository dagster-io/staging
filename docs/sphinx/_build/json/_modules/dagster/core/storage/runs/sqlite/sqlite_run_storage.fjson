{"parents": [{"link": "../../../../../../", "title": "Module code"}], "title": "dagster.core.storage.runs.sqlite.sqlite_run_storage", "body": "<h1>Source code for dagster.core.storage.runs.sqlite.sqlite_run_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">sqlalchemy</span> <span class=\"k\">as</span> <span class=\"nn\">db</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">check</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sql</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">check_alembic_revision</span><span class=\"p\">,</span>\n    <span class=\"n\">create_engine</span><span class=\"p\">,</span>\n    <span class=\"n\">get_alembic_config</span><span class=\"p\">,</span>\n    <span class=\"n\">handle_schema_errors</span><span class=\"p\">,</span>\n    <span class=\"n\">run_alembic_downgrade</span><span class=\"p\">,</span>\n    <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">,</span>\n    <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.sqlite</span> <span class=\"kn\">import</span> <span class=\"n\">create_db_conn_string</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.seven</span> <span class=\"kn\">import</span> <span class=\"n\">urljoin</span><span class=\"p\">,</span> <span class=\"n\">urlparse</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.utils</span> <span class=\"kn\">import</span> <span class=\"n\">mkdir_p</span>\n<span class=\"kn\">from</span> <span class=\"nn\">sqlalchemy.pool</span> <span class=\"kn\">import</span> <span class=\"n\">NullPool</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">..schema</span> <span class=\"kn\">import</span> <span class=\"n\">RunStorageSqlMetadata</span><span class=\"p\">,</span> <span class=\"n\">RunTagsTable</span><span class=\"p\">,</span> <span class=\"n\">RunsTable</span>\n<span class=\"kn\">from</span> <span class=\"nn\">..sql_run_storage</span> <span class=\"kn\">import</span> <span class=\"n\">SqlRunStorage</span>\n\n\n<div class=\"viewcode-block\" id=\"SqliteRunStorage\"><a class=\"viewcode-back\" href=\"../../../../../../../sections/api/apidocs/internals/#dagster.core.storage.runs.SqliteRunStorage\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SqliteRunStorage</span><span class=\"p\">(</span><span class=\"n\">SqlRunStorage</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;SQLite-backed run storage.</span>\n\n<span class=\"sd\">    Users should not directly instantiate this class; it is instantiated by internal machinery when</span>\n<span class=\"sd\">    ``dagit`` and ``dagster-graphql`` load, based on the values in the ``dagster.yaml`` file in</span>\n<span class=\"sd\">    ``$DAGSTER_HOME``. Configuration of this class should be done by setting values in that file.</span>\n\n<span class=\"sd\">    This is the default run storage when none is specified in the ``dagster.yaml``.</span>\n\n<span class=\"sd\">    To explicitly specify SQLite for run storage, you can add a block such as the following to your</span>\n<span class=\"sd\">    ``dagster.yaml``:</span>\n\n<span class=\"sd\">    .. code-block:: YAML</span>\n\n<span class=\"sd\">        run_storage:</span>\n<span class=\"sd\">          module: dagster.core.storage.runs</span>\n<span class=\"sd\">          class: SqliteRunStorage</span>\n<span class=\"sd\">          config:</span>\n<span class=\"sd\">            base_dir: /path/to/dir</span>\n\n<span class=\"sd\">    The ``base_dir`` param tells the run storage where on disk to store the database.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"s2\">&quot;conn_string&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span> <span class=\"o\">=</span> <span class=\"n\">conn_string</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">opt_inst_param</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"s2\">&quot;inst_data&quot;</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClassData</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">:</span> <span class=\"n\">StringSource</span><span class=\"p\">}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">SqliteRunStorage</span><span class=\"o\">.</span><span class=\"n\">from_local</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">config_value</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_local</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;base_dir&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">)</span>\n        <span class=\"n\">conn_string</span> <span class=\"o\">=</span> <span class=\"n\">create_db_conn_string</span><span class=\"p\">(</span><span class=\"n\">base_dir</span><span class=\"p\">,</span> <span class=\"s2\">&quot;runs&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">NullPool</span><span class=\"p\">)</span>\n        <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"s2\">&quot;PRAGMA journal_mode=WAL;&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">RunStorageSqlMetadata</span><span class=\"o\">.</span><span class=\"n\">create_all</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">)</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span>\n        <span class=\"n\">db_revision</span><span class=\"p\">,</span> <span class=\"n\">head_revision</span> <span class=\"o\">=</span> <span class=\"n\">check_alembic_revision</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">db_revision</span> <span class=\"ow\">and</span> <span class=\"n\">head_revision</span><span class=\"p\">):</span>\n            <span class=\"n\">stamp_alembic_rev</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">engine</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">SqliteRunStorage</span><span class=\"p\">(</span><span class=\"n\">conn_string</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">engine</span> <span class=\"o\">=</span> <span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span><span class=\"p\">,</span> <span class=\"n\">poolclass</span><span class=\"o\">=</span><span class=\"n\">NullPool</span><span class=\"p\">)</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">engine</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"n\">handle_schema_errors</span><span class=\"p\">(</span>\n                <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"s2\">&quot;Sqlite run storage requires migration&quot;</span><span class=\"p\">,</span>\n            <span class=\"p\">):</span>\n                <span class=\"k\">yield</span> <span class=\"n\">conn</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alembic_upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">rev</span><span class=\"o\">=</span><span class=\"s2\">&quot;head&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">run_alembic_upgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">rev</span><span class=\"o\">=</span><span class=\"n\">rev</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_alembic_downgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">rev</span><span class=\"o\">=</span><span class=\"s2\">&quot;head&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">alembic_config</span> <span class=\"o\">=</span> <span class=\"n\">get_alembic_config</span><span class=\"p\">(</span><span class=\"vm\">__file__</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">run_alembic_downgrade</span><span class=\"p\">(</span><span class=\"n\">alembic_config</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">,</span> <span class=\"n\">rev</span><span class=\"o\">=</span><span class=\"n\">rev</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">upgrade</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_for_version_066_migration_and_perform</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_alembic_upgrade</span><span class=\"p\">()</span>\n\n    <span class=\"c1\"># In version 0.6.6, we changed the layout of the of the sqllite dbs on disk</span>\n    <span class=\"c1\"># to move from the root of DAGSTER_HOME/runs.db to DAGSTER_HOME/history/runs.bd</span>\n    <span class=\"c1\"># This function checks for that condition and does the move</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_check_for_version_066_migration_and_perform</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">old_conn_string</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;sqlite://&quot;</span> <span class=\"o\">+</span> <span class=\"n\">urljoin</span><span class=\"p\">(</span><span class=\"n\">urlparse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_conn_string</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"s2\">&quot;../runs.db&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">path_to_old_db</span> <span class=\"o\">=</span> <span class=\"n\">urlparse</span><span class=\"p\">(</span><span class=\"n\">old_conn_string</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">path</span>\n        <span class=\"c1\"># sqlite URLs look like `sqlite:///foo/bar/baz on Unix/Mac` but on Windows they look like</span>\n        <span class=\"c1\"># `sqlite:///D:/foo/bar/baz` (or `sqlite:///D:\\foo\\bar\\baz`)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;nt&quot;</span><span class=\"p\">:</span>\n            <span class=\"n\">path_to_old_db</span> <span class=\"o\">=</span> <span class=\"n\">path_to_old_db</span><span class=\"o\">.</span><span class=\"n\">lstrip</span><span class=\"p\">(</span><span class=\"s2\">&quot;/&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">(</span><span class=\"n\">path_to_old_db</span><span class=\"p\">):</span>\n            <span class=\"n\">old_storage</span> <span class=\"o\">=</span> <span class=\"n\">SqliteRunStorage</span><span class=\"p\">(</span><span class=\"n\">old_conn_string</span><span class=\"p\">)</span>\n            <span class=\"n\">old_runs</span> <span class=\"o\">=</span> <span class=\"n\">old_storage</span><span class=\"o\">.</span><span class=\"n\">get_runs</span><span class=\"p\">()</span>\n            <span class=\"k\">for</span> <span class=\"n\">run</span> <span class=\"ow\">in</span> <span class=\"n\">old_runs</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_run</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">)</span>\n            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">unlink</span><span class=\"p\">(</span><span class=\"n\">path_to_old_db</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">run_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot; Override the default sql delete run implementation until we can get full</span>\n<span class=\"sd\">        support on cascading deletes &quot;&quot;&quot;</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">run_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;run_id&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">remove_tags</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunTagsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"n\">remove_run</span> <span class=\"o\">=</span> <span class=\"n\">db</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">where</span><span class=\"p\">(</span><span class=\"n\">RunsTable</span><span class=\"o\">.</span><span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">run_id</span> <span class=\"o\">==</span> <span class=\"n\">run_id</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">conn</span><span class=\"p\">:</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">remove_tags</span><span class=\"p\">)</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">remove_run</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster/core/storage/runs/sqlite/sqlite_run_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}