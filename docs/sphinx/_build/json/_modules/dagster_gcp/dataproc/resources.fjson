{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_gcp.dataproc.resources", "body": "<h1>Source code for dagster_gcp.dataproc.resources</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">time</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">resource</span>\n<span class=\"kn\">from</span> <span class=\"nn\">googleapiclient.discovery</span> <span class=\"kn\">import</span> <span class=\"n\">build</span>\n<span class=\"kn\">from</span> <span class=\"nn\">oauth2client.client</span> <span class=\"kn\">import</span> <span class=\"n\">GoogleCredentials</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.configs</span> <span class=\"kn\">import</span> <span class=\"n\">define_dataproc_create_cluster_config</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.types</span> <span class=\"kn\">import</span> <span class=\"n\">DataprocError</span>\n\n<span class=\"n\">TWENTY_MINUTES</span> <span class=\"o\">=</span> <span class=\"mi\">20</span> <span class=\"o\">*</span> <span class=\"mi\">60</span>\n<span class=\"n\">DEFAULT_ITER_TIME_SEC</span> <span class=\"o\">=</span> <span class=\"mi\">5</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DataprocResource</span><span class=\"p\">(</span><span class=\"nb\">object</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Builds a client to the dataproc API.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">config</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Use Application Default Credentials to check the</span>\n        <span class=\"c1\"># GOOGLE_APPLICATION_CREDENTIALS environment variable</span>\n        <span class=\"c1\"># for the location of the service account key file.</span>\n        <span class=\"n\">credentials</span> <span class=\"o\">=</span> <span class=\"n\">GoogleCredentials</span><span class=\"o\">.</span><span class=\"n\">get_application_default</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># See https://github.com/googleapis/google-api-python-client/issues/299 for the</span>\n        <span class=\"c1\"># cache_discovery=False configuration below</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc</span> <span class=\"o\">=</span> <span class=\"n\">build</span><span class=\"p\">(</span><span class=\"s2\">&quot;dataproc&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;v1&quot;</span><span class=\"p\">,</span> <span class=\"n\">credentials</span><span class=\"o\">=</span><span class=\"n\">credentials</span><span class=\"p\">,</span> <span class=\"n\">cache_discovery</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config</span> <span class=\"o\">=</span> <span class=\"n\">config</span>\n\n        <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_config</span><span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">config</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">k</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;projectId&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;region&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;clusterName&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cluster_config&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">dataproc_clusters</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"c1\"># Google APIs dynamically genned, so pylint pukes</span>\n            <span class=\"c1\"># pylint: disable=no-member</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc</span><span class=\"o\">.</span><span class=\"n\">projects</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">regions</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">clusters</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">dataproc_jobs</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"c1\"># Google APIs dynamically genned, so pylint pukes</span>\n            <span class=\"c1\"># pylint: disable=no-member</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc</span><span class=\"o\">.</span><span class=\"n\">projects</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">regions</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">jobs</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create_cluster</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc_clusters</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n                <span class=\"n\">projectId</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span>\n                <span class=\"n\">region</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span>\n                <span class=\"n\">body</span><span class=\"o\">=</span><span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;projectId&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;clusterName&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_name</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;config&quot;</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_config</span><span class=\"p\">,</span>\n                <span class=\"p\">},</span>\n            <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">iter_fn</span><span class=\"p\">():</span>\n            <span class=\"c1\"># TODO: Add logging</span>\n            <span class=\"c1\"># See: https://bit.ly/2UW5JaN</span>\n            <span class=\"n\">cluster</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cluster</span><span class=\"p\">()</span>\n            <span class=\"k\">return</span> <span class=\"n\">cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;state&quot;</span><span class=\"p\">]</span> <span class=\"ow\">in</span> <span class=\"p\">{</span><span class=\"s2\">&quot;RUNNING&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;UPDATING&quot;</span><span class=\"p\">}</span>\n\n        <span class=\"n\">done</span> <span class=\"o\">=</span> <span class=\"n\">DataprocResource</span><span class=\"o\">.</span><span class=\"n\">_iter_and_sleep_until_ready</span><span class=\"p\">(</span><span class=\"n\">iter_fn</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">done</span><span class=\"p\">:</span>\n            <span class=\"n\">cluster</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cluster</span><span class=\"p\">()</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DataprocError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Could not provision cluster -- status: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">cluster</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">])</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_cluster</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc_clusters</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n            <span class=\"n\">projectId</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span> <span class=\"n\">region</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span> <span class=\"n\">clusterName</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_name</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete_cluster</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc_clusters</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">(</span>\n            <span class=\"n\">projectId</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span> <span class=\"n\">region</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span> <span class=\"n\">clusterName</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cluster_name</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">submit_job</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">job_details</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc_jobs</span><span class=\"o\">.</span><span class=\"n\">submit</span><span class=\"p\">(</span>\n            <span class=\"n\">projectId</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span> <span class=\"n\">region</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span> <span class=\"n\">body</span><span class=\"o\">=</span><span class=\"n\">job_details</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_job</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">job_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">dataproc_jobs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n            <span class=\"n\">projectId</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">project_id</span><span class=\"p\">,</span> <span class=\"n\">region</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">region</span><span class=\"p\">,</span> <span class=\"n\">jobId</span><span class=\"o\">=</span><span class=\"n\">job_id</span>\n        <span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wait_for_job</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">job_id</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;This method polls job status every 5 seconds</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># TODO: Add logging here print(&#39;Waiting for job ID {} to finish...&#39;.format(job_id))</span>\n        <span class=\"k\">def</span> <span class=\"nf\">iter_fn</span><span class=\"p\">():</span>\n            <span class=\"c1\"># See: https://bit.ly/2Lg2tHr</span>\n            <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_job</span><span class=\"p\">(</span><span class=\"n\">job_id</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Handle exceptions</span>\n            <span class=\"k\">if</span> <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;state&quot;</span><span class=\"p\">]</span> <span class=\"ow\">in</span> <span class=\"p\">{</span><span class=\"s2\">&quot;CANCELLED&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ERROR&quot;</span><span class=\"p\">}:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">DataprocError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Job error: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">]))</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">result</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;state&quot;</span><span class=\"p\">]</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;DONE&quot;</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n        <span class=\"n\">done</span> <span class=\"o\">=</span> <span class=\"n\">DataprocResource</span><span class=\"o\">.</span><span class=\"n\">_iter_and_sleep_until_ready</span><span class=\"p\">(</span><span class=\"n\">iter_fn</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">done</span><span class=\"p\">:</span>\n            <span class=\"n\">job</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_job</span><span class=\"p\">(</span><span class=\"n\">job_id</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DataprocError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Job run timed out: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">job</span><span class=\"p\">[</span><span class=\"s2\">&quot;status&quot;</span><span class=\"p\">]))</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_iter_and_sleep_until_ready</span><span class=\"p\">(</span>\n        <span class=\"n\">callable_fn</span><span class=\"p\">,</span> <span class=\"n\">max_wait_time_sec</span><span class=\"o\">=</span><span class=\"n\">TWENTY_MINUTES</span><span class=\"p\">,</span> <span class=\"n\">iter_time</span><span class=\"o\">=</span><span class=\"n\">DEFAULT_ITER_TIME_SEC</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Iterates and sleeps until callable_fn returns true</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Wait for cluster ready state</span>\n        <span class=\"n\">ready</span><span class=\"p\">,</span> <span class=\"n\">curr_iter</span> <span class=\"o\">=</span> <span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"mi\">0</span>\n        <span class=\"n\">max_iter</span> <span class=\"o\">=</span> <span class=\"n\">max_wait_time_sec</span> <span class=\"o\">/</span> <span class=\"n\">iter_time</span>\n        <span class=\"k\">while</span> <span class=\"ow\">not</span> <span class=\"n\">ready</span> <span class=\"ow\">and</span> <span class=\"n\">curr_iter</span> <span class=\"o\">&lt;</span> <span class=\"n\">max_iter</span><span class=\"p\">:</span>\n            <span class=\"n\">ready</span> <span class=\"o\">=</span> <span class=\"n\">callable_fn</span><span class=\"p\">()</span>\n            <span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"n\">iter_time</span><span class=\"p\">)</span>\n            <span class=\"n\">curr_iter</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n\n        <span class=\"c1\"># Will return false if ran up to max_iter without success</span>\n        <span class=\"k\">return</span> <span class=\"n\">ready</span>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">cluster_context_manager</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;This context manager gives syntactic sugar so you can run:</span>\n\n<span class=\"sd\">        with context.resources.dataproc.cluster as cluster:</span>\n<span class=\"sd\">            # do stuff...</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create_cluster</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"bp\">self</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete_cluster</span><span class=\"p\">()</span>\n\n\n<div class=\"viewcode-block\" id=\"dataproc_resource\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_gcp/#dagster_gcp.dataproc_resource\">[docs]</a><span class=\"nd\">@resource</span><span class=\"p\">(</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"n\">define_dataproc_create_cluster_config</span><span class=\"p\">(),</span>\n    <span class=\"n\">description</span><span class=\"o\">=</span><span class=\"s2\">&quot;Manage a Dataproc cluster resource&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">dataproc_resource</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"n\">DataprocResource</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">resource_config</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/dagster_gcp/dataproc/resources", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}