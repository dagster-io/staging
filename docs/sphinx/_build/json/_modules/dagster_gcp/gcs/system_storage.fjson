{"parents": [{"link": "../../../", "title": "Module code"}], "title": "dagster_gcp.gcs.system_storage", "body": "<h1>Source code for dagster_gcp.gcs.system_storage</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">,</span> <span class=\"n\">intermediate_storage</span><span class=\"p\">,</span> <span class=\"n\">system_storage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.storage.system_storage</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_system_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">mem_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">mem_system_storage</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">.file_manager</span> <span class=\"kn\">import</span> <span class=\"n\">GCSFileManager</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.intermediate_storage</span> <span class=\"kn\">import</span> <span class=\"n\">GCSIntermediateStorage</span>\n<span class=\"kn\">from</span> <span class=\"nn\">.object_store</span> <span class=\"kn\">import</span> <span class=\"n\">GCSObjectStore</span>\n\n\n<div class=\"viewcode-block\" id=\"gcs_intermediate_storage\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_gcp/#dagster_gcp.gcs_intermediate_storage\">[docs]</a><span class=\"nd\">@intermediate_storage</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;gcs&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;gcs_bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;gcs_prefix&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;gcs&quot;</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">gcs_intermediate_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">gcs</span>\n    <span class=\"n\">gcs_bucket</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">intermediate_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_bucket&quot;</span><span class=\"p\">]</span>\n    <span class=\"n\">gcs_prefix</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">intermediate_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_prefix&quot;</span><span class=\"p\">]</span>\n    <span class=\"n\">object_store</span> <span class=\"o\">=</span> <span class=\"n\">GCSObjectStore</span><span class=\"p\">(</span><span class=\"n\">gcs_bucket</span><span class=\"p\">,</span> <span class=\"n\">client</span><span class=\"o\">=</span><span class=\"n\">client</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">root_for_run_id</span><span class=\"p\">(</span><span class=\"n\">r_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">object_store</span><span class=\"o\">.</span><span class=\"n\">key_for_paths</span><span class=\"p\">([</span><span class=\"n\">gcs_prefix</span><span class=\"p\">,</span> <span class=\"s2\">&quot;storage&quot;</span><span class=\"p\">,</span> <span class=\"n\">r_id</span><span class=\"p\">])</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">build_intermediate_storage_from_object_store</span><span class=\"p\">(</span>\n        <span class=\"n\">object_store</span><span class=\"p\">,</span> <span class=\"n\">init_context</span><span class=\"p\">,</span> <span class=\"n\">root_for_run_id</span><span class=\"o\">=</span><span class=\"n\">root_for_run_id</span>\n    <span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"gcs_system_storage\"><a class=\"viewcode-back\" href=\"../../../../sections/api/apidocs/libraries/dagster_gcp/#dagster_gcp.gcs_system_storage\">[docs]</a><span class=\"nd\">@system_storage</span><span class=\"p\">(</span>\n    <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s2\">&quot;gcs&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">is_persistent</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"n\">config_schema</span><span class=\"o\">=</span><span class=\"p\">{</span>\n        <span class=\"s2\">&quot;gcs_bucket&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;gcs_prefix&quot;</span><span class=\"p\">:</span> <span class=\"n\">Field</span><span class=\"p\">(</span><span class=\"n\">StringSource</span><span class=\"p\">,</span> <span class=\"n\">is_required</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">default_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;dagster&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">},</span>\n    <span class=\"n\">required_resource_keys</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;gcs&quot;</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n<span class=\"k\">def</span> <span class=\"nf\">gcs_system_storage</span><span class=\"p\">(</span><span class=\"n\">init_context</span><span class=\"p\">):</span>\n    <span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">resources</span><span class=\"o\">.</span><span class=\"n\">gcs</span>\n    <span class=\"n\">gcs_key</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{prefix}</span><span class=\"s2\">/storage/</span><span class=\"si\">{run_id}</span><span class=\"s2\">/files&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n        <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_prefix&quot;</span><span class=\"p\">],</span>\n        <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">SystemStorageData</span><span class=\"p\">(</span>\n        <span class=\"n\">file_manager</span><span class=\"o\">=</span><span class=\"n\">GCSFileManager</span><span class=\"p\">(</span>\n            <span class=\"n\">client</span><span class=\"o\">=</span><span class=\"n\">client</span><span class=\"p\">,</span>\n            <span class=\"n\">gcs_bucket</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_bucket&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">gcs_base_key</span><span class=\"o\">=</span><span class=\"n\">gcs_key</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n        <span class=\"n\">intermediate_storage</span><span class=\"o\">=</span><span class=\"n\">GCSIntermediateStorage</span><span class=\"p\">(</span>\n            <span class=\"n\">client</span><span class=\"o\">=</span><span class=\"n\">client</span><span class=\"p\">,</span>\n            <span class=\"n\">gcs_bucket</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_bucket&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">gcs_prefix</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">system_storage_config</span><span class=\"p\">[</span><span class=\"s2\">&quot;gcs_prefix&quot;</span><span class=\"p\">],</span>\n            <span class=\"n\">run_id</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">pipeline_run</span><span class=\"o\">.</span><span class=\"n\">run_id</span><span class=\"p\">,</span>\n            <span class=\"n\">type_storage_plugin_registry</span><span class=\"o\">=</span><span class=\"n\">init_context</span><span class=\"o\">.</span><span class=\"n\">type_storage_plugin_registry</span><span class=\"p\">,</span>\n        <span class=\"p\">),</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"n\">gcs_plus_default_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">mem_system_storage</span><span class=\"p\">,</span> <span class=\"n\">fs_system_storage</span><span class=\"p\">,</span> <span class=\"n\">gcs_system_storage</span><span class=\"p\">]</span>\n<span class=\"n\">gcs_plus_default_intermediate_storage_defs</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n    <span class=\"n\">mem_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">fs_intermediate_storage</span><span class=\"p\">,</span>\n    <span class=\"n\">gcs_intermediate_storage</span><span class=\"p\">,</span>\n<span class=\"p\">]</span>\n</pre></div>", "current_page_name": "_modules/dagster_gcp/gcs/system_storage", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}