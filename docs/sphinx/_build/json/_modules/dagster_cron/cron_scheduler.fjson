{"parents": [{"link": "../../", "title": "Module code"}], "title": "dagster_cron.cron_scheduler", "body": "<h1>Source code for dagster_cron.cron_scheduler</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">io</span>\n<span class=\"kn\">import</span> <span class=\"nn\">os</span>\n<span class=\"kn\">import</span> <span class=\"nn\">shutil</span>\n<span class=\"kn\">import</span> <span class=\"nn\">stat</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">six</span>\n<span class=\"kn\">from</span> <span class=\"nn\">crontab</span> <span class=\"kn\">import</span> <span class=\"n\">CronTab</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">,</span> <span class=\"n\">check</span><span class=\"p\">,</span> <span class=\"n\">utils</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.host_representation</span> <span class=\"kn\">import</span> <span class=\"n\">ExternalSchedule</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.core.scheduler</span> <span class=\"kn\">import</span> <span class=\"n\">DagsterSchedulerError</span><span class=\"p\">,</span> <span class=\"n\">Scheduler</span>\n<span class=\"kn\">from</span> <span class=\"nn\">dagster.serdes</span> <span class=\"kn\">import</span> <span class=\"n\">ConfigurableClass</span>\n\n\n<div class=\"viewcode-block\" id=\"SystemCronScheduler\"><a class=\"viewcode-back\" href=\"../../../sections/api/apidocs/libraries/dagster_cron/#dagster_cron.cron_scheduler.SystemCronScheduler\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SystemCronScheduler</span><span class=\"p\">(</span><span class=\"n\">Scheduler</span><span class=\"p\">,</span> <span class=\"n\">ConfigurableClass</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Scheduler implementation that uses the local systems cron. Only works on unix systems that</span>\n<span class=\"sd\">    have cron.</span>\n\n<span class=\"sd\">    Enable this scheduler by adding it to your ``dagster.yaml`` in ``$DAGSTER_HOME``.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span> <span class=\"o\">=</span> <span class=\"n\">inst_data</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">inst_data</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_inst_data</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">config_type</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">{}</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">from_config_value</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"p\">,</span> <span class=\"n\">config_value</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">SystemCronScheduler</span><span class=\"p\">(</span><span class=\"n\">inst_data</span><span class=\"o\">=</span><span class=\"n\">inst_data</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_cron_tab</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">CronTab</span><span class=\"p\">(</span><span class=\"n\">user</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">debug_info</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;Running Cron Jobs:</span><span class=\"se\">\\n</span><span class=\"si\">{jobs}</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">jobs</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">job</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">job</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cron_tab</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"s2\">&quot;dagster-schedule:&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">job</span><span class=\"o\">.</span><span class=\"n\">comment</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">start_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">external_schedule</span><span class=\"p\">,</span> <span class=\"s2\">&quot;external_schedule&quot;</span><span class=\"p\">,</span> <span class=\"n\">ExternalSchedule</span><span class=\"p\">)</span>\n        <span class=\"n\">schedule_origin_id</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># If the cron job already exists, remove it. This prevents duplicate entries.</span>\n        <span class=\"c1\"># Then, add a new cron job to the cron tab.</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">())</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_end_cron_job</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_start_cron_job</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Verify that the cron job is running</span>\n        <span class=\"n\">running_schedule_count</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">running_schedule_count</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterSchedulerError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Attempted to write cron job for schedule &quot;</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">{schedule_name}</span><span class=\"s2\">, but failed. &quot;</span>\n                <span class=\"s2\">&quot;The scheduler is not running </span><span class=\"si\">{schedule_name}</span><span class=\"s2\">.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">name</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">running_schedule_count</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterSchedulerError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Attempted to write cron job for schedule &quot;</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">{schedule_name}</span><span class=\"s2\">, but duplicate cron jobs were found. &quot;</span>\n                <span class=\"s2\">&quot;There are </span><span class=\"si\">{running_schedule_count}</span><span class=\"s2\"> jobs running for the schedule.&quot;</span>\n                <span class=\"s2\">&quot;To resolve, run `dagster schedule up`, or edit the cron tab to &quot;</span>\n                <span class=\"s2\">&quot;remove duplicate schedules&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n                    <span class=\"n\">running_schedule_count</span><span class=\"o\">=</span><span class=\"n\">running_schedule_count</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">stop_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">schedule</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_schedule_state</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_end_cron_job</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Verify that the cron job has been removed</span>\n        <span class=\"n\">running_schedule_count</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">running_schedule_count</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">running_schedule_count</span> <span class=\"o\">&gt;</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">DagsterSchedulerError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Attempted to remove existing cron job for schedule &quot;</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">{schedule_name}</span><span class=\"s2\">, but failed. &quot;</span>\n                <span class=\"s2\">&quot;There are still </span><span class=\"si\">{running_schedule_count}</span><span class=\"s2\"> jobs running for the schedule.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">schedule</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">running_schedule_count</span><span class=\"o\">=</span><span class=\"n\">running_schedule_count</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">wipe</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Note: This method deletes schedules from ALL repositories</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Delete all script files</span>\n        <span class=\"n\">script_directory</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">schedules_directory</span><span class=\"p\">(),</span> <span class=\"s2\">&quot;scripts&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">script_directory</span><span class=\"p\">):</span>\n            <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">rmtree</span><span class=\"p\">(</span><span class=\"n\">script_directory</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Delete all logs</span>\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">schedules_directory</span><span class=\"p\">(),</span> <span class=\"s2\">&quot;logs&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">):</span>\n            <span class=\"n\">shutil</span><span class=\"o\">.</span><span class=\"n\">rmtree</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Remove all cron jobs</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cron_tab</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cron_tab</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">job</span> <span class=\"ow\">in</span> <span class=\"n\">cron_tab</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"s2\">&quot;dagster-schedule:&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">job</span><span class=\"o\">.</span><span class=\"n\">comment</span><span class=\"p\">:</span>\n                    <span class=\"n\">cron_tab</span><span class=\"o\">.</span><span class=\"n\">remove_all</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">=</span><span class=\"n\">job</span><span class=\"o\">.</span><span class=\"n\">comment</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_bash_script_file_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">script_directory</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">schedules_directory</span><span class=\"p\">(),</span> <span class=\"s2\">&quot;scripts&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">script_directory</span><span class=\"p\">)</span>\n\n        <span class=\"n\">script_file_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">.sh&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">script_directory</span><span class=\"p\">,</span> <span class=\"n\">script_file_name</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_cron_tag_for_schedule</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;dagster-schedule: </span><span class=\"si\">{schedule_origin_id}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">schedule_origin_id</span><span class=\"o\">=</span><span class=\"n\">schedule_origin_id</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_command</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">script_file</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">schedule_log_file_path</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_logs_path</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"n\">command</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{script_file}</span><span class=\"s2\"> &gt; </span><span class=\"si\">{schedule_log_file_path}</span><span class=\"s2\"> 2&gt;&amp;1&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">script_file</span><span class=\"o\">=</span><span class=\"n\">script_file</span><span class=\"p\">,</span> <span class=\"n\">schedule_log_file_path</span><span class=\"o\">=</span><span class=\"n\">schedule_log_file_path</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">command</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_start_cron_job</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"n\">schedule_origin_id</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n        <span class=\"n\">script_file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_write_bash_script_to_file</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">)</span>\n        <span class=\"n\">command</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_command</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cron_tab</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cron_tab</span><span class=\"p\">:</span>\n            <span class=\"n\">job</span> <span class=\"o\">=</span> <span class=\"n\">cron_tab</span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span>\n                <span class=\"n\">command</span><span class=\"o\">=</span><span class=\"n\">command</span><span class=\"p\">,</span>\n                <span class=\"n\">comment</span><span class=\"o\">=</span><span class=\"s2\">&quot;dagster-schedule: </span><span class=\"si\">{schedule_origin_id}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n                    <span class=\"n\">schedule_origin_id</span><span class=\"o\">=</span><span class=\"n\">schedule_origin_id</span>\n                <span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">job</span><span class=\"o\">.</span><span class=\"n\">setall</span><span class=\"p\">(</span><span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">cron_schedule</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_end_cron_job</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cron_tab</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cron_tab</span><span class=\"p\">:</span>\n            <span class=\"n\">cron_tab</span><span class=\"o\">.</span><span class=\"n\">remove_all</span><span class=\"p\">(</span><span class=\"n\">comment</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cron_tag_for_schedule</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">))</span>\n\n        <span class=\"n\">script_file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_bash_script_file_path</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isfile</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">):</span>\n            <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">running_schedule_count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">matching_jobs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_cron_tab</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">find_comment</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_cron_tag_for_schedule</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">matching_jobs</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_or_create_logs_directory</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">schedules_directory</span><span class=\"p\">(),</span> <span class=\"s2\">&quot;logs&quot;</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">isdir</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">):</span>\n            <span class=\"n\">utils</span><span class=\"o\">.</span><span class=\"n\">mkdir_p</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">logs_directory</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_logs_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">):</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">inst_param</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance&quot;</span><span class=\"p\">,</span> <span class=\"n\">DagsterInstance</span><span class=\"p\">)</span>\n        <span class=\"n\">check</span><span class=\"o\">.</span><span class=\"n\">str_param</span><span class=\"p\">(</span><span class=\"n\">schedule_origin_id</span><span class=\"p\">,</span> <span class=\"s2\">&quot;schedule_origin_id&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_or_create_logs_directory</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">,</span> <span class=\"s2\">&quot;scheduler.log&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_write_bash_script_to_file</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">external_schedule</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Get path to store bash script</span>\n        <span class=\"n\">schedule_origin_id</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin_id</span><span class=\"p\">()</span>\n        <span class=\"n\">script_file</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_bash_script_file_path</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Get path to store schedule attempt logs</span>\n        <span class=\"n\">logs_directory</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_or_create_logs_directory</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"n\">schedule_log_file_name</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">_</span><span class=\"si\">{}</span><span class=\"s2\">.result&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"s2\">&quot;$</span><span class=\"si\">{RUN_DATE}</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"n\">schedule_origin_id</span><span class=\"p\">)</span>\n        <span class=\"n\">schedule_log_file_path</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">logs_directory</span><span class=\"p\">,</span> <span class=\"n\">schedule_log_file_name</span><span class=\"p\">)</span>\n\n        <span class=\"n\">local_target</span> <span class=\"o\">=</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">get_external_origin</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Environment information needed for execution</span>\n        <span class=\"n\">dagster_home</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">getenv</span><span class=\"p\">(</span><span class=\"s2\">&quot;DAGSTER_HOME&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">script_contents</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;&quot;</span>\n<span class=\"s2\">            #!/bin/bash</span>\n<span class=\"s2\">            export DAGSTER_HOME=</span><span class=\"si\">{dagster_home}</span><span class=\"s2\"></span>\n<span class=\"s2\">            export LANG=en_US.UTF-8</span>\n<span class=\"s2\">            </span><span class=\"si\">{env_vars}</span><span class=\"s2\"></span>\n\n<span class=\"s2\">            export RUN_DATE=$(date &quot;+%Y%m</span><span class=\"si\">%d</span><span class=\"s2\">T%H%M%S&quot;)</span>\n\n<span class=\"s2\">            </span><span class=\"si\">{python_exe}</span><span class=\"s2\"> -m dagster api launch_scheduled_execution --schedule_name </span><span class=\"si\">{schedule_name}</span><span class=\"s2\"> </span><span class=\"si\">{repo_cli_args}</span><span class=\"s2\"> &quot;</span><span class=\"si\">{result_file}</span><span class=\"s2\">&quot;</span>\n<span class=\"s2\">        &quot;&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span>\n            <span class=\"n\">python_exe</span><span class=\"o\">=</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">executable</span><span class=\"p\">,</span>\n            <span class=\"n\">schedule_name</span><span class=\"o\">=</span><span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span>\n            <span class=\"n\">repo_cli_args</span><span class=\"o\">=</span><span class=\"n\">local_target</span><span class=\"o\">.</span><span class=\"n\">get_repo_cli_args</span><span class=\"p\">(),</span>\n            <span class=\"n\">result_file</span><span class=\"o\">=</span><span class=\"n\">schedule_log_file_path</span><span class=\"p\">,</span>\n            <span class=\"n\">dagster_home</span><span class=\"o\">=</span><span class=\"n\">dagster_home</span><span class=\"p\">,</span>\n            <span class=\"n\">env_vars</span><span class=\"o\">=</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span>\n                    <span class=\"s2\">&quot;export </span><span class=\"si\">{key}</span><span class=\"s2\">=</span><span class=\"si\">{value}</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"o\">=</span><span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">value</span><span class=\"p\">)</span>\n                    <span class=\"k\">for</span> <span class=\"n\">key</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">external_schedule</span><span class=\"o\">.</span><span class=\"n\">environment_vars</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n                <span class=\"p\">]</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">with</span> <span class=\"n\">io</span><span class=\"o\">.</span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">,</span> <span class=\"s2\">&quot;w&quot;</span><span class=\"p\">,</span> <span class=\"n\">encoding</span><span class=\"o\">=</span><span class=\"s2\">&quot;utf-8&quot;</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">f</span><span class=\"p\">:</span>\n            <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">six</span><span class=\"o\">.</span><span class=\"n\">text_type</span><span class=\"p\">(</span><span class=\"n\">script_contents</span><span class=\"p\">))</span>\n\n        <span class=\"n\">st</span> <span class=\"o\">=</span> <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">stat</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">)</span>\n        <span class=\"n\">os</span><span class=\"o\">.</span><span class=\"n\">chmod</span><span class=\"p\">(</span><span class=\"n\">script_file</span><span class=\"p\">,</span> <span class=\"n\">st</span><span class=\"o\">.</span><span class=\"n\">st_mode</span> <span class=\"o\">|</span> <span class=\"n\">stat</span><span class=\"o\">.</span><span class=\"n\">S_IEXEC</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">script_file</span></div>\n</pre></div>", "current_page_name": "_modules/dagster_cron/cron_scheduler", "sidebars": ["globaltoc.html", "searchbox.html"], "customsidebar": null, "alabaster_version": "0.7.12"}